{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__

== BreezyToolchainTransition ==

== Breezy Toolchain Update ==

Some links ...

* CxxLibraryList
* CxxApplicationList
* UniverseCxxTransition
* <nowiki>[[GCC4CommonProblems]]</nowiki>
* PortingSourcesFrom32To64Bit

=== Summary ===

The current toolchain (binutils, GCC, glibc, kernel-headers) is aging and needs an update to

* support new architecture variants like ppc64.

* better support for newer architectures like amd64.

* to support the Linux Standard Base Version 3 (making NPTL the default, still supporting linuxthreads?)

* Java Support (using GCC-4.0)

The following packages are affected

* nearly all, in particular ...

* glibc: 2.3.2 -> 2.3.5 CVS

* binutils: 2.15 -> 2.16

* GCC 3.3.5 -> 4.0 (have 3.4 as ABI compatible backup)

* all C++ library packages and binaries depending on these (C++ ABI change)

* On HPPA, all binaries depending on libgcc1 (but HPPA is not yet officially supported)

Due to the C++ ABI change, C++ libarary packages have to be renamed,
or new upstream releases with a new soname (and a new package name) have to be used.

=== Time Line ===

* Update glibc, use whichever compiler version works. upload by April 13th ('''DONE''')

* Update to binutils 2.16, once it's released. (Delayed, waiting for 2.16.1 release)

* Update GCC to current CVS versions, update to 4.0.0 release, planned for April 15th. Don't change the default yet. uploads starting April 11th ('''DONE''').

* Apply patches to packages to build with 3.4/4.0. You'll find a lot of work already done by Andreas Jochens, in the Debian BTS. About 800 issues are
  fixed, some 700 still outstanding. The bugs for packages in main are imported from the Debian BTS (http://bugs.debian.org/from:aj@andaco.de) into bugzilla, for universe see UniverseCxxTransition (mostly '''DONE''' for main).

* Make test builds for other packages using the new toolchain ('''DONE''', all syncs from Debian did build using gcc-4.0).

The steps above can be done in parallel (?)

* Enable ppc64 biarch in glibc/GCC to start the ppc64 kernel bakery. (Done for glibc/gcc-3.4, gcc-4.0 in the works)

Many of us won't be active in the week from April 16th to April 23th, therefore we do change the default compiler versions in two steps:

* Make gcc 4.0 the default C/ObjC compiler version, make g77-3.4 the default for g77. '''DONE''' on 14th April. The package syncronisation (import from Debian unstable) then is built/tested with the new C compiler.

* Make g++/gij/gcj 4.0 the default compilers. Note before 25th April, maybe later ('''DONE''').

* Do not allow new source packages into breezy, do not allow applications written in C++ into breezy, until most/all library packages are rebuilt. Update: main is unrestricted again, syncs are unrestricted again, C++ apps in universe are not built by the buildds until all C++ libraries are renamed.

* Upload build-essential version 11, depending on g++ (>= 4:4.0) ('''DONE''')

* Start building library packages using the new C++ ABI. See below for the details. ('''DONE''' for main).

* Unfreeze breezy ('''DONE''') for main

* Rebuild all C++ application packages (automated uploads) ('''DONE''') for main.

=== Open Issues ===

1) glibc

Questions:

* Default nptl headers? (Done for archs that are using nptl by default: ppc, ia64, amd64.  Todo for sparc.  Post-breezy: i386, hppa)

* User linux-libc-headers instead of linux-kernel-headers? ('''DONE''')

* Bump minimum supported kernel version to 2.6?  Eliminates fallback to 2.4 syscalls. (Done as part of NPTL transition)

* If above, will LD_ASSUME_KERNEL=2.4 trick still work, or do we need to provide a 'linuxthreads' wrapper that forces LT usage.

2) GCC 4.0
* Serious miscompile of QT (fixed in 4.0 RC1), target release date of gcc-4 is April 15th

According to dilinger, looks like 3.4 might have to be kept for the kernel for now.

3) KDE

* is KDE 4.0 realistic for breezy? If not, transition qt and KDE as well.
''No KDE 4.0 for at least a year'' -- JonathanRiddell

4) LSB 3 testing. April 20th.

Justification:

* This is a nice measurable goal, and there's no reason why breezy shouldn't be compliant on i386, ia64, ppc, ppc64, and amd64.

* According to taggart, it's reasonable to drop LSB2 certs, and primarily pursue LSB3 cert only.

Questions:

* Can we upload the lsb testsuite as a package, and force a new version upload on a regular basis to test this?  Should the lsb tests be integrated with the glibc build?

Other:

* C++ transition timing.  How do we coordinate the package renames?  Debian will have to go through this eventually.

* Other ABI breakage.  We appear to be safe on our supported arch's.

* When the ppc64 toolchain is done, need to signal kernel team to build ppc64 kernels, and update procps to deal with 64 bit kernels.

* lsb3 has /lib and /lib64 hardcodes still.  How does this interact with multiarch?  (Specifically P_INTERP)

* multiarch? multiarch changes should be orthogonal, so can be done later / independent from the C++ transition.

=== C++ ABI Transition ===
Debian already had a C++ transition in 2002. Still remember? We are proposing the same schema for the forthcoming ABI transition. The following text is derived from this plan.

==== Why do we need one? ====

Because GCC 3.4/4.0 changed the C++ ABI. You can't mix a C++ library compiled with GCC 3.4/4.0 and a C++ application compiled with an earlier version, or vice versa.

Transitions are painful. This will be no exception. The rules here are designed to make it as smooth as possible, but it's still going to be unpleasant. We have to do it, we can't stay with GCC 3.3 for ever.

Other distributions did already switch to 3.4 or 4.0, and most of our ports will have much better toolchains with the newer compiler.

==== How is it called? ====

The C++ ABI has many names (no, actually only two). G++ 3.2/3.3 have the Version 1, 3.4/4.0 have the version 2. To get the ABI version:

<code>g++ -E -dM - < /dev/null | awk '/GXX_ABI/ {print $3}'</code>

Compilers with ABI version 1 print 102, those with version 2 print 1002. During the last C++ ABI transition package names were renamed from libfoo to libfooc102. So rename them to libfooc1002 this time?

No,

* if your package is called libfoo1, add the string ''c2'' to the package name (see below).

* if your package is called libfoo1c102, then drop the ''c102'' from the package name (see below).

==== So what're we going to do? ====

We're going to rebuild all C++ packages with the gcc-3.4/4.0 ABI.

* If you have workarounds to build with a specific gcc version on certain architectures, these should be removed. Also if there are specific optimization settings that have been used to workaround compiler bugs, these should be removed, if possible.

==== If you maintain a library written in C++ ====
* Wait until all of your dependencies have been uploaded in ''c2'' versions, and rebuilt on all architectures.

* Tighten the build dependency on other -dev packages, build-depending on the transitioned library (dev) packages.

* If your package does not contain the ''c102'' suffix, add a ''c2'' to
   the end of the name of your .deb, eg libdb4.0++.deb
   -> libdb4.0++c2.deb. This is similar in spirit to the glibc
   transition adding g to the end of libraries.

* If your package already has a ''c102'' suffix, drop the suffix from
   the package name. (that works, because we don't support direct
   upgrades from woody to etch).

* Add a Conflict and a Replaces with the non-c2 version of the package (the previous version), i.e.

   {{{
        Package: libdb4.0++.deb
        Conflicts: libdb4.0++c102.deb
        Replaces: libdb4.0++c102.deb

        Package: libdb4.2++c2.deb
        Conflicts: libdb4.2++.deb
        Replaces: libdb4.2++.deb}}}

* Be sure to change  '''<code>debian/*.shlibs</code>'''  if it exists. If you are unsure about what to do, have a look at the <nowiki>[[http://www.debian.org/doc/debian-policy/ch-sharedlibs.html#s-sharedlibs-shlibdeps|Debian Documentation]]</nowiki>. Make sure you change the third and fourth component of each line, to reflect the correct 
** package name of the library
** version

* You should not add a ''c2'' to your -dev package.

* The exact placement of the ''c2'' can be tricky. It's
not terribly important; the important thing is that the new package conflicts with the old and has a different name. Stylistically, we prefer to keep the ''c2'' adjacent to the soname number, e.g. libqt3c2-mt-odbc, but if your package ends in a ++, put the ''c2'' after that.

* Add a Conflict with the non-''c2'' version of the package.

* Ensure that you're using g++-4.0 to build. You should have g++ (>= 4:4.0) installed on the system you build on (or build-essential (>= 11) ).

* Optionally, you may wish to add a note in your package description that this version of your library is for use with GCC 4.0.

==== If you maintain a library or a program written in C++ ====

* Wait until all your dependencies have been uploaded in ''c2'' versions, and rebuilt on all architectures.

* If your Depends: line isn't generated automatically, you'll need to change it too. But you should be using dpkg-shlibdeps anyway ;-)
    You should see a dependency on libstdc++6, if you see one on libstdc++5, something is wrong.

* Upload and rejoice!

* If your package contains no C++, do nothing more. You'll start building with the new gcc on your next upload.

You should not rename your package to remove the ''c2'' suffix until upstream changes their soname.

==== Why don't we just change the sonames? ====

Because upstream chooses the soname to match their API. If we change the soname then we render ourselves binary-incompatible with other distros and vendor-supplied binaries. This is important because the LSB3 intends to standardise the GCC 4.0 ABI; for Ubuntu/Debian to become binary-incompatible at this point would be the height of perversity.

Of course, when your upstream does bump the soname, you can drop the ''c2'' from the package name, just like very few libs still have a `g' on the end.

==== How about versioned symbols? ====

Versioned symbols don't even pretend to solve ABI transition problems. Not to mention there's the other-distro compatibility issue -- binaries compiled on Debian would not run on other distros.

==== Why don't we put the libs in a different directory? ====

Basically, it's too complex. For the glibc (.5  to .6) transition, we could do this because they used different dynamic linkers. For this transition, there is also little to gain in having full backwards compatibility to the old ABI. The only gain is that third party binary only applications that dynamically link to C++ using-libs (other than the stdc++ library itself) continue to work.

==== What about other architectures? ====

The rules outlined above should make the autobuilders build your packages with GCC 4.0.

'''TODO''' check for other incompatibilities for non-release architectures,

* i.e. sparc and hppa.

* I.e.: hppa libgcc1 (SJLJ) -> libgcc2 (Dwarf2) transition.

* I.e.: sparc ABI change from 3.3 to 3.4. The SPARC ABI changes should only relate to complex numbers or less used parts of the SPARC64 ABI.  Mathmatical packages probably should be NMU'd once glibc has been compiled with GCC 4.0 for SPARC.

==== Help! My package doesn't build with GCC 4.0 ====

First search for the error in your package, not in GCC. gcc-4.0 is more strict, and g++-4.0 is more strict to the C++ standard than g++-3.3, and as such, things not written in standard C++, but written in an "extended subset" of it, using gnu extension classes that are no longer supported. See http://gcc.gnu.org/gcc-3.4/changes.html#cplusplus and http://gcc.gnu.org/gcc-4.0/changes.html

If you find an internal compiler error (ICE), then submit a bug report. Please look at the error message that gcc emits: in most cases gcc asks for the preprocessed source file to be submitted together with the command line that was used to produce the file. Recompile the file using "-save-temps" and include the (compressed) .i or .ii file in the report.

If you want help with debugging, download the gcc-snapshot package and retry compiling your package with this gcc. Please see the README in the package how this works. In no case should a package built by   gcc-snapshot be uploaded to the archive.

'''TODO''' Update the gcc-snapshot package to HEAD once 4.0 is released.

If you really can't get your package fixed, you should change to build-depend on g++-3.4, and use it in the build process. If even g++-3.4 can't build your package, and your package depend on a library other than libstdc++, you're not likely to release with breezy/etch. We recommend you statically link to any C++ libraries which you use.

==== How do I know what ABI a given g++ is using? ====

The following command will show you the C++ ABI version being used by g++:

<code>g++ -E -dM - < /dev/null | awk '/GXX_ABI/ {print $3}'</code>

==== How do I know when all of my dependencies have  been uploaded on all architectures? ====

'''TODO''' Ubuntu equivalent ...

'''TODO''' update linda/lintian to discover packages (libgcc1/libgcc2, libstdc++5/libstdc++6)

The madison command on merkel (accessible for Debian developers), followed by the package name of your dependencies will show you the latest version, and which archs that version is built for. You should run linda or lintian over your package, as they have a check for multiple C++ libraries being linked to a single binary. If you get an error about more than one libstdc++ being linked, not all of your dependencies are updated yet.

==== Why not use GCC 3.4 as the default compiler? ====

Upstream did announce one more GCC 3.4.x release; with the availability of a newer released compiler version, the older branches usually get less attention. Because 3.4 and 4.0 are ABI compatible (at least on i386, amd64, powerpc and ia64), we can use GCC 3.4 as a fallback.
