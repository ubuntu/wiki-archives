{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__


== Configure Nvidia driver under Xen 3.0.2 on Ubuntu Dapper (6.0.6) ==
Xen virtualization is different from vmware or other virtualization by making operating system cooperate with hypervisor. It's the key to get near native performance. To get best out of Nvidia card, a lot of people use closed-source driver from Nvidia web site. However, it won't work if you run it under Xen. Because Nvidia driver runs in kernel mode and  the it need to be changed to conform the way Xen wants it to be. 
 
Right now there is no official support from Nvida for Xen. However, we could patch the driver to make it work by ourselves.

I have installed Xen on Ubuntu Dapper(6.0.6) and the shipped xserver-xorg Nvidia driver won't support my 2560x1600 30 inch apple monitor and have to use Nvidia's closed-source driver. And it doesn't work under Xen.

After some searching, compiling and loading, now I could open multiple terminal on my 2560x1600 screen. Here I share the information for everyone.

Before you prepare the driver, first download it from Nvidia's web site.
and use use 
<code>sh NVIDIA-Linux-x86-1.0-8762-pkg1.run -x</code>
to extract all the files to current directory. If you want to know what happed inside the package file, use <code>head -n 900 NVIDIA-Linux-x86-1.0-8762-pkg1.run >nvidia.sh</code> to dump the shell script to nvida.sh and read it.

There are 2 ways to do it. Hard way and easy way. 

First, let us play hard.

== Hard Way ==

1. Prepare Xen kernel source. Download Xen 3.0.2 from xen web site. The kernel source is 2.6.16-xen. then type <code>make world</code> to let Xen fetch and compile kernel source code for you. You will see a directory under Xen called 2.6.16-xen which is the kernel source directory which you will use to compile the Nvidia driver.

2. Patch Nvidia driver. Download the patch from here <nowiki>[[http://www.nvnews.net/vbulletin/showthread.php?t=68648]]</nowiki> to patch the Nvidia code.
<pre>
}}}

3. Compile Nvidia driver. There is a trick. Xen 2.6.16-xen is compiled using gcc-3.3 and it expect the Nvidia kernel module compiled with the same version. But the current Dapper default version is 4.0. When you fire the make command, you should do it like this:

<code>make CC=gcc-3.3 SYSSRC=/path/to/xen/kernel module</code>

4. Patch link table.
Somehow, several symbols missing for Nvida module, here is the script you could use( it is from forceld.sh ):
{{{
for sym in xen_tlb_flush force_evtchn_callback xen_features strncpy_from_user copy_to_user copy_from_user; do
export $sym=$(egrep " $sym\$" /boot/System.map-2.6.16-xen | colrm 9)
done
ld -m elf_i386 --defsym xen_tlb_flush=0x$xen_tlb_flush --defsym force_evtchn_callback=0x$force_evtchn_callback --defsym xen_features=0x$xen_features --defsym strncpy_from_user=0x$strncpy_from_user --defsym copy_to_user=0x$copy_to_user --defsym copy_from_user=0x$copy_from_user  -r -o nvidia.ko nvidia.o nvidia.mod.o
</pre>
5. Copy the generated nvidia.ko into /lib/modules/2.6.16-xen/kernel/driers/video/nvidia.ko.

== Easy way ==
Actually, the only critical thing you want is nvidia.mod.o. Nvidia give you a 5M object file to link with the wrapper object nvidia.mod.o. What You really need is just the 8972 bytes nvidia.mod.o. Here I give all lazy people a rest:

1. Download my forceld.sh and nvidia.mod.o and put them into the Nvidir-dir/usr/src/nv.

2. Run forceld.sh using <code>sh forceld.sh</code>.

3. Copy generated nvidia.ko into lib/modules/2.6.16-xen/kernel/driers/video/. 

That's it. 
<nowiki>[[attachment:forceld.sh]]</nowiki>
<nowiki>[[attachment:nvidia.mod.o]]</nowiki>
