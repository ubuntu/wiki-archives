{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work.
* A '''full compressed version''' of the wiki is available on archive.org
|}

__TOC__

The core of Ubuntu Online Accounts consists of a set of upstream project maintained at https://gitlab.com/groups/accounts-sso

The code is stored in git repositories, and because of a <nowiki>[[https://bugs.launchpad.net/bzr-git/+bug/878085|bug in Launchpad]]</nowiki> an automatic import of the repositories into the LP projects is not possible. In this page we'll explain how to manually perform the import (it's usually done at every upstream release, but it can be done more often if needed).

==== Dependencies ====

You'll need bzr-git:
<pre>
sudo apt-get install bzr-git
</pre>

==== Structure of the projects ====

Development happens in https://gitlab.com/groups/accounts-sso and is hosted in git. Code reviews happen there, using the tools provided by gitlab.com. In launchpad, for each upstream repository there are two bzr branches, both owned by the <nowiki>[[https://launchpad.net/~online-accounts|~online-accounts]]</nowiki> team:
* '''<code>upstream</code>''': this is a 1-1 mirror of the git <code>master</code> branch
* '''<code>trunk</code>''': this is the branch where packages are built from; it's made with the code from the <code>upstream</code> branch, plus the debian packaging. Changes land to this branch automatically, once approved with a code review; directly committing to this branch is forbidden.

Development of the Ubuntu-specific changes (typically packaging) can happen in a branch owned by the developer; we'll call this branch '''<code>packaging</code>''', but it could have any name. This branch is created by branching off the current bzr <code>trunk</code> and merging the latest bzr <code>upstream</code> into it; then, any needed packaging changes can be developed on it, and finally it's pushed for review. Once the review process is completed, the changes will be automatically merged into the <code>trunk</code> branch, and packages will be built and added to the archive.

==== Setting up the projects ====

We'll take <nowiki>[[https://gitlab.com/accounts-sso/signond|signond]]</nowiki> as example. The first thing to do, is to create a directory where to host the bzr branches for signond. For example:
<pre>
mkdir ~/src/bzr/signond
cd ~/src/bzr/signond
</pre>
Then, let's create a checkout of the git repository and of the bzr <code>upstream</code> branch which will track it, and set the <code>git</code> branch as parent:
<pre>
git clone git@gitlab.com:accounts-sso/signond.git git
bzr branch lp:~online-accounts/signon/upstream
cd upstream
bzr pull --remember ../git
cd ..
</pre>
Once this is done, we need to get the bzr <code>trunk</code> branch:
<pre>
bzr branch lp:signon trunk
</pre>

This is all what is needed for the initial setup. Let's see now how to merge changes from upstream.

==== Getting the latest upstream ====

We need to move inside the git repository and update it:
<pre>
cd ~/src/bzr/signond/git
git pull
</pre>
For this step, '''it's essential that the currently active branch in the git checkout is <code>master</code>'''; but unless you have switched to another branch yourself, this should always be the case.

Now let's update the bzr <code>upstream</code> branch:
<pre>
cd ../upstream
bzr pull
bzr push    # this should push to lp:~online-accounts/signon/upstream
</pre>

And make the packaging changes needed (at the very least, updating the debian/changelog):
<pre>
cd ../trunk
bzr pull
cd ..
rm -rf packaging
bzr branch trunk packaging
cd packaging

bzr merge ../upstream

...
dch -i

bzr commit
bzr push lp:~<your-lp-id>/signon/packaging
</pre>

After all of this, your final branch with the latest upstream code and updated packaging will be found at <code>lp:~<your-lp-id>/signon/packaging</code>. It's time to create a merge proposal and get it merged into bzr <code>trunk</code>.
