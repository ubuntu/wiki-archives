{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work.
* A '''full compressed version''' of the wiki is available on archive.org
|}

__TOC__


=== Introduction ===
The SecurityTeam is sometimes asked to perform source code auditing, typically during the MainInclusionProcess. Due to time constraints, only a high-level audit is performed for Main Inclusion Reports (MIRs).

While every effort is made to perform the audit within a timely fashion, please remember fixing vulnerabilities and proactive security development are the primary focus of the SecurityTeam.

<nowiki>[[https://bugs.edge.launchpad.net/~ubuntu-security/+assignedbugs|List of bugs waiting for audit]]</nowiki>.

<nowiki>[[https://bugs.launchpad.net/ubuntu/+bugs?field.searchtext=&orderby=-importance&search=Search&field.status%3Alist=NEW&field.status%3Alist=INCOMPLETE_WITH_RESPONSE&field.status%3Alist=INCOMPLETE_WITHOUT_RESPONSE&field.status%3Alist=CONFIRMED&field.status%3Alist=TRIAGED&field.status%3Alist=INPROGRESS&field.status%3Alist=FIXCOMMITTED&field.subscriber=ubuntu-mir|List of all MIR bugs]]</nowiki>.

=== MIR Process ===
# When a source package needs an audit from the SecurityTeam, the bug is assigned to <code>ubuntu-security</code> with a comment asking for the package to be reviewed.
# A member of the SecurityTeam will change the bug status to 'In Progress'. In addition, they will also create an appropriate issue in the private <nowiki>[[https://warthogs.atlassian.net/jira/software/c/projects/SEC/boards/594 | Security Team/MIR JIRA board]]</nowiki> (if one does not already exist), with MIR component (and other if needed, according to the board), and ensure members from the team that requested the MIR are added as watchers to the issue, move this to the In Progress status and comment on the issue that they will be handling it.
# When completed, the SecurityTeam member will unassign <code>ubuntu-security</code>, and add a comment as to the results of the audit. An appropriate comment should also be made on the JIRA issue and the issue should be moved to the DONE queue.

If the bug requires more information, the SecurityTeam member should mark the bug status as 'Incomplete', without changing who the bug is assigned to.

=== Doing the MIR ===

==== High-level overview ====

* Once: clone https://launchpad.net/ubuntu-security-tools
* Once: set up <nowiki>[[SecurityTeam-BuildEnvironment]]</nowiki>
* Once: set up the <nowiki>[[https://wiki.canonical.com/InformationInfrastructure/IS/HowTo/CompanyOpenVPN?action=show&redirect=InformationInfrastructure%2FIS%2FVPN | Canonical VPN]]</nowiki> (if you're going to use Coverity results)
* Once: get Coverity credentials (Currently from AlexM.)
* Once: <nowiki>[[https://wiki.canonical.com/UbuntuEngineering/Security/Coverity|install Coverity tools locally]]</nowiki>

* select a package from the <nowiki>[[ https:--warthogs.atlassian.net-jira-software-c-projects-SEC-boards-594 | JIRA board]]</nowiki>. The <nowiki>[[ https:--trello.com-b-EGj5Msfo-security-mir-backlog | Trello board]]</nowiki> can have some old historical data if needed.
* read the MIR bug for the package in question to get context
* if the package still makes sense to audit, assign the JIRA issue to yourself and move it to In Progress
* <code>uaudit <package name></code> -- finish reading email
* inspect the files in the <code>audits</code> directory
* use <code>vim -q</code> (or equivalent) on the language-specific files in <code>audits</code>; read much of the code
* post Coverity results to the bug, upstream bug trackers
* inspect Coverity results
* determine severity of issues discovered while reviewing code
* contact upstream developers with issues, privately if justified
* decide if the code appears to be written with discipline
* decide if the code appears to be testable
* decide if the code appears to represent sufficient value for users versus maintenance costs
* identify any changes that might reduce risks to more palatable levels
* write up a report using the template to communicate the status of the package
* post the report to the bug
* subscribe yourself to the bug
* unassign the security team from the bug
* move the JIRA issue from In Progress to DONE

==== Details ====
Most of the process is driven by the <code>uaudit</code> script from https://launchpad.net/ubuntu-security-tools

<code>$UST/audits/uaudit</code> expects a lot of tools to be in your <code>PATH</code>:

<pre>
    exes = [
        'umt',
        'audit-binaries.sh',
        'audit-code.sh',
        'audit-docs.sh',
        'audit-log.sh',
        'audit-packaging.sh',
        'bandit',
        'hardening-check',
        'check-source-package',
        'debuild',
        'diffstat',
        'fakeroot',
        'licensecheck',
        'lintian',
        'suspicious-source',
        'ctags',
        'cppcheck',
        'shellcheck',
        'shellcheck.sh',
    ]
</pre>

Many of these are in our repos, I set up symlinks in my <code>~/bin/</code> directory
for the ones not already on my <code>PATH</code>.

<code>uaudit</code> will use <code>umt</code> to download the sources, rebuild the package, and run the
different tools on the results.

If the Coverity analysis tools are available in <code>PATH</code> <code>uaudit</code> will also try and
use these to perform additional analysis (this also requires the associated <code>license.dat</code>).

I start in <code>~/ubuntu/security/audits/</code> and run <code>uaudit <source package name></code> and
eventually there will be:

<pre>
sarnold@hunt:~/ubuntu/security/audits/libfprint/cosmic$ ls -l
total 588
drwxrwxr-x 2 sarnold sarnold   4096 Jul  5 18:32 audits
drwxrwxr-x 4 sarnold sarnold   4096 Jun 27 18:15 binary
drwxrwxr-x 8 sarnold sarnold   4096 Jun 15 20:29 libfprint-0.7.0
-rw-r--r-- 1 sarnold sarnold   7944 Jun 15 20:22 libfprint_0.7.0-1.debian.tar.xz
-rw-r--r-- 1 sarnold sarnold   1239 Jun 15 20:22 libfprint_0.7.0-1.dsc
-rw-r--r-- 1 sarnold sarnold   1728 Jun 15 20:22 libfprint_0.7.0-1_source.build
-rw-r--r-- 1 sarnold sarnold   6289 Jun 15 20:22 libfprint_0.7.0-1_source.buildinfo
-rw-r--r-- 1 sarnold sarnold   2396 Jun 15 20:22 libfprint_0.7.0-1_source.changes
-rw-r--r-- 1 sarnold sarnold 550484 May 17  2017 libfprint_0.7.0.orig.tar.xz
drwxrwxr-x 2 sarnold sarnold   4096 Jun 15 20:26 source
</pre>

Almost all the work takes place in <code>audits/</code> and <code>libfprint-0.7.0/</code>.

<code>audits/WORKFLOW.md</code> contains the general 'plan' of audit. Focus on the top half,
leave everything below <code>https://wiki.ubuntu.com/MIRTeam</code> for the rest of the MirTeam.

<pre>
sarnold@hunt:~/ubuntu/security/audits/libfprint/cosmic/audits$ ls -l
total 1684
-rw------- 1 sarnold sarnold  xxxxx Jun 15 20:26 bandit.txt
-rw------- 1 sarnold sarnold    995 Jun 15 20:24 binaries.txt
-rw-rw-r-- 1 sarnold sarnold   6004 Jun 27 19:48 BUG.md
-rw------- 1 sarnold sarnold  79565 Jun 15 20:24 code-c-noextfilter.txt
-rw------- 1 sarnold sarnold  50475 Jun 15 20:24 code-c.txt
-rw------- 1 sarnold sarnold  52968 Jun 15 20:24 code-java-noextfilter.txt
-rw------- 1 sarnold sarnold    462 Jun 15 20:24 code-java.txt
-rw------- 1 sarnold sarnold 317066 Jun 15 20:24 code-perl-noextfilter.txt
-rw------- 1 sarnold sarnold    436 Jun 15 20:24 code-perl.txt
-rw------- 1 sarnold sarnold 239290 Jun 15 20:24 code-php-noextfilter.txt
-rw------- 1 sarnold sarnold    459 Jun 15 20:24 code-php.txt
-rw------- 1 sarnold sarnold  54866 Jun 15 20:24 code-python-noextfilter.txt
-rw------- 1 sarnold sarnold    468 Jun 15 20:24 code-python.txt
-rw------- 1 sarnold sarnold  xxxxx Jun 15 20:26 coverity.txt
-rw------- 1 sarnold sarnold   1119 Jun 15 20:24 cppcheck.txt
-rw------- 1 sarnold sarnold   9208 Jun 15 20:26 csp-source.txt
-rw------- 1 sarnold sarnold    278 Jun 15 20:25 docs.txt
-rw-rw-r-- 1 sarnold sarnold  xxxxx Jun 15 xx:xx libfprintd-xxxx.build  
-rw-rw-r-- 1 sarnold sarnold    xxx Jun 15 xx:xx log.txt
-rw------- 1 sarnold sarnold  10323 Jun 15 20:26 packaging.txt
-rw-rw-r-- 1 sarnold sarnold   8507 Jun 15 20:22 WORKFLOW.md
-rw------- 1 sarnold sarnold 325486 Jun 15 20:25 shellcheck.txt
-rw-rw-r-- 1 sarnold sarnold 481474 Jun 15 20:26 tags
</pre>

I write my notes as I go in <code>WORKFLOW.md</code>, with the intention of having it as a starting point
for <code>BUG.md</code> and pasting the latter into the bugreport once I'm done. The <code>binaries.txt</code> shows the
<code>hardening-check</code> output, and we mostly expect *all* hardening to be applied
to everything these days. <code>code-*</code> files are generated by language-specific
<code>grep</code> patterns. <code>cppcheck.txt</code> is from <code>cppcheck</code> output, <code>shellcheck.txt</code> is from
<code>shellcheck</code>, <code>tags</code> is from exuberant-ctags, <code>csp-source.txt</code> outputs a bunch of Debian
packaging information (usually most useful for showing the <code>lintian</code>
errors), <code>docs.txt</code> shows READMEs and similar in the tree, and <code>packaging.txt</code>
includes some of the output of the commands listed in the <code>WORKFLOW.md</code> file
on the binary packages (found in the <code>binary/</code> directory earlier).

When the Coverity analysis tools are available, an additional <code>coverity.txt</code> file is
generated which lists the Coverity defects identified during the build.

The full build log is in a <code>*.build</code> file named after the source package. The
<code>log.txt</code> is the output grepped for errors and warnings.

I skim <code>docs</code>, skim <code>csp-source</code>, skim the build logs, read <code>binaries</code>, and
then use the language-specific files for most everything else.

vim's quickfix support is *fantastic* for this. 
<pre>
vim -q ../audits/code-c.txt
vim -q ../audits/cppcheck.txt
</pre>

Then you can use <code>^N</code> and <code>^P</code> to jump through the list of "errors" and read
the surrounding code. (I also like to use <code>:set so=99</code> in vim, to keep the
cursor in the center of the terminal when it can.)

For <code>cppcheck</code> output I have this in my <code>~/.vimrc</code>:

<pre>
set errorformat+=[%f:%l]\ ->\ %m,[%f:%l]:%m
</pre>

If you use emacs, file-local-variables are set in each appropriate <code>.txt</code>
file to allow quick navigation to the associated source code via <code>M-g M-n</code> and
<code>M-g M-p</code> for each next / previous error identified.

Around each line, look for error handling, input hygiene, etc.

There's a wide variety of how much time you can spend on this. For
codebases that "feel" good I might actually look at each line for one
or two seconds at most and look for "did they handle errors". Sometimes
I'll spend a *long* time tracking up and down call sites to see if inputs
come from untrusted sources or not, if they get filtered or sanitized
or something similar elsewhere, etc.

<code>ctags</code> and <code>cscope</code> are really helpful for C and C++. <code>ctags</code> is nice for others.

Sometimes the <code>code-*.txt</code> files will be thousands of entries. You can't
read them all. I tend to read the first fifty or hundred of each "type" of
report and then start skipping.

If there's an extensive test suite that hits these greps, I'll usually
<code>grep -v</code> the tests from the <code>code-*.txt</code> files I'm working with, to make it
easier to focus on the "real" code. Test suites are sloppy.

Hopefully as you read you'll get a good feeling for the overall design of
a project, whether or not the authors were writing with discipline or just
fast and loose, etc.

Some higher-level things that are hard to spot in a snapshot of source
code is overall project velocity. DPDK, nodejs, etc., move SO FAST that
it's really difficult to backport fixes even six months. Bash, bc, awk,
etc. move so slow that fixes can be backported decades without trouble.
Sometimes it's difficult to guess the benefit / cost ratio.

In one MIR, I hated the *idea* of the package and didn't
review it. I talked about it with the stakeholders and
decided that we didn't need to support it. In another, I suggested replacement
packages, but none met the needs of the requesting team, so we carried on
with the audit. Ubuntu is an opinionated distribution: if something doesn't
feel right, we can work with everyone else to find the right path forward.

Once I'm done reading the sources I usually have a good feeling if the
package belongs in the distribution or not. I'll go through the <code>WORKFLOW.md</code>
and answer questions, and make notes of oddities found in the packaging
that need to be fixed first.

We can make requests for changes. Sometimes I'll feel strongly enough
to require the changes and without the ACK completely until it's done,
sometimes it's enough to just make the request and follow up later.
(I can't recall any specific cases of problems.)

Sometimes we'll ask the requesting team to put in writing that they'll
help us prepare fixes or test new packages etc.

I like to be clear with "security team ACK for promoting ... to main" or
"security team NAK for promoting ... to main". Not all bug readers know
the whole process, so I like to be clear that I'm only speaking for the
security team, not the final result.

Once I'm done, I unassign the bug from Ubuntu Security Team, subscribe
to all emails about the bug, and paste the <code>BUG.md</code> contents into
the bug report.

Feel free to ask Seth Arnold (sarnold) any questions.

----
CategoryProcess
