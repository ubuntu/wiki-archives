{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__


=== Branch History Injection Microarchitectural flaws [CVE-2022-0001 (Intel), CVE-2022-0002 (Intel), CVE-2022-23960 (ARM)] ===

It was
<nowiki>[[ https:--www.vusec.net-projects-bhi-spectre-bhb- | discovered]]</nowiki>
that certain processor internals can be manipulated by
unprivileged user processes such that indirect calls in kernel space
speculatively execute 'gadgets' that will disclose private information.

So far, such attacks have only been demonstrated to be feasible with
eBPF, such that Intel recommends disabling unprivileged eBPF and keep
running with eIBRS. There is no need to reboot in order to disable
unprivileged eBPF; re-enabling eBPF will require a reboot for 5.11
kernels and earlier.

Processors that use retpoline by default (because they do not
support eIBRS) have not been shown to be vulnerable to this attack.

As other potential attacks may be possible in the future, the use of
retpoline is one of the possible mitigations. However, its use alone on
some processors that supported eIBRS is not recommended because those
processors may use other predictors when the RSB is empty. So, a patch
has been added that allows users to use eIBRS + retpoline, by booting
with the command line option <code>spectre_v2=eibrs+retpoline</code>. As retpoline
has a performance impact, this was not made the default, so users who
are concerned about potential attacks should reboot with this option.

Setting kernel command line options can be performed by editing
<code>/etc/default/grub</code>, setting <code>GRUB_CMDLINE_LINUX_DEFAULT</code> as
appropriate, and running <code>update-grub</code> afterwards.

Ubuntu is releasing updated kernels that disable unprivileged eBPF
by default to address these and other security issues. Admins can
re-enable if needed it via:

<pre>
$ sudo sysctl kernel.unprivileged_bpf_disabled=0
</pre>

Admins can disable unprivileged eBPF until the next boot via:

<pre>
$ sudo sysctl kernel.unprivileged_bpf_disabled=1
</pre>

Admins can disable it, but allow it to be re-enabled by an admin without
rebooting, via:

<pre>
$ sudo sysctl kernel.unprivileged_bpf_disabled=2
</pre>

To see the current status of unprivileged eBPF, do:

<pre>
$ sysctl kernel.unprivileged_bpf_disabled
</pre>

A result value of '''1''' or '''2''' indicates that unprivileged eBPF is
disabled. When unprivileged eBPF is disabled, a process must have <code>CAP_SYS_ADMIN</code>
(on Ubuntu 5.4.x and older kernels) or at least one of <code>CAP_SYS_ADMIN</code> and
<code>CAP_BPF</code> (on Ubuntu 5.15.x and newer kernels)
capability in order to call the <code>bpf(2)</code> systemcall.

Unprivileged eBPF has been disabled by default, but could be re-enabled
by an admin via sysctl, in Ubuntu since the introduction of 5.13 and
newer kernels in Ubuntu 21.10 and Ubuntu 20.04.4 LTS hardware
enablement (HWE) kernels. Support for disabling unprivileged eBPF with
the possibility of re-enabling without a reboot has been backported
to the 5.4, 4.15, and 4.4 kernels as well as made the default setting
as of 2022-03-08.

===== References =====

* VUSec advisory with link to research paper:
   https://www.vusec.net/projects/bhi-spectre-bhb/
* Intel advisory:
   https://intel.com/content/www/us/en/security-center/advisory/intel-sa-00598.html
* Intel guidance
   https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/technical-documentation/branch-history-injection.html
* Intel blog post:
   https://community.intel.com/t5/Blogs/Products-and-Solutions/Security/Chips-Salsa-Episode-12-March-2022-Security-Advisories/post/1365250
* ARM advisory:
   https://developer.arm.com/support/arm-security-updates/speculative-processor-vulnerability/spectre-bhb
* ARM whitepaper (linked from advisory):
   https://developer.arm.com/-/media/Arm%20Developer%20Community/PDF/Security%20Update%2008%20March%202022/Spectre-BHB%20White%20Paper%20v1.6.pdf
* ARM knowledge base article:
   https://developer.arm.com/documentation/ka004995/latest/
* Linux kernel <code>unprivileged_bpf_disabled</code> sysctl configuration documentation:
   https://www.kernel.org/doc/html/latest/admin-guide/sysctl/kernel.html#unprivileged-bpf-disabled
* Linux kernel <code>spectre_v2</code> boot paramater documentation:
   https://docs.kernel.org/admin-guide/kernel-parameters.html

===== Updates =====

Ubuntu users are recommended to update to the latest kernel. The
majority of users should ensure that the following kernel packages are
installed:

{| class="wikitable"
|-
| '''Ubuntu Release'''
| '''Base Kernel'''
| '''Hardware Enablement (HWE) Kernel'''
|-
| 21.10
| <nowiki>[[ https:--launchpad.net-ubuntu-+source-linux-5.13.0-35.40 | linux-image-5.13.0-35-generic 5.13.0-35.40 ]]</nowiki>
| N/A
|-
| 20.04 LTS
| <nowiki>[[ https:--launchpad.net-ubuntu-+source-linux-5.4.0-104.118 | linux-image-5.4.0-104-generic 5.4.0-104.118 ]]</nowiki>
| <nowiki>[[ https:--launchpad.net-ubuntu-+source-linux-hwe-5.13-5.13.0-35.40~20.04.1 | linux-image-5.13.0-35-generic 5.13.0-35.40~20.04.1 ]]</nowiki>
|-
| 18.04 LTS
| <nowiki>[[ https:--launchpad.net-ubuntu-+source-linux-4.15.0-171.180 | linux-image-4.15.0-171-generic 4.15.0-171.180 ]]</nowiki>
| <nowiki>[[ https:--launchpad.net-ubuntu-+source-linux-hwe-5.4-5.4.0-104.118~18.04.1 | linux-image-5.4.0-104-generic 5.4.0-104.118~18.04.1 ]]</nowiki>
|-
| 16.04 ESM
| <code>linux-image-4.4.0-221-generic</code> 4.4.0-221.254
| <code>linux-image-4.15.0-171-generic</code> 4.15.0-171.180~16.04.1
|-
| 14.04 ESM
| Not affected - 3.13 kernel does not support unprivileged eBPF
| <code>linux-image-4.4.0-221-generic</code> 4.4.0-221.254~14.04.1
|}

Kernels derived from the above (e.g. cloud specific kernels) are also receiving the corresponding updates.

===== Timeline =====
* 2022 Mar 08: VUsec makes their findings public
* 2022 Mar 08: Ubuntu publishes the following USNs:
** <nowiki>[[ https:--ubuntu.com-security-notices-USN-5317-1 | USN 5317-1 ]]</nowiki> for 5.13 and 5.14 based kernels / Ubuntu 20.04, Ubuntu 21.10
** <nowiki>[[ https:--ubuntu.com-security-notices-USN-5318-1 | USN 5318-1 ]]</nowiki> for 5.4 based kernels / Ubuntu 20.04 LTS, Ubuntu 18.04 LTS
** <nowiki>[[ https:--ubuntu.com-security-notices-USN-5319-1 | USN 5319-1 ]]</nowiki> for 4.15 and 4.4 based kernels / Ubuntu 18.04 LTS, Ubuntu 16.04 ESM, Ubuntu 14.04 ESM
* 2022 Mar 09: Updated Ubuntu cloud images became available

===== Public Cloud Image updates =====
* Amazon AWS: 20220308 or newer
* Windows Azure: 20220308 or newer
* Google Compute Engine: 20220308 or newer
* Ubuntu Core Images: 20220308 or newer

Cloud Images dailies will start appearing within 4 hours of the USN announcement. At the direction of the security team, the Cloud Image Team will start manually releasing new images to the public cloud. 
