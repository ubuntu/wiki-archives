{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work.
* A '''full compressed version''' of the wiki is available on archive.org
|}

__TOC__

In bug 1001584, Guilhem Lettron suggested creating a small package to make setup of hugepages for libvirt easy.  At the UDS-R libvirt session it was agreed to go forward with this for 13.04.

Now thinking about it a bit, it seems a new package isn't needed.  All we need is:

1. a small tool to set the values in sysctl for vm.nr_hugepages and vm.nr_overcommit_hugepages (by default to 1/4 of available memory, each, so long as at least 1G is available - does that seem reasonable?).  Or, just documentation (in the server guide) on how to do it.  It comes down to two lines in /etc/sysctl.d/60-hugepages if done by hand.

2. an addition to the pre-start section in /etc/init/qemu-kvm.conf which looks like:

	if [ -x /usr/bin/hugeadm -a $KVM_MOUNT_HUGEPAGES -eq 1 ]; then
		hugeadm --create-group-mounts kvm
	fi

qemu-kvm should also suggest the hugepages package.  This is all that's needed for users in group kvm to be able to use hugepages using kvm by hand, by using

	kvm -mem-path /var/lib/hugetlbfs/group/kvm/pagesize-2097152 ...

That is a rather ugly path to have to type in though.

3. for libvirt, we need give read-write perms to the mount created by step (2) (on x86-64 it'll be /var/lib/hugetlbfs/group/kvm/pagesize-2097152) in /etc/apparmor.d/abstractions/libvirt-qemu.  So long as that path has been mounted we don't likely care about giving the read-write permissions to the VMs (as that is their point), but the problem is that with different huge page sizes the path could differ.

Then, any vms which should use hugepages need

	<memoryBacking><hugepages/></memoryBacking>

added to their xml.  Perhaps this should become a ticky-box in virt-manager, so long as hugepages is installed and set up.

Both 2 and 3 could be made easier by not using hugeadm and instead creating our own kvm-group-owned hugepages path.  Perhaps /run/virt/hugepages?
