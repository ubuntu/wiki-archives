{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__



== Three tasks involved ==

# Handling of hardware events
# Power state switching
# Letting disks idle (buffering disk writes, aka laptop-mode)

Though power management will deal with these, the objectives of the tasks do not solely lie in power management. It may be adviseable to rely on tools specialized for their tasks, instead of implementing an incomplete power management utility.

== Planned work for Lucid ==

* '''Launchpad Entry''': UbuntuSpec:desktop-lucid-powermanagement-tweaks
* '''Created''': 
* '''Contributors''': 
* '''Packages affected''':
* '''Related''': http://lesswatts.org

=== Handling hardware events ===

The <code>acpi-support</code> package should be deprecated; however, new homes need to be found for its current contents.

power-related things to clean up:
* <code>/etc/acpi/start.d</code>: these are currently launched by the init script, which has no equivalent in other packages currently
** 10-save-dmidecode: superseded by /sys interfaces
** 60-asus-wireless-led: should be moved to the kernel (cf. https://bugs.edge.launchpad.net/bugs/22795)
** 90-hdparm.sh: init script in pm-utils?  udev rule on each HD would be preferred (/lib/udev/hdparm already exists)
* <code>/etc/acpi/events/</code>: mostly keypress handling, most of which is ''probably'' obsolete and should be dropped, but verification needed.  Some keypress handling is not obsolete, and needs replacement handling implemented via hal or devicekit (e.g., <code>/etc/acpi/events/asus-touchpad</code>; <code>/etc/acpi/events/ibm-wireless</code>).  And some events are not keypress events at all and need to be handled by <code>hald-addon-acpi</code> or a devicekit-based replacement. 

=== DeviceKit-power quirks ===

Previously, hal had a suspend/resume quirks database that was used to construct a correct commandline for <code>pm-suspend</code>.  devicekit-power doesn't have this; it needs to be implemented.

== Power management packages ==

Foremost there is the '''apm and acpi support in the linux kernel'''.

They make those kind of "hard" events like the end of battery power or the pressing of the suspend or other (laptop) buttons available to our software world.

Then there are '''event manager daemons apmd and acpid'''

They provide means to execute commands on these external events. They run the scripts they find in their config directory tree under /etc/acpi, or /etc/apm respectively.

The package '''acpi-support''' provides a set of such scripts under /etc/acpi that deal with handling special acpi buttons on laptops.

The package '''pm-utils''' provides the pm-action, pm-hibernate, pm-suspend and pm-suspend-hybrid commands. They allow to trigger hard power management events by software. The pm-tools also provide script directories to hook-in other software when switching power (saving) states. 

The '''gnome-power-manager''' is a program with a graphical user interface that subscribes itself to power events and acts on them. It shows you the battery status on laptops and dims down the screen if on battery for example. It will also shutdown or hibernate the computer after some idle time or before the battery runs out, if a user is logged in.

'''Disk idling'''
 
A separate task is allowing harddisks to idle, so they can be parked and spun-down for long enough periods of time.  This is done by a package that is a little bit misleadingly called '''laptop-mode-tools''' but not "disk-idle". Disk idling has to deal with things like reading ahead and postponing disk activity. The program got its name from a kernel feature that is called laptop_mode and allows Linux to chunk up writes to filesystems and not write in between. But to really let a disk idle one has to manage other parts of the system that are relevant to letting disks idle also, like drive parameters, mount options, filesystem settings, cache sizes, sync logging programs etc. "laptop_mode" will do all that.

Disk idling is commonly needed, thus laptop-mode enabled, when laptops operate on batteries to extend the battery times. But for example in vehicles with external power supply disk idling may be needed even on AC. Not necessarily to leave the disk spun down, but to leave the heads parked for shock protection.

Disk spin-down and head parking should not be activated without controlled disk idling. The regular uncoordinated logging or journaling activity may spin up the disks back up almost immediately after spinning down and lead to excessive load cycling.

== Power (saving) states ==

The Common power (saving) states are awake, standby, suspend and hibernate.

During the '''awake''' state all components of the computer are running.

During '''standby''' the CPU keeps running your programs but some components like the monitor and harddisks may be turned off. When you touch the mouse or keyboard or a harddisk is accessed by software they quickly wake up again.

In both the awake and the standby state the speed of modern CPUs may be throttled down,though. For example if not in use.

During '''suspend''' however the CPU is always stopped. In modern PCs even all other components except the RAM memory can be turned off. The RAM will hold the state.

During '''hibernation''' the state is written to harddisk and the whole computer is turned off.

== Architecture ==

This diagram shows how the kernel, hal, hal-info, pm-utils, and gnome-power-manager are plumbed together:

  <nowiki>[[File:power-management.png]]</nowiki>

(<nowiki>[[attachment:power-management.dot|dot source]]</nowiki>)

Please see <nowiki>[[Hotkeys-Architecture]]</nowiki> about the details of "Hotkey handling".

== How to get disks to spin down and idle correctly (without excessive load cycling) ==

=== 10.04 ===

The laptop-mode-tools (disk idleing) package does not get installed by default any more, but just installing it should make disk idleing work (on battery) right away now.

=== 8.10 to 9.10 ===

Many of the previous issues have been addressed. All you need to do is:
* "ENABLE_LAPTOP_MODE=true" in /etc/default/acpi-support (Bugs Bug:244838 Bug:497738)

=== 8.04 (Hardy) ===

Unfortunately, ubuntu has mangled disk idling into event handling and power state switching in the past. And this did not deliver idle disks but break disk idling (laptop-mode) features by leaving undefined (factory default) apm settings in place.

To correct disk-idling in Ubuntu Hardy you need to adjust the following:

* Enable CONTROL_HD_POWERMGMT=1 in /etc/laptop-mode/laptop-mode.conf
  (Bug Bug:244832 missing hdparm -B setting during boot (fixed in intrepid Bug:250935))

* ENABLE_LAPTOP_MODE=true in /etc/default/acpi-support (another package's conffile), even if you do not ENABLE_LAPTOP_MODE_ON_BATTERY or _ON_AC in laptop-mode.conf. So that laptop-mode-tools can control the harddisk power management settings.
  (Bug:244838 laptop-mode needs to be activated in two places)

* Delete or #comment the four $HDPARM blocks (for...done) in /etc/acpi/power.sh and change the two $LAPTOP_MODE start/stop lines to "$LAPTOP_MODE auto"
  (Bug:244836 /etc/acpi/power.sh overrides user settings (fixed in intrepid Bug:250938))<<BR>>
  (Bug:244831 /etc/acpi/power.sh overrides user scripts (fixed in intrepid Bug:250938))<<BR>>
  (Bug:244844 Adapt laptop-mode-tools invocation to ubuntu's acpi-support / pm-utils packages (fixed in intrepid Bug:250935))

* Create an empty "laptop-tools" file (touch /etc/pm/power.d/laptop-tools) to override /usr/lib/pm-utils/power.d/laptop-tools.
  (Bug:239419 pm-utils has laptop-tools script which conflicts with laptop-mode-tools (not so in intrepid))

With the above changes hardy (ubuntu 8.04) will set the hdparm -B value to 254 when booting and thus override inadequately aggressive hardware defaults that cause load cycling. Not all harddisks will stop head parking with value 255 and some may even overheat. (hdparm -B255  turns off the disk's apm feature, but this only turns off the spin down timer in many disks and doesn't increase the head parking timer at all, which is the issue here.)

Other issues/adjustuments are related to have the hdparm -B value also reset after a suspend/resume cycle (fixed in intrepid Bug:250935).
  Bug:244833 missing hdparm -B setting during resume<<BR>>
  Bug:244839 /etc/acpi/start.d and resume.d scripts are not run.<<BR>>
  Bug:244844 Adapt laptop-mode-tools invocation to ubuntu's acpi-support / pm-tools packages
  also:<<BR>>
  Bug:238555 pm-utils doesn't reload hdparm.conf after a suspend

== Comments ==

Can someone maybe elaborate in the wiki why it's not enabled by default? Without an explanation i'm wondering why, and if there maybe are good arguments against doing so.
----
I searched around and it seems I am not the only one with this problem and unfortunately, I could not find a good answer in the forums. Consequently, could someone explain in a little more detail how one would go about creating "a bogus /etc/pm/power.d/laptop-tools script to override /usr/lib/pm-utils/power.d/laptop-tools." Does it entail just making a new file the in the directory or is there actual code that has to go in the file. Thanks - Ali
* Ali, just copy /usr/lib/pm-utils/power.d/laptop-tools to /etc/pm/power.d/laptop-tools and insert the code near line 26 following guidelines in Bug:239419
** Actually, to disabe this yet another "laptop-tools" script from pm-utils you just need to create an empty file (touch /etc/pm/power.d/laptop-tools). (Info also added above)

----
The issues described here are pointed out in the interesting bug Bug:59695: "High frequency of load/unload cycles on some hard disks may shorten lifetime"

----
It would be helpful to have clear guidance on what changes should be made to a 7.10 (Gutsy) system.  I expect the alarming click I hear periodically, especially on an idle system, is an the head reset being discussed.
* Gutsy will lose support at the end of April so I don't think there is a point in adding that.
----

<nowiki>[[http://en.opensuse.org/Disk_Power_Management|This opensuse wiki page]]</nowiki> might be useful for creating a proper solution for pm-utils - -- AzraelNightwalker 
<nowiki>[[http://ubuntuforums.org/showthread.php?p=5564900|This page]]</nowiki> shows a simple script that successfully activates laptop-mode after resuming from suspend in Hardy. --AbtZ
