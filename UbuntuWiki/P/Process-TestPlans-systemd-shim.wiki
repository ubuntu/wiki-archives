{|
  | '''Warning'''
  * This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
  * '''Images''' and '''attachments''' have been removed to conserve space.
  * '''Links''' may not work and there may be formatting issues.
  * A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__


* '''Test plan for component''': systemd-shim
* '''Component Checklist''': 
* '''Trunk URL''': https://github.com/hallyn/systemd-shim.git
* '''Ubuntu Package URL (LP)''': lp:ubuntu/systemd-shim
* '''See Also''': https://wiki.ubuntu.com/Process/TestPlans/upstart
 
=== Dependents/Clients ===

=== Overview ===

Due to the following two bugs, Upstart session jobs which specify the "`cgroup`" stanza could fail. The main user of this stanza is the <nowiki>[[https://launchpad.net/ubuntu-app-launch|ubuntu-app-launch]]</nowiki> (UAL) facility which is used to start most application on Touch devices:

* `upstart` bug Bug:1357252.
* `systemd-shim` bug Bug:1355966.

=== Test Description ===

The following test plan checks to ensure expected behaviour when a job that specifies the "`cgroup`" stanza is run. It does this by creating an upstart job that specifies the `cgroup` stanza and runs that job a large number of times.

Testing for the absence of a race is difficult so ideally the "`test-cgroup`" job would be run as many times as possible to maximise the likelihood of hitting the timing window.

==== Expected Behaviour on a current Touch system ====

The test plan will probably fail after running "`/sbin/start test-cgroup`" less than 100 times (in other words it is easy to force the race).

However, please test on a device to see how often the problem occurs on your particular device. The outcome will give an indication as to how many iterations the test should be repeated for on a system with the latest versions of "`upstart`", "`systemd-shim`" and "`cgmanager`".

=== Test Plan ===

==== To check that cgroup support is working reliably with Upstart ====

* Ensure upstart version `1.13.2~rtm-0ubuntu1` (or newer) is installed.
* Ensure `systemd-shim` version `8` (or newer) is installed.
* Ensure `cgmanager` version `0.32-1` (or newer) is installed.
* Force a logrotate:
   <pre>
### logrotate --force /etc/logrotate.conf
   </pre>
* Truncate the xsession log file:
   <pre>
     echo > ~/.xsession-errors
   </pre>
* Create a simple upstart job that uses the "`cgroup`" stanza by creating file "`~phablet/.config/upstart/test-cgroup.conf`" containing:
   <pre>
     cgroup freezer

     exec cat /proc/self/cgroup
   </pre>
* Run the job multiple times in quick succession:
   <pre>
     su - phablet
     for i in `seq 1027`; do /sbin/start test-cgroup; done
   </pre>
* Ensure you do not get any output from "`/sbin/start`" stating, "`start: Job failed to start`"
* Ensure the xsession log file does not contain any messages like this:
   <pre>
     init: Failed to spawn cgroup-test pre-start process: unable to enter cgroup: Unknown error 196609
   </pre>
* Ensure that "`/var/log/upstart/cgmanager.log`" does not contain any errors like the following two types:
** "May not create" errors
   <pre>
    cgmanager:do_create_main: pid XXXX (uid 32011 gid 32011) may not create under /run/cgmanager/fs/freezer
   </pre>
** "Invalid path" errors
   <pre>
    cgmanager:per_ctrl_move_pid_main: Invalid path /run/cgmanager/fs/freezer/user.slice/user-32011.slice/session-32011.scope/upstart/test-cgroup
   </pre>
* The following command should return 4 lines of output like this:
   <pre>
    $ sort -u ~/.cache/upstart/test-cgroup.log
    1:cpu:/user.slice/user-32011.slice/session-c2.scope
    2:cpuacct:/user.slice/user-32011.slice/session-c2.scope
    3:freezer:/user.slice/user-32011.slice/session-c2.scope/upstart/test-cgroup
    4:name=systemd:/user.slice/user-32011.slice/session-c2.scope
   </pre>

----
