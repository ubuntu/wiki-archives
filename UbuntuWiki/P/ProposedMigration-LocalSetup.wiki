{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__

This page describes how to set up <nowiki>[[ProposedMigration|proposed-migration]]</nowiki> on a clean system.

=== Installability checks and autopkgtests ===

In the simplest case you just want to reproduce the "first stage" of <nowiki>[[https://code.launchpad.net/~ubuntu-release/+git/britney2-ubuntu|britney2-ubuntu]]</nowiki>, which checks that `-proposed` packages were built on all expected architectures, are installable by themselves, issue autopkgtests, collect their test results, and produce a production-like <nowiki>[[http://people.canonical.com/~ubuntu-archive/proposed-migration/update_excuses.html|excuses.html]]</nowiki> and <nowiki>[[people.canonical.com-~ubuntu-archive-proposed-migration-update_excuses.yaml|excuses.yaml]]</nowiki>.

* Check out the code:

<pre>
git clone https://git.launchpad.net/~ubuntu-release/britney/+git/britney2-ubuntu britney2-ubuntu
git clone https://git.launchpad.net/bileto
cd britney2-ubuntu
 </pre>

 The <nowiki>[[https://git.launchpad.net/bileto/tree/britney/fetch-indexes|fetch-indexes]]</nowiki> script inside the bileto repository downloads the source and binary package indexes to `data/<series>` and `data/<series>-proposed`.

* The default <nowiki>[[https://git.launchpad.net/~ubuntu-release/+git/britney2-ubuntu/tree/britney.conf|./britney.conf]]</nowiki> contains the production values for the architecture list, autopkgtest AMQP server (but without the actual password) and swift. For a purely local run you need to install the `rabbitmq-server` package, either locally or into a container, and adjust `ADT_AMQP` accordingly; use `amqp://guest:guest@localhost` or `amqp://guest:guest@10.0.3.XXX` respectively (this will use the default `guest` user of RabbitMQ).

* If you care about inspecting the issued autopkgtest requests in the AMQP queues, you need to declare them for a particular Ubuntu series:

 <pre>
sudo apt install -y amqp-tools
for arch in i386 amd64 armhf ppc64el; do
    amqp-declare-queue -u amqp://<server IP> -d -q debci-mantic-$arch
done
 </pre>

 You can skip this step, then the test requests will simply go into the void.

* Download archive indexes for the desired Ubuntu series:

 <pre>
../bileto/britney/fetch-indexes mantic
 </pre>

* Run britney for the same series:

 <pre>
./britney.py -c britney.conf --series=mantic -v
 </pre>

 You will then have the `excuses.*` and some other files in `output/mantic/`.

* The list of issued test requests can be found in `data/mantic-proposed/autopkgtest/pending.txt`. If you declared AMQP queues above, you can also read/flush them, e. g.

 <pre>
while amqp-get -u amqp://<server IPP> -q debci-mantic-armhf; do echo; done
 </pre>

=== Installability checks and autopkgtests against a PPA ===

This works similarly to the above, except that the PPA is now playing the role of ''series''`-proposed`. Download and use the <nowiki>[[http://people.canonical.com/~pitti/scripts/britney-indexes-ppa|britney-indexes-ppa]]</nowiki> scripts instead and run it with the PPA's archive URL:

<pre>
wget http://people.canonical.com/~pitti/scripts/britney-indexes-ppa
./britney-indexes-ppa vivid http://ppa.launchpad.net/ci-train-ppa-service/stable-phone-overlay/ubuntu
./britney.py -c britney.conf --series=vivid -v
</pre>

If you have a PPA which only builds packages for i386 and amd64, you need to run britney's build/installability checks against this reduced list:

<pre>
./britney-indexes-ppa xenial http://ppa.launchpad.net/pitti/systemd/ubuntu/
./britney.py -c britney.conf --series=xenial -v --architectures='i386 amd64'
</pre>

=== Full Ubuntu production setup ===
The full Ubuntu production setup is done by <nowiki>[[https://code.launchpad.net/~ubuntu-release/britney/britney1-ubuntu|britney1-ubuntu]]</nowiki>. This creates the archive index lists, per-series configuration files, calls the first and second stages of `britney2-ubuntu`, and issues the actual copying of packages from `-proposed` to `-release`. It assumes having a local mirror and a helper script `promote-to-release` which does the actual copying.

'''TODO:''' Fully document and/or provide charm for this.
