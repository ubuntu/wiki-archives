{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work.
* A '''full compressed version''' of the wiki is available on archive.org
|}

__TOC__


* '''Launchpad Entry''': https://launchpad.net/distros/ubuntu/+spec/succinct
* '''Created''': 2006-05-26 by FelixFeyertag
* '''Priority''': NeedsPriority
* '''People''':
* '''Contributors''': FelixFeyertag
* '''Interested''':
* '''Status''': Braindump
* '''Depends''':
* '''Dependents''':
 <<FullSearch>>
* '''BoF sessions''': none yet
* '''Packages affected''': 

=== Summary ===

Succinct is based on rsync/zsync, extended to specifically handle .deb files. This makes it possible to update existing Debian packages without downloading redundant data, common to both the original and updated package. An alternative solution would be to use dedicated patch files. An advantage of Succinct over patch files, is that separate patch files are not necessary, since this method automatically identifies and downloads only those portions of a .deb package that are different to the version available. Computing which blocks of .deb files have changed is handled entirely on the client side, so the server will not have to deal with the overhead of creating patch files on a per-client basis.

Further information about Succint can be found at:
* <nowiki>[[PaulSladen-Succinct]]</nowiki>

For discussion on the patch approach, see:
* <nowiki>[[SmallerUpdates]]</nowiki>
* <nowiki>[[APTPackageDeltas]]</nowiki>
* <nowiki>[[APTPackageDeltas-talk]]</nowiki>

This project is part of Google Summer of Code 2006, and is supervised by Michael Vogt.

=== Rationale ===

To save bandwidth when distributing updates.

=== Use cases ===

Sandy Slowspeed wants to apply the latest security updates for Dapper Drake, upon realizing that it would take over 12 hours to download the 300 MB required on a 56k modem, Sandy decides not to update after all.

=== Scope ===

=== Design ===

This project is based on the rsync algorithm as it is implemented by zsync (with all computation done on the client side). It is extended to work effectively on the .deb package format.

The rsync algorithm is used to identify which blocks of data are the same in the Debian file available, and the updated Debian file on a remote server. The identification occurs by calculating checksums over blocks of data within the two files, and identifying common sequences. A detailed explanation of the algorithm used by rsync can be found at:

* http://rsync.samba.org/tech_report/tech_report.html

The implementation of rsync does all calculations and comparisons on the server side, and a dedicated rsync server must run on the server. The high overhead on the server-side can make it unsuitable for widespread distribution of files. zsync is an alternative implementation based on the rsync algorithm, which does all comparisons on the client side. This is achieved by the server doing a one-time calculation of the checksums of all blocks in the file that needs to be distributed, and stores these checksums to another file. This file then contains all necessary data required for a client to calculate what data is required and what data is already available, so the client can do all calculations. Another advantage of this approach is that no dedicated rsync server needs to be run on the server, as HTTP can be used for all data transfer. Further explanation of the zsync program can be found at:

* http://zsync.moria.org.uk/paper/

The rsync algorithm can be ineffective when sending compressed data, since compression can radically alter common sequences of code within a file. Debian packages contain two gzipped tar files, one for data and another for control information. Because of the compression, rsync can be ineffective if applied directly to Debian packages. The succinct project is going to identify possibilities for finding common sequences of code between two Debian packages despite the compression, and implement the best solution in a program based on zsync. Loosely speaking, zsync will be extended to "understand" Debian packages.

Further, a patch to APT will be provided so that it is able to use succinct when downloading updates from a remote server.

==== Sample Data ====

The table below shows the performance of zsync for transferring the data.tar.gz file from some Debian packages when it is uncompressed, compressed as gzip and compressed as gzip with the --rsyncable option. Note that by default zsync automatically looks inside compressed gzip files, this can be prevented using the -Z option (which will treat the gzipped file as normal binary data). In the table below, the performance on compressed data is shown with -Z and without.

{| class="wikitable"
|-
| <tablestyle="width: 80%">'''Sample Data'''
|-
| Package
| <-2> Version
| <-2> Uncompressed
| <-2> Gzip compressed (with/without zsync -Z option)
| <-2> Gzip compressed with --zsyncable option (with/without zsync -Z option)
|-
| Old
| New
| Local
| Fetched
| Local
| Fetched
| Local
| Fetched
|-
| firefox
| <nowiki>[[ftp:--ftp.ubuntu.com-ubuntu-pool-main-f-firefox-firefox_1.0.7-0ubuntu20_i386.deb|1.0.7-0ubuntu20_i386]]</nowiki>
| <nowiki>[[ftp:--ftp.ubuntu.com-ubuntu-pool-main-f-firefox-firefox_1.0.8-0ubuntu5.10_i386.deb|1.0.8-0ubuntu5.10_i386]]</nowiki>
| 12302336
| 10944576
| 61440/12302336
| 8436056/4214131
| 3164160/12302336
| 5432743/4346548
|-
| firefox
| <nowiki>[[ftp:--ftp.ubuntu.com-ubuntu-pool-main-f-firefox-firefox_1.0.8-0ubuntu5.10_i386.deb|1.0.8-0ubuntu5.10_i386]]</nowiki>
| <nowiki>[[ftp:--ftp.ubuntu.com-ubuntu-pool-main-f-firefox-firefox_1.5.dfsg+1.5.0.4-0ubuntu6.06_i386.deb|1.5.dfsg+1.5.0.4-0ubuntu6.06_i386]]</nowiki>
| 1886208
| 20280600
| 0/1886208
| 7930655/7138161
| 391168/1886208
| 7621814/7255178
|-
| gimp-data
| <nowiki>[[ftp:--ftp.ubuntu.com-ubuntu-pool-main-g-gimp-gimp-data_2.2.2-1ubuntu5_all.deb|2.2.2-1ubuntu5_all]]</nowiki>
| <nowiki>[[ftp:--ftp.ubuntu.com-ubuntu-pool-main-g-gimp-gimp-data_2.2.8-2ubuntu6_all.deb|2.2.8-2ubuntu6_all]]</nowiki>
| 3715072
| 1772697
| 92160/3715072
| 1994886/674701
| 581632/3715072
| 1477323/736132
|-
| openoffice.org-bin
| <nowiki>[[ftp:--ftp.ubuntu.com-ubuntu-pool-main-o-openoffice.org-openoffice.org-bin_1.1.2-2ubuntu6.1_i386.deb|1.1.2-2ubuntu6.1_i386]]</nowiki>
| <nowiki>[[ftp:--ftp.ubuntu.com-ubuntu-pool-main-o-openoffice.org-openoffice.org-bin_1.1.3-8ubuntu2.3_i386.deb|1.1.3-8ubuntu2.3_i386]]</nowiki>
| 27041792
| 96178842
| 0/29054976
| 42036363/32388989
| 7841792/29054976
| 34405598/32924707
|-
| ubuntu-artwork
| <nowiki>[[ftp:--ftp.ubuntu.com-ubuntu-pool-main-u-ubuntu-artwork-ubuntu-artwork_0.2.24-1_all.deb|0.2.24-1_all]]</nowiki>
| <nowiki>[[ftp:--ftp.ubuntu.com-ubuntu-pool-main-u-ubuntu-artwork-ubuntu-artwork_0.2.27-1_all.deb|0.2.27-1_all]]</nowiki>
| 2899968
| 5324148
| 251904/2899968
| 5743360/5036070
| 593920/2899968
| 5410650/5061194
|}

Using the automatic zsync look-inside for standard gzip files repeatedly produces the best results (the least data needs to be fetched), the problem with it is that zsync can not guarantee that the exact same file will be reproduced (such that checksums match).

The table below shows the amount of data downloaded for some more packages as a percentage of the original file size. The first column of each package refers to the amount downloaded by zsync for the uncompressed data (data.tar), the second and third show the amount downloaded by zsync with the -Z option (so that it does not look inside the compressed data) for gzip and gzip --rsyncable compressed data (data.tar.gz) respectively, and the fourth and fifth column show the amount downloaded by zsync with looking inside the compressed data for gzip and gzip --rsyncable compressed data respectively.

{| class="wikitable"
|-
| <bgcolor="#9c9cff"> #
| tar
| <bgcolor="#9c3163"> #
| -Z tar.gz
| <bgcolor="#ffffce"> #
| -Z --rsyncable tar.gz
| <bgcolor="#ceffff"> #
| tar.gz
| <bgcolor="#630063"> #
| --rsyncable tar.gz
|}
{{http://homepages.inf.ed.ac.uk/s0343894/test-data.png}}

=== Implementation ===

==== Code ====

Code will be written in Python where possible/sensible.

==== Data preservation and migration ====

=== Outstanding issues ===

* How best to identify common segments of data between two gzipped files. A "look-inside" mechanism could be used or a --zsync option to gzip.
* APT must be able to validate an updated .deb package. The MD5 sum must therefore match the original package. Another (depreciated) option would be to modify APT to handle different MD5 sums.

=== BoF agenda and discussion ===
I think good thing will be to fetch Packages.gz using delta-compression too. It is done in new version of apt-get in debian. 

=== External Links ===

rsync:

* http://samba.anu.edu.au/rsync/

zsync:

* http://zsync.moria.org.uk/

Discussions on the debian-devel list:

* http://lists.debian.org/debian-devel/2006/05/msg02226.html

* http://lists.debian.org/debian-devel/2005/11/msg00023.html

Some thoughts from Martin Pool (of rsync):

* http://samba.anu.edu.au/rsync/rsync-and-debian/rsync-and-debian.html

=== Bite-size pieces (sladen) ===

==== Generation ====

## Patch `dpkg-deb` to use external `gzip` callout 
## Add a flag to `dpkg-deb` to build with `--rsyncable`
## fork `zsync` and call it `apt-debsync` or something
## allow `apt-debsync` to have an 'offset' field
## get dpkg to pass the offset of the zsync from the start of the resultant `.deb`
## Use the packages listed in `Packagename:`, `Depends:`, `Provides:` and `Replaces:` and search the files inside of these (`dpkg -L`) to get a list of search targets.

==== Reassembly ====

<pre>
15:45 <mvo> that would mean we would have to put the offset inside the packages file?
15:45 <mvo> a interessting idea!
</pre>
11. Make `apt-debsync` do a download of 0..offset and (offset+length)..filesize.  These are the ''header'' and ''footer'' of the `.deb`.
12. Try to assemble the .tar from local files and downloaded pieces;
13. Gzip the `.tar`
14. Top-and-tail on with the two downloaded chunks.

==== Optional ====

21. Add support for '.bz2' (actually really easy compared to the above, see the source code for `bzip2recover`).
22. Make debsync use an text fileformat and gzip the resultant digest-file
23. Make debsync use a longer checksum.

==== Meta-data ====

<pre>
Apt-sync: version digest-file offset
</pre>
<pre>
Apt-sync: 0.1 packagename_version.deb.apt-sync 1234
</pre>

Possibly include an offset and length of the digest-file so that the digest can be added to the end of the `.deb`!

=== Bite sized pieces (mvo) ===

This should be equivalent to the version from sladen, but worded differently. Sladen, please confirm.

<pre>
apt-sync

General: 
- Packages.gz and file.deb files should be aptsync-able
- have a .aptsync file for each deb package in the pool

Generate:
1) patch dpkg-deb to have a option to build the debs with --rsync
 - dpkg-deb currently does its own chunking every 8kB, the result is therefore not the same stream as calling-out to gzip
 - zsync calles out to 'gzip' to compress the stream
 - dpkg-deb needs to have an option to callout to 'gzip' to know the results will be the same.
2) extract the data.tar.gz from the deb
3) construct a .aptsync file from the data.tar.gz, it is a zsync file but it needs to have additonal information like: (offset, len, checksum) of the data.tar.gz inside the deb and possible the content of the tarball)
 - if we didn't want to make /any/ changes to zsync, then the offset and length could be stored in Packages.

Assemble:
1) get the .aptsync file for the deb
2) If there is an existing .deb in /var/lib/cache, take the existing deb and extract and uncompress to get 'data.tar' and put this in /tmp,
3) Assemble a list of 'likely files' on the local disk to hunt for chunks.  This includes the output of 'dpkg -L' for previous version of the package and for those listed in 'Provides:/Replaces:'.  If the previous step found a 'data.tar', add this to the list.
4) let apt-debsync (aka zsync) construct a new 'data.tar' by search all the likely files and downloading any pieces not found locally from the central mirror.
5) Compress this new 'data.tar' using a callout to either gzip or bzip2 (zsync can do this for us).
6) Make sure the checksum matches for the new 'data.tar.gz'
7) Unconditionally download the 'top' and 'tail' of the '.deb' from the mirror.  In the case 'Packages.gz' the top and tail will be zero in length.
7) Re-assemble the .deb by cat'ing the 'top', new 'data.tar.gz' and 'tail' together
8) Ensure this checksum matches, or else just download the whole file by HTTP.
</pre>

=== Comments ===

* As has been <nowiki>[[https://lists.ubuntu.com/archives/ubuntu-devel/2006-January/014746.html|discussed previously]]</nowiki>, for gz files, --rsyncable does not help zsync. Since the zsync-look-inside appears to not currently support  gz files embedded in ar/deb files it may be enabled as a hack to get it working quickly, modifying zsync to support deb files properly is possible and a better long term solution. --JohnMccabeDansted

* How can we measure the compression of --zsyncable. Isn't --zsyncable a proposed implementation of 7z? I think we mean --rsyncable --JohnMccabeDansted

----
CategorySpec
