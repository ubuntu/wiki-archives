{|
  | '''Warning'''
  * This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
  * '''Images''' and '''attachments''' have been removed to conserve space.
  * '''Links''' may not work and there may be formatting issues.
  * A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__

Packaging experimental software for use on your system, sharing with colleagues, or sharing with community via PPA's 

This is a guide for any one that stumbles upon this page, but currently serves primarily as a reference for myself.

(partially covered by my <nowiki>[[http://askubuntu.com/a/482387/5042|answer on AskUbuntu]]</nowiki>)

== Prerequisites ==

This is targeted towards an Ubuntu 12.04 (precise) base system. However it can be used to build packages targeted at any other system

<code>sudo apt-get install packaging-dev</code> should pull all the packages necessary to get started with packaging

Clean environment is recommended, I use a VM, if you are going to be uploading this to a PPA, then you must sign up for launchpad, create a GPG key, register it with Launchpad and sign the code of conduct before it will be uploadable.

== Packaging ==

=== Setting up the environment ===

<code>pbuilder</code> (<nowiki>[[PbuilderHowto|wiki doc]]</nowiki>) is a automated system for building packages in a chroot environment, this avoids polluting your system with unnecessary packages especially useful when building against experimental dependencies.

<code>sudo pbuilder create</code> should initialize a pbuilder system based on your current distro, targeted releases can be done using <code>sudo pbuilder-dist precise create</code> which will pull from packages for that release.

=== From upstream source to ubuntu package ===

Often I will run into software available that is either not packaged or outdated in the debian/ubuntu repositories. Other times it may be updated in newer releases but will require a lot of different new dependencies to be pulled in, and it is not desirable to try to pull many different dependencies (which can conflict with other packages) when it will build perfectly fine against the packages in your distro. 

==== Using existing debian/ubuntu source to build a .deb ====

1. Pull debian source by using <code>pull-debian-source package-name [full-debian-verion]</code>
** Version is optional but useful when you want a specific version 
** Versions from ubuntu releases can be pulled using <code>apt-get src package-name</code>  but will require you adding the <code>deb-src</code> repo in your <code>sources.list</code>}
2. Build package using the existing <code>.dsc</code> file <code>sudo pbuilder[-dist] [precise/trusty] build package-name_version.dsc</code>
3. On successful build  by default <code>pbuilder</code> places result in <code>/var/cache/pbuilder/result/</code> and <code>pbuilder-dist </code> in <code>~/pbuilder/[distro]_result/</code>
4. These debian packages can be installed using <code>dpkg -i</code> or placed in a local apt-repo, uploading to a PPA requires uploading source packages

==== Using existing debian/ubuntu source to upload to PPA ====

1. Pull debian source by using <code>pull-debian-source package-name [full-debian-verion]</code>
** Version is optional but useful when you want a specific version 
** Versions from ubuntu releases can be pulled using <code>apt-get src package-name</code>  but will require you adding the <code>deb-src</code> repo in your <code>sources.list</code>}
2. Unpack <code>package-name_upstreamversion.orig.tar.gz</code> and <code>package-name_debianversion.debian.tar.gz</code>
** Move the newly created  <code>debian</code> folder into the unpacked source folder
3. Change <code>debian/changelog</code> to sign the package upload in your name (follow the template and use exactly what you used for the GPG key)
** This is the minimal amount of change required to upload to your PPA, if the package doesn't build patches may have to be written or dependencies may have to be modified
4. <code>bzr init;bzr add;bzr commit -m "initial";bzr builddeb -- -S -sa</code> this will build a package using the nice bzr-builddeb script and place all the files in the parent directory
** git/mercurial/svn scripts are available I just have had less success
5. Test your build by <code>cd build-area;pbuilder-dist precise build package-name_debianversion.dsc</code> 
** If build is successful on your machine, chances it will succeed on launchpad
6. Upload to launchpad <code>dput ppa:username/ppa-folder package-name_debianversion_source.changes</code>

==== Using an existing debian/ubuntu package to package new upstream version ====

Often I find that there are existing debian/ubuntu packages but for the software I use there may have been significant changes since the last time it was updated in the repos. Luckily the build system often doesn't change at all so it you can *almost* just copy the existing <code>debian</code> folder into the new source.

As good practice, you should probably make sure that you can build the software from source the old fashioned way before attempting to package, this will let you catch major dependency issues (What else do I need to backport!!!) before you tack on all the debian stuff

1. Download upstream source, either from their website or using their VCS of choice

  a. If you get a tarball, it may be simply sufficient to rename it with a <code>.orig.tar.gz</code>

  a. If you use a VCS to get the development version, you need to make the tarball yourself

** For GIT:

    i. checkout a new branch <code>git checkout -b local-packaging-dev</code>

    i. <nowiki>[[http://feeding.cloud.geek.nz/posts/excluding-files-from-git-archive/|read here]]</nowiki> how to set up git to ignore certain files when exporting a tarball  (''don't forget to'' <code>git add .gitattributes;git commit</code> !!)

    i. in the root of the source <code>git archive --format=tgz --prefix=package-name-upstreamversion/ --output=../package-name_upstreamversion.orig.tar.gz HEAD </code>
*** EX: <code>git archive --format=tgz --prefix=openni2-2.2.0.33/ --output=../openni2_2.2.0.33.orig.tar.gz HEAD</code>
*** note the differences in <code>_</code> vs <code>-</code> in tarball vs folder

2. Download the <code>.debian.tar.gz</code> for the previous version of the package available in the archive 
** You can either do it directly with <code>wget</code> or by using <code>debian-pull-source</code> or <code>apt-get src</code> as above

3. With a <code>.orig.tar.gz</code> in hand we can then <code>tar -xf source.orig.tar.gz;tar -xf old_source.debian.tar.gz; mv debian source_dir/</code> to move the debian in place

4. You have to modify the changelog in <code>debian/changelog</code> and potentially many many other files
** Modify the changelog as above to sign your name to the package (PPA only)
** If the package has <code>debian/patches</code> skip ahead to how to deal solve patching issues
5. If the stars smile upon you, you can continue from step 4 in the above section and it will work

=== Fixing Common Issues ===

==== If your package has patches ====
When trying to migrate old debian package info to new upstream packages often you will run into patches in the <code>debian/patches</code> directory.

Patches are set up using <nowiki>[[https://wiki.debian.org/UsingQuilt|Quilt]]</nowiki> 

1. Attempt to see if all the old patches still work <code>quilt push -a</code>
2. Assuming Failure:
** <code>quilt pop -a</code> to revert to the clean source
** <code>quilt push</code> one at a time until you get to the patch that breaks
** examine the patch in your editor of choice, compare it with the source as it is now
** if the patch is easily fixable (a new line was added so QUILT didn't know where to patch
   i. <code>quilt new 00XX-mypatch.patch </code>
   i. <code>quilt add [files to be modified]</code>
   i. modify files using the old patch (you can have the old source set up in parallel with all patches pushed) using your editor of choice
   i. When you are satisfied <code>quilt refresh</code>
   i. Remember to delete the old patch from <code>debian/patches</code> and remove the reference to it in <code>debian/patches/series</code>
3. When you have working patches:
** <code>quilt pop -a</code> to revert to clean source
** Remember to <code>bzr add</code> whatever new patches you added, if you are using <code>bzr-builddeb</code>
4. Continue on as above

==== If your package needs custom dependencies to build ====

pbuilder can be easily set up to use custom packages to satisfy dependencies. We set up a local repository and tell pbuilder where to look for it.

By default <code>pbuilder-dist</code> creates folders under <code>~/pbuilder/</code>. 

# Create a hooks and local repo directory <code>~/pbuilder/precise_hooks</code> <code>~/pbuilder/precise_local</code>
# Modify <code>~/.pbuilderrc</code> and add the following lines
<pre>
OTHERMIRROR="deb [trusted=yes] file:///home/user/pbuilder/precise_local ./"

BINDMOUNTS="/home/user/pbuilder/precise_local" 

HOOKDIR="/home/user/pbuilder/precise_hooks"

EXTRAPACKAGES="apt-utils"
</pre>
1.#3 create a hook script <code>~/pbuilder/precise_hooks/D05local</code> (the <code>D</code> prefix is necessary because it determines when the script is hooked, the rest of the name only determines hook order.
** <code>(cd /home/user/pbuilder/precise_local ; apt-ftparchive packages . > Packages)</code>
1. Any <code>.deb</code> files placed in <code>~/pbuilder/precise_local/</code> will be automatically picked up by pbuilder to satisfy dependencies
** if you change <code>precise_local</code> to <code>precise_result</code> then all packaged built by <code>pbuilder-dist</code> will automatically be picked up for dependencies (requires no moving)

== Distributing ==

Besides installing <code>.deb</code> with <code>dpkg -i</code> there are other options for distributing custom built packages

=== Serving Locally From an Local Repository ===

A Local repository to serve custom packages with <code>apt-get</code> is easy to set up. 

1. Make a convenient directory for the repo
  i. Move all your packages to this directory
  i. <code>cd /path/to/local/repo;apt-ftp archive packages . > Packages</code>
2. Add this local repo to your apt sources
  i.  <code>sudo echo "deb [trusted=yes] file:/local/repo/Packages ./" > /etc/apt/sources.list.d/gcc-repo.list</code>
3. <code>apt-get update;apt-get install custom_package</code>
