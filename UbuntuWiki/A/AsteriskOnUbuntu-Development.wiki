{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__



export MYSQL_ROOT_PW=peachy2keen

export FREEPBX_VERSION=2.9.0

export ASTERISK_DB_PW=amp109

export IP_ADDRESS=10.1.1.16

apt-get -y update

apt-get -y upgrade

apt-get -y install asterisk sox asterisk-mysql asterisk-mp3 

apt-get -y update

apt-get -y install debconf-utils

debconf-set-selections <<CONF_EOF

debconf debconf/frontend select noninteractive

CONF_EOF

apt-get -y install mysql-server

debconf-set-selections <<CONF_EOF

debconf debconf/frontend select Dialog

CONF_EOF

apt-get -y install linux-headers-`uname -r`

apt-get -y install make bison flex g++ gcc apache2 php5 

apt-get -y install php5-cli php5-mysql php-pear php-db php5-gd curl 

apt-get -y install sox libncurses5-dev libssl-dev libmysqlclient15-dev

apt-get -y install php-pear

apt-get -y install apache2

apt-get -y install php5

apt-get -y install libapache2-mod-php5

/etc/init.d/apache2 restart

apt-get update

pear install DB

apt-get install php5-mysql

cd /etc
mkdir backupasterisk

cp -r asterisk backupasterisk

cp -r /var/run/asterisk backupasterisk

cd /usr/src

wget http://mirror.freepbx.org/freepbx-${FREEPBX_VERSION}.tar.gz

tar -xvf freepbx-${FREEPBX_VERSION}.tar.gz

cd freepbx-${FREEPBX_VERSION}

passwd --delete asterisk

adduser asterisk --disabled-password --gecos "asterisk PBX"

adduser www-data asterisk

cp /etc/apache2/apache2.conf /etc/apache2/apache2.conf-orig

sed -i "s/\(^User *\)\(.*\)/\1asterisk/" /etc/apache2/apache2.conf

sed -i "s/\(^Group *\)\(.*\)/\1asterisk/" /etc/apache2/apache2.conf

sed -i "s|#!/bin/sh|#!/bin/bash|" /usr/sbin/safe_asterisk

cat > /etc/init.d/asterisk <<-END_STARTUP

set -e

set -a

PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

DESC="Asterisk"

NAME=amportal

DAEMON=/usr/sbin/\$NAME

test -x \$DAEMON || exit 0

d_start() {
	amportal start
}

d_stop() {

	amportal stop

}

d_reload() {

	amportal restart

}

case "\$1" in

start)
	echo -n "Starting \$DESC: \$NAME"

	d_start

	echo "."
;;

stop)
	echo -n "Stopping \$DESC: \$NAME"

	d_stop

	echo "."

;;

restart|force-reload)

	echo -n "Restarting \$DESC: \$NAME"

	d_stop

	sleep 10

	d_start

	echo "."

;;

* )

	echo "Usage: \$SCRIPTNAME {start|stop|restart|force-reload}" >&2

	exit 3
;;

esac

exit 0

END_STARTUP

chmod 755 /etc/init.d/asterisk

update-rc.d asterisk defaults 90 10

modprobe ztdummy

mysqladmin -u root -p${MYSQL_ROOT_PW} create asterisk

mysqladmin -u root -p${MYSQL_ROOT_PW} create asteriskcdrdb

mysql -u root -p${MYSQL_ROOT_PW} asterisk < SQL/newinstall.sql

mysql -u root -p${MYSQL_ROOT_PW} asteriskcdrdb < SQL/cdr_mysql_table.sql

mysql -u root -p${MYSQL_ROOT_PW} <<-END_PRIVS

	GRANT ALL PRIVILEGES ON asterisk.* TO asteriskuser@localhost IDENTIFIED BY "${ASTERISK_DB_PW}";

	GRANT ALL PRIVILEGES ON asteriskcdrdb.* TO asteriskuser@localhost IDENTIFIED BY "${ASTERISK_DB_PW}";

	flush privileges;

END_PRIVS

cp /etc/php5/apache2/php.ini /etc/php5/apache2/php.ini-orig

sed -i "s/\(upload_max_filesize *= *\)\(.*\)/\120M/" /etc/php5/apache2/php.ini

sed -i "s/\(memory_limit *= *\)\(.*\)/\1100M/" /etc/php5/apache2/php.ini

sed -i "s/\(magic_quotes_gpc *= *\)\(.*\)/\1Off/" /etc/php5/apache2/php.ini

mkdir /var/run/asterisk

chown asterisk:asterisk /var/run/asterisk

chown asterisk:asterisk -R /etc/asterisk

chown asterisk:asterisk -R /var/lib/asterisk

chown asterisk:asterisk -R /var/log/asterisk

chown asterisk:asterisk -R /var/spool/asterisk

chown asterisk:asterisk -R /var/www

sed -i "s/\[directories\](!) .*/[directories]/" /etc/asterisk/asterisk.conf

sed -i "s|astrundir *=> */var/run|astrundir => /var/run/asterisk|" /etc/asterisk/asterisk.conf

./start_asterisk start

cp amportal.conf /etc/amportal.conf

sed -i "s/# \(AMPDBUSER=asteriskuser\) */\1/" /etc/amportal.conf

sed -i "s/# \(AMPDBPASS=\).*/\1${ASTERISK_DB_PW}/" /etc/amportal.conf

sed -i "s|\(AMPWEBROOT=\)/var/www/html|\1/var/www|" /etc/amportal.conf

sed -i "s|\(FOPWEBROOT=\)/var/www/html/panel|\1/var/www/panel|" /etc/amportal.conf

sed -i "/#AMPWEBADDRESS=192.168.1.101/d" /etc/amportal.conf

sed -i "s/AMPWEBADDRESS=/AMPWEBADDRESS=${IP_ADDRESS}/" /etc/amportal.conf

./install_amp --username=root --password={MYSQL_ROOT_PW} 

/etc/init.d/apache2 restart

amportal start

echo "you're done, go to your browser URL and type in 'localhost/admin', username is admin, password is admin"

echo ""

echo "** VERY IMPORTANT: IF YOU DON'T WANT A LOT OF GRIEF, MAKE SURE THE FIRST THING YOU DO IS TO UPGRADE YOUR MODULES IN FREEPBX SETUP"

echo "http://localhost/admin/config.php?type=setup&display=modules and click on 'check online' and then update the current modules"

echo "if you get an error that a field is missing (password_sha1) then read the end of the script for more notes"

