{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__


=== The challenge ===

This howto describes what you have to do to install Ubuntu 6.10 on a FakeRaid system (for example: nvRaid or Intel Raid or Silicon Image) which is already partitioned. One of the reasons for someone to go the FakeRaid way (and not Software Raid available in Linux) is if he/she wants to share the same RAID setup with one or more Windows installations. I, personally, already had several Windows partitions that I did not want to damage. One of my aims was also to use the existing installer as much as possible and only do the tweaks needed for dmraid, without installing everything by hand. See FakeRaidHowto for the more manual way.

Since my RAID set was already partitioned, I won't cover partitioning of fakeraid sets here. See FakeRaidHowto for this.

You have to use the "Alternate" install CD (or the DVD). Support for fakeraid is already pretty buggy, and the pretty installer on the "Desktop" CD would just get too confused. When I tried the "Desktop" installer, it would not give me the option to install to my raid devices, even if I had installed and run dmraid.

==== In case of failure with the alternate CD ====
You can use the Desktop CD as well, provided you have internet access. I will tell you how to do in the bottom of this document.

=== Preparations ===

To prepare yourself and the system:

* (optional) Boot with a live CD and make backups of the boot sectors and partition tables of your hard drives:
<pre>
sudo dd if=/dev/sda of=backup.sda bs=2048 count=1
</pre>
 Repeat for other disks on your system, /dev/sdb and so on. Print out a list of the partition tables as well:
<pre>
fdisk -l /dev/sda
</pre>
 This might save you time if the boot sector get messed up by a broken grub install, but it is not a substitute for a full backup!

* Download the dmraid deb package to a USB memory stick (best option), an external hard drive, a hard drive not running RAID, or on a floppy or CD (you might need two CD drives for the last option, since the install CD will occupy one drive). <<BR>>
 For best luck, compile the newest package from Feisty, which also has a "light" dmraid-udeb package: https://launchpad.net/distros/ubuntu/+source/dmraid. <<BR>>
 The original one in Edgy will work for some people, and some others again will need a more patched version. I compiled a patched version of dmraid myself, which you can <nowiki>[[http://tormod.webhop.org/linux/dmraid/|download here]]</nowiki> (get the .deb file). In the same directory you can also find a compiled backport of the Feisty version for Edgy and Dapper.

==== Update from a person who has followed the guide ====

To make things easier for people following this guide in the future, I have linked to the exact files that are needed to complete the installation. There are '''two points''' during the installation when you will need to manually enter the shell and install a few packages. The procedure is explained in the forthcoming sections.

 1. The first time you enter the shell, you will need to install ''libdevmapper'' and ''dmraid'' '''udeb''' packages the first time. Download them from here: <nowiki>[[http://librarian.launchpad.net/6443104/libdevmapper1.02-udeb_1.02.08-1ubuntu5_i386.udeb|libdevmapper-udeb]]</nowiki> and <nowiki>[[http://librarian.launchpad.net/5347777/dmraid-udeb_1.0.0.rc13-2ubuntu1_i386.udeb|dmraid-udeb]]</nowiki>

 2. The second time you enter the shell, you need to install ''dmraid'' and ''grub'' '''deb''' packages. Download them from here: <nowiki>[[http://tormod.freeshell.org/linux/dmraid/dmraid_1.0.0.rc13-2ubuntu2tormod~edgy_i386.deb|dmraid-deb]]</nowiki> and <nowiki>[[http://kanotix.com/files/debian/pool/main/g/grub-gfxboot/grub-gfxboot_0.97-11_i386.deb|Grub-GfxBoot]]</nowiki>

 I have linked to the Graphical version of GRUB, which is called <nowiki>[[http://doc.gwos.org/index.php/GfxBoot|GRUB-GfxBoot]]</nowiki>. It provides the same functionality as the normal GRUB, but is a lot more pleasing to the eye. If you would rather have the normal GRUB, get it from <nowiki>[[http://http.us.debian.org/debian/pool/main/g/grub/grub_0.97-24_i386.deb|here]]</nowiki>.

 I have uploaded two of the graphical themes ''message.snow'' and ''message.red'' <nowiki>[[http://www.esnips.com/web/Grub-GfxBoot|here]]</nowiki>. You can also find many more themes on the <nowiki>[[http://doc.gwos.org/index.php/GfxBoot|GRUB-GfxBoot]]</nowiki> page. Download at least one to your memory device.

Copy all files you have downloaded to your memory device (example: USB drive). For sake of simplicity, use the following directory structure:

<pre>
udeb
  -- libdevmapper1.02-udeb_1.02.08-1ubuntu5_i386.udeb
  -- dmraid-udeb_1.0.0.rc13-2ubuntu1_i386.udeb

deb
  -- dmraid_1.0.0.rc13-2ubuntu2tormod~edgy_i386.deb

grub
  -- grub-gfxboot_0.97-11_i386.deb  (or)  grub_0.97-24_i386.deb
  -- message.snow (you don't need this if you are using normal GRUB)
  -- message.red (you don't need this if you are using normal GRUB)
</pre>

=== Start the Installer ===

* Boot from the "Alternate" CD. Choose '''Install in Text Mode''' from the boot menu.
* Answer questions and let it run until '''Partition disks'''. 
  The installer will not be able to detect the disk array. Most probably, you will be presented with the independent disks. '''DO NOT''' partition your independent disks. Doing that would most probably destroy your array and your other Windows partitions. 
* Choose '''Go back'''. You will be presented with the ''installer menu''. Scroll down it till you select the option '''Execute a shell''' and press ''Enter'' (or get a shell with Alt-F2).

=== Install dmraid on the installer ===
==== This is the first time you are entering the shell ====
'''The following instructions in the box may be redundant. Skip this box.'''
<pre>

The dmraid package has some dependencies, which you can just grab from the mounted "Alternate" CD: libsepol1, libselinux1, and for some versions of dmraid, zlib1g. The installer shell has only "udpkg", which will complain a lot, but the meat of the packages will be installed anyway.

udpkg -i /cdrom/pool/main/libs/libsepol/libsepol1_1.12-1_i386.deb
udpkg -i /cdrom/pool/main/libs/libselinux/libselinux1_1.30-1ubuntu1_i386.deb
udpkg -i /cdrom/pool/main/z/zlib/zlib1g-udeb_1.2.3-13ubuntu2_i386.udeb

In the cases where you can pick a .udeb instead of a .deb, like for the zlib1g, udpkg will make less complaints.
 
</pre>

==== Update from a person who has followed the guide ====
I have installed Edgy on my FakeRaid system a number of times, and I have not had to install any of the above 3 packages. The same has been reported by many other users on the forum. So please don't install the above packages unless what I describe below does not work for you.

Retrieve the udeb packages of ''libdevmapper'' and ''dmraid'' from the '''udeb''' folder of your chosen media. In the case of a memory stick, plug it in, and type <code>dmesg | tail</code> to reveal the device name of the stick, and mount it with (for instance) <code>mount /dev/sdg1 /mnt</code> (if dmesg listed sdg and sdg1). Copy the packages to tmp and install it:
<pre>
cp -r /mnt/udeb tmp
udpkg -i tmp/udeb/libdevmapper1.02-udeb*
udpkg -i tmp/udeb/dmraid-udeb*
</pre>

You can now unmount your memory device if you like: <code>umount /mnt</code>

Start dmraid to let it detect your raid set and expose it as one device:
<pre>
modprobe dm-mod
dmraid -ay
</pre>

You should now see your raid device nodes with <code>ls /dev/mapper</code>. If you only see "control" there, something is not working as it should, and maybe you need a newer/patched version of dmraid before you can go on.

Note down (yes, Write it down!) the name of your RAID device before continuing. This will most probably be something like ''nvidia_eacdccid'' or ''via_hfciifae''. The name of your RAID device will be used later while installing the bootloader. I will refer to the RAID device as ''your_raid_set'' henceforth.

Each of your partitions will be named by appending a number to the name of your RAID device. Remember the numbers of the partitions where you are going to mount the root, swap, boot partitions. You will be setting up these partitions in the next step.

=== Set up partitions ===

Type '''exit''' to get out of the shell. It will go back to "Partition disks" again. This time you'll see the disk array in addition to the raw devices. Although this may be done by default, it is important that you go through the list of partitions that you don't intend to use, and remove all settings proposed by the installer for the raw devices! Set them all to '''Do not use'''.

You'll see two listings for your raid devices:
* The first listing shows one "top" level LVG device which lists all partitions under it.
* The second listing shows one LVG device for each partition.

You should use the second listing to select your ''root'', ''swap'', etc. partitions.

Once you have set up the partitions (at least a / and a swap) let the installer write the changes to disk. Verify that it will only modify /dev/mapper/your_raid_set devices.

The installer will now mount your root partition under /target and install all packages. '''Except dmraid :)'''.

==== Second time you enter the shell ====
After the installer has completed installing all packages, a red screen will appear with the error message that the installer was not able to install a bootloader. Don't worry, this is not a problem. The installer detects your target as an LVM and therefore rules out GRUB. It will try "LILO" but that will fail as well. We will install GRUB by hand. This is described below. Just acknowledge the error (press ''OK'' or ''Cancel'' or whatever is available) and you will be shown the ''installer menu'' again.

So, our objective when we enter the shell for the second time is to install the deb packages of ''dmraid'' and ''grub''. Then we setup GRUB bootloader by hand.

=== Install dmraid on the target ===

Choose the '''Execute a shell''' in the installer menu again. Mount ''proc'', ''sys'' and ''dev''.

<pre>
mount --bin /dev /target/dev
mount -t proc proc /target/proc
mount -t sysfs sys /target/sys
</pre>

Install the dmraid package (not the udeb this time) to the target system. Insert and mount your memory device again, as before, if you had unmounted it before. Then copy the ''dmraid'' and ''grub-gfxboot'' deb packages to the target system for installation. If you wish, copy one of the ''message.snow'' or ''message.red'' files to the target system. The ''message'' files are themes for the graphical bootloader. You can get more of these themes <nowiki>[[http://doc.gwos.org/index.php/GfxBoot|here]]</nowiki>.

<pre>
cp -r /mnt/deb /target/root/
cp -r /mnt/grub /target/root/
chroot /target
bash
dpkg -i /root/deb/dmraid*
update-initramfs -u
</pre>

Starting "bash" just makes life easier, but is not necessary. You can also do: <code>chroot /target bash</code>
The installer had already made an initrd, but it has to be updated to get the dmraid stuff in it.

=== Install the GRUB boot loader ===

<pre>
There are mainly three parts you need for a successful setup of GRUB:
 1. The /boot/grub directory with the grub files stage1, stage2, etc.
 2. GRUB installed to the boot sector of the hard drive.
 3. A valid menu.lst in the /boot/grub directory.
</pre>

==== 1. Establish GRUB files in /boot/grub ====

While you're still in a chroot, install grub-gfxboot:

<pre>
dpkg -i /root/grub/grub*
</pre>

This will create a '''/usr/lib/grub''' directory with all the grub files (stage1, stage2, etc.) in it. We want these files to be in the '''/boot/grub''' directory. Also copy the GRUB graphical themes to '''/boot/grub''' if you are using graphical GRUB.

<pre>
mkdir /boot/grub
cp /usr/lib/grub/<your-cpu-arch>-pc/* /boot/grub
cp /root/grub/message* /boot/grub
</pre>

'''NOTE:''' 
 1. The ''<your-cpu-arch>-pc'' should be replaced by whatever is present in your '''/usr/lib/grub''' folder. For example: it is ''i386-pc'' for me.
 2. If the '''grub''' folder is not present in '''/usr/lib''', please check '''/lib'''.

==== 2. Install GRUB to the boot sector of the HDD ====

Next, go into the GRUB shell:
<pre>
grub --no-curses
</pre>

You should now see the ''grub>'' prompt. 

Next, tell GRUB which device is the boot device:

<pre>
device (hd0) /dev/mapper/your_raid_set
</pre>

In my case, it was the RAID array mapped as ''/dev/mapper/nvidia_eacdccid''. 

Next, tell GRUB where all the stuff that is needed for the boot process is.

If you have a separate partition for ''/boot'', then enter
<pre>
find /grub/stage1
</pre>

Else, if you don't have a separate partition for ''/boot'', then enter
<pre>
find /boot/grub/stage1
</pre>

This will return something like <code> (hd0,4) </code>. Whatever you get, insert it in the following command:
<pre>
root (hd0,4)
</pre>

Next, now that you've successfully established the "device" and "root", you can go ahead and instantiate GRUB on the boot device. This sets up the stage 1 bootloader in the device's master boot record and the stage 2 boot loader and grub menu in your boot partition:
<pre>
setup (hd0)
quit
</pre>

==== 3. Configuring the Bootloader's menu.lst ====

Now run:
<pre>
update-grub
</pre>
/!\ If you get the "unexpected operator" error, you'll have to run grub without the wrapper: cd into the /usr/sbin directory and run  <code>exec -a update-grub /usr/sbin/update-grub.real $*</code>

You will be asked if you want to create a new '''menu.lst''' file. Say ''Yes''. 

This adds your newly installed linux kernel, and the associated initial RAM disk image, to the boot options menu that GRUB presents during start-up. You will find this menu in the /boot/grub directory. We need to edit this menu.lst file.

For me, ''nano'' did not work inside ''chroot''. So, I came out and edited the '''menu.lst''' from outside. To exit ''chroot'', type <code> exit </code> twice (the first to exit ''bash'' and the second to exit ''chroot'').

Then type:
<pre>
nano /target/boot/grub/menu.lst
</pre>

The menu.lst file is displayed. Add the following line to the '''top of the file''' to activate the graphical menu ('''do this only if you are using graphical GRUB'''):
<pre>
gfxmenu /boot/grub/message.red
</pre>

The line should be modified to the following if you have a separate partition for '''/boot''':
<pre>
gfxmenu /grub/message.red
</pre>

Replace ''message.red'' with the name of whatever theme you are using.

I needed to make just one more change in my '''menu.lst'''. And that change was: seting the '''# groot''' inside the ''Automagic Defaults Section''.

The groot should point to your boot partition. We already found what our boot partition is using the '''find''' command in ''grub>'' prompt in the previous step. Use that here also. 
<pre>
}}}

An additional change you MAY have to make is setting the '''# kopt=root''' inside the ''Automagic Defaults Section''. I didn't have to do this as it was already set correctly.

Change the <code>kopt=root=</code> setting to /dev/mapper/your_raid_set_root_partition, for instance:
{{{
</pre>

To add a Windows boot option, add this to the end:
<pre>
title Windows
root (hd0,0)
chainloader +1
</pre>
Most of the time, Windows is installed on the first partition, and there's therefore a windows boot sector on (hd0,0). Else, if you know where your Windows boot loader is present, make changes accordingly.

After making all the changes, press ''Ctrl-X'' to exit. Save the file when asked.

''chroot'' back into /target and run <code>update-grub</code> a second time to have the '''# groot''' and '''# kopt''' changes correctly incorporated.

Exit chroot again and open '''menu.lst''' again. This time remove the word '''savedefault''' from the boot stanzas. Or else you will get some "File not found" error preventing you from booting into Ubuntu. Save and exit.

You should be at the shell prompt now.

=== Completing the Installation ===

Type ''exit'' to leave the shell. The ''installer menu'' will be shown again. Now, choose the option that says '''Continue without bootloader'''.

Then the installer completes the installation and reboots.

=== Smoketest ===

Now you should finally be able to boot from the hard drive! GRUB should load and give you a boot menu. Check if all the menu options are working.

=== Installing from the Desktop CD (only if the Alternate Cd way fails) ===
If as me you get some strange errors, no matter what you do, then you can try to install with the Desktop CD.

==== Installing dmraid ====
Start a regular installation, go until the Partitions step. Do NOT touch anything. Instead, open a console with ''CTRL + ALT + F2''.
Configure manually your network using the console so you can have an Internet access. This is necessary.
You can test your internet access using the ''ping''' command.

Then simply do : 
<pre>
}}}
Then now dmraid should be installed !
Continue with the following :
{{{
</pre>
If your RAID array is recognized, then go back to the graphical interface using ''CTRL + ALT + F7''

==== Partition stuff ====
Go back one step of the graphical installation (so you should be in the Keyboard localization step now)
Go again on the Partition step. Choose '''Manual'''.
If your array is listed, then this is a success !
Follow the same recommendations as with the Alternate CD method, regarding the two lists. So mark any of the first list entries with ''Do not use'', and only do some modifications on the second list. Choose to Format your new partitions if available.
Then complete the installation as usual, until the end, but do NOT reboot when prompted ! Or you will have to do all again from the beginning....

==== End of installation ====
When you see the '''Reboot now''' prompt, open a console with ''CTRL + ALT + F2''.
As an information, your new installation is mounted in : /target/
Then install dmraid and grub following the same method as with the Alternate CD, described above (chroot...). Only after this, go back to the UI with ''CTRL + ALT + F7'' and click ''Reboot''.

==== Notes ====
I did this yesterday because I can't get the alternate CD to work. I tried to download the ISO two times, burned it at 2x speed but I get the same failures with two alternate CD :
- Unable to install the ''base package'' : failure at 73%
- Sometimes I was unable to format my swap partition
- Unable to install grub : some various errors 15 and errors 17...

I have a laptop, a FS Amilo Xi 1554. The RAID controller is a via_cdaedhihig. I have windows XP on first partition and I wanted to keep it.
I maybe forgotten to write some steps because I did this yesterday. But if I can do it, you can too ! (I'm very new to Linux, I began two days ago)
Hoping to help the community !
