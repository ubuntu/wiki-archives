{|
  | '''Warning'''
  * This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
  * '''Images''' and '''attachments''' have been removed to conserve space.
  * '''Links''' may not work and there may be formatting issues.
  * A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__


* '''Launchpad Entry''': UbuntuSpec:foundations-karmic-grub2
* '''Created''': ColinWatson
* '''Contributors''': ColinKing, DavidBarth, RobertMillan, and others
* '''Packages affected''': grub, grub2, grub-installer

=== Summary ===

Move to GRUB 2 as the default boot loader.

=== Release Note ===

New installations now use <nowiki>[[http://grub.enbug.org/|GRUB 2]]</nowiki> as their default boot loader. If you still need to use GRUB Legacy for some reason, then add the `grub-installer/grub2_instead_of_grub_legacy=false` option to the kernel command line at installation (press F6 at the CD boot menu) and let us know why!

=== Rationale ===

The traditional version of GRUB, now known as "GRUB Legacy", is no longer supported upstream. The last release (0.97) was made in 2005, and its developers explicitly <nowiki>[[http://www.gnu.org/software/grub/grub-legacy.en.html|state]]</nowiki> that they no longer accept any new features. Unfortunately, GRUB 2 has been in a rather early state of development for many years, and when we have looked at it in the past it has not been feasible to switch to it by default. As a result, in order to support new features such as the ext4 filesystem or moving the distribution to use UUIDs everywhere, we have been compelled to do the work ourselves. Distributions have been gradually diverging in terms of which GRUB Legacy patches they include, and so they all end up with different bugs.

This state of affairs finally appears to be changing. While there are still a few areas where GRUB 2 is not at feature-parity with GRUB Legacy (notably password handling and some issues around default boot options), it now appears to be in a state where the number of regressions is likely to be small enough that we can deal with them feasibly. Meanwhile, GRUB 2 offers new features such as proper EFI support (which is becoming increasingly important as some PC manufacturers begin to switch over to it), video mode support which we could use to integrate smoothly with kernel modesetting, Unicode text display, and others; there is even full support for <nowiki>[[http://grub.gibibit.com/|graphical menus]]</nowiki> under development. Given that the risks look manageable, now is a good time for us to build experience with the new features so that we can confidently deliver them when they are really needed.

=== Design ===

By and large, GRUB 2 appears to be in a reasonably good state now, after a long period when we were unable to seriously contemplate a switch. There are some things to fix, of course, but for the most part these look tractable. The kernel team did extensive <nowiki>[[KernelTeam-Grub2Testing|testing]]</nowiki>, which suggests a strong performance.

=== Implementation ===

==== General issues ====

There are still some minor issues to fix; Ubuntu branding to the configuration file is not quite right.

LVM: Currently GRUB cannot deal with /boot being on LVM, so we need to use LILO in that case. We will check whether GRUB 2 can deal with /boot on LVM (it definitely has code to deal with LVM, so should be a simple matter of configuration), and if so remove the need to ship LILO on our CD images.

XFS: In the past, GRUB had a race condition installing on XFS. This was fixed in GRUB Legacy; ensure that it's fixed in GRUB 2 as well.

EFI/UEFI: We will check support on Intel-based Macs and on x86 PCs with EFI support. (Supply of hardware for the latter case is still rather limited.)

Power``PC: While it is not required for this specification to be considered implemented, it would be useful for Power``PC porters to look at the existing Open``Firmware support and see if we can switch from yaboot. This will need changes in `grub-installer` and `ubiquity`.

==== UI work ====

On systems with multiple operating systems installed, we would like to be able to offer a convenient desktop interface (e.g. via the "Restart..." menu item) to determine which OS will be started at the next boot. GRUB Legacy had `grub-reboot` and `grub-set-default` which could be used for this: `grub-reboot` made a single-shot change, while `grub-set-default` made a permanent change. While GRUB 2 does not quite have this packaged as neatly yet, the primitives are in place (`grub-editenv`, etc.) and it is expected to be simple to put them together. The upstream developers would be interested in integrating this if we beat them to it.

The graphical OS selector is defined as part of this blueprint: <nowiki>[[https://blueprints.edge.launchpad.net/ubuntu/+spec/dx-karmic-os-switcher|dx-karmic-os-switcher]]</nowiki>
The UI portion of it is explained here: <nowiki>[[https://wiki.ubuntu.com/DesktopExperienceTeam/KarmicBootExperienceDesignSpec#Boot%20with%20Graphical%20OS%20Selector|DesktopExperienceTeam/KarmicBootExperienceDesignSpec#Boot%20with%20Graphical%20OS%20Selector]]</nowiki>

At the engineering level, the selector is planned to interact with the system through:
* the format of the boot entries in a grub menu.lst
* or the format of the boot entries in the grub2 menu.cfg files (*)
* the `grub-reboot` command

(*) Note: if both are present, the selector can determine which boot loader is installed by checking whether the `grub` package is installed, or one of the `grub-*` platform packages (excluding `grub-common`); these packages conflict so only one may be installed at once.

By default, we will hide the GRUB menu, but need to make it possible to access it when required by holding down a key. We need to make sure that the key involved is distinct from that used to instruct usplash to show detailed boot output, and also distinct from typical keys used to access firmware setup.

* GRUB Legacy: timeout, interrupted by holding Escape
* PC BIOSes: typical keys include Shift, Delete, and F12, but this is usually accompanied by a message such as "Press Shift to enter CMOS Setup" which disappears before the BIOS is finished, so it is not so important to avoid clashes with this
* Apple Mac: Alt (Option) accesses built-in firmware boot menu; no visual indication of when this should be pressed
* usplash: not implemented yet, so whatever we like

The general consensus appears to be to use Shift to access the GRUB 2 menu, and as reinforced in the UI design spec <nowiki>[[https://wiki.ubuntu.com/DesktopExperienceTeam/KarmicBootExperienceDesignSpec#Bootloader|DesktopExperienceTeam/KarmicBootExperienceDesignSpec#Bootloader]]</nowiki>.

==== Migration ====

(Completion of the tasks identified here is not mandatory for the completion of this specification. We have a migration process already that minimally works, and it is acceptable to consider only new installations as long as we do not actively break the upgrade case. However, improvements here are expected to reduce confusion.)

Although we do not expect to migrate all existing Ubuntu installations to GRUB 2 at this point (upgrading the boot loader being an inherently risky operation), only install it by default for new installations, we would still like to make the upgrade process as smooth as possible. It is already reasonably straightforward thanks to work done by Debian: when you install the `grub-pc` package, you get a "Chainload into GRUB 2" menu item which lets you test whether GRUB 2 will work, and an `upgrade-from-grub-legacy` command that you can run to switch the primary boot loader to GRUB 2.

A smoother approach might be to use GRUB Legacy's `grub-reboot` to arrange to boot into GRUB 2 with zero timeout, and if this works then either use `grub-set-default` to arrange to chainload GRUB 2 by default with zero timeout (cf. http://grub.enbug.org/Hiddenmenu) or run `upgrade-from-grub-legacy`. If we chainload, then GRUB Legacy's stage 1.5 and stage 2 remain integral parts of the boot process, and must not be removed.

Remember that the mapping between Linux device names and GRUB device names in `/boot/grub/device.map` may not be correct. In any migration process, it is important not to rely on this, since that might result in incorrectly overwriting boot sectors that do not already belong to GRUB.

(In the UDS session, we also discussed a problem that was believed to exist whereby `grub` would remove `/boot/grub/menu.lst` on purge. This is in fact not true; it only removes the record of that file in `ucf`, which is fine. This comment is included so that we do not need to have the discussion again!)

=== Test/Demo Plan ===

Significant testing on reasonably recent hardware has <nowiki>[[KernelTeam-Grub2Testing|already been performed]]</nowiki>, but testing on older hardware will be important. Some ideas for this include:

 - Canonical's hardware certification farm
 - Xubuntu community may well have more legacy hardware
 - close coordination with Debian (expected to move to GRUB 2 for Squeeze)
 - further promulgation of <nowiki>[[KernelTeam-Grub2Testing]]</nowiki>

=== See also ===

Previous (misnamed) specification in this series: <nowiki>[[FoundationsTeam-Specs-Grub2ByDefault]]</nowiki>

<nowiki>[[KernelTeam-Grub2Testing|Kernel team testing page]]</nowiki>

----
CategorySpec
