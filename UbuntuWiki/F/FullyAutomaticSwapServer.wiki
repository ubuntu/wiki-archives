{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__

* '''Launchpad Entry:''' UbuntuSpec:fully-automatic-swap-server
* '''Created:''' 2006-02-24 by OliverGrawert
* '''Contributors:''' OliverGrawert, RodrigoNovo, ScottBalneaves
* '''Packages affected:'''
	nbd-server
	nbd-client

=== Summary ===

To support older, low memory diskless clients, network based swap service is needed to make booting and running possible. Ubuntu LTSP supports nbd (Network Block Device) swapping through the nbd-server and nbd-client packages. Currently these packages need manual setup to work with LTSP.  We need to modify these packages to eliminate this manual intervention. Work is also needed to integrate LTSP changes on nbd-server into upstream.

=== Rationale ===

There are a lot of older machines out there, and one of the huge selling points of any thin client GNU/Linux solution will be to use existing hardware that's unable to be used with other operating systems. Developing countries, schools, non-profits, and cost-conscious companies will all be interested in taking advantage of hardware they already own.
Beyond the usage of LTSP, this implementation can indeed be used in other context as well, it might be helpful for netbooted computing clusters or even just to make Ubuntu work on another low memory machine in your local network.

Current Ubuntu LTSP needs a minimum of 48MB to boot. To support lower specced thin clients a form of swapspace is required. Our minimum workstation memory configuration that we want to be able to support should be 32 Megabytes, as a lot of school machines from the late 1990's are configured with this amount of ram.  Being able to support this level of machine would make Edubuntu a viable classroom alternative.

=== Use Cases ===

William has an old lab with a bunch of old Pentium 120's with 32 megabytes of memory. He's been informed that to upgrade his current operating system that he bought in 1998, to the current one will be both expensive and painful, as it will require him to replace all of his lab machines. However, he hears about Edubuntu on Slashdot, and downloads a CD, and within an hour, he's got it installed on a spare file server. He shows his boss the shiny new lab with great educational software without having to upgrade a single workstation's memory, or buy a software license.

Hans is working on an embedded thin client kiosk solution to be used in homeless shelters in a developing country. Money's tight, being a startup, and the kiosk portal's a web based solution, but he needs something to power the minimal kiosk machine, thanks to the fully automatic swap server his 32MB embedded clients will work right away with Ubuntu LTSP.

Wilma's husband has a home network with several PCs. To give Wilma an opportunity to have her own PC, he assembled a machine from his spare parts with a harddisk that is just able to carry Xubuntu on the disk. Instead of loosing valuable diskspace on this machine, Wilma's husband just installed nbd-server on his powerful machine and nbd-client on his wifes PC now the low profile machine will just use swap space on the powerful one.

=== Design ===

==== Server: ====

* The nbd-server needs to be modified to automatically create a swapfile on the fly if a client connects to it, and requests swap space in the form of a network block device.  This will be optional behavior, and will be implemented as a command line option (nbd in LTSP will be exclusively used for swapping, so switching it to a swap only mode is fine in that case). If nbd-server is run through inetd with this specific commandline option for enabling autocreation of files, a swap client can connect right away without any initial work on the system administrators work to pre-create swap files for the exported block devices.
* The nbd-server package should get assigned a default port in /etc/services for ubuntu (there seems to be no standarization on a specific port yet, ltsp.org uses 9210 for their swapd). This will make easy inetd integration possible.
* Code needs to be added to nbd-server to clean up the swap files after the connection is done.
* The authentication mechanism of nbd-server should get enhanced to support the authentication of subnets instead of doing single host only authentication.
* These modifications have already been done by LTSP.  Work needs to be done to make this feature optional during nbd-server startup, code needs to be checked and cleanep up, and finally, sent upstream.

==== Client: ====

* Through the standatization on one port, a wrapper or even a code enhancement to nbd-client for server autodetection would be possible. 
* The client could get either a non blocking wrapper in the initscript that sends a broadcast ping to determine available hosts, and then checks these hosts for nbd service availability or it could get a directly implemented commandline option (which would most likely bloat the client code a bit) that achieves the same. 
* The initscript of nbd-client should also see enhancement to use mkswap and swapon automatically to create a clean swapspace in case a "swap" option is set in the nbd-client configuration.

=== Implementation ===

* Check out ltspswapd from the LTSP project.  Check and see if this meets Ubunutu's needs.
* Integrate ltspswapd changes into nbd-server proper (from where it has branched)
* Make swap partition creation optional (via command line startup option)
* Send changes upstream

=== Ideas / Possible goals for Edgy + 1 ===

* Research options to transparently encrypt network traffic between nbd-server and nbd-client (possibly using stunnel or OpenSSL directly from nbd)
* Avahi support (although, this is quite insecure for swap)
* Implement valid-client-list, to prevent DoS and untrusted clients from connecting
* Implement connection throttling, as an optional feature (to prevent DoS on the swap server)
* Implement suport to public/private key exchange during client authentication (again, possibly using OpenSSL), to keep untrusted clients from connecting

=== Comments ===

* In Mille-xterm, implementation was done using xinetd, that calls a python script before running the nbd server. The script prepare the swap for the client, and then lunch nbd-server. Each connection has it's own instance of nbd-server. The inconvenient is that swap files are not cleaned when a connection is closed. 

=== Updates ===

* Fix to get things exactly the way we want: nbdswapd works perfectly, we just need to add the SO_KEEPALIVE socket option to get it to clean up after itelf if the client goes away uncleanly.  This can be done by adding the line:

<pre>
nbdswapd: ALL: keepalive
</pre>

to the file <code>/etc/hosts.allow</code>  -- ScottBalneaves

----
CategorySpec
CategoryEdubuntuSpec
