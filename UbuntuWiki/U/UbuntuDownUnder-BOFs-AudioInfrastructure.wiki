{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__

== Audio Infrastructure ==

=== Status ===

** Created:  by MattZimmerman<<BR>>
** Priority: HighPriority <<BR>>
** People: MartinPittLead, FabioDiNittoSecond<<BR>>
** Contributors: MattZimmerman, PaulSladen<<BR>>
** Interested: JimMcQuillan <<BR>>
** Status: EditedSpecification, BreezyGoal, DistroSpecification, MattZimmermanQueue<<BR>>
** Packages: <<BR>>
** Depends: <<BR>>
** UduSessions: 2(0)<<BR>>

=== Introduction ===

This specification discusses the audio backend for Breezy and the issues about polypaudio, which we want to reconsider in some weeks when some bugs were fixed. In addition, we introduce the possibility of changing the default sound device.

=== Rationale ===

Thin client implementations will often be in environments like schools in which multimedia is very valuable. We need to make Ubuntu able to bring sound to those terminals! Also, there is currently no way to select the default device if a user has more than one sound card installed (see <nowiki>[[https://bugzilla.ubuntu.com/show_bug.cgi?id=1351|bug #1351]]</nowiki>).

=== Scope and Use Cases ===

** Users might have more than one audio card and they need to be able to sanely configure the default.

** There are plenty of hotpluggable audio devices from webcams, to headphone sets or real audiocards. If the user plugs in a new audio device, he should be asked whether do make this the default sound device (this is suitable for real USB sound cards, but not suitable for headphones, therefore the question is necessary).

** Not all applications can use esd (specially games and skype).

** Remote audio - LTSP clients with sound apps running on the server.

** A user should be able to test the configured audiocards. Many trouble reports can be tracked down to wrong mixer settings or wiring.

=== Implementation Plan ===

* Enable dmix in ALSA by default for known-to-work cards (requires black/white list), since some drivers are known to be broken with dmix.

* Switch from `libesd0` to `libesd-alsa0` so we don't block the single OSS device. Keeping the esd API will allow us a smooth transition.

* Investigate Red Hat dmix hacks that might be worth importing to our environment. (MartinPitt: all bug fixes are in upstream 1.0.9; in FC4 there is an extension "ainit" that automatically creates system configuration files triggered by pam_console; this looks inappropriate for Ubuntu).

* Non-esd apps should be able to use ALSA with dmix (that should be the majority).

* Evaluate the results of the above changes.

* Later in the process switch gstreamer default sink from esd to alsa if dmix works reliably.

* Investigate option to hack ALSA's OSS emulation to support opening `/dev/dsp` multiple times and route it through dmix since OSS is deprecated, but many commercial apps still use it (Fabio will look at the kernel level).

* Parallel to the above activities, another group of people will keep working on polypaudio to fix some bugs (see below). If the integration can be done smoothly, we will evaluate replacing esd by polypaudio again.

* Handle sound card related hotplug events.

* Offer an interface to select the default device.

==== Data Preservation and Migration ====

* The packaging system allows us to smoothly move from esd-oss to esd-alsa (and from esd to polypaudio) by changing dependencies of `ubuntu-desktop`.

==== Packages Affected ====

`hal`:
* Sound devices generate a hotplug event; hal already picks up PCI/USB devices, but not mac-io ones; MartinPitt will evaluate the possibility to support mac-io devices in hal.
* hal allows us to connect an applet to dbus.
* We have a patched kernel to have a fixed index for devices (also upstream now)

`polypaudio`: 
* Erik de Castro Lopo will fix some further bugs in polypaudio, and Fabio will upload the new kernel soon. After that (in about two weeks) we again evaluate the maturity of polypaudio since it offers a much cleaner implementation and much better networking support.

`esd`/`polypaudio`:
* esd or polypaudio needs a possibility to reload the ALSA configuration in `~/.asoundrc` after it was changed (SIGHUP or any other unused signal). The signal should be sent either by the applet or the sound config.

==== User Interface Requirements ====

Configuration program:
* We need to extend System/Settings/Audio to allow to select the default audio device.
* The list of available devices can be obtained by executing `aplay -l` or by looking at `/proc/asound/devices`.

Hotplug response:
* `hal` detects new sound cards and sends out notifications over dbus.
* We write an `event-notifier` plugin which listens to sound card related dbus events. 
* On a hotplug add event, a dialog should appear asking whether to make this device the default and offer to set the mixer levels. 
* On a hotplug remove event, make the previously used sound card the default.
* The default device is configured in `~/.asoundrc` (unless this was modified by a user and we cannot modify it automatically any more).
* We do not store/restore mixer levels for hotplugged devices.

Alsa mixer:
* There should be the option to output a test beep and a capture test. If those fail, the user should get some suggestions what to check (mixer settings, correct wiring).

----
CategoryUdu
CategorySpec 
