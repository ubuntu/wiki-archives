{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work.
* A '''full compressed version''' of the wiki is available on archive.org
|}

__TOC__

== Google Maps implementation for Ubuntu-django-foundations ==

Blueprint: <nowiki>[[https://blueprints.launchpad.net/ubuntu-django-foundations/+spec/maps-jquery-plugin]]</nowiki>

Download: <nowiki>[[attachment:jquery-ubuntu-maps-0.2.4.js]]</nowiki>

Required js libraries:
* jQuery
* jquery-tmpl (only if templates are used)
* Google maps
* markerclusterer
<pre>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://github.com/jquery/jquery-tmpl/raw/master/jquery.tmpl.min.js"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&language=en&region=US"></script>
    <script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/tags/markerclusterer/1.0/src/markerclusterer_packed.js"></script>
</pre>

The plugin consists of 2 commands e.g.
<pre>
$('map-element').selectLocation({ params })
$('map-element').showLocations({ params })
</pre>

Both commands with their parameters and uses will be exmplained below

=== selectLocation ===
Allows the user to add a marker to the map.

There are 3 methods to add/move a marker on the map:
# By clinking an empty space on the map
# By changing the <input> elements that represents the latitude and longitude
# By changing the <input> elements that is a representation of the address

----
==== html_lat and html_lng ====
''The HTML <input> element that represents the latitude and longitude of the marker e.g.''

'''Default'''

<pre>
null
</pre>
''maybe change this to `#id_lng` ''

'''Example'''

HTML
<pre>
<input type="text" id="id_lat" name="lat" value="0.353452" />
<input type="text" id="id_lng" name="lng" value="0.435323" />
</pre>
Javascript
<pre>
$('map-element').selectLocation({ html_lat: $('#id_lat'),
                                  html_lng: $('#id_lng') });
</pre>

'''Specification'''
* When the input already contains data on init, place the marker on the map
* When the data in the inputs is changed, move the marker to that position and center the map at the marker
* When the marker is moved, change the values in the input elements to the coordinates of the marker
* When the inputs are emptied, remove the marker from the map

----
==== marker_icon ====
''The url of the icon that is displayed as marker.''

'''Default'''
<pre>
/media.icons/marker.png
</pre>

'''Example'''
<pre>
$('map-element').selectLocation({ marker_icon: '/media/icons/my_marker.png' });
</pre>

'''Specification'''
* If no marker is specified, use the default marker (supplied by this module)
* If the default marker is not found, use the google default

----
==== html_addr ====
''The HTML <input> elements where the adress is specified''

See <nowiki>[[http://code.google.com/intl/nl/apis/maps/documentation/javascript/services.html#Geocoding| the google api]]</nowiki> for more information

'''Default'''
<pre>
null
</pre>

'''Example'''

HTML
<pre>
<input type="text" id="id_country" name="country" />
<input type="text" id="id_city" name="city" />
<input type="text" id="id_address" name="address" />
</pre>
Javascript
<pre>
$('map-element').selectLocation({ html_addr: $('#id_country, #id_city, #id_address') });
</pre>

'''Specification'''
* If one of the input elements is changed, lookup the address in the google database, and move the marker to that location, and center the map at the marker
* If multiple locations are returned, use the first one
* If the marker is moved, do nothing

=== showLocations ===
''Shows multiple markers on the map. The markers cannot be changed position. When clicked on the marker, it can (if specified) show some HTML content with information about that marker. If there are many markers and zoomed out, the markers are clustered to save some CPU power. When zoomed in, the cluster is separated into single markers. Clicking on a cluster shows the markers in it (max 10).''

----
==== marker_icon ====
''The url of the icon that is displayed as marker.''

'''Default'''
<pre>
null
</pre>

'''Example'''
<pre>
$('map-element').showLocations({ marker_icon: '/media/icons/my_marker.png' });
</pre>

'''Specification'''
* If no marker is specified, use the default marker (supplied by this module)
* If the default marker is not found, use the google default

----
==== markers_url ====
''A list of markers, from url OR a predefined list''

'''Default'''
<pre>
null
</pre>

'''Example'''
<pre>
$('map-element').showLocations({ markers_url: '/map/locations/all/'  });
</pre>

'''Specification'''
The URL should return:
<pre>
[{lng:<float>, lat:<float>},
 {lng:<float>, lat:<float>}
 ...]
</pre>
or (specially for django)
<pre>
[{pk: <int>, fields: {lng:<float>, lat:<float>}},
 {pk: <int>, fields: {lng:<float>, lat:<float>}},
 ...]
</pre>

Additional information can be added to fields.

The JSON can be easily created by the django function:

'''Example'''
''models.py''
class MyModel(models.Model):
<tab>lat = models.FloatField()
<tab>lng = models.FloatField()

''views.py''
from django.core import serializers
data = serializers.serialize('json', MyModel.objects.all(), ensure_ascii=False)
return HttpResponse(data, mimetype="application/json")

----
==== markers_list ====
''A list of markers in json format''

'''Default'''
<pre>
null
</pre>

'''Example'''
<pre>
$('map-element').showLocations({ markers_list: [ {lat: 0.345, lng: 0.3456}, 
                                                 {lat: 44.345, lng: 34.3456} ] });
</pre>

==== position_name ====
''If your json file does not contain 'lat' and 'lng' but uses other names for these fields, you can specify yhe names here''

'''Default'''
<pre>
{ lat: 'lat', lng: 'lng' }
</pre>

'''Example'''
<pre>
$('map-element').showLocations({ position_name: { lat: 'latitude', lng: 'longitude' } });
</pre>

The JSON data provided by markers_url or markers_list should then looks like
<pre>
[ { latitude: 0.345, longitude: 0.3456}, 
  { latitude: 44.345, longitude: 34.3456} ]
</pre>

==== marker_content_url ====
''The content that need to be displayed when clicked on a marker, loaded with an url''

'''Default'''
<pre>
null
</pre>

'''Example'''
<pre>
$('map-element').showLocations({ marker_content_url: '/marker/user/${user}/${username}/' });
</pre>

The part ${user} and ${username} are replaced by the values of the marker
<pre>
{ lat: 45.3245, lng: 23.4563, user: 1, username: 'myname' }
</pre>
is translated to te url '/marker/user/1/myname/'

'''Specification'''
* each ${...} is replaced in the url by the value of the marker
* while the request is loading, the loading infowindow is displayed (icon: '''ajax_load_icon''')
* if the url does not exists, the text from '''ajax_load_error''' is displayed
* When the request is successfull loaded, the contents are shown in the infowindow

==== marker_content_tmpl ====
''If all the values you want to display are in the marker itself, this function can be used to translate the marker data into a nice template''

'''Default'''
<pre>
null
</pre>

'''Example'''
<pre>
$('map-element').showLocations({ marker_content_tmpl: '/path/to/template.tmpl' });
</pre>

The template file should look something like this:
<pre>
<script id="markerTemplate" type="text/x-jquery-tmpl"> 
    <div>
        <p>UserId: ${ marker.user }</p>
        <p>Username: ${ marker.username }</p>
        <p>other param: ${ marker.other }</p>
    </div>
</script>
</pre>

The JSON data provided by markers_url or markers_list should then looks like
<pre>
[ { latitude: 0.345, longitude: 0.3456, user: 1, username: 'myname', other: 'blablabla' }, 
  { latitude: 44.345, longitude: 34.3456, user: 2, username: 'anothername', other: 'not important' } ]
</pre>

----
==== user_location_zoom ====
''Uses the HTML5 geolocation to determine the location of the user. If the value is '''null''' this behaviour is disabled''

See the <nowiki>[[https://developer.mozilla.org/En/Using_geolocation|Mozilla developer page]]</nowiki> for more information

'''Default'''
<pre>
7
</pre>

'''Examples'''
<pre>
$('map-element').showLocations({ user_location_zoom: 9 });
$('map-element').showLocations({ user_location_zoom: null } });
</pre>

'''Specifications'''
* If the value is not 'null' use the HTML5 to determine the location of the user, then set the map's center to that location
* Adapt the zoomlevel to the specified zoomlevel

==== single_marker_zoom ====
''The zoomlevel for the map when there is only one marker on it. Use '''null''' to disable this future''
'''Default'''
<pre>
7
</pre>

'''Example'''
<pre>
$('map-element').showLocations({ single_marker_zoom: 9 });
$('map-element').showLocations({ single_marker_zoom: null });
</pre>

'''Specification'''
* If true and there is only one marker, zoom in and center that marker.
* If false, leave the zoom to the default settings

==== ajax_load_error ====
''The error that is shown when the remote page could not be loaded''

'''Default'''
<pre>
'<p>The page could not be loaded</p>',
</pre>

'''Example'''
<pre>
$('map-element').showLocations({ ajax_load_error: '<p>Contact the site admin, the page could not be loaded</p>' });
</pre>

==== ajax_load_icon ====
''The url of the icon that is shown when an ajax call is executed''

'''Default'''
<pre>
'/ubuntu-website/media/images/ajax-loader.gif'
</pre>

'''Example'''
<pre>
$('map-element').showLocations({ ajax_load_icon: '/path/to/icon.gif' });
</pre>

==== cluster_tmpl ====
''The link to the template that is shown when someone clicks on a cluster''

'''Default'''
<pre>
null
</pre>

'''Example'''
<pre>
$('map-element').showLocations({ cluster_tmpl: '/path/to/template.tmpl' });
</pre>

The template should look like this. '''marker_list''' is the list of markers. From here the attributes of the marker can be used.
<pre>
<script id="clusterTemplate" type="text/x-jquery-tmpl"> 
    <div>
        <ul>
            {{each marker_list.slice(0, 10)}}
            <li>${ user } - ${ is_support }</li>
            {{/each}}
        </ul>
        {{if marker_list.length > 10}}
        <p>and ${ marker_list.length - 10 } more</p>
        {{/if}}
    </div>
</script>
</pre>

==== filter ====
''A filter object for displaying the right markers, which filter on the attributes of the marker''

'''Default'''
<pre>
null
</pre>

'''Example'''
<pre>
$('map-element').showLocations({ filter: [ { element: $('#filter-programmers'), attrs: { program: true },
                                           { element: $('#filter-support'), attrs: { support: true },
                                           { element: $('#filter-none), attrs: {} ] });
</pre>
This example has 2 filters (programmers and support), the last one shows all the markers (no filtering)

The element should be a jQuery DOM element (button to click on, for triggering the filter)
<pre>
<a href="javascript:void(0);" id="filter-programmers">Programmers</a>
<a href="javascript:void(0);" id="filter-support">Support</a>
<div id="filter-none">Show all</div>
</pre>

The markers should have the attibutes '''program''' and '''support'''

'''Specification'''
* When clicked on a 'filter-button' the markers that dont apply to the filter wil be hidden
* When no attrs are supplied, all the markers will be visible

=== Full Example 1 (showLocations) ===
==== models.py ====
<pre>
class Marker(models.Model):
    user = models.ForeignKey(User)
    lat = models.FloatField()
    lng = models.FloatField()
</pre>

==== views.py ====
<pre>
from django.core import serializers
from django.contrib.auth.models import User
from django.shortcuts import get_object_or_404
from models import Marker

def show_all_markers(request):
    data = serializers.serialize('json', Marker.objects.all(), ensure_ascii=False)
    return HttpResponse(data, mimetype="application/json")

def marker_html(request, userId):
    user = get_object_or_404(User, pk=userId)
    return render_to_response('templatename.html', {'user':user})
</pre>

==== urls.py ====
<pre>
    url('^map/markers/all', 'app.views.show_all_markers', name='map-markers-all'),
    url('^map/marker/user/(?P<user>\d+)/', 'app.views.marker_html', name='marker_html'),
</pre>

==== HTML ====
<pre>
<html>
<body>
    <section id="mymap">
    </section>
</body>
</html>
</pre>

==== CSS ====
<pre>
</pre>

==== Javascript ====
<pre>
$(function(){
    $('#mymap').showLocations({ markers_url: '{% url map-markers-all %}',
                                marker_content_url: '/map/marker/user/${user}/',
                                marker_icon: '{{ MEDIA_URL }}icons/marker.png' });
});
</pre>

=== TODO ===
* Allow Cluster options
* Multiple different clusters
* Reloading markers
* Filter markers on attribute
