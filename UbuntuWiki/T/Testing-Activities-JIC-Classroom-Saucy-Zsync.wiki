{|
  | '''Warning'''
  * This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
  * '''Images''' and '''attachments''' have been removed to conserve space.
  * '''Links''' may not work and there may be formatting issues.
  * A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__


== Zsync ==

Zsync is a tool to allow updating a changing ISO image file, such as the daily ISO images of Ubuntu produced during testing, without having to download the whole new file each time.

It works by tracking what has changed within the file and only downloading the changed parts, saving a lot of bandwidth (and time).

=== Basic Usage ===

Install the zsync package in the usual way:

<pre>
sudo apt-get install zsync
</pre>

Zsync uses files containing checkums of each small part of the file.  For Ubuntu ISOs, these are found in the same place as the ISO files themselves, and end in .zsync .  For example, look at the list of files at <nowiki>[[http://cdimage.ubuntu.com/lubuntu/daily-live/current/]]</nowiki> and notice those ending in .zsync .

You can cut and paste the link to one of these files into a shell, as the parameter to the zsync command, for example

<pre>
zsync http://cdimage.ubuntu.com/lubuntu/daily-live/current/saucy-desktop-i386.iso.zsync
</pre>

This will download a file called saucy-desktop-i386.iso  and if you use that same command the next day, it will update that file to the new daily ISO image.

=== Checking the date of an ISO image ===

To find out which day's image a file on your machine <code>saucy-desktop-i386.iso</code> (for example) really is, you can
use the isoinfo command in a small script called <code>iso-date.sh</code>, below.  Save it on your <code>$PATH</code> and run <code>chmod +x iso-date.sh</code> so it is executable, and then

<pre>
iso-date.sh saucy-desktop-i386.iso
</pre>

will display the date of the MD5SUM.TXT file in that ISO image, for example you will see output like

<pre>
Jun 17 2013
</pre>

Here is the very short script:

<pre>

if [ -z "$1" ];
then
  echo "$0: Usage is $0 ISOfilename"
  exit 1
fi

LANG=C isoinfo -l -i "$1" |grep MD5SUM.TXT | \
  sed -e 's/^[0-9 -]\+//g' -e 's/\[.*$//'

</pre>

=== Keeping A Few ISOs around ===

In practice the above approach, although workable and a big advance on downloading the whole ISO image every single day (!), is not always what you would really like.  It makes it hard to know exactly which days image the local file really is, and it does not keep any older versions, making it hard to go back a few days and try an older one to see if a problem is "new", or exactly when it was introduced -- information that can be very valuable to developers.

Therefore, it makes good sense, if you are doing ISO testing, to keep a few of these ISOs around, perhaps a week or two worth, and keep them named so it is clear which date each one is for to avoid confusion.  You could do this by hand, but Linux is better at doing boring repetitive tasks reliably than most humans are... so it is better to let Linux do the work of maintaining the collection of images for you.

One suggested approach is to start with the simple command format described above to get the first daily image needed, and manually rename it to include both the flavour of Ubuntu (in the example above, Lubuntu) and the date, for example

<pre>
mv saucy-desktop-i386.iso lubuntu-saucy-desktop-i386-$(date +%Y%m%d).iso
</pre>

Then, you can run the a command like the following one, to use yesterday's image as a source of data when downloading today's image, and keep the image files named appropriately with dates in them in YYYYMMDD format:

<pre>
zsync -i lubuntu-saucy-desktop-i386-$(date -d yesterday +%Y%m%d).iso \
-o lubuntu-saucy-desktop-i386-$(date +%Y%m%d).iso \
http://cdimage.ubuntu.com/lubuntu/daily-live/current/saucy-desktop-i386.iso.zsync
</pre>

You can put this command in a file <code>get-daily.sh</code> and make it executable with <code>chmod +x get-daily.sh</code> and put it somewhere on your <code>$PATH</code>, perhaps in <code>/usr/local/bin/</code> and then you can just type

<pre>
get-daily.sh
</pre>

each day to get that day's ISO image using zsync.

=== Deleting Old Unwanted Daily ISOs ===

The only remaining issue is that your collection of daily ISOs will grow forever, until you run out of disk space!  To solve this, you need to decide where the collection of ISOs will be kept, such as <code>/usr/local/isos/daily/</code> and then you can delete image files older than 14 days from that directory if there are more than 14 images in there.

<pre>

ISODIR=/usr/local/isos/daily # Where the ISO files are stored
ISONAMEPREFIX=${1:-lubuntu-saucy-desktop-i386} # First part of filename
DAYSTOKEEP=14 # How many days worth of ISO files to keep

[ -d "$ISODIR" ] || exit 1
find "$ISODIR" -type f -name "$ISONAMEPREFIX*.iso" -mtime +$DAYSTOKEEP |head -n -$DAYSTOKEEP |xargs rm
</pre>

Putting a symbolic link to this script in <code>/etc/cron.daily/</code> so it runs every night might be a good way to keep your collection of daily ISO files neat and tidy.  You can also schedule <code>get-daily.sh</code> that way too, if your machine is always connected to the Internet, so your collection of daily ISOs is maintained fully automatically while you sleep!
