{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__

== Monitor/Display video mode detection ==

One of the places that seems to be causing auto-detection headache (and will continue to cause auto-detection headache) is the area of selecting a resolution and refresh frequency for the frame-buffer and monitor.  The reason that this area is so fraught is that you can destroy hardware and/or render the display unoperable by the user, meaning that they may not be able to undo the change that either the installer or the user initiated.

A lot of work has been done in this area.  The following approaches are possible:

Laptops with internal display:

** LCD Chip detection to extract physical aspects of attached screen.

External TFT, External CRT (''Monitor''), Laptop external VGA:

** DCC (''Display Combination Code''), Computer <-> Monitor signalling protocol

Generally, the desired outcome is:

** TFT: ''Native resolution, lowest refresh rate (60Hz)''
** CRT: ''Highest resolution, highest refresh at that resolution''
** (Old Apple and Sparc systems have additional signalling pins).

There are limits on cards too, however in most cases these exceed the capability of the monitor or display they are driving.

=== But it doesn't work... ===

Sometimes, all that auto-detection just doesn't work, for instance if the attached monitor does not support DCC, it is not possible interrogate the screens abilities.  In this case, the default would to normally  fallback to 640x480@60Hz, or better still, ask.  This is what happens.

=== Incumbent Detection ===

Frequently, the machine that Ubuntu is being installed upon will have had a previously setup Operating System.  Perhaps an existing installation of a GNU/Linux distribution (particularly those trying out several distributions), Apple MacOS, or one of several versions of Microsoft Windows.  With analysis of the existing installation, it is possible to find out what Video modes that operating system might been running in.  In the case of a brand-new computer this is probably the best possible data as the complete system, including the monitor, will have been configured as one when it was purchased.

The place ''not'' to use this gleaned information is when a user is {re,}installing Ubuntu.  One of the reason the user maybe re-installed, is if they have a broken X setup (...perhaps even caused by Ubuntu); and there would be no point in copying this!

Perhaps the following would be a way to integrate this information into detection pipeline as just another source to add into the mix.  If nothing else, it could be used as an initial hint if the user needs to be asked:

<pre>
if dccprobe() or xresprobe() or macdect():
    print "Auto detection worked!"
else:
    if incumbentprobe():
        modes.preseed(incumbentprobe())
    else:
        print "Please select from the list"
        modes.ask()
</pre>

=== Language / Keyboard layout ===

A similar option could be used to pre-hint the default selections for Language and Keyboard settings.  Whilst it is desirable to have Ubuntu detect as much as possible itself, there's no point throwing away good information that could be added to the mix to help minimise questions.

Perhaps the default computer and usernames could be filled in, if detected from elsewhere.  Though seeding these may seem a little more hairy.

A final case, might be statically configured network interfaces.

=== How!? ===

Well, here comes the fun bit.  Remember that, in the case of wiping the hard-drive, any incumbent probing has to be done before the disk is reformatted!

=== Microsoft Windows XP ===

This operating system uses the concept of ''The Registry'', a hierarchical binary tree containing Strings, Integers and free-form binary fields, plus references/links to other parts of the tree.  The full tree is built up from multiple individual registry files called ''hives'';  for instance, the Local preferences for this machine and User-specific data pulled down across the network are merged depending on who's logged in.

Change NT Password ('''chntpw''') is a program primarily used for resetting or overriding lost administrator account passwords.  '''chntpw''' also includes a generic ''regedit'' style mode;  this is  used for the following proof-of-concept tests:

Frequent references to '''HKEY_CURRENT_CONFIG''' appear, this is in fact a pointer to one of '''HKEY_LOCAL_MACHINE/Control/ControlSetXXX'''.  That in turn is actually the contents of the hive in '''/WINDOWS/system32/config/SYSTEM''' mounted on '''Control'''.  Confused?  Let's see an example:

<pre>
$ sudo apt-get install chntpw
$ sudo mount /media/windows-xp
$ cd /media/windows-xp/WINDOWS/system32/config/
$ /usr/sbin/chntpw -e SYSTEM

[1020] > ?
Simple registry editor:
hive [<n>] - list loaded hives or switch to hive numer n'
cd <key> - change key
ls | dir [<key>] - show subkeys & values,
cat | type <value> - show key value
st [<hexaddr>] - show struct info
nk <keyname> - add key
dk <keyname> - delete key (must be empty. recursion not supported yet)
ed <value>            - Edit value
nv <type> <valuename> - Add value
dv <valuename>        - Delete value
delallv               - Delete all values in current key
debug - enter buffer hexeditor
q - quit

[1020] > ls
ls of node at offset 0x1024
Node has 7 subkeys and 0 values
offs          key name
[  1188]   <ControlSet001>
[1280b8]   <ControlSet002>
[ 191a8]   <MountedDevice1>
[27f950]   <MountedDevices>
[124870]   <LastKnownGoodRecovery>
[124e80]   <Select>
[124f58]   <Setup>
</pre>

==== Video Modes ====

I eventually tracked down the interesting information about Video modes in:
<pre>
[1020] > cd ControlSet001\Control\Class\{4D36E96E-E325-11CE-BFC1-08002BE10318}\0002\
[118f0] (...)\{4D36E96E-E325-11CE-BFC1-08002BE10318}\0002> ls
ls of node at offset 0x118f4
Node has 1 subkeys and 10 values
offs          key name
[ 11c48]   <MODES>
offs        size      type   value name                    [value if type DWORD]
[ 1194c]     24  REG_SZ            <PreferredMode>
[ 11974]      4  REG_SZ            <DPMS>
[ 11994]     24  REG_SZ            <InfPath>
[ 119d4]     38  REG_SZ            <InfSection>
[ 11a44]     20  REG_SZ            <ProviderName>
[ 11a84]      8  REG_BINARY        <DriverDateData>
[ 11acc]     18  REG_SZ            <DriverDate>
[ 11af4]     22  REG_SZ            <DriverVersion>
[ 11b64]     32  REG_SZ            <MatchingDeviceId>
[ 11bb4]     60  REG_SZ            <DriverDesc>

[118f0] (...)\{4D36E96E-E325-11CE-BFC1-08002BE10318}\0002> cat PreferredMode
Value <PreferredMode> of type REG_SZ, data length 24 [0x18]
1024,768,60
</pre>

This is correct ('''1024,768,60''') for my ThinkPad Laptop as it came delivered running the OS in question.  Note that 128bit UID appears to be 'random', this can just be grepped over and the then checked for the '''Class=="Monitor"''':

<pre>
[11020] (...)\{4D36E96E-E325-11CE-BFC1-08002BE10318}> cat Class
Value <Class> of type REG_SZ, data length 16 [0x10]
Monitor
</pre>

Note also that my laptop also throws up other "Monitors", the following is presumbly the S-Video TV-Out:

<pre>
[115c8] (...)\{4D36E96E-E325-11CE-BFC1-08002BE10318}\0001> cat DriverDesc
Value <DriverDesc> of type REG_SZ, data length 38 [0x26]
Generic Television

[115c8] (...)\{4D36E96E-E325-11CE-BFC1-08002BE10318}\0001> cat MaxResolution
Value <MaxResolution> of type REG_SZ, data length 16 [0x10]
640,480
</pre>

...and this the external VGA port with as-yet-undetected monitor attached;  but specified with the hardware (video card) limits:

<pre>
[2d5058] (...)\{4D36E96E-E325-11CE-BFC1-08002BE10318}\0004> cat DriverDes
Value <DriverDes> of type REG_SZ, data length 44 [0x2c]
Plug and Play Monitor

[2d5058] (...)\{4D36E96E-E325-11CE-BFC1-08002BE10318}\0004> cat Max
Value <Max> of type REG_SZ, data length 20 [0x14]
1600,1200
</pre>

There's also some hints as to what video driver was in use:

<pre>
\ControlSet001\Control\Video\*\0000\InstalledDisplayDrivers = "ialmdnt5"
\ControlSet001\Control\Video\*\0000\InstalledDisplayDrivers = "Intel(R) 82830M Graphics Controller-0"
</pre>

=== Mac OS X ===

A list of display modes is kept in /Library/Preferences/com.apple.windowserver.plist, under the plist key DisplaySets. Width and height are stored there; depth seems to be an index into some list elsewhere, since I'm reasonably certain my monitor isn't currently running 4-bit video. Refresh rate is under the key "RefreshRate16.16", which holds the refresh rate multiplied by 2^16. There's an CGSInterocitorSelectMode key also in that file, which may or may not be the current index--next time I'm booted into MOL I'll check, since MOL seems to use its own display config.

The keys DisplayID, DisplayVendorID, DisplaySerialNumber, DisplayProductID and IODisplayLocation can presumably help discovering whether the current monitor is the same one referred to in the windowserver prefs, but I have no idea where one can find a table of IDs to something meaningful. However, /System/Library/Displays/Overrides registers overridden settings (IE: if someone enables rsolutions normally not accessible), and uses the same ID system.

=== Todo ===

To be continued.

PaulSladen 2004-09-20/21
