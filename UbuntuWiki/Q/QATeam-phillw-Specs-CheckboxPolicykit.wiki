{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__

* '''Launchpad Entry''': <nowiki>[[https://blueprints.edge.launchpad.net/checkbox/+spec/qa-checkbox-policykit|qa-checkbox-policykit]]</nowiki>
* '''Created''': 2008-12-05
* '''Contributors''': schwuk
* '''Packages affected''': checkbox

=== Summary ===

Checkbox currently runs completely as root which is not appropriate default behaviour for most end-user cases. Ideally privileges should be elevated only where there is a specific need as defined in the test.

=== Rationale ===

Although running Checkbox through sudo has allowed us to work around permission related issues, this provides a "tainted" result as well as potentially exposing system vulnerabilities. The latter in particular will become more of a concern as we extend test coverage and incorporate community tests.

Ideally unless we are testing functionality or performing actions that requires root permissions, then all tests should be performed as the current user.

This will also allow us to address current issues with integrating LDTP/desktop tests into Checkbox, as they cannot (easily) be run as root.

=== Use Cases ===

* Jill starts Checkbox from the Admin menu (System Testing). She can get a basic view of her hardware and perform most tests '''as herself''' without entering her password
* Simon runs a test that queries device information which requires root access. He is asked for his password to allow access to that information
* Emma runs a new test that requires additional packages to be installed. She is asked for her password to install those packages automatically
** Some tests require packages to be installed. This should be initiated automatically by the test runner, but the user should have the power to accept or decline (and skip the test).
* Bill is running a suite of PostgreSQL tests that need to be run as the `postgres` user. He is prompted for his password to allow this to happen
* As we add more comprehensive desktop test coverage it is important that they run in an environment that is as realistic as possible - as a user, not as root 

=== Assumptions ===

* The tests that still require root to run can be run in a different mode

=== Design ===

* Run checkbox as a regular user by default
* Add a command-line parameter run checkbox in root mode
** e.g. <code>sudo checkbox --root</code>
** This mode will be used when policykit is not installed (server) and for certification testing
* Test definitions will be extended to contain a ''needs-root'' flag which will prompt the user for a password when testing starts using policy-kit
** Checkbox will check for the availability of policy-kit on start and if a test requiring elevated priveliges is scheduled it will exit with an error
* Package installation is out of scope for the current spec. If a prerequisite for the test is not met the user should be notified and referred to the standard packaging tool.
** In root mode this can be worked around by making the test install the package directly, eliminating the need for user-interaction.

=== Implementation ===

Since there may be multiple, differing requests to elevate privileges in a single test session, individual tests should be evaluated early in the Checkbox process and authorisation step performed as a single action for all requirements.

This authorisation step needs to be performed immediately prior to tests being run.

If authorisation is declined or unsuccessful, the relevant tests should be skipped with an appropriate, informative comment.

==== UI Changes ====

Please see the CheckboxUI spec.

=== Test/Demo Plan ===

* Checkbox runs satisfactoryly without elevated privileges
* Checkbox runs satisfactoryly in root mode
* Elevated privileges are requested for appropriate tests/actions

=== BoF agenda and discussion ===

Why are we running as root?
* Information gathering
* Debugging (apport)
* Some test actions require sudo
 
Run as root and drop down to the user or escalate privileges to root when necessary?
* run as a user and escalating when needed

On server side there is an issue with no X. Look into ConsoleKit

How do we deal with package installation?
 - Check ahead if some packages need to be installed, so the user experience is not too bad.
* ask about installing a package in the beginning rather than asking in test 85 of 90
 
 Given that PolicyKit throws Authentication errors and refuses to unlock if dbus times out, I don't think it's likely to be pretty if there's no dbus at all
 - we would test for DBUS before trying to use PolicyKit
   - if DBUS isn't there, can it be forcibly started to prevent "scary" errors? (I'm not quite sure how this works) Or at least some sort of graceful degredation

----
CategorySpec
