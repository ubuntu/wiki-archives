{|
  | '''Warning'''
  * This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
  * '''Images''' and '''attachments''' have been removed to conserve space.
  * '''Links''' may not work and there may be formatting issues.
  * A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__

This page is a collection of facts observed about the MergeOMatic code and deployment, as of 2024-09-10.

=== Repository ===

The code lives on Launchpad in a Bazaar repository maintained by the Core Dev LP group:

https://code.launchpad.net/~ubuntu-core-dev/merge-o-matic/trunk

=== Environment ===

The code needs Python 2 (yes!), with the following dependencies:

* python-bs4
* python-pychart
* ghostscript
* python-launchpadlib
* libapache2-mod-python

This particular combination means that the latest Ubuntu series the code can run on is Bionic Beaver.

=== Deployment ===

For the sake of brevity, let's use the following definition:

* <code>WORKDIR=/srv/patches.ubuntu.com/</code>
* <code>CODEDIR=/srv/patches.ubuntu.com/code/</code>
* <code>OUTDIR=/srv/patches.ubuntu.com/merges/</code>

The assumption baked in the code is that it will be cloned in $CODEDIR and a cronjob will be installed that will run $CODEDIR/cron.daily on a daily basis, and $CODEDIR/pack-archive.sh every once in a while.

The current cron entrypoint is visible with <code>sudo -u merge crontab -l</code>.

Apache must be configured to use $OUTDIR as its root, with mod_python enabled and its PYTHONPATH pointing to $CODEDIR. That mode must interpret both .py and .html files.

Note that the automatic pull of new sources has been disabled.

=== Website generation ===

The daily cron uses $WORKDIR as its work directory, and $OUTDIR as its output directory. The latter will contain HTML files generated by the scripts but which contain snippets of Python code for the comment feature to work.

The comments are created by a GET request on `addcomment.py` with the `package` and `comment` field (and optionally `component` for the redirection. The contents are saved in $WORKDIR/comments.txt, and obsolete comments are cleaned up during the generation of the status page .html file (not its interpretation by mod_python).

==== grab-merge ====

The merges are stored in $OUTDIR, with one level of indirection (usual "one letter except for libs"). Strangely, that part is called $HASH in the grab-merge script. The merges are generated by the daily cron.

=== Modernization effort ===

IRC discussion: https://irclogs.ubuntu.com/2025/01/15/%23ubuntu-devel.html

Port to Python3: https://code.launchpad.net/~liushuyu-011/merge-o-matic/+git/main/+merge/475917

Useful Dockerfile to work with that branch:

<pre>
FROM ubuntu:22.04 AS build
RUN apt-get update && apt-get install -y git build-essential python3 python3-venv python3-pip
COPY . .
RUN git archive -o /cleaned.tar HEAD && \
    mkdir -p /srv/patches.ubuntu.com/code && \
    cd /srv/patches.ubuntu.com/code && \
    tar -xvf /cleaned.tar && \
    python3 -m venv venv && \
    . venv/bin/activate && \
    pip3 install launchpadlib python-debian "pychart @ git+https://git.launchpad.net/~liushuyu-011/+git/pychart"
RUN mkdir -p /srv/patches.ubuntu.com/published/ /srv/patches.ubuntu.com/merges/

FROM ubuntu:22.04 AS final
RUN apt-get update && \
    apt-get install -y xz-utils ghostscript python3 wget ca-certificates apt-utils && \
    useradd -s /bin/bash -d /srv/patches.ubuntu.com app && \
    mkdir -p /srv/patches.ubuntu.com/published/ /srv/patches.ubuntu.com/merges/ && \
    chown -hR app:app /srv/patches.ubuntu.com
COPY --from=build --chown=app:app /srv/patches.ubuntu.com/code /srv/patches.ubuntu.com/code
USER app
WORKDIR /srv/patches.ubuntu.com
</pre>

Colin's old plan:

** [X] Pacify pyflakes3
** [X] Fix expire-pool to expire more irrelevant packages
** [X] Check pool against Launchpad
** [X] Disambiguate fetching source files from Launchpad in the face of
** epoch-stripped ambiguity
** [ ] Switch to fetching packages from Launchpad on the fly
** [ ] Clear out most of pool (after confirming that all is still well)
** [ ] Move to git
** [ ] Write charm
** [ ] Write spec (including haproxy, HTTPS)
** [X] Deploy to prodstack
** [X] Sync existing data
** [X] Switch DNS
** [X] Decommission shedu
** [ ] Replace frontend with WSGI app (flask?)
** [ ] Migrate pool index state to DB
** [ ] Migrate comments to DB
** [ ] Add SSO for commenting
** [ ] Migrate output files to Swift plus index in DB
