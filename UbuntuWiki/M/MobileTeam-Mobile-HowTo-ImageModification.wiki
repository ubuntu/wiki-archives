{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work.
* A '''full compressed version''' of the wiki is available on archive.org
|}

__TOC__


This Howto is outlining the process to install a package inside Intrepid (8.10) Mobile and MID Images.
Download the latest .img file from cdimage.ubuntu.com , then follow the steps below or use the script at the bottom of this page.

 /!\ Before using either method, you will need to '''install the squashfs-tools''' package

=== The manual way ===

Preparation:
<pre>
mkdir /tmp/image
mkdir /tmp/squashfs
mkdir /tmp/tmpfs
mkdir /tmp/mergemount
</pre>

Mount the filesystems:
<pre>
sudo modprobe unionfs
sudo mount -o loop <your downloaded .img file> /tmp/image
sudo mount -o loop -t squashfs /tmp/image/casper/filesystem.squashfs /tmp/squashfs
sudo mount -t tmpfs tmpfs /tmp/tmpfs
sudo mount -t unionfs -o dirs=/tmp/tmpfs:/tmp/squashfs=ro none /tmp/mergemount
</pre>

Make sure essential filesystems are mounted inside the image:
<pre>
sudo chroot /tmp/mergemount mount -t proc proc /proc
sudo chroot /tmp/mergemount mount -t sysfs sysfs /sys
sudo chroot /tmp/mergemount mkdir -p /dev/pts
sudo chroot /tmp/mergemount mount -t devpts devpts -o noexec,nosuid,gid=5,mode=620 /dev/pts
</pre>

Make sure packagelists are up to date and install the software you like:
<pre>
LANG=C sudo chroot /tmp/mergemount apt-get update
LANG=C sudo chroot /tmp/mergemount apt-get install <your desired package>
</pre>

Clean up:
<pre>
sudo chroot /tmp/mergemount apt-get clean
sudo chroot /tmp/mergemount umount /proc
sudo chroot /tmp/mergemount umount /sys
sudo chroot /tmp/mergemount umount /dev/pts
sudo chroot /tmp/mergemount rm -rf /dev/pts
</pre>

Build a new squashfs with your changes:
<pre>
sudo mksquashfs /tmp/mergemount /tmp/filesystem.squashfs
</pre>

Clean up the temporary mountpoints:
<pre>
sudo umount /tmp/mergemount
sudo umount /tmp/tmpfs
sudo umount /tmp/squashfs
</pre>

Copy the new squashfs in place:
<pre>
sudo cp /tmp/filesystem.squashfs /tmp/image/casper/
</pre>

Clean up the rest:
<pre>
sudo umount /tmp/image
sudo rm -rf /tmp/image /tmp/tmpfs /tmp/squashfs /tmp/mergemount /tmp/filesystem.squashfs
</pre>

Have fun with your changed imagefile ....

=== The same as shellscript ===
The script below uses the same setup as above and spawns a rootshell inside the squashfs, you can then run "apt-get update" and install your package or make other changes, if you exit the shell with Ctrl-D or the 'exit' command it will offer you to re-roll the squashfs for you. 

<pre>

if [ -z $1 ];then
    echo 'i need a path to an imagefile as first argument'
    exit 0
fi

mkdir /tmp/image
mkdir /tmp/squashfs
mkdir /tmp/tmpfs
mkdir /tmp/mergemount

sudo modprobe unionfs

sudo mount -o loop $1 /tmp/image
sudo mount -o loop -t squashfs /tmp/image/casper/filesystem.squashfs /tmp/squashfs
sudo mount -t tmpfs tmpfs /tmp/tmpfs
sudo mount -t unionfs -o dirs=/tmp/tmpfs:/tmp/squashfs=ro none /tmp/mergemount

sudo chroot /tmp/mergemount mount -t proc proc /proc
sudo chroot /tmp/mergemount mount -t sysfs sysfs /sys
sudo chroot /tmp/mergemount mkdir -p /dev/pts
sudo chroot /tmp/mergemount mount -t devpts devpts -o noexec,nosuid,gid=5,mode=620 /dev/pts

sudo cp /etc/resolv.conf /tmp/mergemount/etc/

LANG=C sudo chroot /tmp/mergemount su

sudo chroot /tmp/mergemount rm /etc/resolv.conf
sudo chroot /tmp/mergemount umount /proc
sudo chroot /tmp/mergemount umount /sys
sudo chroot /tmp/mergemount umount /dev/pts
sudo chroot /tmp/mergemount rm -rf /dev/pts

echo -n 'do you want to build a squashfs with the changes ? (y/n) '
read yesno
if [ -z $yesno ];then
    yesno='n'
fi

if [ $yesno = 'y' ];then
    sudo mksquashfs /tmp/mergemount /tmp/filesystem.squashfs
fi

sudo umount /tmp/mergemount
sudo umount /tmp/tmpfs
sudo umount /tmp/squashfs

if [ $yesno = 'y' ];then
    sudo cp /tmp/filesystem.squashfs /tmp/image/casper/
fi

sudo umount /tmp/image
sudo rm -rf /tmp/image /tmp/tmpfs /tmp/squashfs /tmp/mergemount /tmp/filesystem.squashfs
</pre>
