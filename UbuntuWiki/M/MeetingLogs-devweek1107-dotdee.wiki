{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__

=== Dev Week -- dotdee - break a flat file into dynamically assembled snippets -- DustinKirkland -- Tue, Jul 12th, 2011 ===
<pre>
[18:01] <kirkland> howdy all
[18:02] <kirkland> this session is on dotdee
[18:02] <kirkland> there will be a live streamed demo at: http://bit.ly/uclass
[18:02] <kirkland> i invite you to join me there
[18:02] <kirkland> the username and password is guest/guest
[18:03] <kirkland> for those interested, this is a tool called ajaxterm
[18:03] <kirkland> which embeds a terminal in a web browser
[18:03] <kirkland> i've set up a byobu/screen session for the guest user (which is readonly for all of you)
[18:03] <kirkland> I'll drive the demo
[18:04] <kirkland> and annotate it here
[18:04] <kirkland> alternatively, you can ssh guest@ec2-50-19-128-105.compute-1.amazonaws.com
[18:04] <kirkland> with password guest
[18:05] <kirkland> okay, on to dotdee :-)
[18:05] <kirkland> if you've ever configured a Linux/UNIX system, you're probably familiar with the /etc directory
[18:05] <kirkland> and inside of /etc, there are many directories that end in a ".d"
[18:05] <kirkland> watch the terminal while I find a few in /etc
[18:06] <kirkland> there's a bunch!
[18:06] <kirkland> this is a very user friendly way of offering configuration to users
[18:06] <kirkland> usually, files in a .d directory are concatenated, or executed sequentially
[18:07] <kirkland> it give users quite a bit of flexibility for editing or adding configurations
[18:07] <kirkland> to some software or service
[18:07] <kirkland> it also helps developers and packagers of software
[18:07] <kirkland> as it often allows them to drop snippets of configuration into place
[18:07] <kirkland> but not every configuration file is setup in this way
[18:08] <kirkland> in fact, most of them are really quite "flat"
[18:08] <kirkland> a few months ago, I found myself repeatedly needing to converted some flat configuration files
[18:08] <kirkland> to .d style ones
[18:09] <kirkland> this was for software I was working with, as a developer/packager
[18:09] <kirkland> but not software that I had written myself
[18:09] <kirkland> ideally, I would just ask the upstream developers to change their flat .conf file
[18:09] <kirkland> to a .d directory
[18:09] <kirkland> and they would magically do it
[18:09] <kirkland> and test it
[18:09] <kirkland> and release it
[18:09] <kirkland> immediately :-)
[18:10] <kirkland> that rarely happens though :-P
[18:10] <kirkland> so I wrote a little tool that would generically to that for me!
[18:10] <kirkland> and that tool is called "dotdee"
[18:10] <kirkland> so let's take a look!
[18:10] <kirkland> over in the terminal, i'm going to install dotdee, which is already in Ubuntu oneiric
[18:10] <kirkland> sudo apt-get install dotdee
[18:11] <kirkland> for older ubuntu distros, you can 'sudo apt-add-repository ppa:dotdee/ppa'
[18:11] <kirkland> and update, and install it there too
[18:11] <kirkland> cool, so now i have a /usr/sbin/dotdee executable
[18:11] <kirkland> let's take a flat file, and turn it into a dotdee directory!
[18:12] <kirkland> I'm going to use /etc/hosts as my example
[18:12] <kirkland> first, I need to "setup" the file
[18:12] <kirkland> i can first verify that /etc/hosts is in fact a flat file,
[18:12] <kirkland> -rw-r--r-- 1 root root 296 2011-07-13 12:14 /etc/hosts
[18:13] <kirkland> I'm going to set it up like this:
[18:13] <kirkland> sudo dotdee --setup /etc/hosts
[18:13] <kirkland> INFO: [/etc/hosts] updated by dotdee
[18:13] <kirkland> cool!
[18:13] <kirkland> now let's look at what dotdee did....
[18:13] <kirkland> $ ll /etc/hosts
[18:13] <kirkland> lrwxrwxrwx 1 root root 27 2011-07-13 18:13 /etc/hosts -> /etc/alternatives/etc:hosts
[18:13] <kirkland> so /etc/hosts is now a symlink
[18:13] <kirkland> pointing to an alternatives link
[18:14] <kirkland> $ ll /etc/alternatives/etc:hosts
[18:14] <kirkland> lrwxrwxrwx 1 root root 22 2011-07-13 18:13 /etc/alternatives/etc:hosts -> /etc/dotdee//etc/hosts
[18:14] <kirkland> which is pointing to a flat file in /etc/dotdee
[18:14] <kirkland> $ ll /etc/dotdee//etc/hosts
[18:14] <kirkland> -r--r--r-- 1 root root 296 2011-07-13 18:13 /etc/dotdee//etc/hosts
[18:14] <kirkland> if I look at the contents of that file, I see exactly what I had before
[18:15] <kirkland> but let's go to that directory, /etc/dotdee
[18:15] <kirkland> inside of /etc/dotdee, there is a file structure that mirrors the same file structure on the system
[18:15] <kirkland> importantly, we now have a .d directory
[18:15] <kirkland> that refers exclusively to our newly managed file
[18:16] <kirkland> namely, /etc/dotdee/etc/hosts.d
[18:16] <kirkland> in that directory, all we have is a file called 50-original
[18:16] <kirkland> which is the original contents of our /etc/hosts
[18:16] <kirkland> but let's say we want to "append" a host to that fie
[18:16] <kirkland> file
[18:16] <kirkland> let's create a new file in this directory
[18:16] <kirkland> and call it 60-googledns
[18:17] <kirkland> so I edit the new file (as root)
[18:17] <kirkland> add the entry, 8.8.8.8 googledns
[18:17] <kirkland> and I'm going to write the file
[18:17] <kirkland> but before i write the file, let me split the screen
[18:18] <kirkland> so that we can watch it get updated, automatically, in real time!
[18:18] <kirkland> so i ran 'watch -n1 cat /etc/hosts'
[18:18] <kirkland> which is just printing that file every 1 second
[18:18] <kirkland> now i'm going to save our 60-googledns file
[18:18] <kirkland> and voila!
[18:19] <kirkland> we have a new entry appended to our /etc/hosts
[18:19] <kirkland> through the magic of inotify :-)
[18:19] <kirkland> which is a daemon that monitors filesystem events
[18:19] <kirkland> dotdee comes with a configuration (which is dotdee managed, of course!) that adds and removes patterns
[18:19] <kirkland> as you setup/remove dotdee management
[18:20] <kirkland> let's prepend a host
[18:20] <kirkland> we'll call this one 40-foo
[18:20] <kirkland> and see it land at the beginning of the file
[18:20] <kirkland> bingo
[18:20] <kirkland> now it's at the beginning of our /etc/hosts
[18:22] <kirkland> okay
[18:22] <kirkland> so adding/removing a flat text file is one way of affecting our managed file
[18:23] <kirkland> flat text files are just appended or prepended, based on its alpha-numeric positioning
[18:23] <kirkland> but there are 2 other ways as well!
[18:23] <kirkland> you can also put executables in this .d directory
[18:23] <kirkland> which operate on the standard in and out
[18:23] <kirkland> if you want to modify a flat file by "processing" it
[18:24] <kirkland> for instance
[18:24] <kirkland> let's make this file all uppercase
[18:25] <kirkland> whoops
[18:25] <kirkland> okay, there we go
[18:25] <kirkland> which brings me to the --update command :-)
[18:26] <kirkland> dotdee --update can be called against any managed file
[18:26] <kirkland> to update it immediately
[18:26] <kirkland> in case the inotify bit didn't pick up the change
[18:26] <kirkland> in any case, i just did that, and now our /etc/hosts is all uppercase
[18:26] <kirkland> because of our 70-uppercase executable
[18:27] <kirkland> what happens if we move it from 70-uppercase to 10-uppercase?
[18:27] <kirkland> or, rather, how about 51-uppercase?
[18:27] <kirkland> see the output now
[18:28] <kirkland> note that 51-uppercase was applied against the "current state" of the output, as of position 51
[18:28] <kirkland> but 60- was applied afterward
[18:28] <kirkland> so it wasn't affected
[18:28] <kirkland> so that's two ways we can affect the contents of the file
[18:28] <kirkland> a) flat text files, b) scripts that process stdin and write to stdout
[18:29] <kirkland> the third way is patches or diff files
[18:29] <kirkland> given that this is a developer audience, we're probably familiar with quilt
[18:29] <kirkland> and directories of patches
[18:29] <kirkland> this is particularly useful if you need to do some 'surgery' on a file
[18:29] <kirkland> let's say I want to "insert" a line into the middle of this file
[18:30] <kirkland> into the middle of 50-original, for instance
[18:31] <kirkland> okay, so i've added "10.9.8.7        hello-there" to the middle of a copy of this file
[18:31] <kirkland> and i'm going to use diff -up to generate a patch
[18:31] <kirkland> there we go
[18:31] <kirkland> okay, let's put that in this .d dir
[18:32] <kirkland> note that I have to add .patch or .diff as the file extension
[18:32] <kirkland> and now i can cat /etc/hosts and see that the patch has been applied!
[18:33] <kirkland> i could stack a great number of these patches here
[18:33] <kirkland> much like a quilt directory
[18:33] <kirkland> okay, so now let's undo this configuration
[18:34] <kirkland> oh, first
[18:34] <kirkland> sudo dotdee --list /etc/hosts
[18:34] <kirkland> /etc/hosts
[18:34] <kirkland> $ echo $?
[18:34] <kirkland> 0
[18:34] <kirkland> this verifies that /etc/hosts is in fact dotdee managed
[18:34] <kirkland> if i try this against some other file
[18:35] <kirkland> $ sudo dotdee --list /boot/vmlinuz-3.0-3-virtual
[18:35] <kirkland> ERROR: [/boot/vmlinuz-3.0-3-virtual] is not managed by dotdee
[18:35] <kirkland> (I don't recommend dotdee'ing your kernel :-)
[18:35] <kirkland> but we can undo our /etc/hosts
[18:35] <kirkland> $ sudo dotdee --undo /etc/hosts
[18:35] <kirkland> update-alternatives: using /etc/dotdee//etc/hosts.d/50-original to provide /etc/hosts (etc:hosts) in auto mode.
[18:35] <kirkland> INFO: [/etc/hosts] has been restored
[18:35] <kirkland> INFO: You may want to manually remove [/etc/dotdee//etc/hosts /etc/dotdee//etc/hosts.d]
[18:36] <kirkland> and now our /etc/hosts is back to being whatever we saved in 50-original
[18:36] <kirkland> so ...
[18:36] <kirkland> that's how it works
[18:36] <kirkland> and the /etc/hosts example is only marginally useful
[18:37] <kirkland> what I would *really* like to use it for is in configuration file management in Debian/Ubuntu packaging
[18:37] <kirkland> in the case where the upstream daemon or utility has a single, flat .conf file
[18:37] <kirkland> but I really would prefer it to be a .d directory
[18:37] <kirkland> so i just did a find on /etc
[18:38] <kirkland> sudo find /etc/ -type f -name "*.conf"
[18:38] <kirkland> and chose one at random
[18:38] <kirkland>  /etc/fonts/fonts.conf
[18:38] <kirkland> which happens to be XML
[18:38] <kirkland> and I just thought about this
[18:38] <kirkland> i should have mentioned it in our previous section
[18:39] <kirkland> XML is tougher than a linear file, like a shell script
[18:39] <kirkland> in that you can't just append, or prepend text
[18:39] <kirkland> you have to surgically insert the bits you want
[18:39] <kirkland> in which case the latter two methods I mentioned, the executable and the diff/patch will be your friend!
[18:40] <kirkland> okay
[18:40] <kirkland> now I would *really* like to see dpkg learn just a little bit about dotdee
[18:41] <kirkland> I'd like for it to be able to determine *if* a file is managed by dotdee
[18:41] <kirkland> (easy to check using dotdee --list, or just checking if the file is a symlink itself)
[18:41] <kirkland> and if so, then it would use $(dotdee --original ...) to find the 50-original file path
[18:42] <kirkland> and dpkg would write its changes to that location (the 50-original file)
[18:42] <kirkland> such that local admin, or even other packages, could dabble in the .d directory, without causing conffile conflicts or .dpkg-original files
[18:43] <kirkland> okay, anyway, let's take a break for questions
[18:43] <kirkland> I think I've demo'd most of what I'd like to show you
[18:43] <kirkland> any questions?
[18:44] <kirkland> <coalitians> Question: Is there any issues when you upgrade or update due to dotdee?
[18:44] <kirkland> coalitians: great question !
[18:44] <kirkland> coalitians: right, so that's what I was saying about dpkg needing to "learn" about dotdee
[18:44] <kirkland> coalitians: let's look at an example over in our test system
[18:45] <kirkland> coalitians: I'm going to dotdee --setup that font xml
[18:47] <kirkland> coalitians: okay, as you can see, i've made a change
[18:47] <kirkland> coalitians: let's upgrade (or reinstall) the package that owns this file
[18:47] <kirkland> $ sudo apt-get install --reinstall fontconfig-config
[18:47] <kirkland> lrwxrwxrwx  1 root root   38 2011-07-13 18:45 fonts.conf -> /etc/alternatives/etc:fonts:fonts.conf
[18:47] <kirkland> -rw-r--r--  1 root root 5287 2011-07-01 12:12 fonts.conf.dpkg-new
[18:48] <kirkland> unfortunately, dpkg dump fonts.conf.dpkg-new here :-(
[18:48] <kirkland> i have toyed with another inotify/iwatch regex that would look for these :-)
[18:48] <kirkland> slurp them up, and move them over to 50-original
[18:48] <kirkland> which works reasonably well
[18:49] <kirkland> except that I don't yet have the interface for the merge/conffile questions, like dpkg does
[18:49] <kirkland> coalitians: so to answer your question, upgrades are not yet handled terribly gracefully
[18:49] <kirkland> coalitians: and would take a little work within dpkg itself
[18:49] <kirkland> coalitians: sorry;  but great question!
[18:49] <kirkland> any others?
[18:50] <kirkland> I see roughly 19# in the byobu session :-)
[18:50] <kirkland> that's what the red-on-white 19# means
[18:50] <kirkland> 19 ssh sessions
[18:50] <kirkland> did the web interface work for anyone?
[18:50] <kirkland> this is the first time I've tried it
</pre>
