{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__


== Public and Private Keys ==

If your SSH server is visible over the Internet, you should use public key authentication instead of passwords if at all possible.  If you don't think it's important, go to your '''/var/log/''' folder and have a look at the files named '''auth''' (attempted logins for this week) and '''auth.0''' (attempted logins for last week).  My computer - a perfectly ordinary desktop PC - had over 4,000 attempts to guess my password and almost 2,500 break-in attempts in the last week alone.  How many thousand random guesses do you think it will take before an attacker stumbles across your password?

With public key authentication, every computer has a public and a private "key" (a large number with particular mathematical properties).  The private key is kept on the computer you log in from, while the public key is stored on the '''.ssh/authorized_keys''' file on all the computers you want to log in to.  When you log in to a computer, the SSH server uses the public key to "lock" messages in a way that can only be "unlocked" by your private key - this means that even the most resourceful attacker can't snoop on, or interfere with, your session.  As an extra security measure, most SSH programs store the private key in a password-protected format, so that if your computer is stolen or broken in to, you should have enough time to disable your old public key before they break the password and start using your key.  Wikipedia has a <nowiki>[[WikiPedia:Public-key_cryptography|more detailed explanation]]</nowiki> of how keys work.

Public key authentication is a much better solution than passwords for most people.  In fact, if you don't mind leaving a private key unprotected on your hard disk, you can even use keys to do secure automatic log-ins - as part of a network backup, for example.  Different SSH programs generate public keys in different ways, but they all generate public keys in a similar format:

<pre>
<ssh-rsa or ssh-dsa> <really long string of nonsense> <username>@<host>
</pre>

== RSA Key-Based SSH Logins ==

Key-based authentication is but one of several modes of authentication usable with OpenSSH, such as plain password (the default with Ubuntu) and Kerberos tickets.  Key-based authentication has several advantages over password authentication, for example the key values are significantly more difficult to brute-force, or guess than plain passwords, provided an ample key length.

Digital keys are also of course, a metaphor for their physical counterparts, and therefore may impart a degree of portability not possible with plain passwords.  Using key based logins with ssh is generally considered more secure than using plain password logins.

This section of the guide will explain the process of enabling <code>ssh</code> key based logins, generating a set of public/private RSA keys, and using them for logging into your Ubuntu computer(s) via OpenSSH.

== Generating RSA Keys ==

The first step involves the generation of a set of RSA keys for use in authentication.  Typically, you would do this on the machine you intend to use for logging into all other machines, but this does not matter too much, as you can always move the keys around to other machines as needed.  

To create your public and private SSH keys on the command-line:

<pre>
mkdir ~/.ssh
chmod 700 ~/.ssh
ssh-keygen -q -f ~/.ssh/id_rsa -t rsa
</pre>

You will be prompted for a location for saving the keys, and a passphrase for the keys.  When choosing the passphrase for the keys, pick a very strong passphrase, and remember, or note it in a secure place. This passphrase will protect your private key while it's stored on the hard drive and be required to use the keys every time you need to login to a key-based system:

<pre>
Generating public/private rsa key pair.
Enter file in which to save the key (/home/b/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/b/.ssh/id_rsa.
Your public key has been saved in /home/b/.ssh/id_rsa.pub.
</pre>

Your public key is now available as '''.ssh/id_rsa.pub''' in your home folder.

Congratulations!  You now have a set of keys.  Now it's time to make your systems allow you to login with them

=== Password-less Keys ===

<pre>
 press enter to leave your private key unprotected
</pre>

<nowiki>[[File:IconsPage/IconNote.png]]</nowiki> While it is possible to generate a set of RSA keys for use with OpenSSH which do not have a password assigned to them, for easy, password-less logins via <code>ssh</code>, it is very insecure.  If your password-less keys fall into the wrong hands, then so does your authentication, thereby allowing easy compromise of all systems which permit the keys.  In certain situations, such as insecure clustered environments, completely password-less logins may be desirable.''

=== Key Encryption Level ===

Note: The default is a 2048 bit key. You can increase this to 4096 bits with the -b flag (Increasing the bits makes it harder to crack the key by brute force methods).

<pre>
ssh-keygen -t rsa -b 4096
</pre>
.
=== Password Authentication ===

The main problem with public key authentication is that you need a secure way of getting the public key onto your computer before you can log in with it.  If you will only ever log in to your computer from a few other computers (such as logging in to your PC from your laptop), you should copy your SSH keys over immediately, then disable password authentication altogether.  If you would like to log in from other computers from time to time (such as a friend's PC), read <nowiki>[[https://help.ubuntu.com/community/StrongPasswords|Strong Passwords]]</nowiki> for instructions on how to install a program that generates hard-to-guess passwords. 

==== Disable Password Authentication ====

If you've been successful in establishing RSA key-based logins, you may wish to make this the only acceptable form of authentication on your Ubuntu computer(s) by disallowing plain password authentication entirely.  Taking this route will ensure that automated brute-force scanners, and attack tools have a much harder time with your publicly exposed systems.  Be forewarned however, if you lose your keys, you may find yourself locked out!

To disable password authentication:

<pre>
  $ sudo gedit /etc/ssh/sshd_config
</pre>

* Look for the following line:

<pre>
 PasswordAuthentication yes
</pre>

* Uncomment it
* Change ''yes'' to ''no''

<pre>
# PasswordAuthentication yes
</pre>

<nowiki>[[File:IconsPage/IconDialog-Warning1.png]]</nowiki> '''WARNING''' : ''For the second time, if you disable plain password authentication, and do not have a working key-based login, or lose your keys, you will be LOCKED OUT of your remote machine.  Of course, you can still login via console at the machine physically, but this may not be so easy if your remote computer is 500 miles away!  You have been warned again!''

Once you have saved the file, restart your SSH server and try logging in again.  Plain password authentication will be disabled and it shouldn't even ask you for a password now.

=== Root Authentication ===

<code>PermitRootLogin</code> directive when using key-based logins, to enforce a policy disallowing password-based root logins.  You can do so by changing:

{| class="wikitable"
|-
| ''<code>PermitRootLogin yes</code>''
|}

to

{| class="wikitable"
|-
| '''<code>PermitRootLogin without-password</code>'''
|}

Don't be alarmed by the <code>without-password</code>.  This does not mean a user may login as root without supplying a password, but rather, it means no one may log in as root using password authentication, meaning that logging in as root may be done with a public key only.

== Locating the Keys on Remote Computers ==

Assuming the remote Ubuntu computers you wish to use the keys for have running ssh daemons already, then locating your public portion of the key pair on those machines is quite simple.  For example, if you'd like to begin using key-based logins as user ''username'' on a remote machine named ''host'', and ''host'' is running <code>sshd</code>, and reachable by name on your network, simply use the '''ssh-copy-id''' command to properly locate your key:

<code>ssh-copy-id -i ~/.ssh/id_rsa.pub username@host</code>

=== Testing the Login ===

Next, you need to test the login, by attempting a connection to the machine and using your passphrase to unlock the key:

<code>ssh username@host</code>

You will be prompted for the passphrase for your key:

{| class="wikitable"
|-
| Enter passphrase for key '/home/b/.ssh/id_rsa':
|}

Enter your passphrase, and provided ''host'' is configured to allow key-based logins, you should then be logged in as usual.

<nowiki>[[File:IconsPage/IconNote.png]]</nowiki> '''NOTE:''' The examples above were just that: Examples! Substitute the user name, and machine name in the examples with your actual user name in order to increase your chances of success. ;-)

== Troubleshooting ==

==== username@host's password: ====
If you are not prompted for the passphrase, and instead get just the

{| class="wikitable"
|-
| username@host's password:
|}

prompt as usual with password logins, then read on.  There are a few things which could prevent this from working as easily as demonstrated above.  On default Ubuntu installs however, the above examples should work.  If not, then check the following condition, as it is the most frequent cause:

On the remote computer, ensure that the /etc/ssh/sshd_config contains the following lines, and that they are ''uncommented'';

<pre>
PubkeyAuthentication yes
RSAAuthentication yes
</pre>

If not, add them, or uncomment them, restart the sshd, and try logging in again.  If you get the ''passphrase'' prompt now, then congratulations, you're logging in with a key!

==== Permission denied (publickey) ====

If you're sure you've correctly configured sshd_config, appended your public key to authorized_keys, and have your private key in the .ssh directory, and still getting this error:

{| class="wikitable"
|-
| <code>Permission denied (publickey).</code>
|}

Chances are, your /home/user and ~/.ssh/authorized_keys permissions are too open by OpenSSH standards. You can get rid of this problem by issuing the following commands:
<pre>
$ chmod go-w ~/
$ chmod 700 ~/.ssh
$ chmod 600 ~/.ssh/authorized_keys
</pre>

=== Where to From Here? ===

No matter how your public key was generated, you can add it to your Ubuntu system by opening the file '''.ssh/authorized_keys''' in your favourite text editor and adding the key to the bottom of the file.  You can also limit the SSH features that the key can use, such as disallowing port-forwarding or only allowing a specific command to be run.  This is done by adding "options" before the SSH key, on the same line in the '''authorized_keys''' file.  For example, if you maintain a CVS repository, you could add a line like this:

<pre>
command="/usr/bin/cvs server",no-agent-forwarding,no-port-forwarding,no-X11-forwarding,no-user-rc ssh-dss <string of nonsense>...
</pre>

When the user with the specified key logged in, the server would automatically run `/usr/bin/cvs server`, ignoring any requests from the client to run another command such as a shell.  For more information, see <nowiki>[[http://www.openbsd.org/cgi-bin/man.cgi?query=sshd&sektion=8#SSHRC|the sshd man page]]</nowiki>.
