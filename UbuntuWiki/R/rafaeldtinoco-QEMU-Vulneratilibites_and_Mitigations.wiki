{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work.
* A '''full compressed version''' of the wiki is available on archive.org
|}

__TOC__

Tables of Contents:

== Introduction ==

This document should be read together with the following articles:

{| class="wikitable"
|-
| <nowiki>[[https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/SpectreAndMeltdown|Security Team Spectre (Variant 1 and 2) and Meltdown (Variant 3) Knowledge Base Article]]</nowiki>
|-
| <nowiki>[[https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/LazyFP|Security Team Lazy Floating Point Knowledge Base Article (LazyFP)]]</nowiki>
|-
| <nowiki>[[https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/BCBS|Security Team Bounds Check Bypass Store Article (Spectre 1.1 / BCBS)]]</nowiki>
|-
| <nowiki>[[https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/Variant4|Security Team Variant 4 Knowledge Base Article (Variant 4)]]</nowiki>
|-
| <nowiki>[[https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/L1TF|Security Team L1TF Knowledge Base Article (L1TF)]]</nowiki>
|-
| <nowiki>[[https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/MDS|Security Team MDS Knowledge Base Article (MDS)]]</nowiki>
|-
| <nowiki>[[https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/SpectreAndMeltdown/MitigationControls|Security Team Mitigation Controls Knowledge Base Article]]</nowiki>
|}

And the references used here are, among the documents above, the following docs:

{| class="wikitable"
|-
| <nowiki>[[ https:--software.intel.com-security-software-guidance-api-app-sites-default-files-336996-Speculative-Execution-Side-Channel-Mitigations.pdf|Intel Speculative Execution Side Channel Mitigations (Rev 3.0)]]</nowiki>
|-
| <nowiki>[[ https:--software.intel.com-security-software-guidance-api-app-sites-default-files-336983-Intel-Analysis-of-Speculative-Execution-Side-Channels-White-Paper.pdf|Intel Analysis of Speculative Execution Side Channels (Rev 4.0)]]</nowiki>
|-
| <nowiki>[[ https:--software.intel.com-security-software-guidance-insights-deep-dive-mitigation-overview-side-channel-exploits-linux|Intel Deep Dive Mitigation Overview Side Channel Exploits Linux]]</nowiki>
|-
| <nowiki>[[ https:--software.intel.com-security-software-guidance-insights-deep-dive-intel-analysis-l1-terminal-fault|Intel Deep Dive Analysis for L1 Terminal Fault]]</nowiki>
|-
| <nowiki>[[ https:--software.intel.com-security-software-guidance-software-guidance-l1-terminal-fault|Intel Software Guidance for L1 Terminal Fault]]</nowiki>
|-
| <nowiki>[[ https:--software.intel.com-security-software-guidance-insights-deep-dive-intel-analysis-microarchitectural-data-sampling|Intel Deep Dive Analysis Microarchitectural Data Sampling]]</nowiki>
|-
| <nowiki>[[ https:--software.intel.com-en-us-articles-using-intel-compilers-to-mitigate-speculative-execution-side-channel-issues|Using Intel Compilers to Mitigate Speculative Execution Side Channel Issues]]</nowiki>
|-
| <nowiki>[[ https:--en.wikipedia.org-wiki-Kernel_page-table_isolation|Wikipedia: Kernel Page-Table Isolation]]</nowiki>
|-
| <nowiki>[[ https:--en.wikipedia.org-wiki-Lazy_FP_state_restore|Wikipedia: Lazy FP state restore]]</nowiki>
|-
| <nowiki>[[ https:--www.qemu.org-2018-01-04-spectre-|QEMU Spectre and Meltdown Update]]</nowiki>
|-
| <nowiki>[[ https:--www.qemu.org-2018-02-14-qemu-2-11-1-and-spectre-update-|QEMU Spectre and Meltdown New Update]]</nowiki>
|-
| <nowiki>[[ https:--www.berrange.com-posts-2018-06-29-cpu-model-configuration-for-qemu-kvm-on-x86-hosts-|Berrange CPU Model Configuration for QEMU-KVM on X86 hosts]]</nowiki>
|-
| <nowiki>[[ https:--www.kernel.org-doc-html-latest-admin-guide-hw-vuln-mds.html|Kernel Admin Guide on HW vulnerabilities - MDS]]</nowiki>
|-
| <nowiki>[[ https:--www.kernel.org-doc-html-latest-admin-guide-hw-vuln-l1tf.html|Kernel Admin Guide on HW vulnerabilities - MDS]]</nowiki>
|}

----

''' How to read this document ? '''

{i} You should read this!<<BR>>
{o} This is deeper information, you may ignore.<<BR>>
{X} This is a CPU vulnerability! <<BR>>
<!> This is a mitigation technique. <<BR>>
(./) This is a CPU flag to advertise Kernel and/or Hypervisor. <<BR>>

''' Notes: '''

1. Sometimes the mitigation name is the acronym for the CPU flag, example: <!> Indirect Branch Prediction Barrier - (./) ibpb. And sometimes some CPU flag might mitigate more than 1 vulnerability.

2. Downloading the HTML from the wiki (through the proper Download link at the top) and opening it locally will make it better for reading (no CSS themes). You can also print it to PDF if you'd like.

----

Also, do check articles dates and look for newer ones not yet updated in this document. Newer side channel attack techniques might have been discovered by the time this page was created. If you feel this page should be updated, please send us an e-mail at: ubuntu-server@lists.ubuntu.com mentioning what should be updated and why.

== Related CPU Vulnerabilities (CVEs) ==

=== Side Channel Attacks - Spectre and Meltdown ===

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2017-CVE-2017-5753.html | CVE-2017-5753 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-SpectreAndMeltdown | Bounds Check Bypass (Variant 1 - Spectre) ]]</nowiki>

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2017-CVE-2017-5715.html | CVE-2017-5715 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-SpectreAndMeltdown | Branch Target Injection (Variant 2 - Spectre) ]]</nowiki>

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2017-CVE-2017-5754.html | CVE-2017-5754 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-SpectreAndMeltdown | Rogue Data Cache Load (Variant 3 - Meltdown) ]]</nowiki>

=== Side Channel Attacks - Others ===

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-3665.html | CVE-2018-3665 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-LazyFP | Lazy FP Save-Restore (LazyFP) ]]</nowiki>

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-3693.html | CVE-2018-3693 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-BCBS | Bounds Check Bypass Store (Variant (or Spectre) 1.1 and 1.2 - BCBS) ]]</nowiki>

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-3640.html | CVE-2018-3640 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-RSRE | Rogue System Register Read (RSRE - Variant 3a) ]]</nowiki>

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-3639.html | CVE-2018-3639 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-Variant4 | Speculative Store Bypass (SSB - Variant 4 - Spectre-NG) ]]</nowiki>

=== L1 Terminal Fault (L1TF) ===

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-3615.html | CVE-2018-3615 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-L1TF | Intel SGX (Software Guard Extensions) (Foreshadow - L1TF) ]]</nowiki>

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-3620.html | CVE-2018-3620 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-L1TF | Operating Systems and System Management Mode (Fault-OS - SMM) (L1TF) ]]</nowiki>

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-3646.html | CVE-2018-3646 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-L1TF | Virtualization Extensions (L1TF) ]]</nowiki>

=== Microarchitectural Data Sampling (MDS) ===

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-12126.html | CVE-2018-12126 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-MDS | Microarchitectural Store Buffer Data Sampling (MSBDS - Fallout) ]]</nowiki>

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-12127.html | CVE-2018-12127 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-MDS | Microarchitectural Load Port Data Sampling (MLPDS - RIDL) ]]</nowiki>

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-12130.html | CVE-2018-12130 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-MDS | Microarchitectural Fill Buffer Data Sampling (MFBDS - ZombieLoad) ]]</nowiki>

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-11091.html | CVE-2019-11091 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-MDS | Microarchitectural Data Sampling Uncacheable Memory (MDSUM) ]]</nowiki>

This CVE topic structure is used in the same order in all subsequent sections of this document.<<BR>>
The idea is to allow reader to map:<<BR>>

{| class="wikitable"
|-
| CPU Vulnerability
| <->
| Firmware/Kernel/OS Mitigation
| <->
| CPU Flags to Guest
|}

== New CPUs & Firmwares | Kernel and OS Mitigations ==

=== Side Channel Attacks - Spectre and Meltdown ===

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2017-CVE-2017-5753.html | CVE-2017-5753 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-SpectreAndMeltdown | Bounds Check Bypass (Variant 1 - Spectre) ]]</nowiki>
   
  _user pointer sanitization::
  :: <<BR>>To mitigate this exploit technique in the Linux kernel, we first identify instruction sequences that can be tricked into exploitable behavior. Since a sequence must fit a specific pattern and operate on untrusted data before any potential exploit, not all conditional branches are exploitable. Techniques such as static analysis or manual inspection can identify these sequences.
   
 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2017-CVE-2017-5715.html | CVE-2017-5715 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-SpectreAndMeltdown | Branch Target Injection (Variant 2 - Spectre) ]]</nowiki>
   
 <<BR>>The branch target injection exploit targets a processor’s 'indirect branch predictor'. Indirect branches are used very differently than the conditional branches that the first exploit may target. In Linux, indirect branches are used relatively rarely compared to conditional branches, but they are used in critical locations. In addition, the compiler may insert indirect branches without the programmer ever being aware.<<BR>>
 <<BR>>Since the compiler generates these branches, mitigation against this exploit is the most straightforward when the compiler can simply avoid generating vulnerable branch sequences. A software construct called <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-SpectreAndMeltdown-TechFAQ#Retpoline | retpoline ]]</nowiki> can be deployed to help ensure that a given indirect branch is resistant to exploitation. The compiler, automatically, or the programmer, manually, can insert the retpoline logic in binary code. Retpoline deliberately steer the processor’s branch prediction logic to a trusted location, preventing a potential exploit from steering them elsewhere.<<BR>>

  OS and Kernel Mitigation: Retpoline ::
  :: <<BR>>Retpoline needs code (kernel and/or userland) to be recompiled by a compiler with this feature enabled. If not using retpoline, firmware microcode might ALSO mitigate against Spectre Variant 2 on several different platforms.<<BR>><<BR>>

  Firmware Mitigations ::
  :: <<BR>>for Spectre Variant 2 are also provided by different CPU microcodes. Taking amd64 by example, there are MORE THAN 1 mitigation included in more recent microcodes AND about to (or being, or recently done) be included in newer CPUs internal logic.<<BR>>

   Enhanced Indirect Branch Restricted Speculation (IBRS): Restricts speculation of indirect branches::
   :: <<BR>>With enhanced IBRS, the predicted targets of indirect branches executed cannot be controlled by software that was executed in a less privileged predictor mode or on another logical processor. As a result, software operating on a processor with enhanced IBRS need not use WRMSR to set IA32_SPEC_CTRL.IBRS after every transition to a more privileged predictor mode. Software can isolate predictor modes effectively simply by setting the bit once.<<BR>><<BR>>

   Single Thread Indirect Branch Predictors (STIBP): Prevents indirect branch predictions from being controlled by the sibling HW thread ::
   :: <<BR>>STIBP is an indirect branch control mechanism that restricts the sharing of branch prediction between logical processors on a core. ... as  the logical processors sharing a core may share indirect branch predictors, allowing one logical processor to control the predicted targets of indirect branches by another logical processor of the same core.<<BR>><<BR>>Enabling IBRS prevents software operating on one logical processor from controlling the predicted targets of indirect branches executed on another logical processor. For that reason, it is not necessary to enable STIBP when IBRS is enabled.<<BR>><<BR>>

   Indirect Branch Predictor Barrier (IBPB): Ensures earlier code's behavior does not control later indirect branch predictions. Complements Enhanced IBRS ::
   :: <<BR>>IBPB is an indirect branch control mechanism that establishes a barrier, preventing software that executed before the barrier from controlling the predicted targets of indirect branches executed after the barrier on the same logical processor. A processor supports IBPB if it enumerates CPUID.(EAX=7H,ECX=0):EDX[26] as 1.<<BR>><<BR>>IBPB does not define a new mode of processor operation that controls the branch predictors, unlike Indirect Branch Restricted Speculation (IBRS) and Single Thread Indirect Branch Predictors (STIBP). As a result, it is not enabled by setting a bit in the IA32_SPEC_CTRL MSR. Instead, IBPB is a “command” that software executes when necessary.<<BR>>

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2017-CVE-2017-5754.html | CVE-2017-5754 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-SpectreAndMeltdown | Rogue Data Cache Load (Variant 3 - Meltdown) ]]</nowiki>

 <<BR>>The rogue data cache load exploit targets a processor’s speculative data loading mechanisms. Even though the processor’s access control may protect a piece of data, it may still be read speculatively before an illegal access is determined to exist. The first two exploits require manipulating the kernel to do something for an attacker, while this exploit occurs entirely within code which is under the control of an attacker. This means we cannot modify the kernel to mitigate this exploit, we must fundamentally change where kernel data is available.

   Kernel Mitigation: Kernel Page Table Isolation ::
   :: <<BR>>The mitigation for this is conceptually very simple: instead of relying on a processor’s access-control mechanisms to protect data, simply remove the data instead.<<BR>><<BR>>In Linux, this mitigation is referred to as Kernel Page Table Isolation (PTI). This mitigation removes the data from the reach of exploits by having the kernel maintain two independent copies of the hardware page tables. One copy contains the minimal set of data and code needed to run an application and enter or exit the kernel, but it does not contain valuable kernel data. The other set of page tables, active only while the kernel is running, contains everything needed for the kernel to function normally, including its private data.<<BR>>

=== Side Channel Attacks - Others ===

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-3665.html | CVE-2018-3665 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-LazyFP | Lazy FP Save-Restore (LazyFP) ]]</nowiki>

 <<BR>>Lazy FPU state leak, or Lazy FP State Restore, or LazyFP, affects only Intel Core CPUs. It is a combination of flaws in the speculative execution technology presented in some CPUs, and how certain the OS handle context switching on the floating point unit. Basically a local process can leak the content of the FPU register to another process. 

   Kernel Mitigation ::
   :: <<BR>>Intel recommends OS to use Eager FP state restore in lieu of Lazy FP state restore. Linux Kernel does that since kernel 4.5. Older kernels running on processors that support the xsaveopt instruction are also not affected. You can verify if your system has support for xsaveopt by locating the "xsaveopt" feature listed in the flags section of the /proc/cpuinfo file. No particular mitigation for QEMU/KVM.

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-3693.html | CVE-2018-3693 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-BCBS | Bounds Check Bypass Store (Variant (or Spectre) 1.1 and 1.2 - BCBS) ]]</nowiki>

 <<BR>>Many Intel processors use memory disambiguation predictors that allows loads to be executed speculatively before it is known whether the load’s address overlaps with a preceding store’s address. This may happen if a store’s address is unknown when the load is ready to execute. If the processor predicts that the load address will not overlap with the unknown store address, the load may execute speculatively. However, if there was indeed an overlap, then the load may consume stale data. When this occurs, the processor will re-execute the load to ensure a correct result.<<BR>><<BR>> Through the memory disambiguation predictors, an attacker can cause certain instructions to be executed speculatively and then use the effects for side channel analysis.

   Software Based Mitigations ::

    Process Isolation ::
    :: <<BR>>To run untrusted code in different processes, so the address space is not shared among trusted and untrusted code.<<BR>><<BR>>

    LFENCE (requires new firmware/microcode) ::
    :: <<BR>>Software can insert a LFENCE between a store and a subsequent load to prevent the load from executing before the previous store's address is known. This should be applied only in places with realistic risk, as it incurs in performance penalty.<<BR>>

   Firmware Mitigation:: 
   :: <<BR>>Speculative Store Bypass Disable (SSBD)

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-3640.html | CVE-2018-3640 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-RSRE | Rogue System Register Read (RSRE - Variant 3a) ]]</nowiki>

 <<BR>>The rogue system register read method, uses both speculative execution and side channel cache methods to infer the value of some processor system register state which is not architecturally accessible by the attacker. This method uses speculative execution of instructions that read system register state while the processor is operating at a mode or privilege level that does not architecturally allow the reading of that state. The set of system registers that can have their value inferred by this method is implementation-specific.<<BR>>

 <<BR>>Intel’s analysis is that the majority of state exposed by the Variant 3a method is not secret or sensitive, nor directly enables attack or exposure of user data. The use of the Variant 3a method by an attacker may result in the exposure of the physical addresses for some data structures and may also expose the linear addresses of some kernel software entry points.<<BR>>

 <<BR>>Knowledge of these physical and linear addresses may enable attackers to determine the addresses of other kernel data and code elements, which may impact the efficacy of the Kernel Address Space Layout Randomization (KASLR) technique.<<BR>><<BR>>

 Firmware Mitigation::
 :: <<BR>>Speculative Store Bypass Disable (SSBD)

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-3639.html | CVE-2018-3639 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-Variant4 | Speculative Store Bypass (SSB - Variant 4 - Spectre-NG) ]]</nowiki>

 <<BR>>The speculative store bypass method takes advantage of a performance feature present in many high performance processors that allows loads to speculatively execute even if the address of preceding potentially overlapping store is unknown. In such a case, this may allow a load to speculatively read a stale data value. The processor will eventually correct such cases, but an attacker may be able to discover “confused deputy” code which may allow them to use speculative execution to reveal the value of memory that is not normally accessible to them.<<BR>><<BR>>

 OS and Firmware Mitigation: Speculative Store Bypass Disable (SSBD) ::
 :: <<BR>>SSBD prevents a load from executing speculatively until the address of all older stores are known. In Ubuntu, SSBD is OFF by default because it is not needed by most programs and carries a notable performance impact. A prctl() has been added (PR_SPEC_STORE_BYPASS) that enables developers to opt into the mitigation on a per process basis.

 Applications using seccomp filters will be implicitly opted into the mitigations (snaps, processes inside LXD containers, sandboxed firefox and chromium processes, will have SSBD mitigation enabled out of the box).<<BR>><<BR>>

=== L1 Terminal Fault (L1TF) ===

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-3615.html | CVE-2018-3615 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-L1TF | Intel SGX (Software Guard Extensions) (Foreshadow - L1TF) ]]</nowiki>

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-3620.html | CVE-2018-3620 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-L1TF | Operating Systems and System Management Mode (Fault-OS - SMM) (L1TF) ]]</nowiki>

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-3646.html | CVE-2018-3646 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-L1TF | Virtualization Extensions (L1TF) ]]</nowiki>

=== Microarchitectural Data Sampling (MDS) ===

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-12126.html | CVE-2018-12126 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-MDS | Microarchitectural Store Buffer Data Sampling (MSBDS - Fallout) ]]</nowiki>

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-12127.html | CVE-2018-12127 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-MDS | Microarchitectural Load Port Data Sampling (MLPDS - RIDL) ]]</nowiki>

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-12130.html | CVE-2018-12130 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-MDS | Microarchitectural Fill Buffer Data Sampling (MFBDS - ZombieLoad) ]]</nowiki>

 a. <nowiki>[[ https:--people.canonical.com-~ubuntu-security-cve-2018-CVE-2018-11091.html | CVE-2019-11091 ]]</nowiki> - <nowiki>[[ https:--wiki.ubuntu.com-SecurityTeam-KnowledgeBase-MDS | Microarchitectural Data Sampling Uncacheable Memory (MDSUM) ]]</nowiki>

== QEMU/KVM ONLY - Mitigations and CPU Flags ==

== Spectre and Meltdown mitigation detection tool ==

 <<BR>>There are different tools that can be used to detect these vulnerabilities in an environment (Architecture, CPU, Firmware Levels, OS Kernel, Hypervisor Types and Versions) AND to show you if all of them are mitigated or not.<<BR>>

 <<BR>>A very good one that can be used is: https://github.com/speed47/spectre-meltdown-checker

 <<BR>>Bellow you will find this tools output from a Cascade Lake CPU Server. Note that this document tried to explain all its acronyms for CPU Vulnerabilities and/or Mitigation Techniques above, so do search this document for an acronym found at the tool output if you need further explanation.<<BR>>

 <<BR>>TIP: I'd run the tool in the Hypervisor Host AND inside the VM OS, to make sure that both, the Host and the Guest have all mitigations in place. With the information provided in previous section of this document (QEMU/KVM Guests HW Mitigations) you will be able to make sure you're correctly advertising your REAL CPU Mitigation Flags into your Guests (so their OS can choose better technique for each of the vulnerabilities).<<BR>><<BR>>

 '''Spectre and Meltdown mitigation detection tool v0.42-1-g91d0699'''

<pre>
Checking for vulnerabilities on current system Kernel is Linux
4.18.0-23-generic #24~18.04.1-Ubuntu SMP Thu Jun 13 17:08:52 UTC 2019 x86_64
CPU is Intel(R) Xeon(R) Gold 6252 CPU @ 2.10GHz
</pre>

 '''Hardware check'''

<pre>
* Hardware support (CPU microcode) for mitigation techniques
** Indirect Branch Restricted Speculation (IBRS)
*** SPEC_CTRL MSR is available: YES
*** CPU indicates IBRS capability: YES (SPEC_CTRL feature bit)
** Indirect Branch Prediction Barrier (IBPB)
*** PRED_CMD MSR is available: YES
*** CPU indicates IBPB capability: YES (SPEC_CTRL feature bit)
** Single Thread Indirect Branch Predictors (STIBP)
*** SPEC_CTRL MSR is available: YES
*** CPU indicates STIBP capability: YES (Intel STIBP feature bit)
** Speculative Store Bypass Disable (SSBD)
*** CPU indicates SSBD capability: YES (Intel SSBD)
** L1 data cache invalidation
*** FLUSH_CMD MSR is available: YES
*** CPU indicates L1D flush capability: YES (L1D flush feature bit)
** Microarchitecture Data Sampling
*** VERW instruction is available: YES (MD_CLEAR feature bit)
** Enhanced IBRS (IBRS_ALL)
*** CPU indicates ARCH_CAPABILITIES MSR availability: YES
*** ARCH_CAPABILITIES MSR advertises IBRS_ALL capability: YES
** CPU explicitly indicates not being vulnerable to Meltdown/L1TF (RDCL_NO): YES
** CPU explicitly indicates not being vulnerable to Variant 4 (SSB_NO): NO
** CPU/Hypervisor indicates L1D flushing is not necessary on this system: YES
** Hypervisor indicates host CPU might be vulnerable to RSB underflow (RSBA): NO
** CPU explicitly indicates not being vulnerable to Microarchitectural Data Sampling (MDS_NO): YES
** CPU supports Software Guard Extensions (SGX): NO
** CPU microcode is known to cause stability problems: NO
    (model 0x55 family 0x6 stepping 0x6 ucode 0x4000021 cpuid 0x50656)
** CPU microcode is the latest known available version: NO
    (latest version is 0x4000024 dated 2019/04/07 according to builtin MCExtractor DB v112 - 2019/05/22)
</pre>

 '''CPU vulnerability to the speculative execution attack variants'''

<pre>
** Vulnerable to CVE-2017-5753 (Spectre Variant 1, bounds check bypass): YES
** Vulnerable to CVE-2017-5715 (Spectre Variant 2, branch target injection): YES
** Vulnerable to CVE-2017-5754 (Variant 3, Meltdown, rogue data cache load): NO
** Vulnerable to CVE-2018-3640 (Variant 3a, rogue system register read): YES
** Vulnerable to CVE-2018-3639 (Variant 4, speculative store bypass): YES
** Vulnerable to CVE-2018-3615 (Foreshadow (SGX), L1 terminal fault): NO
** Vulnerable to CVE-2018-3620 (Foreshadow-NG (OS), L1 terminal fault): NO
** Vulnerable to CVE-2018-3646 (Foreshadow-NG (VMM), L1 terminal fault): NO
** Vulnerable to CVE-2018-12126 (Fallout, microarchitectural store buffer data sampling (MSBDS)): NO
** Vulnerable to CVE-2018-12130 (ZombieLoad, microarchitectural fill buffer data sampling (MFBDS)): NO
** Vulnerable to CVE-2018-12127 (RIDL, microarchitectural load port data sampling (MLPDS)): NO
** Vulnerable to CVE-2019-11091 (RIDL, microarchitectural data sampling uncacheable memory (MDSUM)): NO
</pre>

 '''CVE-2017-5753 aka Spectre Variant 1, bounds check bypass'''

<pre>
* Mitigated according to the /sys interface: YES (Mitigation: __user pointer sanitization)
* Kernel has array_index_mask_nospec: YES (1 occurrence found of x86 64 bits array_index_mask_nospec())
* Kernel has the Red Hat/Ubuntu patch: NO
* Kernel has mask_nospec64 (arm64): NO

> STATUS: NOT VULNERABLE (Mitigation: __user pointer sanitization)
</pre>

 '''CVE-2017-5715 aka Spectre Variant 2, branch target injection'''

<pre>
* Mitigated according to the /sys interface: YES
 (Mitigation: Enhanced IBRS, IBPB: conditional, RSB filling)

* Mitigation 1
** Kernel is compiled with IBRS support: YES
*** IBRS enabled and active: YES
** Kernel is compiled with IBPB support: YES
*** IBPB enabled and active: YES

* Mitigation 2
** Kernel has branch predictor hardening (arm): NO
** Kernel compiled with retpoline option: YES
** Kernel supports RSB filling: YES

> STATUS: NOT VULNERABLE (IBRS + IBPB are mitigating the vulnerability)
</pre>

 '''CVE-2017-5754 aka Variant 3, Meltdown, rogue data cache load'''

<pre>
* Mitigated according to the /sys interface: YES (Not affected)
* Kernel supports Page Table Isolation (PTI): YES
** PTI enabled and active: NO
** Reduced performance impact of PTI: YES 
    (CPU supports INVPCID, performance impact of PTI will be greatly reduced)
* Running as a Xen PV DomU: NO

> STATUS: NOT VULNERABLE (your CPU vendor reported your CPU model as not vulnerable)
</pre>

 '''CVE-2018-3640 aka Variant 3a, rogue system register read'''

<pre>
* CPU microcode mitigates the vulnerability: YES

> STATUS: NOT VULNERABLE (your CPU microcode mitigates the vulnerability)
</pre>

 '''CVE-2018-3639 aka Variant 4, speculative store bypass'''

<pre>
* Mitigated according to the /sys interface: YES
  (Mitigation: Speculative Store Bypass disabled via prctl and seccomp)
* Kernel supports disabling speculative store bypass (SSB): YES (found in /proc/self/status)
* SSB mitigation is enabled and active: YES (per-thread through prctl)
* SSB mitigation currently active for selected processes: YES
  (systemd-journald systemd-logind systemd-networkd systemd-resolved systemd-timesyncd systemd-udevd)

> STATUS: NOT VULNERABLE (Mitigation: Speculative Store Bypass disabled via prctl and seccomp)
</pre>

 '''CVE-2018-3615 aka Foreshadow (SGX), L1 terminal fault'''

<pre>
* CPU microcode mitigates the vulnerability: N/A

> STATUS: NOT VULNERABLE (your CPU vendor reported your CPU model as not vulnerable)
</pre>

 '''CVE-2018-3620 aka Foreshadow-NG (OS), L1 terminal fault'''

<pre>
* Mitigated according to the /sys interface: YES (Not affected)
* Kernel supports PTE inversion: YES (found in kernel image)
* PTE inversion enabled and active: NO

> STATUS: NOT VULNERABLE (your CPU vendor reported your CPU model as not vulnerable)
</pre>

 '''CVE-2018-3646 aka Foreshadow-NG (VMM), L1 terminal fault'''

<pre>
* Information from the /sys interface: Not affected
* This system is a host running a hypervisor: YES
* Mitigation 1 (KVM)
** EPT is disabled: NO
* Mitigation 2
** L1D flush is supported by kernel: YES (found flush_l1d in /proc/cpuinfo)
** L1D flush enabled: NO
** Hardware-backed L1D flush supported: YES (performance impact of the mitigation will be greatly reduced)
** Hyper-Threading (SMT) is enabled: YES

> STATUS: NOT VULNERABLE (your CPU vendor reported your CPU model as not vulnerable)
</pre>

 '''CVE-2018-12126 aka Fallout, microarchitectural store buffer data sampling (MSBDS)'''

<pre>
* Mitigated according to the /sys interface: YES (Not affected)
* Kernel supports using MD_CLEAR mitigation: YES (md_clear found in /proc/cpuinfo)
* Kernel mitigation is enabled and active: NO
* SMT is either mitigated or disabled: NO

> STATUS: NOT VULNERABLE (your CPU vendor reported your CPU model as not vulnerable)
</pre>

 '''CVE-2018-12130 aka ZombieLoad, microarchitectural fill buffer data sampling (MFBDS)'''

<pre>
* Mitigated according to the /sys interface: YES (Not affected)
* Kernel supports using MD_CLEAR mitigation: YES (md_clear found in /proc/cpuinfo)
* Kernel mitigation is enabled and active: NO
* SMT is either mitigated or disabled: NO

> STATUS: NOT VULNERABLE (your CPU vendor reported your CPU model as not vulnerable)
</pre>

 '''CVE-2018-12127 aka RIDL, microarchitectural load port data sampling (MLPDS)'''

<pre>
* Mitigated according to the /sys interface: YES (Not affected)
* Kernel supports using MD_CLEAR mitigation: YES (md_clear found in /proc/cpuinfo)
* Kernel mitigation is enabled and active: NO
* SMT is either mitigated or disabled: NO

> STATUS: NOT VULNERABLE (your CPU vendor reported your CPU model as not vulnerable)
</pre>

 '''CVE-2019-11091 aka RIDL, microarchitectural data sampling uncacheable memory (MDSUM)'''

<pre>
* Mitigated according to the /sys interface: YES (Not affected)
* Kernel supports using MD_CLEAR mitigation: YES (md_clear found in /proc/cpuinfo)
* Kernel mitigation is enabled and active: NO
* SMT is either mitigated or disabled: NO

> STATUS: NOT VULNERABLE (your CPU vendor reported your CPU model as not vulnerable)
</pre>
