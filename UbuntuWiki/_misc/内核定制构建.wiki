{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__

The Kernel build documentation has moved to https://help.ubuntu.com/community/Kernel/Compile

How to build upstream (or git) kernels is located <nowiki>[[KernelTeam-GitKernelBuild|here]]</nowiki>

Please update any bookmarks or links pointing to this page.

This page is now used for comments, questions and discussion.

=== Comments ===

'''Q:''' How does one compile a driver module only without having to recompile the whole kernel. I have a custom joystick driver drivers/input/joystick/custom.c that I am tweaking. Will the procedure at http://www.cyberciti.biz/tips/build-linux-kernel-module-against-installed-kernel-source-tree.html work?

'''A:''' Here's some untested hints.

There's "building external modules" instruction doc in the kernel source:
http://lxr.linux.no/linux+v2.6.28.3/Documentation/kbuild/modules.txt

If you do "make help" in the kernel it mentions a .ko target:
 dir/file.ko     - Build module including final link
(around http://lxr.linux.no/linux+v2.6.28.3/Makefile#L1258)

MartinPitt: the easiest and best recipe that I found is to treat them as external modules, even when they are in-tree. This avoids having to configure the kernel tree, and also takes care to install them into `/extras/`, so that they don't overwrite the packages' kernel modules and you have an easy way to revert. For example, to test a patch to the i915 driver:

 <pre>
 cd linux-2.6.30/drivers/gpu/drm/i915/
 patch i915_drv.c /tmp/patch # make any modification you need here
 make -C /usr/src/linux-headers-`uname -r` M=`pwd` modules
 sudo make -C /usr/src/linux-headers-`uname -r` M=`pwd` modules_install
 sudo depmod -a
 </pre>

This will put the driver into /lib/modules/*/extra/i915.ko; if it breaks, just remove that and do `depmod -a` again.

MattBehrens: If you run into missing include files with MartinPitt's recipe above, you may need to set KBUILD_SRC as well.  For that same driver I had to do:

 <pre>
 make -C /usr/src/linux-headers-`uname -r` M=`pwd` KBUILD_SRC=`pwd`/../../../.. modules
 sudo make -C /usr/src/linux-headers-`uname -r` M=`pwd` KBUILD_SRC=`pwd`/../../../.. modules_install
 </pre>

'''Q:''' What about custom install and netboot images (and their initrd etc)?, PeterMagnusson

'''A:''' Take a look at the Debian Installer instructions for this: http://wiki.debian.org/DebianInstaller/Modify/CustomKernel  Although I haven't tried these instructions yet, and they might not quite work with the current Ubuntu Way, they look fairly comprehensive and should at least be a step in the right direction.  (MatthewPalmer)

'''Q:''' What directory are you in when you run these commands
ls -l debian/config/i386/
I'm sure you mean to untar the kernel source you just downloaded and cd into that tree (cd /usr/src ; tar xf linux-source-2.6.17.tar.bz2 ; cd linux-source-2.6.17) but there is no directory debian/config/i386 in there.
debian/Config has .config files in it, but no bigiron file so i dono where that kernel comes from?  EliCriffield

'''A:'''
Maybe he meant debian/Config?

'''A2:'''
On 6.06, the linux-source package does not include the debian directory, it seems. You need to install the source package for linux-image, with a command like

sudo apt-get source linux-image-2.6.15-27-386

SteveEdmondson

'''Q:''' Is there any way to get a kernel build faster? I would like to do some "light" kernel hacking. What are the easy steps to just compile a kernel image?
** you can try using make-kpkg, the standard debian kernel-building tool.  There are lots of guides around, hopefully the net person to read this page will have more time and put in a link.  
** http://newbiedoc.sourceforge.net/system/kernel-pkg.html

 
'''Q:''' What is Ubuntu's default kernel config?  The kernel doesn't put anything in /proc/config.
** like all debian-based system, ubuntu's kernel puts the config in <code> /boot/config-`uname -r` </code>

'''Q:''' Maybe that's not the right place to ask, but I am stuck... I am trying to compile a vanilla kernel (to test an issue with suspend/resume). I do not want to use the make-kpkg method --- too slow on recompiles. So I can compile the kernel, install modules, and then I make the initrd.img with the update-initramfs thing... and all seems to work, but the new kernel simply boots on a BusyBox and does not boot
the system. How do I build an initramfs image equivalent to the standard ubuntu one? RomanoGiannetti2
** Well, auto-answering. update-initramfs '''do''' work. I was bitten by this bug: 
http://lists.debian.org/debian-kernel/2006/07/msg00427.html
which seems to still exists. Call update-initramfs with -v and it will fail.

'''Q:''' What is the correct way to add 'lib/firmware/<custom-kernel>' to a custom kernel .deb so that the kernel and firmware can be distributed together?

'''Q:''' Where do the firmware images from the generic kernel come from - (ie which package?) - or how does one get them so one can build a generic kernel? It would be useful if this was explained somewhere.

I found that the system didn't recover very easily from errors and unsuccessful builds, and that the debian/rules "clean" target didn't always want to clean up, so I had to reinstall the source several times. It may be possible to redesign the debian/rules script to make it easier for non-devs to use. If I learn enough about Makefiles I will make an effort to do that...

'''Q:''' Where can I find the .config file for the \casper\ live cd 7.04 kernel  RichardWarwick

'''Q:''' The page gives a stern warning against building kernels just to customize a driver. Could we please have some other page with step-by-step instructions for customizing a driver. E.G. adding a device ID to usbserial? BensonMargulies2

'''A/Q:''' I recently had to build a kernel with the same version names just so I could basically load a serial PCI module the kernel maintainers won't patch and this also required I include a new kernel because the module is built into kernel instead of being a module. I agree, it is a really crappy way to do it but this is the only way I know which still lets all the Ubuntu repository packages still keep on keeping on. They still think it's the regular Ubuntu kernel. It is, with the exception of one darn PCI module. For what it's worth, here's the batch file of all this entailed:
* sudo apt-get build-dep linux-source-2.6.22 fakeroot
* sudo apt-get source linux-image-2.6.22-14-generic
* cd linux-source-2.6.22-2.6.22/
* # PATCH YOUR MODULE(s) SOURCE
* sudo cp /boot/config-2.6.22-14-generic .config
* # MAKE SMALL CHANGES TO THE KERNEL CONIFG IF NEEDED
* sudo make menuconfig
* cat /proc/version
* # notice the -14-generic part of the version and use this in the Makefile: EXTRAVERSION = -14
* sudo vi Makefile
* sudo make-kpkg --rootcmd fakeroot --initrd --append-to-version=-generic kernel-image
* sudo cp arch/i386/boot/bzImage /boot/bzImage-2.6.22-14-generic
* sudo cp YOUR-MODULE.ko to /lib/module/2.6.22-14-generic/kernel/MODULE-LOCATION/MODULE-NAME.ko
* # copy the default grub menu item and change the vmlinuz.... kernel to use bzImage.....
* sudo vi /boot/grub/menu.lst

'''Q''':Is there a better way and is there a way to just build modules instead of the whole kernel and all modules?

'''Q:''' When I try to run "debian/scripts/misc/oldconfig" I get the error:
"bash: debian/scripts/misc/oldconfig: Permission denied"
I get a similar error with debian/scripts/misc/splitconfig.pl
This is easy to workaround with "chmod +x debian/scripts/misc/oldconfig". However, is this a bug or an error in the doc, or ...?

'''Q:''' The linux-image-2.6.24-7-generic.deb is only 18MB, but my custom built kernel linux-image-2.6.24.3-kml-kml_2.6.24-16.30_i386.deb is 198MB. All I did was add the Kernel Mode Linux patch, and disable Paravirtualisation. Why would it be so large? Also when I try to install the deb it <nowiki>[[http://www.csse.uwa.edu.au/~john/bugs/InstallCustomKernel|claims]]</nowiki> it cannot find "/lib/firmware/2.6.24.3-kml-kml"; why?
* This expansion occurs when I use make-kpkg. When I use the other approach the kernel size is normal, but it seems to not build the .config changes into the kernel (though it does put them in /boot/....config)
* This expansion appears to be caused by the .ko files becoming larger. The standard net/ipv6/ipv6.ko file is 312K, but the one created by make-kpkg is 4.5MB.
* The expansion has nothing to do with the KML patch. It also occurs when attempting to compile a standard Ubuntu kernel with make-kpkg.
* A workaround is to set CONFIG_DEBUG_INFO=n in the .config file.
'''A:''' This is explained elsewhere in the wiki. We compile our kernels with debug symbols to create the debug packages. In our build process, we strip the debug symbols from the modules in the main package.

'''Q:''' The page says that I should copy the .config and customize it before doing a make-kpkg. However make-kpkg seems to overwrite the .config within a minute of starting. What gives?

'''A:''' make-kpkg normalises the .config. If your additions to the .config specify features that are not in the tree, then they will be removed. (E.g. you may have enabled options in .config, but forgot to patch the kernel to add support for those options to the kernel)

'''Q:''' How can you prevent Adept Updater from wanting to replace a custom kernel with the standard kernel before an update has occurred?

'''A:''' I think Adept Update adds new kernels but does not remove old ones. Try Editing /boot/grub/menu.lst and copy the entry for your custom kernel above the "AUTOMAGIC KERNELS LIST" so that it will remain the default boot kernel even after newer kernels have been installed.

'''Q/A:''' I have also noticed the warning against compiling your own kernel at the top of this howto, as well as the admonition that the availability of the linux-headers make it unnecessary to do a full kernel compile to build a single driver.  It has been my experience that the linux-headers don't work.  Every time I have to build vmware-tools modules, or third party drivers such as Tivoli Storage Manager tape library drivers the build fails with linux-headers.  So, if the system is to support such applications I always build my own kernel so that the running kernel has a complete set of matching source code, that actually works, to build other software against.  I also find it strange that a linux system with gcc installed can't build a 5 line "C" program that includes "stdio.h".  I did an "apt-get install build-essential" to fix this. Do enjoy the package management.

'''A:''' I have excellent experience building the VirtualBox guest kernel modules against absolutely clean installations of Ubuntu Desktop, in versions ranging from 6.06 to 10.04.

'''Q:''' This question may be the same as the one above about Adept Updater but I'm not sure.  After building a customized kernel using the first method (the Ubuntu way) the system updater will constantly try to downgrade your custom kernel to the stock Ubuntu kernel of the same version.  For example, I just built a custom 2.6.28-14 kernel.  After installing this custom kernel if I do an "apt-get dist-upgrade" it will replace my custom 2.6.28-14 kernel with the stock Ubutun 2.6.28-14 kernel.  What is the correct way to prevent that?

'''Q:''' In the sections on good and bad reasons to compile your own kernel, performance is not mentioned. Is there a performance gain after compiling the kernel locally?

'''Q:''' How do you unpack your kernel after step "Get the kernel source" and before "Modify the source for your needs"? Particularly, where is debian/config?

----
CategoryKernel CategoryDocumentation
