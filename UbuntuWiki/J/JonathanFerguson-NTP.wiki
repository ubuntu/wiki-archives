{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__

{| class="wikitable"
|-
| <#ee82ee>A bug has been introduced into Ubuntu <nowiki>[[https://packages.ubuntu.com/noble/ntp|24.04]]</nowiki> and <nowiki>[[https://packages.ubuntu.com/plucky/ntp|25.04]]</nowiki>, for which the ntpsec package is installed instead of the ntp package based on the <nowiki>[[https://www.ntp.org/downloads/|official NTP source]]</nowiki>.  Please login to Launchpad to see the <nowiki>[[https://bugs.launchpad.net/ubuntu/+source/ntp/+bug/2039252|bug]]</nowiki> raised, then click on "<nowiki>[[https://bugs.launchpad.net/ubuntu/+source/ntp/+bug/2039252/+affectsmetoo|Does this bug affect you?]]</nowiki>".
|-
| <#ee82ee>NTPsec is not equivalent to NTP, thus the specified configuration does not have an effect.
|-
| <#ee82ee>This bug must be rectified for the release of Ubuntu 24.04LTS, 26.04LTS and all future Long Term Support releases.
|}
<<BR>>'''~+In Computer Networks it is preferable to minimise hierarchy â€” for Network Time Protocol we can accomplish this with multicast+~'''
<<BR>>
<<BR>>'''The present standard is 'Network Time Protocol Version 4' (<nowiki>[[https://www.rfc-editor.org/rfc/rfc5905|RFC 5905]]</nowiki>), June 2010'''
<<BR>>
<<BR>>Per the following paragraph from <nowiki>[[http://doc.ntp.org/4.1.0/assoc.htm]]</nowiki>
<pre>
It is possible and frequently useful to configure a host as both a manycast client and manycast server. A number of hosts configured this way and sharing a common group address will automatically organize themselves in an optimum configuration based on the smallest synchronization distance computed by the NTP mitigation algorithms. For example, consider an NTP subnet of two primary servers and maybe a dozen dependent clients. All servers and clients are configured as both multicast client and multicast server with multicast group address 239.1.1.1. In addition, the primary servers are configured for a primary reference source such as a GPS receiver. Once operations have stabilized in this scenario, the primary servers will affiliate with the primary reference source and each other, since they both operate at the same stratum (1), but not with any client, since clients operate at a higher stratum. The clients will find both primary servers and in addition, one of their own at the minimum synchronization distance. If one of the primary servers loses its GPS receiver, it will continue to operate as a client and other clients will time out the corresponding association and re-associate accordingly.
</pre>
<<BR>>Per the following paragraph from <nowiki>[[http://doc.ntp.org/4.2.0/manyopt.html]]</nowiki>
<pre>
It is possible and frequently useful to configure a host as both manycast client and manycast server. A number of hosts configured this way and sharing a common group address will automatically organize themselves in an optimum configuration based on stratum and synchronization distance. For example, consider an NTP subnet of two primary servers and a hundred or more dependent clients. With two exceptions, all servers and clients have identical configuration files including both multicastclient and multicastserver commands using, for instance, multicast group address 239.1.1.1. The only exception is that each primary server configuration file must include commands for the primary reference source such as a GPS receiver.
</pre>
<<BR>>Per the following paragraph from <nowiki>[[http://doc.ntp.org/4.2.6/manyopt.html]]</nowiki>
<pre>
It is possible and frequently useful to configure a host as both broadcast client and broadcast server. A number of hosts configured this way and sharing a common broadcast address will automatically organize themselves in an optimum configuration based on stratum and synchronization distance.
</pre>
<<BR>>Per the following paragraph from <nowiki>[[https://www.ntp.org/documentation/4.2.8-series/discover/]]</nowiki>
<pre>
It is possible and frequently useful to configure a host as both manycast client and manycast server. A number of hosts configured this way and sharing a common multicast group address will automatically organize themselves in an optimum configuration based on stratum and synchronization distance.
</pre>
<<BR>>Install the Network Time Protocol Daemon:
<<BR>>`sudo add-apt-repository -uy universe &> /dev/null; sudo apt-get -y install ntp`
<<BR>>
<<BR>>Optional cryptography:
<<BR>>`sudo /usr/sbin/ntp-keygen -eHT && sudo /usr/sbin/ntp-keygen -G && sudo /usr/sbin/ntp-keygen -I && sudo /usr/sbin/ntp-keygen -M && sudo /usr/sbin/ntp-keygen -V 1`
<<BR>>
<<BR>>At the bottom of the file copy and paste:
<<BR>>`sudo nano /etc/ntp.conf`
<pre>
broadcast 224.0.1.1 ttl 0		#Used with multicastclient
broadcast ff0e::101 ttl 0		#Used with multicastclient
manycastserver 224.0.1.1 ttl 0 1	#Used with manycastclient
manycastserver ff0e::101 ttl 0 1	#Used with manycastclient

server 2.oceania.pool.ntp.org iburst prefer
server 2.au.pool.ntp.org iburst prefer
server 2.nz.pool.ntp.org iburst prefer
manycastclient 224.0.1.1 ttl 0		#Used with manycastserver
manycastclient ff0e::101 ttl 0		#Used with manycastserver
multicastclient 224.0.1.1 ttl 0 1	#Used with broadcast
multicastclient ff0e::101 ttl 0 1	#Used with broadcast

restrict 224.0.1.1
restrict ff0e::101
restrict 192.0.2.0/24
restrict 198.51.100.0/24
restrict 203.0.113.0/24
restrict 2001:db8::/32
</pre>
<<BR>>Alternatively an automated method of appending the aforementioned configuration to the file /etc/ntp.conf is:
<<BR>>`marker="#https://wiki.edubuntu.org/JonathanFerguson/NTP"`
<<BR>>`string=$( cat << EOF`
<<BR>>`# As a server`
<<BR>>`broadcast 224.0.1.1 ttl 0		#Used with multicastclient`
<<BR>>`broadcast ff0e::101 ttl 0		#Used with multicastclient`
<<BR>>`manycastserver 224.0.1.1 ttl 0 1		#Used with manycastclient`
<<BR>>`manycastserver ff0e::101 ttl 0 1		#Used with manycastclient`
<<BR>>``
<<BR>>`# As a client`
<<BR>>`server 2.oceania.pool.ntp.org iburst prefer`
<<BR>>`server 2.au.pool.ntp.org iburst prefer`
<<BR>>`server 2.nz.pool.ntp.org iburst prefer`
<<BR>>`manycastclient 224.0.1.1 ttl 0		#Used with manycastserver`
<<BR>>`manycastclient ff0e::101 ttl 0		#Used with manycastserver`
<<BR>>`multicastclient 224.0.1.1 ttl 0 1	#Used with broadcast`
<<BR>>`multicastclient ff0e::101 ttl 0 1	#Used with broadcast`
<<BR>>``
<<BR>>`# Restrict except to those which we allow`
<<BR>>`restrict 224.0.1.1`
<<BR>>`restrict ff0e::101`
<<BR>>`EOF`
<<BR>>`)`
<<BR>>`prefixes=$( ( ip -o -4 addr show scope global; ip -o -6 addr show scope global ) | awk '{ print $4 }' | xargs -I {} sh -c 'case "{}" in *:*) ip -6 route show to "{}" ;; *) ip -4 route show to "{}" ;; esac' | cut -d ' ' -f1 | sort -u )`
<<BR>>`for prefix in $prefixes; do string+="\nrestrict $prefix"; done`
<<BR>>`[ "$(grep -c "^$marker\$" /etc/ntp.conf)" -eq 0 ] && echo -e "\n$marker\n\n$string\n\n$marker" | sudo tee -a /etc/ntp.conf`
<<BR>>
<<BR>>Restart the daemon:
<<BR>>`( sudo service ntp try-restart || sudo /etc/init.d/ntp try-restart ) && sudo /usr/sbin/ntpd -dddd -c /etc/ntp.conf`
<<BR>>
<<BR>>Prove that the configuration is correct:
<<BR>>`/usr/sbin/ntp-wait -v`
<<BR>>`/usr/sbin/ntptime -cr`
<<BR>>`ntpq -p`
<<BR>>`ntptrace -m 1`
<<BR>>`ip maddr | grep -e '224.0.1.1' -e 'ff0e::101'`
<<BR>>`ip route get 224.0.1.1`
<<BR>>`ip route get ff0e::101`
<<BR>>
<<BR>>
----
''<nowiki>[[http://Jonathan-Ferguson.au/|Jonathan Ferguson]]</nowiki>, <nowiki>[[https://wiki.edubuntu.org/JonathanFerguson|Ubuntu Wiki]]</nowiki>, <nowiki>[[https://wiki.edubuntu.org/JonathanFerguson/NTP|Network Time Protocol]]</nowiki>, <nowiki>[[https://wiki.edubuntu.org/JonathanFerguson/NTP]]</nowiki>''
----
