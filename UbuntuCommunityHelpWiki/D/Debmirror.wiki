{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work.
* A '''full compressed version''' of the wiki is available on archive.org
|}

__TOC__



''For information on Ubuntu mirroring, see <nowiki>[[https://wiki.ubuntu.com/Mirrors|Mirrors]]</nowiki>''

=== To build a mirror with debmirror follow these steps ===

This is not covering all use cases but it will allow you experiment. To do this safely 100 gigs of space are needed to mirror main source and binaries. This number grows a lot as time progresses.

==== Alternative Consideration ====

1. If you want to don't download all the apt binaries for all boxes onto one box on a network then maybe
 <<BR>>1.1. Apt-cache, <nowiki>[[https://help.ubuntu.com/community/Apt-Cacher-Server|Apt-Cacher-Server]]</nowiki>
 <<BR>>1.2. Apt-Cacher-Ng <nowiki>[[https://wiki.debian.org/AptCacherNg|apt-cacher-ng]]</nowiki>
 <<BR>>1.3. Transparent proxy <nowiki>[[http://help.ubuntu.com/community/HttpReplicator|http-replicator]]</nowiki>
2. rsync. The <nowiki>[[http://help.ubuntu.com/community/Rsyncmirror|Rsyncmirror]]</nowiki> page goes into greater detail on this method. Rsync can create a full mirror of a site and selects files indiscriminately. Debmirror, however, does allow for better control over which packages are mirrored and can be easier on the amount of hard drive space required.

==== Start The Mirror Build Process ====

Open gnome-terminal by clicking Applications -> Accessories -> Terminal.
<<BR>>If your sources list has universe enabled, skip the next step.
<<BR>>Open your sources list (<code>sudo sensible-editor /etc/apt/sources.list</code>), and add the following line:
<pre>
deb http://archive.ubuntu.com/ubuntu/ focal universe
</pre>
<<BR>>Then save and return to a prompt.

'''Update the package lists and then install debmirror:'''

<pre>
sudo apt-get update
sudo apt-get install debmirror gnupg xz-utils
</pre>

Gnupg is need for keyring. Xz is need for decompression.
 
<<BR>> Now we have to create a directory to save the files to. The approximate size of the components of the mirror  are:
{| class="wikitable"
|-
| feisty
| ~27G
| main, restricted, universe, multiverse (i386 only)
| 
|-
| dapper
| 15G
| main, restricted, universe, multiverse (i386 only)
| 
|-
| trusty
| 60G
| main, restricted, universe, multiverse (i386 only)
| 
|-
| Bionic
| 192G
| main, restricted, universe, multiverse (amd64 )
| bionic bionic-security bionica-updates
|-
| focal
| 142G
| main, restricted, universe, multiverse (amd64 )
| focal focal-security focal-updates
|}

Please ensure where ever you make the mirror has room for the packages you want to download!
<<BR>>(If you are more advanced you can make different parts of the mirror on different volumes, but that is not something for this howto).

<<BR>>The tree structur we will end up with:
<pre>
/opt/UbuntuMirror/
├── mirrorkeyring
│   ├── trustedkeys.kbx
├── ubuntu-mirror
│   ├── dists
│   ├── pool
│   └── project
├── mirrorbuilder.sh
</pre>

<<BR>>We will make our mirror on /opt/ with
<pre>
sudo mkdir /opt/UbuntuMirror
</pre>

=== Create the file `mirrorbuild.sh` ===

Now to create `mirrorbuild.sh`
<<BR>>Open your prefered editor thus
<pre>
sudo sensible-editor /opt/UbuntuMirror/mirrorbuild.sh
</pre>

Copy the text from the box below into the editor.
<<BR>>You may omit the lines starting with # (EXCEPTION: the line that starts #!/bin/bash must be left in.)

==== Contents of the mirror script, please adapt it to your needs ====
<pre>

export GNUPGHOME=/opt/UbuntuMirror/mirrorkeyring

arch=amd64

section=main,restricted,universe,multiverse

release=focal,focal-security,focal-updates

server=archive.ubuntu.com

inPath=/ubuntu

proto=http

outPath=/opt/UbuntuMirror/ubuntu-mirror

debmirror	-a $arch \
		--no-source \
		-s $section \
		-h $server \
		-d $release \
		-r $inPath \
		--progress \
		--method=$proto \
		$outPath

</pre>

==== How to use the file ====
	Save the file and exit.
        Give it execute permissions

<pre>
sudo chmod +x /opt/UbuntuMirror/mirrorbuild.sh
</pre>

==== GPG keyring file ====
Depending on what version of gpg that is used, different filenames are used for the keyring. "pubring.gpg", "trustedkeys.gpg"

<pre>
sudo mkdir /opt/UbuntuMirror/mirrorkeyring
gpg --no-default-keyring --keyring /opt/UbuntuMirror/mirrorkeyring/trustedkeys.gpg --import /usr/share/keyrings/ubuntu-archive-keyring.gpg
</pre>

'''For a mirror host running older releases (Unknown change date):'''

<pre>
sudo mkdir /opt/UbuntuMirror/mirrorkeyring
gpg --no-default-keyring --keyring /opt/UbuntuMirror/mirrorkeyring/pubring.gpg --import /usr/share/keyrings/ubuntu-archive-keyring.gpg
</pre>

'''Now change the permissions and ownership on the mirror.'''

The group name is your username:
<pre>
sudo chown -R root:username /opt/UbuntuMirror/mirrorkeyring
sudo chmod -R 571 /opt/UbuntuMirror/mirrorkeyring
</pre>

=== Run the program ===

 And the final part of setting up the mirror is to execute the files:
<pre>
/opt/UbuntuMirror/mirrorbuild.sh
</pre>
Now walk away. Your machine has a lot of downloading to do! Seriously... it'll take hours to download > 140 Gigabyte of data.

=== Set up the remote access to the mirror via http ===

We need to install Apache2. You could choose Apache version 1.3 but that is beyond the scope of this document.
<<BR>>	We can do this with `sudo apt-get install apache2`
<<BR>>
<<BR>> Then (for simplicity sake) lets make a link from /home/UbuntuMirror to /var/www/ubuntu.
<<BR>> Replace"${mirrorbox-hostname}" with your DNS or IP-address.
<pre>
ln -s /opt/UbuntuMirror/ubuntu-mirror /var/www/html/ubuntu
</pre>
This means when you go to download from your mirror, you will visit `http://${mirrorbox-hostname}/ubuntu/`.

to test from commandline:
<pre>
wget  http://localhost/ubuntu/dists/focal-security/Release.gpg
</pre>
<<BR>>
<<BR>>	Right! So we have all the packages, and a working server. Now we need to set up the clients.

=== Add a cronjob to keep the mirror updated ===

If you want to keep your mirror fresh, you will want to stick your mirror script in cron. To edit root's crontab, do:
<pre>
sudo crontab -e
</pre>
And now add the following line:
<pre>
2 */12 * * * /opt/UbuntuMirror/mirrorbuild.sh

</pre>
Which will run two minutes after the hour every twelve hours. MAKE SURE that there is a blank line after the line you added, otherwise it will never run. If you want to be paranoid, restart cron:
<pre>
sudo /etc/init.d/cron restart
</pre>

=== Set up a client system ===

Open a terminal and enter
<pre>
cd /etc/apt
sudo mv sources.list sources.list.orig
sudo sensible-editor sources.list
</pre>
Replace"${mirrorbox-hostname}" with your DNS or IP-address.
<<BR>> Now in your editor, put the following lines:
<pre>
deb http://${mirrorbox-hostname}/ubuntu focal main restricted universe multiverse
deb http://${mirrorbox-hostname}/ubuntu focal-security main restricted universe multiverse
deb http://${mirrorbox-hostname}/ubuntu focal-updates main restricted universe multiverse
</pre>

Then save and exit
<<BR>>	If you then run
<pre>
sudo apt-get update
sudo apt-get dist-upgrade
</pre>
you should be updating from your new server!

=== advanced ===

==== Local translations ====
By default language spesific packages will be download, examples are:

 . "*language-pack-*"
 . "*locale-*"
 . "*l10n-*"
 . "*myspell-*_"
 . "manpages-*"

and if <nowiki>[[http://manpages.ubuntu.com/manpages/trusty/man1/debmirror.1.html|--i18n]]</nowiki> is use  Additionally download Translation-<lang>.bz2.

To filter out this package you need to use ''''--exclude='''' and ''''--include=''''.

Example with norwegian:
<pre>
--exclude='/Translation-.*' --include='/Translation-(no|en).*'
--exclude='/language-pack-.*' --include='/language-pack-?(gnome|kde)-(no|en).*'
--exclude='(thunderbird|firefox)-locale-.*' --include='(thunderbird|firefox)-locale-(nb|nn).*'
--exclude='/libreoffice-l10n.*' --include='/libreoffice-l10n-(nb|nn).*'
--exclude='/manpages-(\w{2}|\w{2}-extra|\w{2}-dev|\w{2}-extra-dev)_.*'
--exclude='/myspell-(\w{2}|\w{2}-\w{2,3}|)[-_].*' --include='/myspell-(nb|nn).*'
</pre>

==== Exclude deb section ====

<nowiki>[[https://www.debian.org/doc/debian-policy/ch-archive.html#s-subsections|deb section]]</nowiki>

For a industral setting not all is needed:
<pre>
--exclude-deb-section=games \
--exclude-deb-section=news \ 
--exclude-deb-section=science \
--exclude-deb-section=xfce \ 
--exclude-deb-section=mail \
--exclude-deb-section=hamradio \
--exclude-deb-section=haskell \ 
--exclude-deb-section=education \
</pre>

=== Debmirror using config file ===
Debmirror has support for using config files, making it easyer to automate with tools like Ansible:

The script: 
<pre>

export GNUPGHOME=/etc/debmirror

debmirror --config-file=/etc/debmirror/ubuntu.conf

</pre>

Example of config:
<pre>
$mirrordir="/volume1/debmirror/Ubuntu";

$progress=1;
$host="no.archive.ubuntu.com";

$remoteroot="/ubuntu";
$download_method="http";

@dists=( 'focal', 'focal-security', 'focal-updates',);
@sections=( 'main', 'restricted', 'universe', 'multiverse',);
@arches=( 'amd64',);
@excludes=( '/Translation-.*', '/Translation-en.gz', '/language-pack-.*', '(thunderbird|firefox)-locale-.*', '/libreoffice-l10n.*', '/manpages-(\w{2}|\w{2}-extra|\w{2}-dev|\w{2}-extra-dev)_.*', '/myspell-(\w{2}|\w{2}-\w{2,3}|)[-_].*', '/unidic-mecab.*', '/libreoffice-dev-doc.*', '/thunderbird-dbg.*', '/firefox-dbg.*', '/texlive-fonts-extra.*',);
@includes=( '/myspell-(nb|nn).*', '/libreoffice-l10n-(nb|nn).*', '(thunderbird|firefox)-locale-(nb|nn).*', '/language-pack-?(gnome|kde)-(no|en).*', '/Translation-(no|en\.|en_GB|en_US).*',);
$i18n=1;
$do_source=0;

$state_cache_days=1;

$timeout=1;

$rsync_batch=200;
$rsync_options="-aIL --partial";

$diff_mode="use";

1;

</pre>

----
CategoryNetworking CategoryPackageManagement
