{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work.
* A '''full compressed version''' of the wiki is available on archive.org
|}

__TOC__


== Introduction ==
This document describes how to configure the Logitech TrackMan Marble Mouse (USB), shown in the following figure:

<nowiki>[[File:marble-mouse-buttons-names.png|Logitech Marble Mouse USB|position="left"]]</nowiki>

What Logitech calls left and right button are coded 1 and 3, with no middle button; the small buttons Logitech calls "Forward" and "Backward" are coded as back (8) and forward (9). This knowledge will help you create your own mappings, if desired.

== Without any special configuration ==

Without any special configuration, the mouse would work the way expected:

* '''Left''' - Normal left mouse button.
* '''Back''' - Single click is back
* '''Forward''' - Single click is next.
* '''Right''' - Normal right mouse button.

However, the mouse lacks scroll buttons and middle button. These have to be emulated. This article is about how to make that happen.

== Ubuntu 18.04 and newer ==

This section guides the reader on how to establish a working trackball, tested using Ubuntu 18.04 through 19.04 (note the middle click caveat above). In 18.04, things are mostly the same as prior, but the driver has shifted from "evdev" to "libinput".  This requires some minor tweaks to the options.

=== Configuration ===
To get your Marble Mouse working in Ubuntu 18.04, complete the following steps:
# Locate the existing '''xorg.conf.d''' directory: <code> locate xorg.conf.d | grep d$ </code>
# In Ubuntu 18.04, it is located in /usr/share/X11/ 
# Edit '''40-libinput.conf''' in that directory. (Note: Do not create your own '''xorg.conf.d''' directory as it can disable your keyboard and freeze X.)
# Add a new <code>InputClass</code> section of '''40-libinput.conf''' using one of the example configurations below.
# Logout and restart X, or reboot.
# If editing '''40-libinput.conf''' does not work, edit '''/etc/X11/xorg.conf''' instead. The remainder of this section refers to this as the '''X Configuration File'''.
# Tip: Upgrading from 18.10 to 19.04 the modified 40-libinput.conf was overwritten back to the distribution version.  A solution is to create a new 39-libinput.conf with only the contents of this section.  An extra precaution is to create a new directory /opt/etc and put the file there, then symlink it to the original.  For my system, that was '''sudo ln -s /etc/x11/39-libinput.conf /usr/share/X11/xorg.conf.d/39-libinput.conf'''.

For an explanation of the libinput options used below, see man (4) libinput, also available online <nowiki>[[https://wayland.freedesktop.org/libinput/doc/latest/configuration.html|here]]</nowiki>.

For a guide on how to update libinput in Wayland, including how to test options in run-time before encoding them in the configuration files, see <nowiki>[[https://wayland.freedesktop.org/libinput/doc/latest/faqs.html#faq-configure-wayland|here]]</nowiki>.

=== Example Configuration #1: add wheel emulation feature ===

This configuration yields:
* '''Left''' - Normal left mouse button.
* '''Back''' - Single click is back; 
* '''Forward''' - Single click is next; press and hold to scroll freely horizontally and vertically.
* '''Right''' - Normal right mouse button.

Add the following text to the '''X Configuration File''':

<pre>
Section "InputClass"
        Identifier  "Marble Mouse"
        MatchProduct "Logitech USB Trackball"
        Driver "libinput"
        Option "ScrollMethod" "button"
        Option "ScrollButton" "9"
EndSection
</pre>

In this case, mouse wheel is emulated by pressing and holding the "Forward" button, the button 9. You can configure to use button 8, the "Back" button, instead, but, in that case, both "Left button" and "Back Button" would need to be pressed together in order to select text while scrolling, and since both buttons are under a thumb, it will be rather acrobatic to do it with just one thumb.

=== Example Configuration #2: add middle mouse button emulation ===

<pre>
Section "InputClass"
        Identifier  "Marble Mouse"
        MatchProduct "Logitech USB Trackball"
        Driver "libinput"
        Option "ScrollMethod" "button"
        Option "ScrollButton" "9"
        Option "MiddleEmulation" "on"
EndSection
</pre>

With this configuration, clicking left and right mouse button at the same time results a middle-click, which function as pasting the selected text under cursor to the place under mouse pointer.

=== Trouble Shooting ===
Once you have logged back in, if it is not immediately working you can run
<pre>
tail -f /var/log/Xorg.0.log
</pre>
from a terminal, unplug and re-plug your mouse, and see what the X server is doing.  You should see (among other things) two successive lines something like this:

<pre>
(**) Logitech USB Trackball: Applying InputClass "libinput pointer catchall"
(**) Logitech USB Trackball: Applying InputClass "Marble Mouse"
</pre>

If you only see the first and not the second, your <code>InputClass</code> section is being ignored.  Either it is failing one of the Match lines (see the following paragraphs) or the configuration file it is in is being ignored entirely.  If the Match lines appear correct, try moving the configuration from xorg.conf to xorg.conf.d/ as per above, or vice-versa.

In the above examples, the device name given in the <code>MatchProduct</code> option is "Logitech USB Trackball". Older models of the Marble Mouse may have a different name. Take a look at the output of the following command to determine the name of your device and change that line if necessary:

<pre>
dmesg | grep Logitech
</pre>

Edit the <code>MatchProduct</code> line in the above configuration to use your device name.
For instance, older trackballs may use the following:
<pre>
        MatchProduct "ImExPS/2 Logitech Explorer Mouse"
</pre>

These older models may also use a different button mapping:
<pre>
        Option "ButtonMapping" "1 8 3 4 5 6 7 2 9"
</pre>

== From Ubuntu 10.04 to 17.10 ==

This section guides the reader on how to establish a working trackball using Ubuntu 10.04 through 17.10 (note the middle click caveat above). In 10.04, hal is gone, and udev does not appear to be reliably supported by Xorg. However, Xorg supports <code> InputClass </code> sections in its configuration files, which are described here.

=== Configuration ===
To get your Marble Mouse working in Ubuntu 10.04, complete the following steps:
# Locate the existing '''xorg.conf.d''' directory: <code> locate xorg.conf.d | grep d$ </code>
# In Ubuntu 14.04, it is located in /usr/share/X11/ 
# Edit '''50-marblemouse.conf''' in that directory. (Note: Do not create your own '''xorg.conf.d''' directory as it can disable your keyboard and freeze X.)
# Update the <code>InputClass</code> section of '''50-marblemouse.conf''' using one of the example configurations below.
# Logout and restart X, or reboot.
# If editing '''50-marblemouse.conf''' does not work, edit '''/etc/X11/xorg.conf''' instead. The remainder of this section refers to this as the '''X Configuration File'''.

For an explanation of the evdev options used below, see man (4) evdev, also available online <nowiki>[[http://www.x.org/archive/X11R7.5/doc/man/man4/evdev.4.html|here]]</nowiki> (for X.org 7.5 as used in Ubuntu 10.04, 10.10 and 11.04).

=== Example Configuration #1: add wheel emulation feature ===

This configuration yields:
* '''Left''' - Normal left mouse button.
* '''Back''' - Single click is back; 
* '''Forward''' - Single click is next; press and hold to scroll freely horizontally and vertically.
* '''Right''' - Normal right mouse button.

Add the following text to the '''X Configuration File''':

<pre>
Section "InputClass"
        Identifier  "Marble Mouse"
        MatchProduct "Logitech USB Trackball"
        MatchIsPointer "on"
        MatchDevicePath "/dev/input/event*"
        Driver "evdev"
        Option "EmulateWheel" "true"
        Option "EmulateWheelButton" "9"
EndSection
</pre>

In this case, mouse wheel is emulated by pressing and holding the "Forward" button, the button 9. You can configure to use button 8, the "Back" button, instead, but, in that case, both "Left button" and "Back Button" would need to be pressed together in order to select text while scrolling, and since both buttons are under a thumb, it will be rather acrobatic to do it with just one thumb.

=== Example Configuration #2: add middle mouse button emulation ===

<pre>
Section "InputClass"
        Identifier  "Marble Mouse"
        MatchProduct "Logitech USB Trackball"
        MatchIsPointer "on"
        MatchDevicePath "/dev/input/event*"
        Driver "evdev"
        Option "EmulateWheel" "true"
        Option "EmulateWheelButton" "9"
        Option "Emulate3Buttons" "true"
EndSection
</pre>

With this configuration, clicking left and right mouse button at the same time results a middle-click, which function as pasting the selected text under cursor to the place under mouse pointer.

In Ubuntu 12.04 and later, one additional configuration needs to be done. The default setting for '''middle-button-enabled''' in Gnome is '''false'''. Since Gnome settings are applied '''after''' xorg settings, this results in middle button emulation disabled. To fix this, run the following in a terminal:

<pre>
gsettings set org.gnome.settings-daemon.peripherals.mouse middle-button-enabled true
</pre>

This needs to be done only once for each user - Gnome remembers this setting between logins.

For a GUI alternative to `gsettings`, install the `dconf-tools` package and run `dconf-editor`. The setting can be found at org::gnome::settings-daemon::peripherals::mouse.

=== Example Configuration #3, forgo "Back" button ===
This example yields:
* '''Left Button''' - Normal left mouse button.
* '''Back Button''' - Normal middle mouse button.
* '''Forward Button''' - Single click results 'next'. Press and hold scrolls with the trackball vertically.
* '''Right Button''' - Normal right mouse button.

Add the following text to the '''X Configuration File''':
<pre>
Section "InputClass"
    Identifier      "Marble Mouse"
    MatchProduct    "Logitech USB Trackball"
    MatchIsPointer  "on"
    MatchDevicePath "/dev/input/event*"
    Driver          "evdev"
    Option          "SendCoreEvents" "true"

### Physical buttons come from the mouse as:
### Big:   1 3
### Small: 8 9
### 
### This makes left small button (8) into the middle, and puts
### scrolling on the right small button (9).
### 
    Option "Buttons"            "9"
    Option "ButtonMapping"      "1 8 3 4 5 6 7 2 9"
    Option "EmulateWheel"       "true"
    Option "EmulateWheelButton" "9"

EndSection
</pre>

If you intend this:
* '''Forward Button''' - Scroll freely with the trackball, both horizontally and vertically.

Add this:
<pre>
    Option "YAxisMapping"       "4 5"
    Option "XAxisMapping"       "6 7"
</pre>

=== Trouble Shooting ===
Once you have logged back in, if it is not immediately working you can run
<pre>
tail -f /var/log/Xorg.0.log
</pre>
from a terminal, unplug and re-plug your mouse, and see what the X server is doing.  You should see (among other things) two successive lines something like this:

<pre>
(**) Logitech USB Trackball: Applying InputClass "evdev pointer catchall"
(**) Logitech USB Trackball: Applying InputClass "Marble Mouse"
</pre>

If you only see the first and not the second, your <code>InputClass</code> section is being ignored.  Either it is failing one of the Match lines (see the following paragraphs) or the configuration file it is in is being ignored entirely.  If the Match lines appear correct, try moving the configuration from xorg.conf to xorg.conf.d/ as per above, or vice-versa.

In the above examples, the device name given in the <code>MatchProduct</code> option is "Logitech USB Trackball". Older models of the Marble Mouse may have a different name. Take a look at the output of the following command to determine the name of your device and change that line if necessary:

<pre>
dmesg | grep Logitech
</pre>

Edit the <code>MatchProduct</code> line in the above configuration to use your device name.
For instance, older trackballs may use the following:
<pre>
        MatchProduct "ImExPS/2 Logitech Explorer Mouse"
</pre>

These older models may also use a different button mapping:
<pre>
        Option "ButtonMapping" "1 8 3 4 5 6 7 2 9"
</pre>

== Ubuntu 9.10 and older ==
=== Introduction ===
Input devices are now configured using Hal, which means most settings in '''xorg.conf''' will be ignored when X starts. Hal's configuration files are stored in '''/etc/hal/fdi/policy''' with a file name extension of '''.fdi'''. After making configuration changes, restart X (or reboot the computer).

=== Ubuntu 9.10 - 24-Mar-2010 ===
Avoid using Hal for this release as it has known issues. Try the following:
1. Edit '''''$HOME/bin/trackball.sh''''': <pre>
dev="Logitech USB Trackball"
we="Evdev Wheel Emulation"
xinput set-int-prop "$dev" "$we Button" 8 8
xinput set-int-prop "$dev" "$we" 8 1

# Make sure '''''trackball.sh''''' begins with '''#!/bin/bash'''.
# Make the script executable: <pre>
chmod +x $HOME/bin/trackball.sh
</pre>
2. Add the following lines to '''''$HOME/.bashrc''''': <pre>
xmodmap $HOME/.Xmodmap > /dev/null 2>&1
$HOME/bin/trackball.sh
</pre>
3. Edit '''''$HOME/.Xmodmap''''': <pre>
pointer = 1 8 3 4 5 6 7 9 2
</pre>

Logout and log back in. This setup provides:
* '''Left Button''' - Left click
* '''Back Button''' - Hold to scroll; click for '''back'''
* '''Forward Button''' - Paste highlighted text (simulates middle-click)
* '''Right Button''' - Right click

=== Horizontal and Vertical Scrolling Example ===
To enable vertical and horizontal scrolling while holding down the small, left mouse button ("Back Button" in the image) change '''/etc/hal/fdi/policy/mouse-wheel.fdi''' to:

<pre>
<?xml version="1.0" encoding="ISO-8859-1"?>
<deviceinfo version="0.2">
  <device>
    <match key="info.product" string="Logitech USB Trackball">
      <merge key="input.x11_options.ButtonMapping" type="string">1 2 3 4 5 6 7 8 9</merge>
      <merge key="input.x11_options.EmulateWheel" type="string">true</merge>
      <merge key="input.x11_options.EmulateWheelButton" type="string">8</merge>
      <merge key="input.x11_options.ZAxisMapping" type="string">4 5</merge>
      <merge key="input.x11_options.XAxisMapping" type="string">6 7</merge>
      <merge key="input.x11_options.Emulate3Buttons" type="string">true</merge>
    </match>
  </device>
</deviceinfo>
</pre>

=== Vertical Scrolling Example ===
To enable vertical scrolling while holding down the small, left mouse button ("Back Button" in the image), change '''/etc/hal/fdi/policy/mouse-wheel.fdi''' to:

<pre>
<?xml version="1.0" encoding="ISO-8859-1"?>
<deviceinfo version="0.2">
  <device>
    <match key="info.product" string="Logitech USB Trackball">
      <merge key="input.x11_options.ButtonMapping" type="string">1 8 3 9 2</merge>
      <merge key="input.x11_options.EmulateWheel" type="string">true</merge>
      <merge key="input.x11_options.EmulateWheelButton" type="string">8</merge>
      <merge key="input.x11_options.ZAxisMapping" type="string">4 5</merge>
      <merge key="input.x11_options.Emulate3Buttons" type="string">false</merge>
    </match>
  </device>
</deviceinfo>
</pre>

Here's the /etc/hal/fdi/policy/mouse-wheel.fdi for '''left-handed operation''' (with right-handed in comments):

<pre>
<?xml version="1.0" encoding="ISO-8859-1"?>
<deviceinfo version="0.2">
  <device>
    <match key="info.product" string="Logitech USB Trackball">
      <merge key="input.x11_options.Buttons" type="string">9</merge>
      <merge key="input.x11_options.EmulateWheel" type="string">true</merge>
      <merge key="input.x11_options.EmulateWheelTimeout" type="string">300</merge>
      <!-- Left hand -->
      <merge key="input.x11_options.ButtonMapping" type="string">3 9 1 4 5 6 7 8 2</merge>
      <merge key="input.x11_options.EmulateWheelButton" type="string">9</merge>
      <!-- Right hand -->
      <!-- <merge key="input.x11_options.ButtonMapping" type="string">1 8 3 4 5 6 7 2 9</merge> -->
      <!-- <merge key="input.x11_options.EmulateWheelButton" type="string">8</merge> -->
      <merge key="input.x11_options.XAxisMapping" type="string">6 7</merge>
      <merge key="input.x11_options.YAxisMapping" type="string">4 5</merge>
      <merge key="input.x11_options.ZAxisMapping" type="string">4 5</merge>
      <merge key="input.x11_options.Emulate3Buttons" type="string">true</merge>
    </match>
  </device>
</deviceinfo>
</pre>

==== Firefox ====
If vertical scrolling does not work in Firefox, ensure the following '''about:config''' values are set (using Firefox):

<pre>
mousewheel.horizscroll.withnokey.action		user set	integer	0
mousewheel.horizscroll.withnokey.sysnumlines	user set	boolean	true
</pre>

=== Middle Click ===
Currently the button mapping described above is being ignored by Hal. (As of 9.04 it appears that the button mapping is now applied correctly. Only use one method or the other.)  This is particularly problematic if you want one of the small buttons to serve as middle click.  A simple workaround is to remap what you need via xmodmap.  As an example, let's map the small left button as middle click.  Save this in your .Xmodmap file:

<pre>
pointer = 1 8 3 4 5 6 7 2 9
</pre>

Note that all we did was to swap the numbers 2 and 8.  If you'd like to use the small right button as middle click, swap 2 and 9 instead.  The .Xmodmap file will be loaded next time you log in.  To run it manually, run:

<pre>
$ xmodmap .Xmodmap
</pre>

Using xmodmap affects all mice you have plugged in, an alternative is to use xinput to remap the buttons just for the device you specify.

<pre>
$ xinput set-button-map "Logitech USB Trackball" 1 8 3 4 5 6 7 2 9
</pre>

xinput may report the trackball as having 32 buttons and some window managers such as fluxbox require you to map all buttons reported for the device even though the buttons do not exist when using xinput.  For fluxbox and similar window mangers the command below would map the trackball for left handed use.  The large button on the right would be left click, the large button on the left would be right click, the small button on the right would function as a middle button, and the small button on the left would function as the scroll.

<pre>
$ xinput set-button-map "Logitech USB Trackball" 3 9 1 4 5 6 7 8 2 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32
</pre>

If you have a different device and don't know its identifier, you can find it via:

<pre>
$ xinput list
</pre>

=== Setting options via HAL may not work in Ubuntu 9.10 by default ===
Ubuntu 9.10 (Karmic Koala) contains gnome-settings-daemon 2.28.1 which does not honour settings made in /etc/hal/fdi/policy/. This is filed as http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=552279. A workaround by disabling the mouse plugin of gnome-settings-daemon is described at http://bbs.archlinux.org/viewtopic.php?pid=644304. In my case  (MacBook Pro 5,4 using the bcm5974 touchpad module) I had to reboot once after applying the workaround to make it stick. After this, I could change the settings as expected by editing the HAL fdi file and restarting HAL (some settings may need a module reload, too). Note that you can use
<pre>
$ lshal | less
</pre>
or similar to check whether the fdi settings were correctly merged into the configuration.

=== Alternative: apply settings via xinput ===
If you do not want to use HAL (or apply the workaround from the above section in Ubuntu 9.10), using xinput provides an alternative way to make the Logitech Marble work.

Horizontal & vertical scrolling with small left key & drag lock with small right key example:
<pre>
xinput set-button-map "Logitech USB Trackball" 1 2 3 4 5 6 7 8 9
xinput set-int-prop "Logitech USB Trackball" "Evdev Wheel Emulation Button" 8 8
xinput set-int-prop "Logitech USB Trackball" "Evdev Wheel Emulation" 8 1
xinput set-int-prop "Logitech USB Trackball" "Evdev Wheel Emulation Axis" 8 6 7 4 5
xinput set-int-prop "Logitech USB Trackball" "Evdev Wheel Emulation X Axis" 8 6
xinput set-int-prop "Logitech USB Trackball" "Evdev Drag Lock Buttons" 8 9
</pre>

You can add the lines above in a bash script (say marbleScroll.sh):

Now run the script
<pre>
$ sh marbleScroll.sh
</pre>

You can check what you have made via:
<pre>
$ xinput list-props "Logitech USB Trackball"
</pre>

=== External Links ===
* <nowiki>[[http://mvogt.wordpress.com/2008/08/15/xorg-evdev-and-emulatewheel/]]</nowiki> - Explanation of how to find your input device using xinput.
* <nowiki>[[https://bugs.launchpad.net/ubuntu/+source/xserver-xorg-input-evdev/+bug/261400]]</nowiki> - Link to launchpad with further explanation of how the new hal policy works.
* <nowiki>[[http://ubuntuforums.org/showthread.php?t=938487]]</nowiki> - Link to original thread in intrepid testing forums for the Logitech Marble Mouse USB.
* <nowiki>[[http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=552279]]</nowiki> - Link to Debian bug report about gnome-settings-daemon 2.28.x
* <nowiki>[[http://bbs.archlinux.org/viewtopic.php?pid=644304]]</nowiki> - Link to a workaround for said issue in gnome-settings-daemon.

----
CategoryHardware CategoryX
