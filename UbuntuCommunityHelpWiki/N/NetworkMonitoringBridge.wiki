{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__


== Introduction ==

This document outlines the creation of a network monitoring bridge on Ubuntu 14.04 but should work on any supported versions at this time. (15/4/16) The bridge can be transparently plugged into any segment of a local subnet to analyze network traffic without disturbing network services.  Several services are used for monitoring and they provide comprehensive statistics on network usage and throughput.  For more information on what a bridge is see the Linux Documentation Project <nowiki>[[http://www.tldp.org/HOWTO/BRIDGE-STP-HOWTO/index.html|Bridging Howto]]</nowiki>.

=== Sample uses of the network monitor ===
1. Analyze connection problems to local database server
    ''Network configuration'': LAN <=> switch <=> Database server

    ''Network with monitoring'': LAN <=> switch <=> Network Monitoring Bridge <= PATCH CABLE => Database server

2. Analyze network usage on a subnet at our University
    ''Network configuration'': INTERNET <=> Gateway firewall <=> Switch <=> Local network Computers

    ''Network with monitoring'': INTERNET <=> Gateway firewall <= PATCH CABLE => Network Monitoring Bridge <=> Switch <=> Local network Computers

== Prerequisites ==

Begin with a PC. Almost any modern PC will be enough for moderate bandwidth, but if you need close to full gigabit speeds, you will need a more powerful CPU and buss. (PCI will not support full gigabit speeds as you will fill the buss one way and have no room going back out.) Install two network cards on this machine and obtain a Patch cable. If you use gigabit cards, you will not need a crossover cable to connect directly to another PC. If, however, you use 100 meg cards, you may need a crossover cable.  You may begin with either a Desktop or Server installation of Ubuntu. See InstallingSoftware for more information.

You will need to know your interfaces names. This used to be eth0 and eth1, but now we have <nowiki>[[https://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/|Predictable Network Interface Names]]</nowiki> which means they could be eth0, p3p1, p2p1, enp9s0, wlp9s0, or eno16777728. (Yes, those are all real examples. Do an <code>ifconfig</code> from the cli to find out what Ubuntu is actually calling your nics.

== Install and configure the Software ==

Install bridge utilities from Main repository
<pre> 
sudo apt-get install bridge-utils 
</pre>

Install monitoring tools
<pre> 
sudo apt-get install darkstat etherape ntop ssh traceroute wireshark zenmap
</pre>
'''NOTE:''' ntopng is a similar, but updated ntop that you may want to consider.

=== Configure the Bridge ===

Edit /etc/network/interfaces to reflect your network topology. The following example configuration configures the bridge via DHCP. You could easily modify the line <code> iface bridge01 inet dhcp </code> to be <code> iface bridge01 192.168.1.2 netmask 255.255.255.0 up </code> for a static IP address.

Sample /etc/network/interfaces file
<pre>

auto lo
iface lo inet loopback

auto br0
iface br0 inet dhcp
        bridge_ports eth0 eth1
        bridge_stp off
        bridge_fd 0
        bridge_maxwait 0
</pre>
If you have used bridge utilities on older versions of Linux, you will note that <code>auto eth0</code> and <code>iface eth0 inet manual</code> are not in the file.  This is because br0 will bring up the components assigned to it.

Restart networking
<pre> 
sudo /etc/init.d/networking restart 
</pre>
or
<pre> 
sudo reboot
</pre>

=== Configure ntop ===

Edit ntop configuration 
<pre> 
sudo nano /var/lib/ntop/init.cfg
</pre>

Change the INTERFACES line to the name of your bridge. Something like... 
<pre>
INTERFACES="br0"
</pre>

configure NTOP to recognize your local subnet 
<pre> 
sudo nano /etc/default/ntop 
</pre>

Change the GETOPTS variable to something like...
<pre> 
GETOPTS="--local-subnets=192.168.1.0/24" 
</pre>

Set the admin password for NTOP (Enter the password for your sudo account)
<pre> 
sudo ntop --set-admin-password 
</pre>

Restart NTOP
<pre> 
sudo /etc/init.d/ntop restart 
</pre>

Test ntop by browsing to http://localhost:3000

=== Configuing DarkStat ===

Edit the configuration file:
<pre>
sudo nano /etc/darkstat/init.cfg
</pre>
<pre>
START_DARKSTAT=yes

INTERFACE="-i br0"

PORT="-p 8888"
</pre>
'''NOTE:''' You can also pick eth0 or eth1 as the interface to prevent tracking your own monitoring traffic.  Simply pick the interface that is not between you and the core.

=== Configuing Wireshark ===

Wireshark is a GUI application.  But it does not need a GUI on the monitoring server to run.  You can access it remotely with ssh -X even with no GUI on the server.

You will need to configure wireshark to allow non root users to capture packets.
<pre>
sudo dpkg-reconfigure wireshark-common
</pre>
You will need to add allowed users to "wireshark" group.
<pre>
sudo nano /etc/group
</pre>

== Install device and begin monitoring ==

# To begin monitoring choose a place on your network that you would like to monitor as shown in the examples above
# Plug the patch cable to one of the network devices on the Network Monitoring Bridge
# Unplug the network cable from the computer you would like to monitor and plug the cable into the other network device of the Network Monitoring Bridge
# Plug free end of the patch cable to the computer that will be monitored
# Restart networking on the Network Monitoring Bridge
<pre>
 sudo /etc/init.d/networking restart
 </pre>
 
View network traffic statistics via ntop at http://ip_address_of_network_monitor:3000

View network traffic statistics via darkstat at http://ip_address_of_network_monitor:8888

Access the other programs via ssh.
<pre>
ssh -X ip_address_of_network_monitor
</pre>

Run wireshark, etherape or zenmap in a GUI on your local workstation. (If you are on Windows, youmay wantto install <nowiki>[[http://mobaxterm.mobatek.net/|MobaXterm]]</nowiki> It is a Windows ssh client with X already integrated, with easy setup.

Run nmap from an ssh command line without X if needed.

== Additional Information ==

Bridging is popular, and so it has reference material in several places that may not all be updated at once.  These are the links I know of;
* <nowiki>[[KVM-Networking|KVM Networking]]</nowiki> - Network configuration for the KVM virtual machines server.
* <nowiki>[[NetworkConnectionBridge|Network Connection Bridge]]</nowiki> - This page.
* <nowiki>[[BridgingNetworkInterfaces|Installing bridge utilities]]</nowiki> - A similar page from a Bridge-Utils point of view.
* <nowiki>[[NetworkMonitoringBridge|Network Monitoring Bridge]]</nowiki> - An in-line sniffer page.

----
