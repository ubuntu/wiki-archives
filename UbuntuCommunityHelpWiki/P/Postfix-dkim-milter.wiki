{|
  | '''Warning'''
  * This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
  * '''Images''' and '''attachments''' have been removed to conserve space.
  * '''Links''' may not work and there may be formatting issues.
  * A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__


== Introduction ==

DomainKeys Identified Mail (DKIM) is a method for E-mail authentication, allowing a person who receives email to verify that the message actually comes from the domain that it claims to have come from. The need for this type of authentication arises because spam often has forged headers.

DKIM uses public-key cryptography to allow the sender to electronically sign legitimate emails in a way that can be verified by recipients.

DKIM also guards against tampering with mail, offering almost end-to-end integrity from a signing to a verifying Mail transfer agent (MTA). 

<nowiki>[[http://en.wikipedia.org/wiki/DKIM|Read more on Wikipedia]]</nowiki>

dkim-milter is a milter-based application (dkim-filter) which plugs in to <nowiki>[[Postfix]]</nowiki> to provide DomainKeys Identified Mail service for your.  NOTE: Starting with Ubuntu 10.04, dkim-filter is deprecated.  Use the opendkim package instead.  Configuration is generally similar to dkim-filter, but it is still actively maintained.

== Installation ==

We assume you already successfully installed Postfix MTA, if not, please read the <nowiki>[[Postfix]]</nowiki> dedicated page.

To install '''dkim-milter''', you need Universe repositories added, if so, use your favorite package manager and install the package. For example:
<pre>
sudo aptitude install dkim-milter
</pre>

Simply accept the defaults when the installation process asks questions. The configuration will be done in greater detail in the next stage.

== Configuration ==

'''dkim-milter''' configuration consists of two files:
<pre>
/etc/dkim-filter.conf
/etc/default/dkim-filter
</pre>

Use your favorite editor to edit those files.
Here's an example of '''/etc/dkim-filter.conf''' file already edited to suit my needs:
<pre>
Syslog			yes
UMask			105 # 'id postfix' in your sheel

Domain			ubuntu.ro
KeyFile			/etc/mail/dkim.key # See bellow how to generate and set up the key
Selector		mail

AutoRestart		yes
Background		yes
Canonicalization	simple
DNSTimeout		5
Mode			sv
SignatureAlgorithm	rsa-sha256
SubDomains		no
X-Header		no

Statistics		/var/log/dkim-filter/dkim-stats
</pre>

Actually '''/etc/dkim-filter.conf''' is the most important file. It provides our milter with required information about selector (used for DNS requests and email verifications) and used signing key (the key is used for signing the outgoing emails).

Here's an example of '''/etc/defaults/dkim-filter'''. This file is used to literally connect the milter to MTA:
<pre>
SOCKET="inet:8891@localhost" # Ubuntu default - listen on loopback on port 8891
</pre>

In my case, this file needs no additional editing.

Now, to tell the Postfix about the existing milter, and where to connect with it, edit your Postfix main.cf file '''/etc/postfix/main.cf''', and append to its content the following data:
<pre>
milter_default_action = accept
milter_protocol = 2
smtpd_milters = inet:localhost:8891
non_smtpd_milters = inet:localhost:8891
</pre>

If you are using already some milter (for example <nowiki>[[Postfix-DomainKeys]]</nowiki>), you can add the new one like this:
<pre>
milter_default_action = accept
milter_protocol = 2
smtpd_milters = inet:localhost:8891,inet:localhost:8892
non_smtpd_milters = inet:localhost:8891,inet:localhost:8892
</pre>

== Key generation for dkim-milter and its setup with DNS ==

Actually it's not big deal. Generate an OpenSSL RSA key as you do it always, then move it private part to the location you indicated in your '''/etc/dkim-filter.conf''':
<pre>
openssl genrsa -out private.key 1024
openssl rsa -in private.key -out public.key -pubout -outform PEM
cp private.key /etc/mail/dkim.key
</pre>

The DNS record should look like this:
<pre>
mail._domainkey.ubuntu.ro. IN TXT "k=rsa; t=y; p=PpYHdE2tevfEpvL1Tk2dDYv0pF28/f 5MxU83x/0bsn4R4p7waPaz1IbOGs/6bm5QIDAQAB"
</pre>

Where everything after '''p=''' is actually the content of the public key we generated above, '''public.key'''. To use it, strip out the comments inside it, this:
<pre>
-----BEGIN PUBLIC KEY-----
</pre>
and this:
<pre>
-----END PUBLIC KEY-------
</pre>

== Startup and testing ==

Once configuration above was done, the daemon can be started with:
<pre>
sudo /etc/init.d/dkim-filter start
</pre>
If it doesn't start, search the logs for problems and see what it requires more:
<pre>
grep -i dkim /var/log/mail.log
</pre>

Also you can test your config file:
<pre>
dkim-filter -x /etc/dkim-filter.conf
</pre>
If you get the error like: '''dkim-filter: milter socket must be specified'''
Then try manually specifing the socket, in our case it is local:
<pre>
dkim-filter -x /etc/dkim-filter.conf -p local
</pre>

Now restart the Postfix MTA, and check for email signing:
<pre>
/etc/init.d/postfix restart
</pre>

For testing purposes, I recommend you tools like:
* http://www.sendmail.org/dkim/tools
* or just send an email to autorespond+dkim[at]dk.elandsys.com

Testing results should look like this in Gmail:
{{http://stas.nerd.ro/blog/data/dkim-filter.png}}
