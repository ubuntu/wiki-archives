{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__



== Introduction ==

This document will teach you how to set up a basic Postfix mail server with IMAP and POP3 services. It does not included advanced topics such as integrating virus-checking and spam-filtering, which are dealt with in PostfixVirtualMailBoxClamSmtpHowto and PostfixCompleteVirtualMailSystemHowto.

== Setup Overview ==

In our setup, Postfix sends and receives mail from Internet and stores them in the user mailboxes while clients on the Internet can retrieve their mails via Courier IMAP or POP3. The user authentication is done by Courier Authdaemon. The following diagram shows this process.

'''<nowiki>[[File:SetupOverview.jpg]]</nowiki>'''

== Anatomy of Postfix ==

=== Components ===

The following figure shows the main Postfix system components, and the main information flows between them.

'''<nowiki>[[File:PostfixComponentsNw.gif]]</nowiki>'''

* Yellow ellipsoids are mail programs.
* Yellow boxes are mail queues or files.
* Blue boxes are lookup tables.
* Programs in the large box run under control by the Postfix resident master daemon.
* Data in the large box is property of the Postfix mail system.

=== Receiving Mail ===

When a message enters the Postfix mail system, the first stop is the incoming queue. The figure below shows the main components that are involved with new mail.

'''<nowiki>[[File:PosfixRecieving.gif]]</nowiki>'''

* Mail is posted locally. The Postfix <nowiki>[[http://www.postfix.org/sendmail.1.html|sendmail]]</nowiki> program invokes the privileged <nowiki>[[http://www.postfix.org/postdrop.1.html|postdrop]]</nowiki> program which deposits the message into the '''maildrop''' directory, where the message is picked up by the <nowiki>[[http://www.postfix.org/pickup.8.html|pickup]]</nowiki> daemon. This daemon does some sanity checks, in order to protect the rest of the Postfix system.

* Mail comes in via the network. The Postfix <nowiki>[[http://www.postfix.org/smtpd.8.html|SMTP server]]</nowiki> receives the message and does some sanity checks, in order to protect the rest of the Postfix system.

* Mail is generated internally by the Postfix system itself, in order to return undeliverable mail to the sender. The <nowiki>[[http://www.postfix.org/bounce.8.html|bounce or defer]]</nowiki> daemon brings the bad news.

* Mail is forwarded by the <nowiki>[[http://www.postfix.org/local.8.html|local]]</nowiki> delivery agent, either via an entry in the system-wide <nowiki>[[http://www.postfix.org/aliases.5.html|alias]]</nowiki> database, or via an entry in a per-user <nowiki>[[http://www.postfix.org/aliases.5.html|.forward]]</nowiki> file. This is indicated with the unlabeled arrow.

* Mail is generated internally by the Postfix system itself, in order to <nowiki>[[http://www.postfix.org/basic.html#notify|notify]]</nowiki> the postmaster of a problem (this path is also indicated with the unlabeled arrow).The Postfix system can be configured to notify the postmaster of SMTP protocol problems, <nowiki>[[http://en.wikipedia.org/wiki/E-mail_spam|UCE]]</nowiki> policy violations, and so on.

* The <nowiki>[[http://www.postfix.org/cleanup.8.html|cleanup]]</nowiki> daemon implements the final processing stage for new mail. It adds missing '''From:''' and other message headers, arranges for address rewriting to the standard user@fully.qualified.domain form, and optionally extracts recipient addresses from message headers. The '''cleanup''' daemon inserts the result as a single queue file into the '''incoming''' queue, and notifies the <nowiki>[[http://www.postfix.org/qmgr.8.html|queue manager]]</nowiki> of the arrival of new mail. The '''cleanup''' daemon can be configured to transform addresses on the basis of <nowiki>[[http://www.postfix.org/rewrite.html#canonical|canonical]]</nowiki> and <nowiki>[[http://www.postfix.org/rewrite.html#virtual|virtua]]</nowiki> table lookups.

* On request by the cleanup daemon, the <nowiki>[[http://www.postfix.org/trivial-rewrite.8.html|trivial-rewrite]]</nowiki> daemon rewrites addresses to the standard user@fully.qualified.domain form.

== Install Postfix ==

In this setup I assume that your domain is <code>yourdomain.com</code> and it has a valid MX record setup as <code>mail.yourdomain.com</code>. Remember to replace <code>yourdomain.com</code> with your actual domain in the example codes in this howto. Also I assume that you know what an MX record is. To find out MX your type in a terminal:

<pre>
dig mx yourdomain.com
</pre>

'''To install postfix'''

<pre>
sudo apt-get install postfix
</pre>

Install mailx package for use as command mail utility program. Mail command is installed with this package.

<pre>
sudo apt-get install mailutils
</pre>

== Test your default setup ==

Add a user before you start this.

<pre>
sudo useradd -m -s /bin/bash fmaster
sudo passwd fmaster
</pre>

Test your default installation using the following code segment.

<pre>
telnet localhost 25
</pre>
(if that doesn't work, check to see if postfix is running)
<pre>
sudo postfix status
</pre>
If it is not running, start it
<pre>
sudo postfix start
</pre>

Postfix will prompt like following in the terminal so that you can use to type SMTP commands.

<pre>
Trying 127.0.0.1...
Connected to mail.fossedu.org.
Escape character is '^]'.
220 localhost.localdomain ESMTP Postfix (Ubuntu)
</pre>

Type the following code segment in Postfix's prompt.

<pre>
ehlo localhost
mail from: root@localhost
rcpt to: fmaster@localhost
data
Subject: My first mail on Postfix

Hi,
Are you there?
regards,
Admin
. (Type the .[dot] in a new Line and press Enter )
quit
</pre>

Check the mailbox of <code>fmaster</code>

<pre>
su - fmaster
mail
</pre>

When you type <code>mail</code> command an output like follows display in your terminal.

<pre>
Mail version 8.1.2 01/15/2001.  Type ? for help.
"/var/mail/fmaster": 2 messages 2 new
>N  1 root@localhost     Mon Mar  6 12:49   13/479   Just a test
 N  2 root@localhost     Mon Mar  6 12:51   15/487   My first mail
&
</pre>
You will observe that mails are indexed by numbers and you can type the number of which the mail that you want to read. For example type no <code>"2"</code> to read the 2nd mail. The type <code>"q"</code> to quit. The mail will be written to a file called <code>mbox</code> in user's home directory. According to our example it will be <code>/home/fmaster/mbox</code>.

All messages in an mbox type of mailbox are concatenated and stored in a single file. The beginning of each message is indicated by a line whose first five characters are "From " and a blank line is appended to the end of each message

== Setting Postfix Support for Maildir-style Mailboxes ==

Maildir is a format for an e-mail spool that does not require file locking to maintain message integrity because the messages are kept in separate files with unique names. A Maildir is a directory (often named Maildir) with three subdirectories named tmp, new, and cur. The subdirectories should all reside on the same filesystem.

Another reason to use Maildir format is that Courier IMAP/POP3 servers only work with  Maildir format of mailboxes.

Please find out more about Maildir <nowiki>[[http://en.wikipedia.org/wiki/Maildir|here]]</nowiki>

Instruct Postfix to use Maildirs instead of Mboxes:

<pre>
 sudo postconf -e "home_mailbox = Maildir/"
</pre>

Ensure Procmail isn't used: (if the step was taken during dpkg-reconfigure, by mistake)

<pre>
sudo postconf -e "mailbox_command = "
</pre>

'''Restart Postfix''' to make changes effect.

<pre>
sudo  /etc/init.d/postfix restart
</pre>

Test your setup again

Check the mailbox of <code>fmaster</code>

<pre>
su - fmaster
MAIL=/home/fmaster/Maildir
mail
</pre>

== Installing courier IMAP and POP3 ==

<pre>
sudo apt-get install courier-pop
sudo apt-get install courier-imap
</pre>

== Adding your local domains to postfix ==

Add your domains to <code>mydestination</code>:
(my destination is a value in the postfix configuration file. to view your existing setting, type sudo postconf mydestination)

<pre>
sudo postconf -e "mydestination = mail.fossedu.org, localhost.localdomain, localhost, yourdomain.com"
</pre>
(note that command above will overwrite your previous settings of mydestination, so make note of your previous entries)

'''Add your local networks, too:'''

Postfix comes with the localhost (127.0.0.1) entry; you may have others, here we assume your LAN is on 192.168.1.0/24.  Make changes to suit your situation.

<pre>
sudo postconf -e "mynetworks = 127.0.0.0/8, 192.168.1.0/24"
</pre>

'''Make Postfix to receive mail from the Internet'''

Instruct Postfix to receive on all interfaces:

<pre>
sudo postconf -e "inet_interfaces = all"
</pre>

'''(optional) Make Postfix accept IPv4, IPv6 protocols'''

If you're not using IPv6 yet, and you're paranoid, use "ipv4" instead of "all". Again, this is to suit your own network sensibilities.

<pre>
sudo postconf -e "inet_protocols = all"
</pre>

'''Start courier-authdaemon'''

The courier-authdaemon isn't started after installation. Without it, imap authentication will fail:

<pre>
sudo service courier-authdaemon start
</pre>

'''Configure courier-authdaemon to start on boot:'''

<pre>
sudo systemctl enable courier-authdaemon
</pre>

Finally, restart Postfix;

<pre>
sudo  /etc/init.d/postfix restart
</pre>

Test your setup again using following code:

<pre>
netcat mail.yourdomain.com 25
ehlo yourdomain.com
mail from: root@yourdomain.com
rcpt to: fmaster@yourdomain.com
data
Subject: My first mail for my domain

Hi,
Are you there?
regards,
Admin
. (and Enter In a new Line)
quit
</pre>

Check the mailbox of <code>fmaster</code>

<pre>
su - fmaster
cd Maildir/new
ls
</pre>

Now you will see mail has a separate file.

== Testing Courier POP3 ==

Type in a terminal:

<pre>
netcat mail.yourdomain.com 110
</pre>

Use the following example code segment for your test. Be intelligent to tweak the changes appropriately to your environment. An output like follows will display in your terminal.

<pre>
Connected to mail.yourdomain.com (208.77.188.166).
Escape character is '^]'.
+OK Hello there.
</pre>

Type the following code segment in the prompt provided by the Courier POP3 server. I assume that you are intelligent enough not to type the lines which starts from <code>+OK</code>

<pre>
user fmaster
+OK Password required.
pass password
+OK logged in.
quit
</pre>

== Testing Courier IMAP ==

Type in a terminal:

<pre>
netcat mail.yourdomain.com 143
</pre>

Use the following example code segment for your test. Be intelligent and tweak the changes appropriately to your environment. An output like follows will display in your terminal.

<pre>
* OK [CAPABILITY IMAP4rev1 UIDPLUS CHILDREN NAMESPACE THREAD=ORDEREDSUBJECT THREAD=REFERENCES SORT QUOTA IDLE ACL ACL2=UNION STARTTLS XCOURIEROUTBOX=INBOX.Outbox] Courier-IMAP ready. Copyright 1998-2005 Double Precision, Inc.  See COPYING for distribution information.
</pre>

Type the following code segment in the prompt provided by the Courier IMAP server.

<pre>
a login fmaster password
a OK LOGIN Ok.
a logout
</pre>

== Local Alias database ==

When mail is to be delivered locally, the local delivery agent runs each local recipient name through the  aliases database. The mapping does not affect addresses in message headers. Local aliases are typically used to implement distribution lists, or to direct mail for standard aliases such as '''postmaster''' to real people. The table can also be used to map Firstname.Lastname addresses to login names.

Alias lookups are enabled by default and you will see following code segment in '''main.cf''' file.

<pre>
...
alias_maps = hash:/etc/aliases
...
</pre>

=== Creating an alias for an account ===

The following codes illustrate how you can setup an alias. This step is optional since we are going to configure virtual mail domains later in this howto. I have added this step to make sure you understand how you can do this in case it is required.

'''Create a user'''

<pre>
sudo useradd -m -s /bin/bash sysadmin
sudo passwd sysadmin
</pre>

'''Edit the alias table'''

Open the alias file with:

<pre>
sudo vi /etc/aliases
</pre>

Add the following code:

<pre>
fmaster: sysadmin
</pre>

To make your changes take effect type:

<pre>
sudo newaliases
</pre>

To test your changes send a mail to <code>fmaster</code> and check the mail in <code>/home/sysadmin/Maildir/new</code> folder.

== Per User .forward Files ==

Users can control their own mail delivery by specifying destinations in a file called .forward in their home directories. The syntax of these files is the same as system aliases, except that the lookup key and colon are not present.

I will illustrate an example here:

Assume that you need to forward all the mails which come to the sysadmin account to an another account.  Enter the following commands:

<pre>
su - sysadmin
touch .forward
</pre>

Then open the .forward file

<pre>
vi .forward
</pre>

Add  the following code:

<pre>
fossedu@example.com
</pre>

Remember to use email address which exists in this exercise.

Now send a mail to <code>sysadmin</code> and mail should come to fossedu@example.com

== Postfix virtual Aliases for separate domains and Linux system accounts ==

With this approach, every hosted domain can have its own info etc. email address. However, it still uses Linux system accounts for local mailbox deliveries.

With virtual alias domains, each hosted address is aliased to a local UNIX system account or to a remote address. The example below shows how to use this mechanism for the fossedu.org and linuxelabs.com domains.

Inside the '''main.cf''' file, we tell it how to handle these virtual domains:

<pre>
sudo postconf -e "virtual_alias_domains = fossedu.org linuxelabs.com"
sudo postconf -e "virtual_alias_maps = hash:/etc/postfix/virtual"
</pre>

Edit the <code>/etc/postfix/virtual</code> file:

Add two Linux system accounts

<pre>
sudo useradd -m -s /bin/bash sigiri
sudo useradd -m -s /bin/bash kala
</pre>

Set passwords for the above users.

<pre>
sudo passwd sigiri
sudo passwd kala
</pre>

<pre>
sudo vi /etc/postfix/virtual
</pre>

Add the following code segment:

<pre>
info@fossedu.org       sigiri
info@linuxelabs.com    kala
</pre>

To create a Map Database type :
<pre>
sudo postmap /etc/postfix/virtual
</pre>
postmap is  utility program that will convert <code>/etc/postfix/virtual</code> to <code>/etc/postfix/virtual.db</code> in Berkley DB format, so that Postfix can access the data faster.

Restart Postfix to make changes take effect:

<pre>
sudo /etc/init.d/postfix restart
</pre>

Send mails to both info@fossedu.org and info@linuxelabs.com and those mails should come to mailboxes of  '''sigiri''' and '''kala''' respectively.
