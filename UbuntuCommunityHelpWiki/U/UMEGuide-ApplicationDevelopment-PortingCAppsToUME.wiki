{|
  | '''Warning'''
  * This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
  * '''Images''' and '''attachments''' have been removed to conserve space.
  * '''Links''' may not work and there may be formatting issues.
  * A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__

This uses some information <nowiki>[[http://moblin.org/howto_porting-maemo.html|from upstream]]</nowiki>. If you are feeling really brave do <nowiki>[[http://lists.maemo.org/pipermail//maemo-developers/2006-August/005316.html|this]]</nowiki> first.

== Objective ==
This shows how to port an application  written in C (liferea) to Ubuntu Mobile. <nowiki>[[http://liferea.sourceforge.net/|Liferea]]</nowiki> is an aggregator for online news feeds written in C utilizing GTK for its graphical interface.

== Assumed Knowledge ==
You have set up the UME development environment as show <nowiki>[[https://wiki.ubuntu.com/MobileAndEmbedded/CreatingAnImageForUMEDevice|here]]</nowiki>. Also that you can change the Flash UI as explained <nowiki>[[http://ianlawrence.info/random-stuff/location-services-on-ubuntu-mobile|here]]</nowiki>. You should be familiar with or have the desire to learn C programming, including the 'auto' tools. A good tutorial on automake is <nowiki>[[http://sourceware.org/autobook/|here]]</nowiki>

'''Dependencies Needed'''

aptitude install libgtkhtml2-0 libgtkhtml2-dev libxml-perl libxslt1-dev libglade2-0 libglade2-dev libsqlite3-0 libsqlite3-dev libhildondesktop-dev xulrunner

== Overview ==
Porting applications basically comes down to two things:

1. Use <code>HildonProgram</code> and <code>HildonWindow</code> classes instead of the <code>GtkWindow</code> class.

2. Use the <code>HildonWindow</code> menu bar instead of the <code>GTKMenuBar</code>

== Get the source and try to compile ==
<code>user@machine:/home/ian/Dev/Ume/ports/src# apt-get source liferea</code>
this downloads the source

<pre>
liferea-1.4.2
liferea_1.4.2.orig.tar.gz
liferea_1.4.2-0ubuntu1.diff.gz
liferea_1.4.2-0ubuntu1.dsc</pre>

this gives some ./autoconf errors like:
<pre>
No package 'libxslt' found
No package 'sqlite3' found
No package 'libglade-2.0' found</pre>

which are the applications dependencies, so install the packages needed if you have not already done so:
<code>aptitude install libgtkhtml2-0 libgtkhtml2-dev libxml-perl libxslt1-dev libglade2-0 libglade2-dev libsqlite3-0 libsqlite3-dev libhildondesktop-dev xulrunner</code>

this passed autoconf but running make gave an error of:

<pre>
gtkhtml2.c: In function 'gtkhtml2_launch_url':
gtkhtml2.c:458: error: too many arguments to function 'update_request_new'
gtkhtml2.c:458: warning: assignment from incompatible pointer type
gtkhtml2.c:459: error: dereferencing pointer to incomplete type
gtkhtml2.c:460: error: dereferencing pointer to incomplete type
gtkhtml2.c:461: error: dereferencing pointer to incomplete type
gtkhtml2.c:462: error: dereferencing pointer to incomplete type
gtkhtml2.c:463: error: dereferencing pointer to incomplete type
gtkhtml2.c:465: error: too few arguments to function 'update_execute_request'
make[4]: *** [liblihtmlg_la-gtkhtml2.lo] Error 1
make[4]: Leaving directory `/home/ian/Desktop/liferea-1.4.2/src/gtkhtml2'</pre>

It seems to be hitting by <nowiki>[[http://www.nabble.com/Stable-Release-1.4.2-t4432014.html|this]]</nowiki> bug.

So downloaded the <nowiki>[[http://sourceforge.net/project/downloading.php?group_id=87005&use_mirror=osdn&filename=liferea-1.4.3.tar.gz&1674222|latest bugfix stable release 1.4.2b]]</nowiki> and this compiled successfully and also ran make ok so now it is time to 'Hildonize' it. 

== HILDONIZING ==

It is useful to know that the default location for C header files is in <code>/usr/include</code>. Inside this directory we have another directory hildon-1 and inside this directory we have hildon, so the full path to the hildon header files is:
<code>/usr/include/hildon-1/hildon</code>
 
First modify the file configure.ac
Around line 42 add the line:

<code> AC_ARG_ENABLE(hildon,    AS_HELP_STRING([--enable-hildon],[compile for Hildon environment @<:@default=no@:>@]),,enable_hildon=no)</code>

and then on lines 212 - 225 add:

<pre>
dnl ********
dnl Hildon
dnl ********
 
if test "x$enable_hildon" = "xyes"; then
   dnl AC_MSG_CHECKING([for GtkHTML2 support])
   PKG_CHECK_MODULES([HILDON], hildon-1 >= 1.0.5,enable_hildon=yes,enable_hildon=no)
   AC_SUBST(HILDON_CFLAGS)
   AC_SUBST(HILDON_LIBS)
else
   enable_hildon=no
fi

AM_CONDITIONAL(WITH_HILDON, test "x$enable_hildon" = "xyes")</pre>

and then finally on line 548 echo the information back so that there is visual confirmation to the user that Hildon is enabled:

<code>echo "Build Hildon support............ : $enable_hildon"</code>

these changes enable the passing of the argument --enable-hildon on the command line like:

<code>./configure --enable-hildon</code>

 <nowiki>[[attachment:configure.ac]]</nowiki>

After making these changes run autoreconf:
<code>user@machine:~/Dev/Ume/liferea-1.4.2b$ autoreconf</code>

This step is necessary because autoreconf runs autoconf, autoheader, aclocal, automake, libtoolize, and autopoint (when appropriate) to update the Build System in the specified directories and their subdirectories. In other words it registers the changes made to configure.ac

Next change Makefile.am 
This is located in the <code>liferea-1.4.2b/src</code> directory. On line 67 add the Hildon libraries <code>$(HILDON_LIBS)</code> to <code>liferea_bin_LDADD</code> 

<pre>
liferea_bin_LDADD =	net/liblinet.a \
			parsers/libliparsers.a \
			fl_sources/libliflsources.a \
			notification/liblinotification.a \
			ui/libliui.a \
			$(PACKAGE_LIBS) $(X_LIBS) $(X_PRE_LIBS) -lX11 $(X_EXTRA_LIBS) $(DBUS_LIBS) $(NM_LIBS) $(INTLLIBS) $(GNUTLS_LIBS) $(HILDON_LIBS)</pre>

 <nowiki>[[attachment:Makefile.am]]</nowiki>

this enables liferea to link against the Hildon libraries.

Next change the Makefile.am inside the liferea-1.4.2b/src/ui directory. 
On line 11 add: 
<code>libliui_a_CFLAGS = $(PACKAGE_CFLAGS) $(DBUS_CFLAGS) $(HILDON_CFLAGS)</code>

this passes the <code>$(HILDON_CFLAGS)</code> to the compiler

 <nowiki>[[attachment:ui_Makefile.am]]</nowiki>

These are all the changes needed to be made to autotools. Next copy the liferea.glade file which is in the root liferea-1.4.2b directory and rename it to liferea_hildon.glade  This means that if the --enable-hildon flag is passed at compile time the liferea_hildon.glade file is used and if not liferea.glade is used.

Here are the differences between the two files:

<pre>
user@machine:/home/user/liferea-1.4.2b$ diff -Nu liferea.glade liferea_hildon.glade 
--- liferea.glade       2007-08-19 13:56:50.000000000 -0400
+++ liferea_hildon.glade        2007-09-25 14:17:38.000000000 -0400
@@ -2,11 +2,8 @@
 <!DOCTYPE glade-interface SYSTEM "glade-2.0.dtd">
 <!--*- mode: xml -*-->
 <glade-interface>
-  <widget class="GtkWindow" id="mainwindow">
-    <property name="title" translatable="yes">Liferea</property>
-    <property name="default_width">640</property>
-    <property name="default_height">480</property>
-    <property name="icon_name">liferea</property>
+  <widget class="GtkVBox" id="mainwindow">
+    <property name="visible">True</property>
     <child>
       <widget class="GtkVBox" id="vbox1">
         <property name="visible">True</property></pre>

 <nowiki>[[attachment:liferea.glade]]</nowiki>
 <nowiki>[[attachment:liferea_hildon.glade]]</nowiki>

In short the mainwindow is a <code>GtkVBox</code> in the hildon version and a <code>GtkWindow</code> normally. This change is explained <nowiki>[[http://maemo.org/development/documentation/how-tos/3-x/howto_porting_to_maemo_bora.html|in this tutorial]]</nowiki> in the section 'Hildonizing Main View'

Now liferea needs to know to pull in the appropriate glade file depending on whether it is compiled for hildon or not. 

In the file <code>liferea-1.4.2b/src/ui/ui_shell.c</code> inside the function <code>static void liferea_shell_init (LifereaShell *ls)</code> line 113 now looks like:

<pre>
	ls->priv->xml = glade_xml_new (PACKAGE_DATA_DIR G_DIR_SEPARATOR_S PACKAGE G_DIR_SEPARATOR_S "liferea_hildon.glade", "mainwindow", GETTEXT_PACKAGE);
	ls->priv->xml = glade_xml_new (PACKAGE_DATA_DIR G_DIR_SEPARATOR_S PACKAGE G_DIR_SEPARATOR_S "liferea.glade", "mainwindow", GETTEXT_PACKAGE);

Also the file <code>liferea-1.4.2b/src/ui/ui_dialog.c</code> inside the function <code>GtkWidget *liferea_dialog_new (const gchar *filename, const gchar *name)</code> line 139 now looks like:

<pre>
		ld->priv->xml = glade_xml_new (PACKAGE_DATA_DIR G_DIR_SEPARATOR_S PACKAGE G_DIR_SEPARATOR_S "liferea_hildon.glade", name, GETTEXT_PACKAGE);
		ld->priv->xml = glade_xml_new (PACKAGE_DATA_DIR G_DIR_SEPARATOR_S PACKAGE G_DIR_SEPARATOR_S "liferea.glade", name, GETTEXT_PACKAGE);

 <nowiki>[[attachment:ui_shell.c]]</nowiki>
 <nowiki>[[attachment:ui_dialog.c]]</nowiki>

All the other changes to Liferea are in <code>liferea-1.4.2b/src/ui/ui_mainwindow.c</code> 

On line 34 add the header file include:
<pre>

On line 66 in the function <code>static struct mainwindow</code> create the <code>HildonProgram</code> structure like:
<pre>
	HildonProgram	*program;
	GtkWidget	*container;
	GtkWidget	*window;
	GtkWindow	*window;

On line 536 in the function <code>static struct mainwindow *ui_mainwindow_new(void)</code> make an instance of a <code>HildonProgram</code> like:
<pre>
	mw->program = HILDON_PROGRAM(hildon_program_get_instance());
	mw->container = window;
	mw->window = hildon_window_new();
	gtk_container_add(GTK_CONTAINER(mw->window), GTK_WIDGET(mw->container));
	hildon_program_add_window(mw->program, HILDON_WINDOW(mw->window));
	mw->window = GTK_WINDOW (window);

Also the maemo tutorial mentioned above notes 'Also remove functions accel_set_func and accel_edited_callback' so on line 1255 add:
<pre>
	accel_group = gtk_ui_manager_get_accel_group (ui_manager);
	gtk_window_add_accel_group (mw->window, accel_group);

 <nowiki>[[File:liferea.png]]</nowiki>

=== Now on to the menu functions. ===

<nowiki>[[http://blogs.igalia.com/svillar/?p=16|This blog post]]</nowiki> provided the inspiration for this.

Trying to use the <code>GtkUIManager</code> caused a problem. The reason is that hildon_window_set_menu expects a <code>GtkMenu</code> as second argument, but the <code>GtkUIManager</code> gives a <code>GtkMenuBar</code>

Adding an utility function to the code that converts from a <code>GtkMenuBar</code> to a <code>GtkMenu</code> solves this. The very nice thing is that it still uses the definitions in the glade file. On line 1269 add:

<pre>
	GtkWidget *main_menu;
	GList *iter;

	/* Create new main menu */
	main_menu = gtk_menu_new();

	iter = gtk_container_get_children (GTK_CONTAINER (mw->menubar));
	while (iter) {
		GtkWidget *menu;

		menu = GTK_WIDGET (iter->data);
		gtk_widget_reparent(menu, main_menu);

		iter = g_list_next (iter);
	}

	hildon_window_set_menu(HILDON_WINDOW(mw->window), GTK_MENU(main_menu));

 <nowiki>[[attachment:ui_mainwindow.c]]</nowiki>

That is all the changes made so now move the project to the target filesystem and run:

<pre>
./configure --enable-hildon --prefix=/usr/ --libdir=/usr/lib
make
make install</pre>

and then start the UI for the target filesystem. Click on the shell image and run
<pre>
export DISPLAY=:2
 liferea</pre>

 <nowiki>[[File:hildonized.png]]</nowiki>

Here it is running in the maemo environment too

 <nowiki>[[File:liferea_maemo.png]]</nowiki>

 <nowiki>[[attachment:liferea-1.4.2b.tar.gz]]</nowiki>
