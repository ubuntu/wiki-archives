{|
  | '''Warning'''
  * This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
  * '''Images''' and '''attachments''' have been removed to conserve space.
  * '''Links''' may not work and there may be formatting issues.
  * A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__



=== Disclaimer ===

'''Building and using a custom kernel will make it very difficult to get support for your system.'''

'''While it is a learning experience to compile your own kernel, you will not be allowed to file bugs on the custom-built kernel (if you do, they will be Rejected without further explanation).'''

'''Note: This page would need significant cleaning. You may want to refer to <nowiki>[[https://wiki.ubuntu.com/Kernel/BuildYourOwnKernel|Kernel/BuildYourOwnKernel]]</nowiki> page in Ubuntu wiki instead which is a cleaner and more up-to-date guide to (simple) kernel building'''

If you have a commercial support contract with Ubuntu/Canonical, this will void such support.

Also note that this page describes how to do things for the Edgy (2.6.17) kernel and newer! Until this kernel source, we did not have any mechanisms in place that would allow people to build their own kernels easily. This was intentional.

This page does '''NOT''' describe how to <nowiki>[[https://wiki.ubuntu.com/KernelTeam/GitKernelBuild|build upstream kernels]]</nowiki> from <code>kernel.org</code>. This is how to rebuild the actual Ubuntu kernel starting from source.

=== Reasons for compiling a custom kernel ===

* You are a kernel developer.
* You need the kernel compiled in a special way, that the official kernel is not compiled in (for example, with some experimental feature enabled).
* You are attempting to debug a problem in the stock Ubuntu kernel for which you have filed or will file a bug report.
* You have hardware the stock Ubuntu kernel does not support.
* You love computers and are curious and interested in hacking on your own GNU/Linux system to learn more about how it works (with the understanding that you'll need to fix anything you break).

=== Reasons for NOT compiling a custom kernel ===

* You merely need to compile a special driver. For this, you only need to install the linux-headers packages.
* You have no idea what you are doing, and if you break something, you'll need help fixing it. Depending on what you do wrong, you might end up having to reinstall your system from scratch.
* You got to this page by mistake, and checked it out because it looked interesting, but you don't really want to learn a lot about kernels.

If you want to install a new kernel without compilation, you can use <nowiki>[[Synaptic]]</nowiki>, search for <code>linux-image</code> and select the kernel version you want to install.

An easier way is to click on <code>System > Administration > Update Manager</code>, then click on the <code>Check</code> button, and finally click on <code>Apply all updates</code> including the kernel.

=== Tools you'll need ===

To start, you will need to install a few packages. Use a following command line to install precisely the packages needed for the release you are using:

''' Hardy (8.04): '''
<pre>
sudo apt-get install linux-kernel-devel fakeroot kernel-wedge build-essential
</pre>

Note: The package <code>makedumpfile</code> is not available in Hardy.

''' Lucid (10.04): '''

<pre>
sudo apt-get install fakeroot build-essential crash kexec-tools makedumpfile kernel-wedge
sudo apt-get build-dep linux
sudo apt-get install git-core libncurses5 libncurses5-dev libelf-dev asciidoc binutils-dev
</pre>

''' Raring (13.04): '''
<pre>
sudo apt-get build-dep linux-image-`uname -r`
</pre>

=== Get the kernel source ===

There are a few ways to obtain the Ubuntu kernel source:

==== Option A) Use git ====
    Use <code>git</code> - This is for users who always want to stay in sync with the latest Ubuntu kernel source. For your information, detailed instructions on it can be found in the <nowiki>[[Ubuntu:KernelTeam-KernelGitGuide|Kernel Git Guide]]</nowiki>
<<BR>>The git repository does not include necessary control files, so you must build them by:
<pre>
fakeroot debian/rules clean
</pre>
==== Option B) Download the source archive ====
 Download the source archive - This is for users who want to rebuild the standard Ubuntu packages with additional patches. Note that this will almost always be out of date compared to the latest development source, so you should use <code>git</code> (option A) if you need the latest patches.

<<BR>> Use a follow command to install the build dependencies and extract the source (to the current directory):

 '''Ubuntu Hardy (8.04)'''
<pre>
sudo apt-get build-dep --no-install-recommends --only-source linux
apt-get source --only-source linux
</pre>
 Ubuntu modules source may also be needed if you plan to enable PAE and 64 GiB support in the kernel for 32-bit Hardy (8.04). The Ubuntu supplied modules may not be compatible with a PAE enabled kernel.
<pre>
sudo apt-get build-dep --no-install-recommends linux-ubuntu-modules-$(uname -r)
apt-get source linux-ubuntu-modules-$(uname -r)
</pre>

 The source will be downloaded to a subdirectory inside the current directory.

 '''Ubuntu Karmic Koala (9.10) and newer releases'''
<pre>
sudo apt-get build-dep --no-install-recommends linux-image-$(uname -r)
apt-get source linux-image-$(uname -r)
</pre>

 The source will be downloaded to the current directory as a trio of files (for Lucid, at least) (<code>.orig.tar.gz</code>, <code>.diff.gz</code>, and <code>.dsc</code>) and a sub-directory. For instance, if <code>uname -r</code> returns <code>2.6.32-25-generic</code>, you'll obtain <code>linux_2.6.32.orig.tar.gz</code>, <code>linux_2.6.32-25.44.diff.gz</code>, <code>linux_2.6.32-25.44.dsc</code> and the sub-directory <code>linux-2.6.32</code>.

 ''' Raring (13.04): '''
<pre>
sudo apt-get source linux-image-`uname -r`
</pre>

==== Option C) Download the source package ====
 Download the source package (detailed instructions are further down this page under <nowiki>[[#AltBuildMethod|Alternate Build Method (B): The Old-Fashioned Debian Way]]</nowiki>) - This is for users who simply want to modify, or play around with, the Ubuntu-patched kernel source. Again, this will not be the most up-to-date (use Option A/git if you need the latest source). Please be aware this is NOT the same as Option B/Download the source archive.

=== Modify the source for your needs ===

    For most people, simply modifying the configs is enough. If you need to install a patch, read the instructions from the patch provider to learn how to apply it.

    The stock Ubuntu configs are located in <code>debian/config/ARCH/</code> where <code>ARCH</code> is the architecture you are building for (Starting with Jaunty this is <code>debian.master/config/ARCH/</code>). In this directory there are several files. The <code>config</code> file is the base for all targets in that architecture. Then there are several <code>config.FLAVOUR</code> files that contain options specific to that target. For example, here are the files for 2.6.20, i386:

<pre>
ls -l debian/config/i386/
total 108
-rw-r--r-- 1 root src  73962 2007-08-13 01:29 config
-rw-r--r-- 1 root root  1369 2007-08-13 01:29 config.386
-rw-r--r-- 1 root root  1330 2007-08-13 01:29 config.generic
-rw-r--r-- 1 root root  1395 2007-08-13 01:29 config.server
-rw-r--r-- 1 root root  1756 2007-08-13 01:29 config.server-bigiron
-rw-r--r-- 1 root root     8 2007-08-13 01:25 lowlatency
-rw-r--r-- 1 root root   194 2007-08-13 01:25 vars.386
-rw-r--r-- 1 root root   218 2007-08-13 01:25 vars.server-bigiron
</pre>

'''If you do not find the config files under <code>debian/config</code>, you may find them in your <code>/boot</code> directory (for instance, <code>/boot/config-2.6.22-14-generic</code>) otherwise you should check to see if an alternate location has been specified within debian/debian.env of your kernel source directory.'''

If you need to change a config option, simply modify the file that contains the option. If you modify just the <code>config</code> file, it will affect all targets for this architecture. If you modify one of the target files, it only affects that target.

After applying a patch, or adjusting the configs, it is always best to regenerate the config files to ensure they are consistent. There is a helper command for this. To regenerate all architectures run:

<pre>
debian/rules updateconfigs
</pre>

'''If you just want to update one architecture''', run:

<pre>
debian/scripts/misc/oldconfig ARCH
</pre>
Note: If you don't have the <code>debian/</code> directory after using <code>apt-get source</code>, use <code>dpkg-source -x *dsc</code> to extract the sources properly.

For these two commands to work, you need to give the scripts in the <code>debian/scripts/misc</code> and <code>debian/scripts</code> directories execute permission with the following command:

<pre>
chmod -R u+x debian/scripts/*
</pre>

=== Build the Kernel(s) ===

There are two listed ways to build the Ubuntu kernel:

==== Build Method A: Build the kernel (when source is from git repository, or from apt-get source) ====

    To build the kernel(s) is very simple. Depending on your needs, you may want to build all the kernel targets, or just one specific to your system. However, you also want to make sure that you do not clash with the stock kernels.

Note:
Though these outside instructions include making a separate and unique branch of the kernel, unlike here, they include thorough explanations of all necessary steps from start to finish.
* Oneiric (11.10) Kernel 3.2 : http://blog.avirtualhome.com/2012/01/13/compile-linux-kernel-3-2-for-ubuntu-11-10/
* Oneiric (11.10) : http://blog.avirtualhome.com/2011/10/28/how-to-compile-a-new-ubuntu-11-10-oneiric-kernel/
* Maverick on Lucid (10.04): http://blog.avirtualhome.com/2010/07/14/how-to-compile-a-ubuntu-2-6-35-kernel-for-lucid/
* Lucid (10.04): http://blog.avirtualhome.com/2010/05/05/how-to-compile-a-ubuntu-lucid-kernel/

'''These instructions are specific to the git-tree and for the source downloaded via <code>apt-get source</code>, ''not'' when downloading the <code>linux-source</code> package from <code>kernel.org</code>'''

Use this command to build all targets for the architecture you are building on:

<pre>
fakeroot debian/rules clean
AUTOBUILD=1 fakeroot debian/rules binary-debs
</pre>

<code>debian/rules clean</code> creates <code>debian/control</code>, <code>debian/changelog</code>, and so on from <code>debian.<branchname>/*</code> (e.g. <code>debian.master</code>). It is necessary in git trees following git commit 3ebd3729ce35b784056239131408b9a72b0288ef "UBUNTU: [Config] Abstract the debian directory".

The <code>AUTOBUILD</code> environment variable triggers special features in the kernel build. First, it skips normal ABI checks (ABI is the binary compatibility). It can do this because it also creates a unique ABI ID. If you used a git repo, this unique ID is generated from the git HEAD SHA. If not, it is generated from the <code>uuidgen</code> program (which means every time you execute the <code>debian/rules</code> build, the UUID will be different!). Your packages will be named using this ID. (Note that in Intrepid and newer, you will need <code>skipabi=true</code> to skip ABI checks.)

'''To build a specific target''', use this command:

<pre>
fakeroot debian/rules clean
AUTOBUILD=1 NOEXTRAS=1 fakeroot debian/rules binary-FLAVOUR
</pre>

Where <code>FLAVOUR</code> is one of the main flavours of the kernel (e.g. <code>generic</code>)

'''To build one of the custom flavours''' (found in <code>debian/binary-custom.d/</code>), use:

<pre>
fakeroot debian/rules clean
AUTOBUILD=1 NOEXTRAS=1 fakeroot debian/rules custom-binary-FLAVOUR
</pre>

'''As of this documentation, custom flavours include <code>xen</code> and <code>rt</code>.'''

If you have a more than one processor or more than one core, you can speed things up by running concurrent compile commands. Prepend <code>CONCURRENCY_LEVEL=2</code> for two processors or two cores; replace '2' with whatever number suits your hardware setup (for Gutsy and later, you can alternatively use <code>DEB_BUILD_OPTIONS=parallel=2</code>).

<pre>
fakeroot debian/rules clean
DEB_BUILD_OPTIONS=parallel=2 AUTOBUILD=1 NOEXTRAS=1 fakeroot debian/rules binary-generic
</pre>

If you get ABI errors, you can avoid the ABI check with <code>skipabi=true</code>. For example,

<pre>
fakeroot debian/rules clean
DEB_BUILD_OPTIONS=parallel=2 AUTOBUILD=1 NOEXTRAS=1 skipabi=true fakeroot debian/rules binary-generic
</pre>

To trigger a rebuild, remove the appropriate stamp file from <code>debian/stamps</code> (e.g. <code>stamp-build-server</code> for the <code>server</code> flavour, etc.).

The debs are placed in your the parent directory of the kernel source directory.

If needed, the Ubuntu modules source for Hardy (8.04) can be built in a similar way.
<pre>
cd linux-ubuntu-modules-2.6.24-2.6.24
AUTOBUILD=1 fakeroot debian/rules binary-debs
</pre>

Alternatively, if you need to specify a different kernel than the running one, use
<pre>
cd linux-ubuntu-modules-2.6.24-2.6.24
AUTOBUILD=1 fakeroot debian/rules binary-debs KDIR=/path/to/kerneldir
</pre>

If you get an error, try running this in the <code>kerneldir</code>: (example for the <code>generic</code> flavour)
<pre>
cat debian/config/i386/config debian/config/i386/config.generic > .config
make prepare scripts
</pre>

==== Alternate Build Method (B): The Old-Fashioned Debian Way ====

The new Ubuntu build system is great for developers, for people who need the absolute latest bleeding-edge kernel, and people who need to build a diverse set of kernels (several "flavours"). However it can be a little complex for ordinary users. If you don't need the latest development sources, there is a simpler way to compile your kernel from the <code>linux-source</code> package. As suggested above, all you need for this is:
<pre>
sudo apt-get install linux-source device-tree-compiler # device-tree-compiler is only needed if you are targeting the PowerPC architecture
mkdir ~/src; cd ~/src
tar xjvf /usr/src/linux-source-<version-number-here>.tar.bz2
cd linux-source-<version-number-here>
</pre>
The last command in the sequence brings you into the top directory of a kernel source tree. 

Before building the kernel, you must configure it. If you wish to re-use the configuration of your currently-running kernel, start with
<pre>
cp -vi /boot/config-`uname -r` .config
</pre>

Before you run <code>make menuconfig</code> or <code>make xconfig</code> (which is what the next step tells you to do), make sure you have the necessary packages:

<pre>
sudo apt-get install qt3-dev-tools libqt3-mt-dev # if you plan to use 'make xconfig'
sudo apt-get install libncurses5 libncurses5-dev # if you plan to use 'make menuconfig'
</pre>

If you would like to see what is different between your original kernel config and the new one (and decide whether you want any of the new features), you can run:
<pre>
make oldconfig
</pre>
Since the 2.6.32 kernel, a new feature allows you to update the configuration to only compile modules that are actually used in your system:
<pre>
make localmodconfig
</pre>
Then, regardless of whether you're re-using an existing configuration or starting from scratch:
<pre>
make menuconfig # or "make xconfig" if you prefer
or
</pre>

<<BR>>What about this... ? (which is from the <nowiki>[[https://wiki.ubuntu.com/Kernel/BuildYourOwnKernel|Kernel/BuildYourOwnKernel]]</nowiki> Page in the section "Modifying the configuration")
<pre>
chmod a+x debian/scripts/*
chmod a+x debian/scripts/misc/*
fakeroot debian/rules clean
fakeroot debian/rules editconfigs
</pre>
<<BR>>
If you re-used the existing configuration, note that Ubuntu kernels build with debugging information on, which makes the resulting kernel modules (*.ko files) much larger than they would otherwise be. To turn this off, go into the config's "Kernel hacking"<!-- ; then, under "Kernel debugging", --> and turn OFF "Compile the kernel with debug info".

Now you can compile the kernel and create the packages:
<pre>
make clean # only needed if you want to do a "clean" build
make deb-pkg
</pre>

You can enable parallel make use <code>make -j</code>). Try 1+''number of processor cores'', e.g. 3 if you have a dual core processor:
<pre>
make -j3 deb-pkg
</pre>

On a newer kernel, if you only need binary packages and want several builds (while editing the source) to not cause everything to be rebuilt, use:
<pre>
make -j3 bindeb-pkg
</pre>

The *.deb packages will be created in the parent directory of your Linux source directory (in this example, they would be placed in <code>~/src</code> because our Linux source directory is <code>~/src/linux-source-<version-number-here></code>).

=== Install the new kernel ===

If you want to see the Ubuntu splash screen (or use text mode) before you get to X instead of just a black screen, you'll want to make sure the <code>framebuffer</code> driver loads:
<pre>
echo vesafb | sudo tee -a /etc/initramfs-tools/modules
echo fbcon | sudo tee -a /etc/initramfs-tools/modules
</pre>

Now that you've told <code>initramfs-tools</code> which modules it should include, and once the build is complete, you can install the generated debs using <code>dpkg</code>:

<pre>
sudo dpkg -i linux-image-2.6.20-16-2be-k7_2.6.20-16_i386.deb
sudo dpkg -i linux-headers-2.6.20-16-2be-k7_2.6.20-16_i386.deb
</pre>

Similarly, if you have built the Ubuntu module for Hardy (8.04) earlier, install them as follows:

<pre>
sudo dpkg -i linux-ubuntu-modules-2.6.24-16-generic_2.6.24-16.23_i386.deb
sudo dpkg -i linux-headers-lum-2.6.24-16-generic_2.6.24-16.23_i386.deb
</pre>

If you use modules from <code>linux-restricted-modules</code>, you will need to recompile this against your new <code>linux-headers</code> package.

Note: In response to the various comments in the remainder of this section: On Ubuntu Precise (12.04) it appears that postinst DOES take care of the initramfs stuff. After installing the package my new kernel booted just fine without following any of the methods below. Someone please correct me if I'm mistaken.

Since Ubuntu Lucid (10.04) the image postinst no longer runs the <code>initramfs</code> creation commands. Instead, there are example scripts provided that will perform the task. These scripts will work for official kernel images as well. For example:
<pre>
sudo cp /usr/share/doc/kernel-package/examples/etc/kernel/postinst.d/initramfs /etc/kernel/postinst.d/initramfs
sudo mkdir -p /etc/kernel/postrm.d/
sudo cp /usr/share/doc/kernel-package/examples/etc/kernel/postrm.d/initramfs /etc/kernel/postrm.d/initramfs
</pre>

''Note: I couldn't get the above scripts to help in generating an <code>initrd</code> for the kernel - and so the built kernel couldn't boot; the only thing that worked for me was the recommendation in http://www.debian-administration.org/article/How_Do_I_Make_an_initrd_image, "use initramfs command. It is real solution."; what I used (after the custom-built kernel's *.deb's were installed), was:
<pre>
cd /boot
sudo mkinitramfs -k -o initrd.img-2.6.32.15+drm33.5-mylucid 2.6.32.15+drm33.5-mylucid
sudo update-grub2
</pre>
''

''Note (Michael): that is because you need to include the right package scripts to build the <code>initrd</code> at package install time. The <code>make-kpkg</code> option is <code>--overlay-dir</code>. By default, <code>make-kpkg</code> uses <code>/usr/share/kernel-package</code> as an overlay directory, which contains the default, uncustomised scripts for a Debian distribution, and not the ones needed for building a Ubuntu kernel.

The following instructions are based on this link: http://crashcourse.ca/introduction-linux-kernel-programming/intermission-building-new-ubuntu-1004-kernel-free-lesson

First copy the default overlay directory to your home directory:
<pre>
$ cp -r /usr/share/kernel-package $HOME
</pre>
Then install the source of the kernel you are using currently, using the exact package name, e.g.
<pre>
$ cd
$ apt-get source linux-image-2.6.32-24-generic
</pre>
which will unpack the sources to $HOME/linux-2.6.32. Now copy the control scripts into your new overlay:
<pre>
$ cp linux-2.6.32/debian/control-scripts/{postinst,postrm,preinst,prerm} kernel-package/pkg/image/
$ cp linux-2.6.32/debian/control-scripts/headers-postinst kernel-package/pkg/headers/
</pre>
And now you can execute <code>make-kpkg</code> with the additional command line option <code>--overlay-dir=$HOME/kernel-package</code>.
''

=== Rebuilding ''linux-restricted-modules'' ===

The linux-restricted-modules (l-r-m) package contains a number of non-DFSG-free drivers (as well as some firmware and the ipw3945 wireless networking daemon) which, in a perfect world, wouldn't have to be packaged separately, but which unfortunately are not available under a GPL-compatible license. If you use any of the hardware supported by the l-r-m package, you will likely find that your system does not work as well after switching to a custom kernel. In this case you should try to compile the l-r-m package.

See CustomRestrictedModules on how to rebuild l-r-m (if you use nVidia or ATI binary drivers, you do).

Note: you will need around 8 hours of compilation time and around 10 Gb of hard drive space to compile all kernel flavours and restricted modules.

Further note: There are no l-r-m or linux-restricted-modules packages in Lucid.

=== Speeding Up the Build ===

Use <code>distcc</code> and, if you're rebuilding often, <code>ccache</code>. A good overview of using <code>distcc</code> on a debian-based system is available at http://myrddin.org/howto/using-distcc-with-debian. If you have AMD64 machines available on your local area network, they can still participate in building 32-bit code; <code>distcc</code> seems to handle that automatically. However, with <code>distcc</code> taking over all compiles by default, you will need to set <code>HOSTCC</code> so that when kernel builds want to use the compiler on the host itself, they don't end up distributing jobs to the 64-bit server. If you fail to do that, you'll get link-compatibility failures between 64-bit and 32-bit code. My <code>make-kpkg</code> command, with <code>/usr/lib/ccache</code> at the head of my <code>$PATH</code>, looks like:

<pre>
MAKEFLAGS="HOSTCC=/usr/bin/gcc CCACHE_PREFIX=distcc" make-kpkg --rootcmd fakeroot --initrd --append-to-version=-suspend2 kernel-image kernel-headers kernel-source
</pre>

=== More documentation ===

* <nowiki>[[Kernel-Upgrade]]</nowiki>

=== Comments ===
Please go to the community wiki page for comments, questions and discussion: https://wiki.ubuntu.com/KernelCustomBuild

=== External information ===
* http://www.howtoforge.com/kernel_compilation_ubuntu Compile a kernel from kernel.org source in Ubuntu
* https://kernel-team.pages.debian.net/kernel-handbook/ch-common-tasks.html#s-common-building
----
CategoryKernel CategoryKernel
