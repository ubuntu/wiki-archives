{|
  | '''Warning'''
  * This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
  * '''Images''' and '''attachments''' have been removed to conserve space.
  * '''Links''' may not work and there may be formatting issues.
  * A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__


== Manage your virtual machines ==

=== From the GUI ===
There are several methods from the GUI, but the easiest to set up is probably <nowiki>[[VirtManager|VirtManager]]</nowiki>.  See the setup guide at the above link. Alternative management options include <nowiki>[[http://www.convirture.com/|convirt]]</nowiki> (GUI) or <nowiki>[[http://www.convirture.com/wiki/index.php?title=Convirt2_Installation|convirt2]]</nowiki> (WWW).

=== From the shell ===
You can manage your VMs from the shell using <nowiki>[[http://linux.die.net/man/1/virsh|virsh]]</nowiki>. You can get a list of the available commands if you type "help". Type "help command" to get additional infos for a particular command.

==== Define your new VM ====

Before you can manage your new VM with virsh, you must define it:

<pre>
$ virsh --connect qemu:///system
Connecting to uri: qemu:///system
Welcome to virsh, the virtualization interactive terminal.

Type:  'help' for help with commands
       'quit' to quit

virsh # define /etc/libvirt/qemu/newvm.xml
Domain newvm defined from /etc/libvirt/qemu/newvm.xml
</pre>

Note that to list newvm, you must use 'list --inactive' or 'list --all', since list without any options will only list currently running machines.

==== List your VMs ====

Virsh allows you to list the virtual machines available on the current host:

<pre>
yhamon@paris:/etc/libvirt/qemu$ virsh --connect qemu:///system
Connecting to uri: qemu:///system
Welcome to virsh, the virtualization interactive terminal.

Type:  'help' for help with commands
       'quit' to quit

virsh # help list
  NAME
    list - list domains

  SYNOPSIS
    list [--inactive | --all]

  DESCRIPTION
    Returns list of domains.

  OPTIONS
    --inactive       list inactive domains
    --all            list inactive & active domains

virsh # list
 Id Name                 State
----------------------------------
 15 mirror               running
 16 vm2                  running

virsh # list --all
 Id Name                 State
----------------------------------
 15 mirror               running
 16 vm2                  running
  - test5                shut off
</pre>

==== Define, undefine, start, shutdown, destroy VMs ====

The VMs you see with list --all are VMs that have been "defined" from an XML file. Every VM is configured via a XML file in /etc/libvirt/qemu. If you want to remove a VM from the list of VMs, you need to undefine it:

<pre>
virsh # undefine test5   # WARNING: undefine will delete your XML file!
Domain test5 has been undefined

virsh # list --all
 Id Name                 State
----------------------------------
 15 mirror               running
 16 vm2                  running
</pre>

To be able to undefine a virtual machine, it needs to be shutdown first:

<pre>
virsh # shutdown mirror
Domain mirror is being shutdown
</pre>

This command asks for a nice shutdown (like running shutdown in command line).

'''Notice''': Ubuntu 10.04 server doesn't have acpid installed by default. This package needs to be installed on the guest OS before it will listen to any requests from the host.

You can also use "destroy", the more brutal way of shutting down a VM, equivalent of taking the power cable off:

<pre>
virsh # destroy mirror
Domain mirror destroyed
</pre>

If you have made a change to the XML configuration file, you need to tell KVM to reload it before restarting the VM:

<pre>
virsh # define /etc/libvirt/qemu/mirror.xml
Domain mirror defined from /etc/libvirt/qemu/mirror.xml
</pre>

Then, to restart the VM:

<pre>
virsh # start mirror
Domain mirror started
</pre>

==== Suspend and resume a Virtual Machine ====

Virsh allows you to easily suspend and resume a virtual machine.

<pre>
virsh # suspend mirror
Domain mirror suspended

virsh # resume mirror
Domain mirror resumed
</pre>

== Editing the attributes of a Virtual Machine ==

libvirt stores it's configuration as xml in '/etc/libvirt/qemu'. The xml is easy to understand, and is similar to VMware *.vmx files. While it is possible to edit these files in place and restart libvirt-bin for the changes to take effect, the recommended method for modifying the attributes of a virtual machine is via virsh (or virt-manager, if it supports changing the hardware you want to change). The concept is simple:

# export (aka 'dump') the xml of the virtual machine you want to edit
# edit the xml
# import (aka 'define') the xml

For example, to edit the machine named 'foo' (you can get a list of your machines with 'virsh list --all'), do:<pre>
$ virsh dumpxml foo > /tmp/foo.xml
(edit /tmp/foo.xml as needed)
$ virsh define /tmp/foo.xml
</pre>

=== Adding CPUs ===
KVM allows you to create SMP guests. To allocate two CPUs to a VM, dump the xml as above, then edit your xml to have:<pre>
<domain type='kvm'>
  ...
  <vcpu>2</vcpu>
  ...
</domain>
</pre>

Now define the VM as above.

=== Adding Memory ===
To change the memory allocation in a VM, dump the xml as above, then edit your xml to have:<pre>
<domain type='kvm'>
  ...
  <memory>262144</memory>
  <currentMemory>262144</currentMemory>
  ...
</domain>
</pre>

Now define the VM as above.  Keep in mind that the memory allocation is in kilobytes, so to allocate 512MB of memory, use 512 * 1024, or 524288.

=== Changing the Network Card Model ===
kvm and qemu currently default to using the rtl8139 NIC. Supported NICs in Ubuntu 8.04 LTS are i82551, i82557b, i82559er, ne2k_pci, pcnet, rtl8139, e1000, and virtio. To use an alternate NIC, dump the xml as above, then edit your xml to have:<pre>
<domain type='kvm'>
  ...
    <interface type='network'>
      ...
      <model type='e1000'/>
    </interface>
  ...
</domain>
</pre>

Now define the VM as above.

=== Adding USB Device Pass-through ===
==== Limitations ====
* USB protocol <=2.0
* Apparmor modifications needed

==== Apparmor Modification ====
In order for a software program to access the usb device correctly the apparmor abstraction for qemu must be changed. Edit '''/etc/apparmor.d/abstractions/libvirt-qemu''' add a line:
<pre>
/run/udev/data/* r,
</pre>

After making the changes the guest must be restarted to get its profile regenerated.

==== Adding USB devices ====

This can also be done via '''virt-manager'''.

First find the usb Vendor ID and Product ID.:
<pre>
$ lsusb
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 005 Device 012: ID 0a5c:2110 Broadcom Corp. Bluetooth Controller
Bus 005 Device 003: ID 0483:2016 SGS Thomson Microelectronics Fingerprint Reader
Bus 005 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
Bus 004 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
Bus 003 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
Bus 002 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
</pre>

In the event that the '''Broadcom Corp. Bluetooth Controller''' wants to be selected the vendor and product ids are '''0a5c''' and '''2110''' respectively.

==== Hot Add ====
Create an xml snippet just representing the device like
<pre>
<hostdev mode='subsystem' type='usb' managed='yes'>
    <source>
        <vendor id='0x0a5c'/>
        <product id='0x2110'/>
    </source>
</hostdev>
</pre>

You can then attach/detach that via:
<pre>
$ virsh attach-device <guestname> <<our-device-xml-file>
$ virsh detach-device <guestname> <<our-device-xml-file>
</pre>

==== Static Add ====
The IDs can be entered into the xml profile. This can be done through virsh through the '''edit <domain>''' command.:
<pre>
<domain type='kvm'>
  <name>windowsxp</name>
  …
  <devices>
    …
    <hostdev mode='subsystem' type='usb'>
      <source>
        <vendor id='0x0a5c'/>
        <product id='0x2110'/>
      </source>
    </hostdev>
  </devices>
</domain>
</pre>

=== Get new IDs ===

To get a new mac address to paste into your xml file, use this command:

MACADDR="52:54:$(dd if=/dev/urandom count=1 2>/dev/null | md5sum | sed 's/^\(..\)\(..\)\(..\)\(..\).*$/\1:\2:\3:\4/')"; echo $MACADDR

To get a new uuid for your xml file, use: uuidgen

----
CategoryVirtualization
