{|
  | '''Warning'''
  * This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
  * '''Images''' and '''attachments''' have been removed to conserve space.
  * '''Links''' may not work and there may be formatting issues.
  * A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__



== Building and Using Tux-on-ice Kernels with Ubuntu ==
Suspending the activity of a laptop or desktop can be one of the most frustrating and buggy parts of the Linux user experience.  Some users find that their problems are significantly eased by using kernels patched with the out-of-tree <nowiki>[[http://www.tuxonice.net|tuxonice]]</nowiki> code.  This code is not supported by the Ubuntu project. Tuxonice was <nowiki>[[http://lists.tuxonice.net/lurker/message/20070702.072738.a09b8c89.en.html|previously]]</nowiki> known as suspend2. Steps to enable tuxonice in Gutsy gibbon are well documented <nowiki>[[http://wiki.tuxonice.net/DistroAndHardwareSetup/Ubuntu_Gutsy_Gibbon|here]]</nowiki>.

== Changes to initramfs ==
It is very important to make changes to your initramfs for tuxonice to work properly. For more information see <nowiki>[[http://wiki.tuxonice.net/DistroAndHardwareSetup/Ubuntu_Gutsy_Gibbon|here]]</nowiki> and this <nowiki>[[https://bugs.launchpad.net/ubuntu/+source/initramfs-tools/+bug/75616|feature request]]</nowiki> report. By default, you can be assured that tuxonice will have no effect on your in-kernel suspend known as <nowiki>[[http://suspend.sf.net|swsusp]]</nowiki>.

== Compiling a tux-on-ice Kernel ==

There are different ways to do this.  

=== Method 1: patch the Ubuntu linux-source package ===
The easiest and most straightforward way to create your own kernels is to install the linux-source package and patch the resultant source tree.  It's not hard but requires some work at the command-line:
<pre>
sudo apt-get install linux-source
cd /usr/src
sudo chown root:admin ./
tar xjvf linux-source-2.6.XXXXX.tar.bz2
cd linux-source-2.6.XXXXX
</pre>

Check the http://www.tuxonice.net/ website for a version that matches with your kernel version. Use wget to download the latest patch set to your home directory, modifying the file name as appropriate:
<pre>
wget http://www.tuxonice.net/downloads/all/tuxonice-3.0-rc5-for-2.6.22.16.patch.bz2
</pre>
Now apply the patch, modifying the file name as appropriate (you should still be inside the linux-source directory):
<pre>
bzcat ~/tuxonice-XXXX-for-2.6.XXXX.patch.bz2  | patch -p1
</pre>
Look for any FAILED messages. If there are any, that is probably because the Ubuntu source code differs from the vanilla source code that the tuxonice patch expects. Open the associated .rej files in a text editor and see if you can apply the patches manually.

Finally, we have some work to do to make sure that the kernel package name is compatible with linux-restricted-modules.  Make sure you get this right, or you'll find yourself compiling over and over again.  First, check the abi_version of the official kernels with:
<pre>
uname -r
</pre>

The abi_version is the number after the -, for example if the output is 2.6.20-15-generic the abi_version is 15.  Next, edit the file "Makefile" in your source directory, setting EXTRAVERSION to the abi_version, for example:
<pre>
gedit Makefile
</pre>
changing
<pre>
EXTRAVERSION =-ubuntu1
</pre>
to
<pre>
EXTRAVERSION =-15
</pre>

Your kernel tree is now ready.  Next step is to build the kernel source package the debian way:
<pre>
sudo apt-get install kernel-package fakeroot
sudo apt-get build-dep linux-image-`uname -r`
make gconfig # note you may need to install packages libgtk2.0-dev and libglade2-dev
####### to make gconfig work
#### an alternative option is to run 'make menuconfig', for which you need
####### libncurses5-dev
make-kpkg --rootcmd fakeroot --initrd --append-to-version=-suspend2 kernel-image kernel-headers kernel-source
</pre>
When running gconfig or menuconfig, make sure that the suspend2 options (listed under "power") and the lzf options (listed under "crypto") are checked. It's also a good idea to approximate the ubuntu kernel settings as closely as possible; you can do this by loading the config file for the default kernel image.  If it's installed, you'll find it at <code> /boot/config-2.6.20-15-generic </code> or similar.  

The --append-to-version switch gives your kernel a useful identifier, and will be important when we build the restricted-modules package (see below).  It will be, in effect, the custom "flavour" of your kernel.  

Finally, install your packages this way:
<pre>
sudo dpkg -i ../*.deb
</pre>

If you run into trouble, there are some more instructions on building kernels this way at KernelCustomBuild.  

=== Method 2: Vanilla kernel from kernel.org ===

If you're having trouble building the Ubuntu kernel, then you can, try to build the vanilla upstream kernel. This should pretty much always work. However, you will lose the third-party Ubuntu kernel modules. This method is <nowiki>[[http://wiki.tuxonice.net/DistroAndHardwareSetup/Ubuntu_Gutsy_Gibbon|documented]]</nowiki> directly on the TuxOnIce website.

=== Method 3: Git repository ===

If you have brand new hardware it is best to use the bleeding edge code from git. This method is described on the <nowiki>[[http://wiki.suspend2.net/BuildingUbuntuKernels|TuxOnIce wiki]]</nowiki>.   
Tuxonice has a <nowiki>[[http://lists.tuxonice.net/lurker/message/20071130.183559.c235f643.en.html|patch]]</nowiki> available always for the current ubuntu-git-kernel.
The current <nowiki>[[http://kernel.ubuntu.com|Ubuntu kernel]]</nowiki> git tree is available <nowiki>[[http://kernel.ubuntu.com/git?p=ubuntu/ubuntu-gutsy.git;a=summary|here]]</nowiki>.
There is information on building git kernels at CustomKernelBuild and KernelGitGuide.

== Compiling linux-restricted-modules ==

This section has moved to its own page, CustomRestrictedModules.  Go to that page, but remember to note down your abi_version and kernel flavour before you do so.  

== Hibernate script ==
If you enable CONFIG_SUSPEND2_REPLACE_SWSUSP in your kernel config then gnome-power-manager/equivalent of your desktop environment should simply work. In case your laptop needs some quirks (like unloading some modules, restart network, etc...) then it is better to install <nowiki>[[http://wiki.tuxonice.net/HibernateScript|hibernate script]]</nowiki>.

----
