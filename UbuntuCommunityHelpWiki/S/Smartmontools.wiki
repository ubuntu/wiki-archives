{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work.
* A '''full compressed version''' of the wiki is available on archive.org
|}

__TOC__


== Introduction ==
Smartmontools is a set of applications that can test hard drives and read their hardware SMART statistics. Note: SMART data may not accurately predict future drive failure, however abnormal error rates may be an indication of possible hardware failure or data inconsistency.

This how to will help you to configure Smartmontools to do actions such as shut down the computer or send an e-mail when the disk is going to fail.

=== Prerequisites ===
* A modern S.M.A.R.T. capable hard disk

== Setting up ==
=== Installation ===
You can install the <code>smartmontools</code> package from the Synaptic Package Manager (see <nowiki>[[SynapticHowto]]</nowiki>), or by typing the following into the terminal:
<pre>
sudo apt-get install smartmontools </pre>

=== Checking a drive for SMART Capability ===
To ensure that your drive supports SMART, type:
<pre>
sudo smartctl -i /dev/sda </pre>

where /dev/sda is your hard drive. This will give you brief information about your drive. The last two lines may look something like this:

<pre>
SMART support is: Available - device has SMART capability.
SMART support is: Enabled </pre>

=== Enabling SMART ===
In the case that SMART is not enabled for your drive, you can enable it by typing:
<pre>
sudo smartctl -s on /dev/sda </pre>

== Testing a Drive ==
You may run any type of test while the drive is mounted although there may be some drop in performance. There are three types of test that can be conducted on a drive:
# Short
# Extended (Long)
# Conveyance

To find an estimate of the time it takes to conduct each test, type:
<pre>
sudo smartctl -c /dev/sda </pre>

The most useful test is the extended test (long). You can initiate the test by typing:
<pre>
sudo smartctl -t long /dev/sda </pre>

=== Results ===
You can view a drive's test statistics by typing:
<pre>
sudo smartctl -l selftest /dev/sda </pre>

To display detailed SMART information for an IDE drive, type:
<pre>
sudo smartctl -a /dev/sda </pre>

To display detailed SMART information for a SATA drive, type:
<pre>
sudo smartctl -a -d ata /dev/sda
</pre>
Note: This also works for IDE drives in new kernels that are being run through the SCSI stack and show up as /dev/sdX

=== Suggested application: GSmartControl ===
Take a look at <nowiki>[[http://gsmartcontrol.sourceforge.net/home/|GSmartControl]]</nowiki>. It's a nice graphical frontend to smartctl; it shows all SMART values, and highlights those that indicate old age or impending failure, plus you may run tests on demand:

<nowiki>[[attachment:gsmartcontrol - failing.png|<nowiki>[[File:gsmartcontrol - failing.png|GSmartControl main window|width=177]]</nowiki></nowiki>]] <nowiki>[[attachment:gsmartcontrol - info_failing.png|<nowiki>[[File:gsmartcontrol - info_failing.png|GSmartControl attribute list|width=350]]</nowiki></nowiki>]]

As usual, you may install it from Synaptic or running <code>sudo apt-get install gsmartcontrol</code>.

== Advanced: Running as Smartmontools as a Daemon ==
You can run Smartmontools in the background and have it check drives and email when there are issues:

Open the file <code>/etc/default/smartmontools</code> with your favourite text editor. For example (using vim): <code>sudo vim /etc/default/smartmontools</code>. Uncomment the line <code>start_smartd=yes</code>.

How <code>smartd</code> is going to scan the disks and what it will do in case of errors is controlled by the daemon configuration file, <code>/etc/smartd.conf</code>. Again, use your favourite text editor to open this file. There should be one uncommented line, similar to:
<pre>
DEVICESCAN -m root -M exec /usr/share/smartmontools/smartd-runner</pre>
In this example (which is the default for Karmic), <code>smartd</code> will:
* scan for all ATA/SCSI devices (<code>DEVICESCAN</code>). The rest of the file will be ignored;
* mail a report to the 'root' account in case of trouble (<code>-m</code>);
* but instead of the <code>mail</code> command, it will execute <code>/usr/share/smartmontools/smartd-runner</code> and feed the report to it (<code>-M exec program</code>).
<code>/usr/share/smartmontools/smartd-runner</code> is a script that basically saves the report to a temporary file, and then runs anything it finds in <code>/etc/smartmontools/run.d/</code>; take a look there to understand what you already have (there should be a script that mails the report).

There are several <code>-M</code> directives that change when and how often reports are sent. You need to specify (<code>-m something</code>) in order to use them, even if you're not sending any mail.

You may include some useful options:
<pre>
DEVICESCAN -H -l error -l selftest -f -s (O/../../5/11|L/../../5/13|C/../../5/15) -m root -M exec /usr/share/smartmontools/smartd-runner</pre>

In this example, <code>smartd</code> will:
* check the SMART health status (<code>-H</code>);
* report increases in both SMART error logs (<code>-l</code>);
* check for failure of any Usage Attributes (<code>-f</code>);
* schedule an Offline Immediate Test every Friday at 11 am, a Long Self-Test every Friday at 1 pm, and a Conveyance Self-Test every Friday at 3 pm (<code>-s</code>) -- see the <code>smartd</code> manual page for what these tests do so you can choose what suits you.

You may also replace DEVICESCAN with the path of the device which you'd like to be monitored (e.g. <code>/dev/sda</code>), and the daemon will only monitor this drive. You'll need one such line for each device.

=== Actions in case of trouble ===

You'll want to configure the actions <code>smartd</code> will take in case of trouble. If all you want is a notification shown on your desktop, skip to "Personal computer" below.

Most of the time, you only need to place a script in <code>/etc/smartmontools/run.d/</code>. Whenever <code>smartd</code> wants to send a report, it will execute <code>smart-runner</code> and the latter will run your script.

You have several variables available to your script (again, see the <code>smartd</code> manpage). These come from a test run:
<pre>
SMARTD_MAILER=/usr/share/smartmontools/smartd-runner
SMARTD_SUBJECT=SMART error (EmailTest) detected on host: XXXXX
SMARTD_ADDRESS=root
SMARTD_TFIRSTEPOCH=1267409738
SMARTD_FAILTYPE=EmailTest
SMARTD_TFIRST=Sun Feb 28 21:45:38 2010 VET
SMARTD_DEVICE=/dev/sda
SMARTD_DEVICETYPE=sat
SMARTD_DEVICESTRING=/dev/sda
SMARTD_FULLMESSAGE=This email was generated by the smartd daemon running on:
SMARTD_MESSAGE=TEST EMAIL from smartd for device: /dev/sda
</pre>

Your script also has a ''temporary'' copy of the report available as "$1". It will be deleted after you finish but the same content is written to <code>/var/log/syslog</code>.

==== Personal computer ====
For a visual notification, you may just install <code>smart-notifier</code>. You will see a large popup with the report:

<nowiki>[[File:smart-notifier_warning.png]]</nowiki>

Alternatively, you may create a custom notification (bubble) as seen in other GNOME programs.

You will need to install the <code>libnotify-bin</code> package:
<pre>
sudo aptitude install libnotify-bin</pre>

Now create a text file called <code>60notify</code> in <code>/etc/smartmontools/run.d</code>:
<pre>
sudo vi /etc/smartmontools/run.d/60notify</pre>

and add the following to the file:
<pre>

DISPLAY=:0.0 notify-send --icon=important "Possible disk failure" "$SMARTD_DEVICE may have a problem"
</pre>
(The <code>DISPLAY=:0.0</code> part is a variable assignment that helps programs to locate your X server. It's already set for your terminal, but the script lacks it since it is being run inside a different session).

Now give it execute permissions:
<pre>
sudo chmod +x /etc/smartmontools/run.d/60notify</pre>

This will produce a nice libnotify bubble with a warning icon:

<nowiki>[[File:smart_notification.png]]</nowiki>

You may also experiment with Zenity:
<pre>

DISPLAY=:0.0 zenity --text-info --filename="$1" --title="smartd: $SMARTD_DEVICE may have a problem"
</pre>

'''Notice:''' Be very careful with these scripts as they are run under the root account.

==== Server ====
Here, you may wish to handle things differently. In this example we want to mail an admin ''and'' shut down the server.
Comment out the line that contains <code>DEVICESCAN</code>, by adding # to the beginning of the line. Then, add this to the end of the file:

<pre>
/dev/hda -H -l error -l selftest -f -s (O/../../5/11|L/../../5/13|C/../../5/15) \
-m admin@somewhere.com -M exec /usr/share/smartmontools/smartd-runner</pre>
(Be sure not to add any whitespace after the "\")

Now, we are going to make the script which is going to shut down the computer *after* we mail the admin. Create a text file called <code>99shutdown</code> in <code>/etc/smartmontools/run.d</code> and add the following to the file:

<pre>

sleep 40
shutdown -h now</pre>

The number ''99'' at the start of the filename is to ensure that it is called last when <code>smartd-runner</code> runs. It will wait 40 seconds and then shut down the computer. Of course, you may customize this at will; you may not wish to turn off the server.

Now, it is time to start the daemon: <pre>
sudo service smartmontools start</pre>

==== Testing ====
If you want to test all these actions, add <code>-M test</code> after <code>exec /usr/share/smartmontools/smartd-runner</code> and restart the daemon (<code>sudo service smartmontools restart</code>). When the daemon comes up, it will execute the script immediately with a test message. '''Notice:''' If you included the <code>shutdown -h</code> line, the script will shut down the computer as soon as the service starts. To fix this, you will have to start the computer in recovery mode and remove the <code>-M test</code> option from <code>/etc/smartd.conf</code>.

Based on <nowiki>[[http://gentoo-wiki.com/HOWTO_Monitor_your_hard_disk(s)_with_smartmontools|Gentoo Wiki: HOWTO Monitor your hard disk(s)withsmartmontools]]</nowiki>.

==== Note ====
Before running this, be sure to check that you have a "mail" command, and do a test first to your address. On my default Fiesty:

jim@beorn:~$ mail

The program 'mail' can be found in the following packages:
* mailx
* mailutils
Try: sudo apt-get install <selected package>

Make sure you have the 'universe' component enabled

bash: mail: command not found

== Utility: Checking all disks at once ==
Note: Following the Gentoo Wiki I made a modified script which checks all the disk in <code>/dev/disk/by-id/</code>
Just invoke the script below as follows:
<pre>
./smart.sh short|long|offline
</pre>
The script creates a directory named <code>smart-logs</code> and stores all the files there.
<pre>

[ ! "$@" ] && echo "Usage: $0 type [type] [type]"

[ ! -e smart-logs ] && mkdir smart-logs
[ ! -d smart-logs ] && Can not create smart-logs dir && exit 1

a=0

for t in "$@"; do

        case "$t" in
                offline)  l=error;;
                short|long)  l=selftest;;
********* ) echo $t is an unrecognised test type. Skipping... && continue
        esac

       for hd in  /dev/disk/by-id/ata*; do
                r=$(( $(smartctl -t $t -d ata $hd | grep 'Please wait' | awk '{print $3}') ))
                echo Check $hd - $t test in $r minutes
                [ $r -gt $a ] && a=$r
       done
     echo "Waiting $a minutes for all tests to complete"
		sleep $(($a))m

	for hd in /dev/disk/by-id/ata*; do
                smartctl -l $l -d ata $hd 2>&1 >> smart-logs/smart-${t}-${hd##*/}.log
        done

	
done

for i in {1..10}; do
        sleep .01
        echo -n -e \\a
done

echo "All tests have completed"
</pre>
(Remember to give execute permissions to the script with <code>chmod +x smart.sh</code>).

== Testing drives behind MegaRAID ==
If `/dev/sda` is a MegaRAID device then straightforward execution of smartctl on it is not effective. It just returns an empty report for the controller itself. To get S.M.A.R.T. attributes of a drive behind the RAID controller you need to use the following command:

<pre>
for i in {0..23}; do sudo smartctl -x /dev/sda -d megaraid,$i >>./OUTPUT; done</pre>

== Examples of SMART reports ==
See large collection of smartctl reports for various hard drives <nowiki>[[https://github.com/linuxhw/SMART|here]]</nowiki>.

----
CategoryHardware
