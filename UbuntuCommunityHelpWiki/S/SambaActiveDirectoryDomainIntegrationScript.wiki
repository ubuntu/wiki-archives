{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work.
* A '''full compressed version''' of the wiki is available on archive.org
|}

__TOC__



Discussion of this wiki can be found <nowiki>[[http://ubuntuforums.org/showthread.php?t=2012421 | here ]]</nowiki>

== What this procedure will do ==

If all runs well you will have a Linux machine completely integrated with your Active Directory server. The shared folders permissions will be managed from your samba server and it will use groups and users taken directly from your AD Domain Controller. Just follow this guide and use the attached script!

== Preface ==
 This procedure was tested with a Linux machine running Ubuntu10.04 and both Windows Server2003 and WindowsServer2008r2 as AD Server.

 This procedure is taken from a lot of guides but you can find the best guide that I found <nowiki>[[http://wiki.samba.org/index.php/Samba_&_Active_Directory#Authenticating_share_users_and_groups_against_active_directory |here]]</nowiki>

 It's perfectly explicated in all its sections and it treats every part more deeply than this one. I really recommend to consult it for every doubt. 

== Get The Script ==

<nowiki>[[http://ubuntuforums.org/attachment.php?attachmentid=170348&d=1285260826 |from here]]</nowiki>

== Requirements ==

 To join your Linux machine to your Active Directory Domain you need:

** Access to a Windows Domain Controller with a Domain Administrator account
** Access to a Linux machine with administrator account (sudoer or root account)
** The archive provided with this guide extracted in a folder (do not move or edit the “templates” folder or its content)

For testing I really recommend to use a Linux virtual machine for the first time if it is possible.

 It's important that the name of the machine you will add to domain has a name shorter than 15 characters. If not you must modify it in /etc/hostname and in /etc/hosts file with your preferred text editor (vi,nano,gedit) and restart the machine:

<pre>
sudo nano /etc/hostname
</pre>

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> user-laptop
|}

<pre>
sudo nano /etc/hosts
</pre>

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> 127.0.0.1 localhost
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> 127.0.1.1 user-laptop
|}

Kerberos is time-dependent, so you may have to make sure that the machine time is correct using a protocol like NTP. So synchronize your Linux machine time and date with the same NTP server of your domain with:

<pre>
sudo ntpdate your.domain.ntp.server
</pre>

You can also make this command run regularly with crontab:

<pre>
sudo crontab -e
</pre>

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> # m h dom mon dow command
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> 00 12 * * * ntpdate your.domain.ntp.server
|}

In this way the command will run at 12:00 o'clock every day with root privilege (visit this  <nowiki>[[http://www.crontabrocks.org/ |link]]</nowiki> for more information about crontab).
 It is also important that your DNS is properly configured as your domain DNS; you can do that using a network manager (like network-manager or wicd) or modifying the /etc/resolv.conf file with the proper configuration. An example:

<pre>
sudo nano /etc/resolv.conf
</pre>

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> domain yourdomain.local
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> search yourdomain.local
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> nameserver 10.0.0.5
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> nameserver 10.0.0.1
|}

Note that if you using a network manager program it's probable that your /etc/resolv.conf configuration will be ignored and replaced by an auto-generated one.
 Now test your configuration with the “nslookup” command using both server name and this IP; the result might be something like this:

<pre>
nslookup 10.0.0.5
</pre>

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> Name: WServer2k3
|}

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> Address: 10.0.0.5
|}

<pre>
nslookup WServer2k3
</pre>

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> Name: WServer2k3
|}

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> Address: 10.0.0.5
|}

If you changed the name maybe it's better to reboot the machine.

== Running ==
 The first thing to do is to edit AD_join.sh variables: open it with your favorite editor

<pre>
nano AD_join.sh
</pre>

and modify only the variables in the first part of the script editing only between “quotation_marks”: 

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> SUPER_USER="myusername"
|}

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> DOMAIN="MYDOMAIN"
|}

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> FQDN_CAPITAL="MYDOMAIN.LOCAL"
|}

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> FQDN="mydomain.local"
|}

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> DOMAIN_CONTROLLER="mydomaincontroller.domain.local "
|}

Do not modify under the WARNING line unless you know what you're doing. 

Be sure that AD_join.sh has the execution bit set. Open a terminal, change location in the containing directory, and run the script with root privilege:

<pre>
cd /path/of/script/directory/AD_join
sudo chmod +x AD_join.sh
</pre>

Now you can run the script

<pre>
sudo ./AD_join.sh
</pre>

The script will install samba, winbind and kerberos in your machine and will change the original configurations files name in *.bkp in order to preserve them (also the entire /etc/pam.d/ directory will be copied to /etc/pam.d.bkp). Then it puts the new files (smb.conf, krb5.conf, nsswitch.conf, system-auth) in proper directories and restart the necessary services. 
Remember that when kerberos visual configuration appear you have to say just &lt;OK&gt; leaving blank the text field.

== Testing and Joining ==
 It's time to test your configuration and try to join in your Active Directory domain.
 First of all test your samba configuration file, open a terminal and type:

<pre>
testparm
</pre>

If all runs well you will see your samba's configuration. If not, the program will say  in which line of smb.conf file there is problem. In this case you can try to correct it or you can comment it out with "#" or ";". 
Note that probably Samba will warn you about "winbind separator = +" line, but that should be okay.
 Now try to join domain with the command:

<pre>
sudo net ads join -U your_domain_admin
</pre>

Change "administrator" with proper domain's administrator name.
 If all runs well the domain's administrator password is requested. If not, it's possible that your network connection parameter for DNS server is not properly configured, modify your network configuration or run:

<pre>
sudo net ads join -S your_server_IP_or_name -U your_domain_admin
</pre>

If all is right you will see a "SUCCESS" message in your terminal.
 Reboot your machine.
 Now you can test the joining with:

<pre>
wbinfo -u
</pre>

this gives the domain's users list

<pre>
wbinfo -g
</pre>

this gives the domain's groups list

<pre>
sudo  wbinfo -a your_domain_user
</pre>

this checks if your_domain_user using password connects to the domain
 You can also check the Winbind nsswitch module with getent:

<pre>
getent passwd
getent group
</pre>

Note that even if the procedure is a success, not sure that "getent" command gives the expected results.
 For testing your Kerberos configuration use this:

<pre>
kinit your_domain_user@YOUR_DOMAIN.LOCAL
</pre>

Replace "your_domain_user" with an existing user name and replace "YOUR_DOMAIN.LOCAL" with your domain name. If all is set correctly your_domain_user's password is requested. If not a kinit error will be prompted in terminal; in this case you might check your Kerberos configuration. Remember it's important CASE SENSITIVENESS.

== That's it! ==
 Your Linux machine is now joined to your Active Directory.

 Now you can:

** Manage permissions and access to your shared resource from your samba server
** Log on the Linux machine using your domain's credentials
** Browse shares on your Linux machine from your domain computers

Try to log in trough ssh

<pre>
ssh your_domain_user@linux_machine
</pre>

at “password:” enter your domain user password
 Every time you log on to the Linux machine with domain credentials a new home is created for that user in /home/YOUR_DOMAIN/your_domain_user.
 In order to secure those home folders, once they are created, you may run

<pre>
sudo chgrp “domain admins” /home/MY_DOMAIN/*
sudo chmod 700 /home/MY_DOMAIN/*
</pre>

So your user's homes will be private but accessible from “Domain Admins” members. You may wish to automate this by scheduling these commands using cron or crontab, because when a new user logs in the home directory just created has 755 permissions and “Domain Users” as group, so all users can browse each other homes. (and that's not such a big deal. In italian “Bella merda!”)

 If you want you can read the /etc/samba/smb.conf.bkp (recommended) file to understand what each field signifies. You can also uncomment the end of /etc/samba/smb.conf file in order to share a “test” folder (be sure to modify the field with the correct path and info). Remember that every time you change the /etc/samba/smb.conf file you might to restart the service with:

<pre>
sudo service smbd restart
</pre>

Manage folder's accesses editing the "valid users" field with the proper users and or groups. 
 The syntax is as follow:

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> valid users =@YOUR_DOMAIN+your_group YOUR_DOMAIN+your_user
|}

Note: no spaces between = and @
 This allows all the users of the Active Directory group "your_group" to access the shared folder and to the Active Directory user "your_user" also.
 If your groups name have spaces like "Group Name with Spaces" it is necessary to put quotation marks:

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> valid users =@"YOUR_DOMAIN+Group Name with Spaces"
|}

Pay attention to the case sensitiveness of the domain names.
 There are a lot of fields you can add or modify in your samba configuration: you can find some example in the preconfigured file (smb.conf) like the “admin user” field or the “[homes]” sharing option (with which you can share user's home folders to them as they login).

 Feel free to do all the experiments you want.

== Troubleshooting ==

 idQp posted some troubleshooting tips <nowiki>[[http://ubuntuforums.org/showthread.php?t=1580505&highlight=serbiss&page=10 |here]]</nowiki> 

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> If you get this error msg:
|}

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> "Failed to join domain: failed to connect to AD: Strong(er) authentication required"
|}

{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> you must add the following line to your smb.conf (GLOBAL Settings):
|}
<pre>
 client ldap sasl wrapping = sign 
</pre>
{| class="wikitable"
|-
| <tablestyle="width:100%" class="ubuntu_quotebackground"> this is because of an microsoft update that enables the ldap signing requirement to your AD.
|}

Originally posted <nowiki>[[http://ubuntuforums.org/showthread.php?t=1580505|The Ubuntu Forums (ubuntuforums.org)]]</nowiki>
