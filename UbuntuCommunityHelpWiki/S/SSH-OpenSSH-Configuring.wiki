{|
  | '''Warning'''
  * This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
  * '''Images''' and '''attachments''' have been removed to conserve space.
  * '''Links''' may not work and there may be formatting issues.
  * A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__

Parent page: <nowiki>[[InternetAndNetworking| Internet and Networking]]</nowiki> >> <nowiki>[[SSH]]</nowiki>

== Introduction ==

Once you have installed an OpenSSH server, 
<pre>
sudo apt-get install openssh-server 
</pre>
you will need to configure it by editing the `sshd_config` file in the `/etc/ssh` directory.

{| class="wikitable"
|-
| <style="border-right: 0px solid black; background-color: #B0C4DE"><nowiki>[[File:IconsPage/tip.png]]</nowiki>
| <style="border-left: 0px solid black; background-color: #B0C4DE">`sshd_config` is the configuration file for the OpenSSH ''server''.  `ssh_config` is the configuration file for the OpenSSH ''client''.  Make sure not to get them mixed up.
|}

First, make a backup of your `sshd_config` file by copying it to your home directory, or by making a read-only copy in `/etc/ssh` by doing:

<pre>
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.factory-defaults
sudo chmod a-w /etc/ssh/sshd_config.factory-defaults
</pre>

Creating a read-only backup in `/etc/ssh` means you'll always be able to find a known-good configuration when you need it.

Once you've backed up your `sshd_config` file, you can make changes with any text editor, for example; 
<pre>
sudo gedit /etc/ssh/sshd_config
</pre>
runs the standard text editor in Ubuntu 12.04 or more recent.  For older versions replace "sudo" with "gksudo".  Once you've made your changes (see the suggestions in the rest of this page), you can apply them by saving the file then doing:

<pre>
sudo restart ssh
</pre>

If you get the error, "Unable to connect to Upstart", restart ssh with the following:

<pre>
sudo systemctl restart ssh
</pre>

Configuring OpenSSH means striking a balance between security and ease-of-use.  Ubuntu's default configuration tries to be as secure as possible without making it impossible to use in common use cases.  This page discusses some changes you can make, and how they affect the balance between security and ease-of-use.  When reading each section, you should decide what balance is right for your specific situation.

== Disable Password Authentication ==

Because a lot of people with SSH servers use weak passwords, many online attackers will look for an SSH server, then start guessing passwords at random.  An attacker can try thousands of passwords in an hour, and guess even the strongest password given enough time.  The recommended solution is to use <nowiki>[[..-Keys|SSH keys]]</nowiki> instead of passwords.  To be as hard to guess as a normal SSH key, a password would have to contain 634 random letters and numbers.  If you'll always be able to log in to your computer with an SSH key, you should disable password authentication altogether.

If you disable password authentication, it will only be possible to connect from computers you have specifically approved.  This massively improves your security, but makes it impossible for you to connect to your own computer from a friend's PC without pre-approving the PC, or from your own laptop when you accidentally delete your key.

''It's recommended to disable password authentication unless you have a specific reason not to.''

To disable password authentication, look for the following line in your `sshd_config` file:

{| class="wikitable"
|-
| '''<code>#PasswordAuthentication yes</code>'''
|}

replace it with a line that looks like this:

{| class="wikitable"
|-
| '''<code>PasswordAuthentication no</code>'''
|}

Once you have saved the file and <nowiki>[[http://www.cyberciti.biz/faq/howto-start-stop-ssh-server/|restarted your SSH server]]</nowiki>, you shouldn't even be asked for a password when you log in.

== Disable Forwarding ==

By default, you can tunnel network connections through an SSH session.  For example, you could connect over the Internet to your PC, tunnel a <nowiki>[[VNC|remote desktop]]</nowiki> connection, and access your desktop.  This is known as "port forwarding".

By default, you can also tunnel specific graphical applications through an SSH session.  For example, you could connect over the Internet to your PC and run `nautilus "file://$HOME"` to see your PC's home folder.  This is known as "X11 forwarding".

While both of these are very useful, they also give more options to an attacker who has already guessed your password.  Disabling these options gives you a little security, but not as much as you'd think. With access to a normal shell, a resourceful attacker can replicate both of these techniques and a specially-modified SSH client.

''It's only recommended to disable forwarding if you also use <nowiki>[[..-Keys#keys-with-specific-commands|SSH keys with specified commands]]</nowiki>''.

To disable forwarding, look for the following lines in your `sshd_config`:

{| class="wikitable"
|-
| '''<code>AllowTcpForwarding yes</code>'''
|}

{| class="wikitable"
|-
| '''<code>X11Forwarding yes</code>'''
|}

and replace them with:

{| class="wikitable"
|-
| '''<code>AllowTcpForwarding no</code>'''
|}

{| class="wikitable"
|-
| '''<code>X11Forwarding no</code>'''
|}

If either of the above lines don't exist, just add the replacement to the bottom of the file.  You can disable each of these independently if you prefer.

== Specify Which Accounts Can Use SSH ==

You can explicitly allow or deny access for certain users or groups.  For example, if you have a family PC where most people have weak passwords, you might want to allow SSH access just for yourself.

Allowing or denying SSH access for specific users can significantly improve your security if users with poor security practices don't need SSH access.

''It's recommended to specify which accounts can use SSH if only a few users want (not) to use SSH.''

To allow only the users `Fred` and `Wilma` to connect to your computer, add the following line to the bottom of the `sshd_config` file:

{| class="wikitable"
|-
| '''<code>AllowUsers Fred Wilma</code>'''
|}

To allow everyone except the users `Dino` and `Pebbles` to connect to your computer, add the following line to the bottom of the `sshd_config` file:

{| class="wikitable"
|-
| '''<code>DenyUsers Dino Pebbles</code>'''
|}

It's possible to create very complex rules about who can use SSH - you can allow or deny specific groups of users, or users whose names match a specific pattern, or who are logging in from a specific location.  For more details about how to create complex rules, see the <nowiki>[[http://manpages.ubuntu.com/manpages/hardy/man5/sshd_config.5.html|sshd_config man page]]</nowiki>

== Rate-limit the connections ==
It's possible to limit the rate at which one IP address can establish new SSH connections by <nowiki>[[UFW|configuring the uncomplicated firewall]]</nowiki> (ufw). If an IP address is tries to connect more than 10 times in 30 seconds, all the following attempts will fail since the connections will be DROPped. The rule is added to the firewall by running a single command:

<pre>
sudo ufw limit ssh
</pre>

On a single-user or low-powered system, such as a laptop, the number of total simultaneous pending (not yet authorized) login connections to the system can also be limited. This example will allow two pending connections. Between the third and tenth connection the system will start randomly dropping connections from 30% up to 100% at the tenth simultaneous connection. This should be set in `sshd_config`.

{| class="wikitable"
|-
| '''<code>MaxStartups 2:30:10</code>'''
|}

In a multi-user or server environment, these numbers should be set significantly higher depending on resources and demand to alleviate denial-of-access attacks. Setting a lower the login grace time (time to keep pending connections alive while waiting for authorization) can be a good idea as it frees up pending connections quicker but at the expense of convenience.

{| class="wikitable"
|-
| '''<code>LoginGraceTime 30</code>'''
|}

== Log More Information ==

By default, the OpenSSH server logs to the AUTH facility of syslog, at the INFO level.  If you want to record more information - such as failed login attempts - you should increase the logging level to VERBOSE.

''It's recommended to log more information if you're curious about malicious SSH traffic.''

To increase the level, find the following line in your `sshd_config`:

{| class="wikitable"
|-
| '''<code>LogLevel INFO</code>'''
|}

and change it to this:

{| class="wikitable"
|-
| '''<code>LogLevel VERBOSE</code>'''
|}

Now all the details of `ssh` login attempts will be saved in your `/var/log/auth.log` file.

If you have started using a different port, or if you think your server is well-enough hidden not to need much security, you should increase your logging level and examine your `auth.log` file every so often.  If you find a significant number of spurious login attempts, then your computer is under attack and you need more security.

Whatever security precautions you've taken, you might want to set the logging level to `VERBOSE` for a week, and see how much spurious traffic you get.  It can be a sobering experience to see just how much your computer gets attacked.

== Display a Banner ==

If you want to try to scare novice attackers, it can be funny to display a banner containing legalese.  This doesn't add any security, because anyone that's managed to break in won't care about a "no trespassing" sign--but it might give a bad guy a chuckle.

To add a banner that will be displayed before authentication, find this line:

{| class="wikitable"
|-
| '''<code>#Banner /etc/issue.net</code>'''
|}

and replace it with:

{| class="wikitable"
|-
| '''<code>Banner /etc/issue.net</code>'''
|}

This will display the contents of the `/etc/issue.net` file, which you should edit to your taste.  If you want to display the same banner to SSH users as to users logging in on a local console, replace the line with:

{| class="wikitable"
|-
| '''<code>Banner /etc/issue</code>'''
|}

To edit the banner itself try 
<pre>
sudo gedit /etc/issue.net
</pre>

Here is an example for what you might put in an `issue` or `issue.net` file and you could just copy&paste this in:

<pre>
* **************************************************************************
                            NOTICE TO USERS

This computer system is the private property of its owner, whether
individual, corporate or government.  It is for authorized use only.
Users (authorized or unauthorized) have no explicit or implicit
expectation of privacy.

Any or all uses of this system and all files on this system may be
intercepted, monitored, recorded, copied, audited, inspected, and
disclosed to your employer, to authorized site, government, and law
enforcement personnel, as well as authorized officials of government
agencies, both domestic and foreign.

By using this system, the user consents to such interception, monitoring,
recording, copying, auditing, inspection, and disclosure at the
discretion of such personnel or officials.  Unauthorized or improper use
of this system may result in civil and criminal penalties and
administrative or disciplinary action, as appropriate. By continuing to
use this system you indicate your awareness of and consent to these terms
and conditions of use. LOG OFF IMMEDIATELY if you do not agree to the
conditions stated in this warning.

* ***************************************************************************
</pre>

== Troubleshooting ==

Once you have finished editing `sshd_config`, make sure to save your changes before restarting your SSH daemon.

First, check that your SSH daemon is running:

<pre>
ps -A | grep sshd
</pre>

This command should produce a line like this:

<pre>
<some number> ?        00:00:00 sshd
</pre>

If there is no line, your SSH daemon is not running.  If it is, you should next check that it's listening for incoming connections:

<pre>
sudo ss -lnp | grep sshd
</pre>

This command should produce a line that looks like one of these:

<pre>
0  128  :::22  :::*  users:(("sshd",16893,4))
0  128   *:22   *:*  users:(("sshd",16893,3))
</pre>

If there is more than one line, in particular with a port number different than 22, then your SSH daemon is listening on more than one port - you might want to go back and delete some `Port` lines in your `sshd_config`.  If there are no lines, your SSH daemon is not listening on any ports, so you need to add at least one `Port` line.  If the line specifies something other than "*:22" ([::]:22 is IPv6), then your SSH daemon is listening on a non-standard port or address, which you might want to fix.

Next, try logging in from your own computer:

<pre>
ssh -v localhost
</pre>

This will print a lot of debugging information, and will try to connect to your SSH server.  You should be prompted to type your password, and you should get another command-line when you type your password in.  If this works, then your SSH server is listening on the standard SSH port.  If you have set your computer to listen on a non-standard port, then you will need to go back and comment out (or delete) a line in your configuration that reads `Port 22`.  Otherwise, your SSH server has been configured correctly.

To leave the SSH command-line, type:

<pre>
exit
</pre>

If you have a local network (such as a home or office network), next try logging in from one of the other computers on your network.  If nothing happens, you might need to tell your computer's firewall to allow connections on port 22 (or from the non-standard port you chose earlier).

Finally, try logging in from another computer elsewhere on the Internet - perhaps from work (if your computer is at home) or from home (if your computer is at your work).  If you can't access your computer this way, you might need to tell your router's firewall to allow connections from port 22, and might also need to configure <nowiki>[[ServersBehindNAT|Network Address Translation]]</nowiki>.
