{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work.
* A '''full compressed version''' of the wiki is available on archive.org
|}

__TOC__


== Introduction ==
Kerberos is an authentication protocol using secret-key cryptography. There are several implementations of the Kerberos protocol used in both commercial and open-source software. This guide covers configuring the Samba server and clients to utilize Kerberos authentication services.

== Active Directory ==

<nowiki>[[http://wiki.samba.org/index.php/Samba_%26_Active_Directory|Detailed instructions]]</nowiki> for integrating Samba with Active Directory are available on the <nowiki>[[http://wiki.samba.org/|Samba wiki]]</nowiki>.

The linked page gives the location of the PAM configuration files for Red Hat. In Ubuntu, the PAM configuration files are located in `/etc/pam.d/` directory. The auth, account, and passwd stanzas are split into three files in Ubuntu: `/etc/pam.d/common-auth` for auth stanzas; `/etc-pam.d/common-account` for account stanzas; and `/etc/pam.d/common-passwd` for passwd stanzas.

Ubuntu versions 9.04 (Jaunty Jackalope) and newer automatically update the PAM configuration files using the `pam-auth-update` utility. In previous versions, the configuration files must be edited manually.

== MIT Kerberos ==

Instructions for installing and configuring MIT Kerberos are available on <nowiki>[[Kerberos|its wiki page]]</nowiki>. Samba is just another service to Kerberos, so to allow Samba to authenticate users via Kerberos, simply generate a principal for the Samba server, place the service key in a keytab, and configure Samba to use it.

The name of this principal must take the form `cifs/server.example.com@EXAMPLE.REALM`, and '''the encryption type must be rc4-hmac:normal.'''

Here is a step-by-step guide:

1. Launch the `kadmin` utility as the realm administrator or as a user authorized to add principals:
<pre>
$ kadmin -p admin/admin
</pre>

2. In the `kadmin` interface, issue the following command:
<pre>
kadmin: addprinc -randkey cifs/server.example.com
</pre>
A message indicating the principal `cifs/server.example.com@EXAMPLE.REALM` should be displayed.

3. Generate a keytab for the new principal:
<pre>
kadmin: ktadd -k /path/to/keytab -e rc4-hmac:normal cifs/server.example.com
</pre>
'''Make sure to include the encryption type.''' The default encryption type is not compatible with the Samba client utilities.

4. Securely copy the keytab to `/etc/krb5.keytab` on the server that will be running Samba.

5. Make sure only the root user can access the keytab:
<pre>
$ chown root:root /etc/krb5.keytab
$ chmod 0600 /etc/krb5.keytab
</pre>

6. Edit the `smb.conf` file (located in `/etc/samba/` by default) as indicated below:

<pre>
...
security = ADS
realm = KERBEROS_REALM
encrypt passwords = yes
kerberos method = secrets and keytab
password server = kdc.fdqn
...
</pre>

The password server option is only required if you intend to use a password server other than the one configured in `/etc/krb5.conf`. 

7. Restart Samba:
<pre>
$ sudo /etc/init.d/samba restart
</pre>

=== User Administration ===

Add users to the Kerberos database using the `kadmin` interface:
<pre>
kadmin: addprinc <username>[@REALM.NAME]
</pre>
The realm name is optional in properly configured Kerberos environments.

You will be prompted to enter a password for the user. Once a user is added you should be able to acquire Ticket-Granting Tickets with `kinit` from any system that is configured to authenticate using your Kerberos domain. See the <nowiki>[[Kerberos]]</nowiki> page for more details.

Note that '''Samba maps authenticated users to a system users'''. This means that if you add a user to the Kerberos database that does not exist as a system user, you will not be able to authenticate using your Kerberos credentials until a user of the same name is added as a system user. See AddUsersHowto for details on adding users. Other options such as pulling user information from LDAP are possible, but outside the scope of this guide.

The existence of a user can be checked with this command:
<pre>
$ id <username>
</pre>

== Testing ==

<pre>
$ kinit <Kerberos username>
$ smbclient -k -L //server/
</pre>

If all is well, a listing of active shares will be displayed.
