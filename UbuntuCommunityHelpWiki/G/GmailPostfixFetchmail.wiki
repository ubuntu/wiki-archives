{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__


== Introduction ==
How to use Postfix and Fetchmail to access a single Gmail account using an old-fashioned client such as mutt or Emacs GNUS. 

''If you use Evolution or a similar modern e-mail client, you do not
need to use this''. Your client has the ability to connect directly to the Gmail POP3 and SMTP services.
** Help with Evolution: UsingGmailWithEvolution.
** Help with Thunderbird: http://mail.google.com/support/bin/answer.py?answer=38343

This setup is intended to be as simple and as close to a standard Ubuntu configuration as possible.
This setup does ''not'' verify the Gmail SMTP server certificate. 

=== Not For Beginners ===
You should be familiar with:
* How to install packages
* How to edit text configuration files.
* Terms like POP3, SMTP and SSL.

=== References ===
* http://prantran.blogspot.com/2007/01/getting-postfix-to-work-on-ubuntu-with.html
* http://souptonuts.sourceforge.net/postfix_tutorial.html
* http://www.postfix.com/TLS_README.html
* http://www.postfix.com/SASL_README.html
* http://www.postfix.com/ADDRESS_REWRITING_README.html
* http://postfix.state-of-mind.de/patrick.koetter/smtpauth/smtp_auth_mailservers.html
* http://postfix.state-of-mind.de/patrick.koetter/smtpauth/postfix_tls_support.html

== Packages needed ==
You will need the postfix and fetchmail packages.  See
InstallingSoftware for more on installing packages.  Postfix will work on Ubuntu as is from apt-get without any compilation necessary

== Setting up your Gmail account ==
You will need to enable POP access for your Gmail account.  This is done through the google website.  See
UsingGmailWithEvolution for more.  Gnus queues mail to postfix, postfix forwards to Google. An openssl certificate is made by a CA signing authority signing a request to generate a server-side certificate.  Although  to encrypt the connection between Gnus and postfix is possible, this is not necessary if mail is being sent from gnus to postix at the local machine.  The connection between postfix and google will be encrypted.  This is like https but by the smtp protocol which is by emails.  So it is not always necessary to use postfix to do this because some A Mail User Agents can do this itselves : a MUA is a client like gnus or evolution.  Postfix will be a client when is connects to google, and the variables pertaining by this are beginning as smtp-the-something.  Where postfix is the daemon it receives mails, into our case from the localhost, and the variables pertaining by this mode commence as smtpd-something.  Don't forget!  

A "mail delivery agent" is the back end used to store mails, which can be postfix. A "mail transfer agent" is a server talking SMTP : it receives mail via SMTP, and it can pass it on via SMTP. Postfix is a combination of MTA and MDA. 

to send every mail through Google you also need to set option as 

relayhost[smtp.gmail.com]:587

Another option is to use a transport map.

transport_maps = hash:/etc/postfix/transport

The easiest is to just use a mail client, and nothing inter-locuting, but we are not doing this by using postfix at all.
Postfix may and can be used as a storage mail retrieval of fetchmail exclusively, and let the mail client perform the smtp encryption  to google directly.  So this is available as an alternative plan, when this one does work.  It is very time-consuming, awkward, frustrating, and annoying.
 
== Example username ==
In all the examples below, I've assumed that the username on the
Ubuntu system is <code>jane</code>, and that the Gmail username is
<code>jane.doe@gmail.com</code>, with password <code>doeadeer</code>.  You obviously need to
replace these with your local username, your Gmail username and Gmail
password as appropriate.

== Configuring Postfix ==
To setup Postfix, you will need to create 5 files:
* /etc/postfix/main.cf
* /etc/postfix/generic
* /etc/postfix/generic.db
* /etc/postfix/passwd
* /etc/postfix/passwd.db
You will need root access to create and edit these files; see RootSudo
for more on gaining root access.

=== Stop Postfix ===
It's not necessary to do so, but if you wish to stop Postfix while
configuring, run (as root)
<pre>
  /etc/init.d/postfix stop
</pre>

=== /etc/postfix/main.cf ===
When you install Postfix you will be prompted to make configurative
choices.  You can choose "No configuration"; in this case no
configuration file will be created, and you can use the contents
below.  The configuration choices used to create it are listed in the
Appendix.

This is the Postfix configuration file /etc/postfix/main.cf:

<pre>

smtpd_banner = $myhostname ESMTP $mail_name (Ubuntu)
biff = no

append_dot_mydomain = no

smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${queue_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${queue_directory}/smtp_scache

myhostname = localhost
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
mydestination = localhost, localhost.localdomain
mynetworks = 127.0.0.0/8
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = loopback-only
inet_protocols = all

smtp_tls_loglevel=1
smtp_tls_security_level=encrypt
smtp_sasl_auth_enable=yes
smtp_sasl_password_maps=hash:/etc/postfix/sasl/passwd
smtp_sasl_security_options = noanonymous

smtp_generic_maps=hash:/etc/postfix/generic

relayhost=[smtp.gmail.com]:587
</pre>

An explanation of each non-standard line (following the comment "non
debconf entries start here") is given in the Appendix.

=== /etc/postfix/generic and /etc/postfix/generic.db ===
The generic file tells Postfix how to map local e-mail addresses to
Internet addresses when mail is sent via SMTP.  Postfix rewrites
"From:" headers to make e-mail appear to come from
<code>jane.doe@gmail.com</code> instead of <code>jane@localhost</code>.

The /etc/postfix/generic is a plain text file, and should look as
follows:
<pre>
jane@localhost   jane.doe@gmail.com
</pre>

/etc/postfix/generic.db is generated from this using the postmap command:
<pre>
cd /etc/postfix
postmap generic
</pre>

=== /etc/postfix/sasl/passwd and /etc/postfix/sasl/passwd.db ===
The passwd file contains your Gmail password.  Like
/etc/postfix/generic file discussed above, it is a plain text file;
it should look as follows:
<pre>
[smtp.gmail.com]:587    jane.doe@gmail.com:doeadeer
</pre>

To create passwd.db, and set ownership and permissions appropriately,
run the following commands:
<pre>
cd /etc/postfix/sasl
postmap passwd
chown root.root passwd passwd.db
chmod 600 passwd passwd.db
</pre>

=== Start or reload Postfix ===
If you previously stopped Postfix, restart it with
<pre>
  /etc/init.d/postfix start
</pre>

If you didn't stop Postfix, force it to reload its configuration with
<pre>
  postfix reload
</pre>

=== Testing ===
Postfix provides a means of testing its address rewriting rules using
the sendmail command with the '-bv' option.  If the mail would be sent
externally (i.e., via smtp.gmail.com), the command will cause sendmail
to connect and authenticate to smtp.gmail.com, which makes it a
convenient way to test the Postfix setup.

One possibly inconvenient feature of sendmail -bv is that the result
is mailed to the user who ran the command; thus, if mail is utterly
misconfigured, you will never receive the result.  If you suspect this
is the case, you can check /var/log/mail.log to see what went wrong, or you can type mail within the same account as the sender.

Alternatively do <code>echo 'test mail' | mail -s 'testing this' foo@bar.com </code>

To check that basic delivery works, run the following command as a
normal user (replacing "jane", as elsewhere, with your username):
<pre>
sendmail -bv jane
</pre>
You should receive a mail starting with:
<pre>
This is the mail system at host localhost.

Enclosed is the mail delivery report that you requested.

                   The mail system

<jane@localhost> (expanded from <jane>): delivery via local: delivers to mailbox
</pre>
If this didn't work, make sure that Postfix is running.

To check that Postfix can successfully connect to gmail, run
<pre>
sendmail -bv jane.doe@gmail.com
</pre>
You should receive a mail starting with:
<pre>
This is the mail system at host localhost.

Enclosed is the mail delivery report that you requested.

                   The mail system

<jane.doe@gmail.com>: delivery via smtp.gmail.com[66.249.91.109]:587: 250 2.1.5 OK
</pre>
Potential problems with this are discussed in the following section.

=== Potential Postfix problems ===
==== Cannot find password ====
If you get an error message like this:
<pre>
<jane.doe@gmail.com>: delivery via smtp.gmail.com[66.249.91.109]:587:
    host smtp.gmail.com[66.249.91.109] said: 530 5.5.1 Authentication Required
    c24sm1773006ika (in reply to MAIL FROM command)
</pre>

then Postfix cannot figure out what password to send gmail; make sure
that the smtp_sasl_password_maps entry in /etc/postfix/main.cf is
correct, that /etc/postfix/sasl/passwd is correct, and that you've
created /etc/postfix/sasl/passwd.db.

==== No mechanism available ====
If you get an error message like this:
<pre>
   SASL authentication failed; cannot authenticate to server
   smtp.gmail.com[66.249.91.109]: no mechanism available
</pre>
you have probably forgotten the smtp_sasl_security_options line in
/etc/postfix/main.cf.

== Configuring Fetchmail ==
The setup presented here configures the system-wide fetchmail service,
which is by default always running; for this use /etc/fetchmailrc is
the configuration file.  If you want to run fetchmail as your normal
user you should use ~/.fetchmailrc; that case is not further discussed
here.

Unlike the Postfix setup above, the fetchmail configuration presented here ''will''
verify the Gmail POP3 server's certificate.

=== Stop the fetchmail service ===
To stop fetchmail while configuring it, run
<pre>
/etc/init.d/fetchmail stop
</pre>

=== /etc/fetchmail.rc ===
The file /etc/fetchmailrc should look as follows:
<pre>
set syslog

set daemon 240

poll pop.gmail.com
  with nodns,
  with protocol POP3
  user "jane.doe@gmail.com" there is jane here,
  with password doeadeer,
  with ssl, sslcertck;
</pre>

A detailed explanation is given in the appendix, though fetchmail's
configuration language hopefully makes it clear.

Since this file contains your Gmail password, you may wish to give it
restrictive read permission:
<pre>
chmod 600 /etc/fetchmailrc
</pre>

=== Testing ===

To test your configuration, run fetchmail as below; this should be run
as root, since it reads /etc/fetchmailrc.
<pre>
fetchmail -v -d0 -f /etc/fetchmailrc
</pre>

Take a look at /var/log/mail.log (e.g., using <code>less /var/log/mail.log</code>) 
to see that the connection was successful.

=== Restart fetchmail ===
Once your configuration is working, you can restart fetchmail with
<pre>
/etc/init.d/fetchmail start
</pre>

== Appendix ==
=== Debconf choices for main.cf above ===

For the record, the main.cf above was created with

  dpkg-reconfigure postfix

with the following selections:

<pre>
General type of configuration: Satellite system
Mail for root: <blank> (default)
Mail name: localhost (default)
SMTP relay host: <blank> (default is smtp.localdomain)
Other destinations to accept mail for: localhost, localhost.localdomain, localhost (default)
Synchronous updates: no (default)
Local networks: 127.0.0.0/8 (default)
Mailbox size limit: 0 (default)
Local address extension character: + (default)
Internet protocols to use: all (default)
</pre>

=== Explanation of /etc/postfix/main.cf ===
Only the non-debconf lines are explained.  For much more, run 
<code>man 5 postconf</code> or visit <nowiki>[[http://www.postfix.com/documentation.html]]</nowiki>.

<pre>
smtp_tls_loglevel=1
</pre>

Basic logging of connections to smtp.gmail.com.

<pre>
smtp_tls_security_level=encrypt
</pre>

Require an encrypted TLS connection to smtp.gmail.com.  It would be
preferable to use the verify level.

<pre>
smtp_sasl_auth_enable=yes
</pre>

Enable SMTP authentication.

<pre>
smtp_sasl_password_maps=hash:/etc/postfix/sasl/passwd
</pre>

Where the SMTP authentication data is to be found.

<pre>
smtp_sasl_security_options = noanonymous
</pre>

This one is a bit obscure: by specifying noanonymous, one allows
plaintext passwords to be sent (I think noplaintext is the next level
"up" from noanonymous).  Gmail's SMTP server apparently accepts
plaintext authentication only.

<pre>
smtp_generic_maps=hash:/etc/postfix/generic
</pre>

Where the generic mapping data is to be found.

<pre>
relayhost=[smtp.gmail.com]:587
</pre>

Address and port number for SMTP connections.  Putting the hostname in
square brackets means it is interpreted as a hostname, rather than a
mail name (as I understand it, Postfix uses "normal" DNS records
rather than MX records when square brackets are used).

=== Explanation of /etc/fetchmailrc ===
Run <code>man fetchmail</code> for details.  Fetchmail's configuration
language has the interesting property of ignoring some words (like
"with") and punctuation (like the comma and semicolon).

<pre>
set syslog
</pre>

Log messages to syslog; fetchmail messages will appear in
/var/log/mail.log.

<pre>
set daemon 240
</pre>

Check for mail every 240 seconds.

<pre>
poll pop.gmail.com
</pre>
Each account entry starts with keyword "poll", followed by the server
hostname.

<pre>
  with nodns,
</pre>
This is probably unnecessary.

<pre>
  with protocol POP3
</pre>
Connect to pop.gmail.com mail using the POP3 protocol.

<pre>
  user "jane.doe@gmail.com" there is jane here,
</pre>
Login to the POP3 server with username "jane.doe@gmail.com"; deliver
mail to local user "jane".

<pre>
  with password doeadeer,
</pre>  
The POP3 password is "doeadeer".

<pre>
  with ssl, sslcertck;
</pre>

Use SSL in communicating to the POP3 server, and verify that the
certificate is valid.  fetchmail uses the certificates provided by the
ca-certificates packages for this.

=== Verifying the Gmail SMTP server certificate ===
The configuration above does ''not'' verify the certificate of the
Gmail SMTP server.  This would be very easy to do but for
<nowiki>[[https://bugs.launchpad.net/ubuntu/+source/ubuntu-docs/+bug/118963|Bug 118963]]</nowiki>

If you need this verification, you can either read
<nowiki>[[http://souptonuts.sourceforge.net/postfix_tutorial.html|reference 2]]</nowiki>
above, which shows you how to download and install the certificate
yourself, or you can do something like this:

<pre>
mkdir /var/spool/postfix/certs
cp -R /etc/ssl/certs/* /var/spool/postfix/certs
mkdir -p /var/spool/postfix/usr/share/ca-certificates
cp -R /usr/share/ca-certificates /var/spool/postfix/usr/share/ca-certificates
</pre>

Then, in main.cf, change the smtp_tls_security_level line and add an
smtp_tls_CApath line as follows:
<pre>
smtp_tls_security_level=verify
smtp_tls_CApath=/certs
</pre>

This might need to be redone if you upgrade postfix (e.g., when
upgrading Ubuntu).

=== If Nothing Is Working ===
If possible, check that you can access the Gmail SMTP and POP3
services with a client like Thunderbird; Google provide complete
instructions for setting up Thunderbird
<nowiki>[[http://mail.google.com/support/bin/answer.py?answer=38343|here]]</nowiki>.

You can try port 465 instead of 587 for SMTP.

You can do a check that SMTP connections can be made using stunnel, as
follows:
<pre>
stunnel -v 2 -c -n smtp -f -r smtp.gmail.com:587
</pre>

You should see something like this:
<pre>
2007.10.15 22:10:13 LOG5[9230:3083238176]: Using 'smtp.gmail.com.587' as tcpwrap
per service name
2007.10.15 22:10:13 LOG5[9230:3083238176]: stunnel 3.26 on i486-pc-linux-gnu PTH
READ+LIBWRAP with OpenSSL 0.9.8c 05 Sep 2006
220 mx.google.com ESMTP b30sm3913237ika
2007.10.15 22:10:15 LOG5[9230:3083238176]: VERIFY OK: depth=1, /C=ZA/ST=Western 
Cape/L=Cape Town/O=Thawte Consulting cc/OU=Certification Services Division/CN=Th
awte Premium Server CA/emailAddress=premium-server@thawte.com
2007.10.15 22:10:15 LOG5[9230:3083238176]: VERIFY OK: depth=0, /C=US/ST=Californ
ia/L=Mountain View/O=Google Inc/CN=smtp.gmail.com
</pre>

Terminate this connection with Ctrl-C.

You can also try testing the POP3 connection, though I had no success
with this:
<pre>
stunnel -v 2 -c -n pop3 -f -r pop.gmail.com:995
</pre>

Note that you ''cannot'' use openssl's s_client to test the SMTP
connection; Gmail's SMTP server requires the client to begin
communications with HELO (or EHLO), while s_client jumps straight to
STARTTLS.

== Why is everything still broken? ==
<pre>
smtpd_recipient_restrictions = 
			     permit_mynetworks
			     permit_sasl_authenticated
			     reject_unauth_destination
smtpd_sasl_authenticated_header = yes
</pre>

Now you MUST MUST MUST alter the master.cf file as demonstrated in <nowiki>[[http://souptonuts.sourceforge.net/postfix_tutorial.html|reference 2]]</nowiki>.  If you do not you might experience looking at a server certificate error in your mailq.

Another, and THE MOST IMPORTANT, thing is that probably your $mydomain, $myhostname, and a load of other things are not concurring with register user accounts on your local computer. The solution is within /usr/share/postfix/main.cf.dist which is a commented, more complete version of a main.cf
The clue lies in the fall_transport variable.  This permits postfix to work far less rigidly on machines which have spoof domains established within /etc/hosts by the benefit til the operation of nntp servers like leafnode.

<pre>
inet_interfaces = all
mynetworks_style = host
local_recipient_maps =
fallback_transport =
</pre>

If you are still having problems with authorisation and certificate recognition, forget the above about the snakeoil certificate, and follow the most excellent instructions to make your own certificate at
<nowiki>[[http://postfix.state-of-mind.de/patrick.koetter/smtpauth/postfix_tls_support.html|reference 7]]</nowiki>
This page is more useful than this whole venture by postfix itself. If it works it feels rewarding, but it can take one week of effort and worthwhile learning.

----
CategoryEmail CategoryInternet
