{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__


== Introduction ==
Internet Connection Sharing (ICS) provides the ability for one computer to share its Internet connection with another computer. To do this, a computer with an Internet connection must be configured to function as an Internet gateway. A second computer (or network of computers) connects to the Internet indirectly via the gateway computer.

Situations in which ICS may be necessary include:
* Dial-up connection.
* Authenticated (PPPoA/E) connection.
* Wireless connection.
* When it is impractical (such as with distance) to run multiple network cables to each computer.

=== GUI Method via Network Manager (Ubuntu 14.04, 16.04) ===

Assuming your Internet connection is on Wi-Fi, and you want to share via cable.
On Ubuntu 14.04 open Network connections from the applet or via commandline <code>nm-connection-editor</code>, then <code>add</code> a connection, select type <code>ethernet</code>, <code>create</code>, then on tab IPv4 Settings select Method <code>Shared to other computers</code>. That should be all for connection sharing. 

Assuming you have a cable connection and want to create a hotspot for other Wi-Fi devices.
For Wi-Fi you need to set an SSID and Method <code>Hotspot</code> on tab <code>Wi-Fi</code>, as well as Security <code>WPA</code> and a password on <code>Wi-Fi Security</code> tab.

On 16.04 start the <code>nm-connection-editor</code> via commandline, configure as before, then the created connection appears and works from gnome3-shell network settings.

=== GUI Method via Network Manager (Ubuntu 12.04) ===

Open Settings->Network->Wireless and create a new Ad Hoc network. To use a common denominator for all devices choose WEP for security and create a 5 letters password from 0..9A..F. Note that this a least secure encryption standard.

=== GUI Method via Network Manager (Ubuntu 11.10) ===

Follow the GUI Method via Network Manager (Ubuntu 9.10 and up) below but there is a bug which turn off and on the share connection. The workaround for now is to set IPv6 options to Ignore and then sudo killall dnsmasq. Reconnect and it should work.

http://askubuntu.com/questions/64494/wired-connection-shared-with-other-computers-connects-then-disconnects-in-11-10

=== GUI Method via Network Manager (Ubuntu 9.10 and up) ===
In order to share an Internet connection, the computer that will do the sharing must have two network cards or ports. This assumes that you are using at least one Ethernet port and that it is identified as "eth0". eth0 will be the port that other computers will connect to you on.

When you are logged in:
* Go to "System" on your top bar.
* Navigate to "Preferences" and select "Network Connections".
* When that window opens, select "Auto eth0", and press "Edit" (This assumes that you are connected to the Internet on some other port, for example wlan0 using wireless).

A new window will open. Navigate to the tab titled "IPv4 Settings", and change the Method to "Shared to other computers". After restarting the computer, you should now be able to plug in any computer into your other Ethernet port or share through your wireless card.

Note: To clarify the above example, here is an example configuration that will work:
1. You are already connected to the Internet using your wireless on port wlan0.
2. The Ethernet port eth0 is connected to the PC that needs to share your Internet connection (or you could wire eth0 to a router for multiple machines).

Note: In the case of connecting a router, especially one with wireless, where you want the users to share your connection: 
1. Check '''before you start''' (in Synaptic or with <code>dpkg-query -l dnsmasq*</code>) that dnsmasq-base ''is'' installed and that dnsmasq is ''not'' installed. Install or uninstall as appropriate (see next section).
2. After connecting the router, to enable masquerading, type:
<pre>
sudo iptables -t nat -A POSTROUTING -j MASQUERADE
</pre>

==== Wireless Ad-Hoc connection sharing scenario ====

Step-by-step guide:

* dnsmasq-base has to be installed:
<pre>
sudo apt-get install dnsmasq-base
</pre>
* '''Remove dnsmasq because it conflicts with NetworkManager:
<pre>
sudo apt-get remove dnsmasq
</pre>'''
* Restart NetworkManager:
<pre>
sudo /etc/init.d/network-manager restart
</pre>
* Add a new wireless network with NetworkManager (left-click on NetworkManager icon, then select "Create New Wireless Network").
* Call the new network "UbuntuAdhoc" (Note: If you choose another name, you will have to turn on connection sharing later by editing the network that you just created).
* Set encryption to "WEP40..." (Note: You may have to experiment here according to what type of encryption with ad-hoc the device supports. '''WPA is not supported''').

NetworkManager now should connect to itself (which means it creates the ad-hoc wireless network and routes any Internet traffic to your wired network interface). Now, connect with the client(s), and you should have a working Internet connection.

=== Ubuntu Internet Gateway Method (iptables) ===
You will need two network cards in the gateway computer, or a PPP interface and a network card. One network card (or PPP interface) connects to the Internet. We will call this card ''eth0''. The other card connects to your internal network. We will call this ''eth1''. It is also possible to do ICS with a single network card. In this case, use ''eth0'' for the Internet and ''eth0:0'' for the internal network.

# Internet <<==>> eth0 <> Ubuntu gateway <> eth1 <<==>> Client PC
# Internet <<==>> ppp0 <> Ubuntu gateway <> eth1 <<==>> Client PC
# Internet <<==>> eth0 <> Ubuntu gateway <> eth0:0 <<==>> Client PC

==== Gateway set up ====
The following example will focus on the most common gateway setup: an Ubuntu computer with two wired network adapters (eth0 and eth1) hosting ICS to a static internal network configured for the 192.168.0.x subnet.

For this example, eth0 is used to represent the network card connected to the Internet, and eth1 represents the network card connected to a client PC. You can replace eth0 and eth1 as needed for your situation. Also, any <nowiki>[[http://en.wikipedia.org/wiki/Ip_address#IPv4_private_addresses|private IP subnet]]</nowiki> can be used for the internal network IP addresses.

In summary:
 eth0 = the network adapter with internet (external or WAN).<<BR>>
 eth1 = the network adapter to which a second computer is attached (internal or LAN).<<BR>>
192.168.0.x = IP subnet for eth1<<BR>>

Your setup may be different. If so, make sure to change them accordingly in the following commands.

===== Configure internal network card =====
Configure your internal network card (eth1) for static IP like so:
<pre>
sudo ip addr add 192.168.0.1/24 dev eth1
</pre>
The external and internal network cards cannot be on the same subnet.

====== Configure NAT ======
Configure iptables for NAT translation so that packets can be correctly routed through the Ubuntu gateway. <pre>
sudo iptables -A FORWARD -o eth0 -i eth1 -s 192.168.0.0/24 -m conntrack --ctstate NEW -j ACCEPT
sudo iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
sudo iptables -t nat -F POSTROUTING
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</pre>

The first rule allows forwarded packets (initial ones).
The second rule allows forwarding of established connection packets (and those related to ones that started).
The third rule does the NAT.

IPtables settings need to be set-up at each boot (they are not saved automatically), with the following commands:
* Save the iptables:
<pre>
sudo iptables-save | sudo tee /etc/iptables.sav
</pre>

* Edit <code>/etc/rc.local</code> and add the following lines before the "exit 0" line:
<pre>
iptables-restore < /etc/iptables.sav
</pre>

===== Enable routing =====
* Configure the gateway for routing between two interfaces by enabling IP forwarding:
<pre>
sudo sh -c "echo 1 > /proc/sys/net/ipv4/ip_forward"
</pre> 

* Edit <code>/etc/sysctl.conf</code>, and (up to '''10.04''') add these lines:
<pre>
net.ipv4.conf.default.forwarding=1
net.ipv4.conf.all.forwarding=1
</pre>

'''''The <code>/etc/sysctl.conf</code> edit is required because of the following bug in Hardy and later releases:'''''
<nowiki>[[https://bugs.launchpad.net/ubuntu/+source/procps/+bug/84537|Launchpad Bug Report]]</nowiki>

* From '''10.10''' onwards, it suffices to edit <code>/etc/sysctl.conf</code> and uncomment:
<pre>
</pre>
... so that it reads:
<pre>
net.ipv4.ip_forward=1
</pre>

==== Client set up ====
Any OS can connect to the Internet as an ICS client as long as networking has been configured correctly. The following example will focus on how to set up an Ubuntu ICS client. For this example, it is assumed that the client is connected to an Ubuntu gateway, which has been configured to share ICS on the 192.168.0.x subnet according to the gateway set up outlined above.

For this example, eth0 is the network card on the client which is connected (by crossover cable) to eth1 on the Ubuntu gateway. You can replace eth0 as needed for your situation. Also, any private IP subnet can be used for the internal network IP address, as long as it matches the subnet on the gateway.

===== Disable networking =====
<pre>
sudo /etc/init.d/networking stop
</pre>

===== Give the client a static IP address =====
<pre>
sudo ip addr add 192.168.0.100/24 dev eth0
</pre>

This IP address can be anything within the gateway's private IP range.

===== Configure routing =====
<pre>
sudo ip route add default via 192.168.0.1
</pre>

This address should match the IP address on the gateway's internal network card (eth1 in the above example).

===== Configure DNS servers =====
Unless your ICS gateway can also perform <nowiki>[[http://en.wikipedia.org/wiki/Domain_Name_System|DNS]]</nowiki>, you must manually configure the client with your ISP DNS servers. If you do not know your ISP's DNS servers, you can use <nowiki>[[https://www.opendns.com/start?device=ubuntu|OpenDNS servers]]</nowiki> instead.

* Backup your current <code>/etc/resolve.conf</code> file:
<pre>
sudo cp /etc/resolv.conf /etc/resolv.conf.backup
</pre>
* Open <code>/etc/dhcp3/dhclient.conf</code> with your favorite text editor:
<pre>
sudo nano /etc/dhcp3/dhclient.conf
</pre>
* Search for the line that starts "prepend domain-name-servers", and change it to look like this:
<pre>
prepend domain-name-servers 208.67.222.222,208.67.220.220;
</pre>
208.67.222.222 and 208.67.220.220 are OpenDNS DNS servers. If you wish to use your ISP's DNS servers, use them here instead of the OpenDNS servers.

===== Restart networking =====
<pre>
sudo /etc/init.d/networking restart
</pre>

Once this is finished, your client will now have access to the Internet via ICS. Please direct any questions/comments to the <nowiki>[[http://ubuntuforums.org/showthread.php?s=88b74f79f0ab07638e6b361c09040b45&t=503287|Internet Connection Sharing Documentation]]</nowiki> thread.
----
A beginner's working example of a Ubuntu Desktop with 2 NIC cards, sharing Internet connection: http://ubuntuforums.org/showthread.php?p=3713684

=== Advanced Gateway Configuration ===
The above example outlines how to do basic ICS on a static IP network. Once you have configured your Ubuntu computers for ICS and confirmed that everything works across your static network, there are a few advanced routing configurations which can make it much easier to set up the ICS client.

Advanced configurations include DHCP server and DNS server. A DHCP server allows the client to get an IP address automatically without having to manually configure a static IP. A DNS server allows the client to resolve Internet host names without manually configuring DNS addresses.

==== DHCP/DNS server ====
This is deceptively easy, and will be acceptable for most situations. However, it will not allow the ICS client to see computers on different subnets.

* Install software.
<pre>
sudo aptitude install dnsmasq
</pre>

* Stop the server. After dnsmasq has been installed, it is automatically started, so it will need to be stopped before changes can be made.
<pre>
sudo /etc/init.d/dnsmasq stop
</pre>

* Make a backup of the well-commented configuration file (we won't use any of this, but it's handy to have a copy of for reference later).
<pre>
sudo cp /etc/dnsmasq.conf /etc/dnsmasq.conf-backup
</pre>

* Edit <code>/etc/dnsmasq.conf</code> with your favorite text editor, and add the following two lines:
<pre>
interface=eth1
dhcp-range=192.168.0.100,192.168.0.250,72h
</pre>

Note:
The "interface" should match the interface that your clients are connected to, and the "dhcp-range" should be within the gateway's private IP subnet that you configured according with the "Gateway set up" directions above.

* Start the DHCP/DNS server.
<pre>
sudo /etc/init.d/dnsmasq start
</pre>

Now, your clients should be able to pull an automatic ip address and resolve host names.

=== Other approaches ===
The following section includes a rough outline of some alternative methods for configuring an ICS gateway. They are incomplete and untested. They are included simply for the sake of information.

==== Alternate server software (CLI) ====
There are other ways to host ICS, but they are outside the scope of this article.

===== Alternate NAT =====
The ipmasq daemon does NAT routing so you don't have to configure iptables. The following directions are incomplete and should not be considered a full description of what needs to be done to configure ipmasq.

<pre>
sudo aptitude install ipmasq
</pre>

Configure ipmasq to allow dhcp requests. Otherwise, you need to stop ipmasq to make a connection. You need to copy a .rul from the documentation directory into the <code>/etc</code> config and edit the interface name. Then, reconfigure ipmasq to start after networking has been started.

<pre>
sudo dpkg-reconfigure ipmasq
</pre>

===== Dedicated DHCP server =====
dhcp3 is an easy to configure and scalable true DHCP server that can be configured for many different aplications. dhcp3 configuration is more complex, but it can be useful in many situations:

https://help.ubuntu.com/community/dhcp3-server

===== Dedicated DNS server =====
BIND9 is a popular and well-supported local DNS server. It is very versatile and very powerful, but difficult to configure correctly:

https://help.ubuntu.com/community/BIND9ServerHowto

==== Alternate gateway software (GUI) ====
Another approach is to set up <nowiki>[[Firestarter]]</nowiki>, to run connection sharing, to set up dhcp3-server, and to set its configuration to listen to the correct eth*. To change this later, run <code>sudo dpkg-reconfigure dhcp3-server</code>.

Basically, you need to have Firestarter active/turned on/protecting, to have the connection shared.

When you install dhcp3-server, it will place a sample config file in your <code>/etc/dhcp3</code> folder, called dhcpd.conf. I suggest that you install dhcp3-server first and then Firestarter because if you are lucky, Firestarter will set up a new dhcp3 config file for you.

At any time that changes are made to your <code>dhcpd.conf</code> file, restart the server by typing <code>sudo /etc/init.d/dhcp3-server restart</code>.
Alternatively, every time you run the <code>sudo dpkg-reconfigure dhcp3-server</code> command, at the end,  your server will restart.

There are several issues that I had. First of all, the Firestarter firewall won't even start if you don't have it configured to listen to the right interface. You can change which one it listens to in Preferences --> Network Settings. The Local-network-connected device must be the same as you have dhcp3-server listening to. Of course, both checkboxes under that need to be checked. The Internet-connected network device will be the one that is configured for Internet. Now, I have two NICs, but I have PPPoE configured on eth0, and I have Internet connection sharing configured on the same one, because eth0 is also configured for a static 192.168 internal IP for my internal network.

==== Simple iptables example ====
In a simple example, wlan0 has the Internet connection, and eth0 is being used to share the connection. It could be connected directly with a single computer via a crossover cable or switch, or you could have a router with a cable from eth0 to the WAN port and a whole LAN setup behind this. Interestingly, the Internet connection could be ppp0, a 3G, or mobile Internet modem.

# !/bin/sh <<BR>>
# <<BR>>
# internet connection sharing wlan0 is the gate way <<BR>>
# eth0 is the lan port this might use a straight ethernet cable to a router wan port or a switch or a single PC<<BR>>
# 192.168.2.2 is the port that is being used by the lan for access I changed it to 192.168.2.254 and set fixed addresses for the wan and router<<BR>>
# <<BR>>
# change wlan0 to ppp0 and you can use this for mobile broadband connection sharing<<BR>>
# <<BR>>
 ip link set dev eth0 up<<BR>>
 ip addr add 192.168.2.1/24 dev eth0<<BR>>
 sysctl net.ipv4.ip_forward=1<<BR>>
 iptables -t nat -A POSTROUTING -o wlan0 -s 192.168.2.0/24 -j MASQUERADE<<BR>>
 iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport 3074 -j DNAT --to-destination 192.168.2.2<<BR>>
 iptables -t nat -A PREROUTING -i wlan0 -p udp -m multiport --dports 88,3074 -j DNAT --to-destination 192.168.2.2<<BR>>
 iptables -A FORWARD -i wlan0 -d 192.168.2.2 -p tcp --dport 3074 -j ACCEPT<<BR>>
 iptables -A FORWARD -i wlan0 -d 192.168.2.2 -p udp -m multiport --dports 88,3074 -j ACCEPT<<BR>>
 
You could use the above as a bash script changing things to suit your needs.<<BR>>

 If things go wrong, the following script should save you when things get badly messed up. 

<<BR>>
# !/bin/sh<<BR>>
# <<BR>>
# rc.flush-iptables - Resets iptables to default values. <<BR>>
# <<BR>>
# Copyright (C) 2001  Oskar Andreasson &lt;bluefluxATkoffeinDOTnet&gt;<<BR>>
# <<BR>>
# This program is free software; you can redistribute it and/or modify<<BR>>
# it under the terms of the GNU General Public License as published by<<BR>>
# the Free Software Foundation; version 2 of the License.<<BR>>
# <<BR>>
# This program is distributed in the hope that it will be useful,<<BR>>
# but WITHOUT ANY WARRANTY; without even the implied warranty of<<BR>>
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the<<BR>>
# GNU General Public License for more details.<<BR>>
# <<BR>>
# You should have received a copy of the GNU General Public License<<BR>>
# along with this program or from the site that you downloaded it<<BR>>
# from; if not, write to the Free Software Foundation, Inc., 59 Temple<<BR>>
# Place, Suite 330, Boston, MA  02111-1307   USA<<BR>>
# <<BR>>
# Configurations<<BR>>
# <<BR>>
 IPTABLES="/usr/sbin/iptables"<<BR>>
# <<BR>>
# reset the default policies in the filter table.<<BR>>
# <<BR>>
 $IPTABLES -P INPUT ACCEPT<<BR>>
 $IPTABLES -P FORWARD ACCEPT<<BR>>
 $IPTABLES -P OUTPUT ACCEPT<<BR>>
# <<BR>>
# reset the default policies in the nat table.<<BR>>
# <<BR>>
 $IPTABLES -t nat -P PREROUTING ACCEPT<<BR>>
 $IPTABLES -t nat -P POSTROUTING ACCEPT<<BR>>
 $IPTABLES -t nat -P OUTPUT ACCEPT<<BR>>
# <<BR>>
# reset the default policies in the mangle table.<<BR>>
# <<BR>>
 $IPTABLES -t mangle -P PREROUTING ACCEPT<<BR>>
 $IPTABLES -t mangle -P POSTROUTING ACCEPT<<BR>>
 $IPTABLES -t mangle -P INPUT ACCEPT<<BR>>
 $IPTABLES -t mangle -P OUTPUT ACCEPT<<BR>>
 $IPTABLES -t mangle -P FORWARD ACCEPT<<BR>>
# <<BR>>
# flush all the rules in the filter and nat tables.<<BR>>
# <<BR>>
 $IPTABLES -F<<BR>>
 $IPTABLES -t nat -F<<BR>>
 $IPTABLES -t mangle -F<<BR>>
# <<BR>>
# erase all chains that's not default in filter and nat table.<<BR>>
# <<BR>>
 $IPTABLES -X<<BR>>
 $IPTABLES -t nat -X<<BR>>
 $IPTABLES -t mangle -X<<BR>>

Further reading: https://help.ubuntu.com/community/IptablesHowTo

Internet connection sharing documentation thread: http://ubuntuforums.org/showthread.php?t=503287 (Please note that this thread is in an old read-only section of the forum and cannot be posted to. Requests for help may be posted in one of the main sections of the forum.) 

=== See also ===
* <nowiki>[[WifiDocs-ShareEthernetConnectionThroughWireless]]</nowiki>
* InternetHowto
----
CategoryHardware CategoryInternet CategoryNetworking
