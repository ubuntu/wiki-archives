{|
  | '''Warning'''
  * This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
  * '''Images''' and '''attachments''' have been removed to conserve space.
  * '''Links''' may not work and there may be formatting issues.
  * A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__

== Introduction ==
Cyrus is one of the most widely used IMAP/POP servers. Cyrus is apreciated for virtualisation of mailboxes and cool stuff like server side filtering (Sieve) or shared folders. It is frequently used in universities. In this howto, a basic installation of Cyrus with authentication on PAM will be explained.

== Installation ==

Cyrus is in the main repository of Ubuntu (and as a consequence benefit from canonical security support). Install the following packages: <code>cyrus-admin-2.2 cyrus-clients-2.2 cyrus-imapd-2.2 sasl2-bin</code> (see InstallingSoftware). If you plan to support POP3 protocol install also <code>cyrus-pop3d-2.2</code>

If you do not have a <nowiki>[[http://en.wikipedia.org/wiki/Mail_transfer_agent|MTA]]</nowiki> yet, this step will install <code>postfix</code>. Please refer to the <nowiki>[[Postfix]]</nowiki> page for details.

== Configuration ==

=== Cyrus ===

Cyrus configuration is done in two configurations files: <code>/etc/imapd.conf</code> and <code>/etc/cyrus.conf</code>.

First, edit the <code>/etc/cyrus.conf</code> to activate the protocols you want. Here, imap and imaps will be activated:
<pre>
8<----------------------------------------
SERVICES {
##### --- Normal cyrus spool, or Murder backends ---
##### add or remove based on preferences
        imap            cmd="imapd -U 30" listen="imap" prefork=0 maxchild=100
        imaps           cmd="imapd -s -U 30" listen="imaps" prefork=0 maxchild=100
##### pop3           cmd="pop3d -U 30" listen="pop3" prefork=0 maxchild=50
##### pop3s          cmd="pop3d -s -U 30" listen="pop3s" prefork=0 maxchild=50
8<----------------------------------------
</pre>

You might need to update the location of the UNIX socket if using lmtp. At least in Ubuntu 8.04 the location is <code>/var/run/cyrus/socket/lmtp</code>. In postfix set accordingly.

Then edit <code>/etc/imapd.conf</code> (do not believe the name, it concerns general Cyrus stuff configuration). Only some parameters will be focused as most of options will match most of the needs.

<pre>
8<----------------------------------------
unixhierarchysep: no
8<----------------------------------------
</pre>

By default, unixhierarchysep if set to <code>no</code> which means that the separator is "." and not "/". You will have to turn in to <code>yes</code> if you want your mailbox to contains "." for example if you use mail addresses for naming your mailboxes.

<pre>
8<----------------------------------------
admins: cyrus
8<----------------------------------------
</pre>

This parameter defines an administrator for all the services. It will be required for administration operations like mailbox creation.

<pre>
8<----------------------------------------
sasl_pwcheck_method: saslauthd
8<----------------------------------------
</pre>

Indicates the method used for user authentication. <code>saslauthd</code> can also be used for Postfix authentication, as detailed in <nowiki>[[Postfix]]</nowiki> page.

<pre>
8<----------------------------------------
sasl_mech_list: PLAIN
8<----------------------------------------
</pre>

Last, change the <code>/etc/default/saslauthd</code>:

<pre>
START=yes

MECHANISMS="pam"
</pre>

Your authentication will be based on PAM. Probabily PAM is correctly setup on your machine.

Just launch <code>saslauthd</code> daemon:

<pre>
</pre>

=== Mail Transfer Agent ===

You have to configure your mail transfer agent to deliver your messages in your cyrus mailbox. In this howto, Postfix MTA will be presented. Feel free to add your favorite MTA.

==== Postfix ====

With Postfix, there are two ways of delivering messages in you mailbox: with a special transport named cyrus, or via lmtp (which is a protocol more or less similar to smtp). '''Choose the one you prefer'''. The <code>cyrus</code> transport is simple, <code>lmtp</code> is more powerful (i.e. you can communicate with lmtp between machines).

===== cyrus transport =====

In your postfix <code>main.cf</code> configuration file, add the following line:
<pre>
mailbox_transport = cyrus
</pre>

On Ubuntu installation, the transport <code>cyrus</code> is NOT already configured in <code>/etc/postfix/master.cf</code>. You must add manually at the end of <code>master.cf</code> the following lines:
<pre>
cyrus     unix  -   n   n   -   -   pipe
  flags=R user=cyrus argv=/usr/sbin/cyrdeliver -e -m "${extension}" ${user}
</pre>

===== lmtp =====

In your postfix <code>main.cf</code> configuration file, add the following line:
<pre>
mailbox_transport = lmtp:unix:/var/run/lmtp
</pre>

By default, on Ubuntu, the Unix socket lmtp is opened.  Make sure the socket matches the socket specified in your <code>/etc/cyrus.conf</code> and <code>/etc/imapd.conf</code>. 

In your postfix <code>master.cf</code> configuration file, edit the following line:
<pre>
lmtp      unix  -       -       -       -       -       lmtp
</pre>

to

<pre>
lmtp      unix  -       -       n       -       -       lmtp
</pre>

Otherwise, "No such file or directory" errors will be logged in the <code>/var/log/mail.log</code> as postfix tries to look for the socket in a chrooted environment.

Finally add postfix user to the mail group.
<pre>
adduser postfix mail
</pre>

== Mailbox creation ==

First, you have define a "password" for the user admin for the cyrusadm. With root make this:
<pre>
Password: TYPE YOUR CYRUS PASSWORD HERE
Again (for verification): RETYPE YOUR CYRUS PASSWORD
</pre>
and:
<pre>
Enter new UNIX password: TYPE YOUR CYRUS PASSWORD HERE
Retype new UNIX password: RETYPE YOUR CYRUS PASSWORD
</pre>

You also have to create the mailboxes for the users. User the <code>cyradm</code> utility for that:

<pre>
cyradm --user cyrus localhost
IMAP Password:
localhost>
</pre>

You can have the full description of the commands available by typing <code>help</code>. We will give more details in the section Administration & Maintenance.

Mailbox creation is done like this:
<pre>
localhost>cm user.toto
</pre>

Dot not forget the prefix <code>user.</code> or the mailbox created will be considered as a shared mailbox.

If you choose for <code>unixhierarchysep: yes</code> in /etc/imapd.conf the prefix must be <code>user/</code>

== Test ==

Test that your installation works correctly:

<pre>
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
* OK hostname Cyrus IMAP4 v2.1.18-IPv6-Debian-2.1.18-2ubuntu2 server ready
imap login user password
imap OK User logged in
</pre>

Where ''user'' and ''password'' are your login and password on the server. If it does not work check <code>/var/log/mail.log</code> for evidence.

== Administration / Maintenance ==

== Links ==

<nowiki>[[http://www.tldp.org/HOWTO/Postfix-Cyrus-Web-cyradm-HOWTO/|Postfix Cyrus Web cyradm HOWTO]]</nowiki>

----
CategoryEmail CategoryNetworking
