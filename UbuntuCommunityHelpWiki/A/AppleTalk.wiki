{|
  | '''Warning'''
  * This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
  * '''Images''' and '''attachments''' have been removed to conserve space.
  * '''Links''' may not work and there may be formatting issues.
  * A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__


=== Introduction ===
Some people using <nowiki>[[http://en.wikipedia.org/wiki/Appletalk|AppleTalk]]</nowiki> printers or running Mac OS 9 still want to use AppleTalk. While the AppleTalk protocol suite is considered deprecated by Apple these days, the large number of legacy devices makes discarding the protocol unfeasible.

=== Installing AppleTalk Daemons ===
Installation is easy, just use apt-get to install <nowiki>[[http://netatalk.sf.net|Netatalk]]</nowiki>.

<pre>
sudo apt-get install netatalk
</pre>

And wait for netatalk to run. If you get an error similar to:

<pre>
Starting Netatalk services (this will take a while): nbp_rgstr: FÃ¶rbindelsen dog ut (timeout)
Can't register laptop:Workstation@*
invoke-rc.d: initscript netatalk, action "start" failed.
dpkg: fel vid hantering av netatalk (--configure):
 underprocess post-installation script gav felkod 1
Fel uppstod vid hantering:
 netatalk
E: Sub-process /usr/bin/dpkg returned an error code (1)
</pre>

Then try adding your AppleTalk connected interface (eth0, eth1, wlan0 etc) to the end of /etc/netatalk/atalkd.conf 

<pre>
sudo gedit /etc/netatalk/atalkd.conf
</pre>

by typing the appropriate interface at the end of the file and try starting the services:

<pre>
sudo /etc/init.d/netatalk start
</pre>

<nowiki>[[http://archives.devshed.com/forums/networking-100/nbp-rgstr-connection-timed-out-startingnetatalk-on-fedora4t-1871279.html|Reference]]</nowiki>

=== AppleTalk Printing ===
Getting your Ubuntu installation to print to an AppleTalk printer is relatively easy.

First, provide CUPS with a working PAP (the Netatalk printing methodology) backend. You may download one from <nowiki>[[attachment:pap|here]]</nowiki>. Once you have that file, cd to where that file is stored and:

<pre>
sudo chmod +x pap
</pre>

<pre>
sudo mv pap /usr/lib/cups/backend
</pre>

Now all you need to do is restart CUPS. You can do this with

<pre>
sudo /etc/init.d/cups restart
</pre>

This should provide you with AppleTalk printing. 

Now, set up the printer by opening the Printing admin tool (System>Administration>Printing) and clicking the "New" button.

Before we go any farther we need to find the device URI, this can be accomplished by calling the backend without any arguments

<pre>
/usr/lib/cups/backend/pap
</pre>

This should return something like
<pre>
network pap "HP LaserJet 4050 Series " "LaserWriter"
</pre>

We want to take the device name and convert it into a pap address to use as the device URI. This is done by using the prefix "pap://" and converting any spaces into "%20". So in this case it would be

<pre>
pap://HP%20LaserJet%204050%20Series%20
</pre>

Note that in this case there was a space after the word "Series". This is important!

Now, under Devices select "Other" and enter the device URI we just found. 
<nowiki>[[File:Screenshot-New Printer.png]]</nowiki>

Click forward. Select your printer Make and Model and whatever options it may have. Once completed, print a test page to see if it works.

There you go. AppleTalk printing from Ubuntu! Enjoy. 

=== Finding Your Printer URI ===
If you are having trouble finding the correct URI for your printer first call the backend without argument :

<pre>
/usr/lib/cups/backend/pap
</pre>

if this doesn't work, try using nbplkup

<pre>
nbplkup
</pre>

=== AppleTalk Names ===
An Ubuntu node will show up on the AppleTalk network as 'localhost'. This is due to 'hostname -s' returning localhost instead of using the real name (in /etc/init.d/netatalk).

To remedy this, change the appropriate line in /etc/hosts and move the real hostname in front of 'localhost.localdomain', for example:

<pre>
127.0.0.1  realname localhost.localdomain localhost
</pre>

There's an open bug report documenting the problem with said order in /etc/hosts that is causing trouble with other programs, too.

https://launchpad.net/distros/ubuntu/+source/netcfg/+bug/8980

=== Problems ===
If nothing is coming out of your printer, debug the pap backend and view the log to see where problems may be coming from.

<pre>
sudo gedit /usr/lib/cups/backend/pap
</pre>

and uncomment out the lines that write out to the log file. (Delete the ##'s on lines that contain "echo")

restart cups and try to print another file

<pre>
sudo /etc/init.d/cups restart
</pre>

Now check the logs for any problems

<pre>
sudo cat /tmp/pap.log
</pre>

a sample log file should look like this
<pre>
+++++++++++++++++++++++++++++
Sat Feb   7 16:34:05 EST 2009 new job in pap backend
uri pap://HP%20LaserJet%204050%20Series%20
new file    /var/tmp/22205.prn
copies  1
nbpname HP LaserJet 4050 Series
%%[ status: busy; source: EIO 2 (ATALK) ]%%
Normal exit
</pre>

NOTE: if you see a line that says "NBP Lookup failed"
<pre>
HP LaserJet 4050 Series :LaserWriter@*: NBP Lookup failed
</pre>

You must restart netatalk and your printer should work again
<pre>
sudo /etc/init.d/netatalk restart
</pre>

=== Other Info ===
The following may be needed if you have more than one AppleTalk Zone or are having general problems.

With netatalk installed, run <code>nbplkup</code> to find the names of the AppleTalk printers on your network. Make a note of these names.

Edit /etc/cups/printers.conf (as root) to add the printer. Here's an example for a printer named "Laser Writer Select 360". The "LW360" you see is the name you'd like to see in Ubuntu. It can be almost anything. The "Laser Writer Select 360" name you see in the URL must be exactly the name that nbplkup gave you for the printer.

<pre>
<Printer LW360>
Info LW360
Location Local zone
DeviceURI pap://Laser%20Writer%20Select%20360
State Idle
Accepting Yes
JobSheets none none
QuotaPeriod 0
PageLimit 0
KLimit 0
</Printer>
</pre>

This example assumes a single, default AppleTalk zone. If you have more than one zone, the printer URL should end with %40 followed by the zone name.

<pre>
<Printer LW360>
Info LW360
Location Local zone
DeviceURI pap://Laser%20Writer%20Select%20360%40zonefour
State Idle
Accepting Yes
JobSheets none none
QuotaPeriod 0
PageLimit 0
KLimit 0
</Printer>
</pre>

Mozilla uses a newer Ghostscript engine than most Apple printers will support. If an error page stating this comes from the printer when you try to print from Firefox/Mozilla, change the default print string in Firefox/Mozilla's printing prefs to

<pre>
gs -q -sDEVICE=pswrite -sOutputFile=- -dNOPAUSE -dBATCH -dMozConvertedToLevel2=true - | lpr ${MOZ_PRINTER_NAME:+'-P'}${MOZ_PRINTER_NAME}"
</pre>

----
CategoryNetworking
