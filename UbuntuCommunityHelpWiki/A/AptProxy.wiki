{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work and there may be formatting issues.
* A '''compressed''' version with images and the original syntax is in the repo '''Releases'''.
|}

__TOC__


=== Introduction ===
apt-proxy is a program that caches the packages you download from the Internet, to your hard disk. Because apt-proxy behaves as if it were a HTTP server with a full copy of the repositories you select, you can access the packages from other computers on your network.  If a package is not in the cache, apt-proxy automatically downloads and caches it. This can significantly decrease download bandwidth and installation time when you have to install the same packages repeatedly (i.e. an upgrade of multiple machines).

=== Installation ===
apt-proxy is available from the Universe archive.  To install it, run this command from a terminal:

<pre>
sudo apt-get install apt-proxy
</pre>

=== Configuring apt-proxy Server ===
==== Default settings ====
'''You should change the default port to 9998 instead of 9999 while <nowiki>[[https://bugs.edge.launchpad.net/ubuntu/+source/apt-proxy/+bug/154494 | bug 154494]]</nowiki> isn`t fixed in order to apt-proxy to work.'''

The first section of the apt-proxy configuration file, located at ''/etc/apt-proxy/apt-proxy-v2.conf'', contains the default settings for the apt-proxy and its cache.

The first step is to check the <code>address</code> parameter to the IP of your apt-proxy server in the internal network. If it is commented out, apt-proxy will listen on all the IP addresses of your server.  The <code>port</code> parameter specifies the port apt-proxy listens on for requests and defaults to 9999, which is generally a good value to use.

If you wish to change the directory that apt-proxy stores its cached packages, change the <code>cache_dir</code> parameter.  The cache directory defaults to ''/var/cache/apt-proxy''. 

If you are using a web proxy server (such as Squid), you can configure apt-proxy to be aware of it with <code>http_proxy = proxy_server:port</code>.
If you are behind a firewall you may experience problems with active FTP connections when trying to connect to a FTP backend. <code>passive_ftp = on</code> should solve this problem.

The other values control the time a package remains in the cache, how old a package must be at least before apt-proxy checks for newer versions or how often the cache is checked for old packages. They can safely be left on their default values.

==== Backends ====
apt-proxy has to know where to find remote repositories, which it refers to as '''backends'''. This is done via backend sections in ''/etc/apt-proxy/apt-proxy-v2.conf''. A backend entry for Ubuntu may look like this: <pre>
[ubuntu]
;; Ubuntu archive
backends =
        http://archive.ubuntu.com/ubuntu
        http://de.archive.ubuntu.com/ubuntu
</pre> As you can see, it is possible to specify more than one server, separated by blank space. If the first server is down, apt-proxy tries to get the data from the second server and so on.  ''Note: If the first server is up, but does not have a required file, apt-proxy will not fall back to a second server.''
You can also override values set in the <code>[default</code>-section. For instance, if you know that a special server takes very long to answer a request, you can increase the timeout value: <pre>
[ubuntu-slow]
timeout = 60 ;wait 1 Minute
backends = prot://some.very.slow.server.net/ubuntu-slow
</pre>

A complete example '''apt-proxy-v2.conf''' may look like this: <pre>
[DEFAULT]
;; All times are in seconds, but you can add a suffix
;; for minutes(m), hours(h) or days(d)

address = 127.0.0.1
port = 9999
cache_dir = /var/cache/apt-proxy

;; Control files (Packages/Sources/Contents) refresh rate
min_refresh_delay = 1s
complete_clientless_downloads = 1

;; Debugging settings.
debug = all:4 db:0

timeout = 30
passive_ftp = on

;;--------------------------------------------------------------
;; Cache housekeeping

cleanup_freq = 1d
max_age = 120d
max_versions = 3

;;---------------------------------------------------------------
;; Backend servers
;;
;; Place each server in its own [section]

[ubuntu]
; Ubuntu archive
backends =
        http://archive.ubuntu.com/ubuntu
        http://de.archive.ubuntu.com/ubuntu

[ubuntu-security]
; Ubuntu security updates
backends = http://security.ubuntu.com/ubuntu

[marillat]
backends = http://mirrors.ecology.uni-kiel.de/debian/debian-multimedia

[debian]
; Backend servers, in order of preference
backends =
        http://ftp.us.debian.org/debian
        http://ftp.de.debian.org/debian
        http://ftp2.de.debian.org/debian
        ftp://ftp.uk.debian.org/debian

[debian-non-US]
; Debian debian-non-US archive
backends =
        http://ftp.uk.debian.org/debian-non-US
        http://ftp.de.debian.org/debian-non-US
        ftp://ftp.uk.debian.org/debian

[security]
; Debian security archive
backends =
        http://security.debian.org/debian-security
        http://ftp2.de.debian.org/debian-security

[openoffice]
; OpenOffice.org packages
backends =
        http://ftp.freenet.de/pub/debian-openoffice
        http://ftp.sh.cvut.cz/MIRRORS/OpenOffice.deb
        http://borft.student.utwente.nl/debian

[apt-proxy]
; Apt-proxy new versions
backends = http://apt-proxy.sourceforge.net/apt-proxy
</pre>

Note that you don't specify versions of distributions in this file; by enabling Ubuntu, you gain the ability to proxy for all versions (Hoary, Breezy, Dapper etc). What is downloaded depends on what is configured in the sources.list file on each client.

=== Initializing apt-proxy ===
After changing the apt-proxy configuration file, restart apt-proxy and update the list by running the following:

<pre>
$ sudo /etc/init.d/apt-proxy restart
</pre>

Your apt-proxy is ready for use.

=== Importing apt Cache ===
Note: In the current version of apt-proxy in the repositories (1.9.33ubuntu1), this might not work correctly.  This is a <nowiki>[[https://launchpad.net/ubuntu/+source/apt-proxy/+bug/4844|known bug]]</nowiki>.  Regardless, attempting this should not negatively impact your system.

Packages already downloaded with apt-get, are cached in ''/var/cache/apt/archives''. These packages can be imported into the apt-proxy cache with '''apt-proxy-import''' from the current package list. '''aptitude update''' should be run prior to '''apt-proxy-import''' to get a fresh list as follows:

<pre>
$ sudo aptitude update
$ sudo apt-proxy-import -r /var/cache/apt/archives
</pre>

=== Updating clients to use your proxy server ===
apt clients need the ''/etc/apt/sources.list'' file to be reconfigured to point to the new apt-proxy server instead of the outside world.  Configuration of the ''sources.list'' file looks similar to the config for normal apt repositories with the exception that the backend section has to be appended to the path: 
<pre>
deb http://apt-proxy:port/backend dist component
</pre>

Replace mentions of specific repository URL with references to your server and the backend for it; such as: <pre>
deb http://archive.ubuntu.com/ubuntu dapper main restricted
deb http://security.ubuntu.com/ubuntu dapper-security main restricted universe
</pre> would become <pre>
deb http://server:9999/ubuntu dapper main restricted
deb http://server:9999/ubuntu-security dapper-security main restricted universe
</pre>

A sources.list corresponding to the ''apt-proxy-v2.conf'' above may look like this: <pre>
deb http://localhost:9999/ubuntu dapper main restricted universe multiverse
deb-src http://localhost:9999/ubuntu dapper main restricted universe multiverse

deb http://localhost:9999/ubuntu-security dapper-security main restricted universe multiverse
deb-src http://localhost:9999/ubuntu-security dapper-security main restricted universe multiverse
</pre>

=== Troubleshooting ===
==== Problems with acquiring packages ====
In Dapper Drake, other Ubuntu computers connecting to the proxy may have problems receiving the file headers of the repository list.  If this happens to you, on the computers connecting to the proxy, edit /etc/apt/apt.conf, with:

<pre>
sudo nano /etc/apt/apt.conf
</pre>

or your choice of text editor.  It will likely be

<pre>
Acquire::http::Proxy "false";
</pre>

change this to

<pre>
Acquire::Proxy "false";
</pre>

and save, exit, and try updating the repositories file list again with

<pre>
sudo apt-get update
</pre>

or any other method that updates the repositories (such as Check in Update Manager or Reload in Synaptic).  It should load correctly now.

==== Connection Refused ====
On some setups, the proxy is not available to external machines.
The proxy works very well on localhost, but fails to cooperate with external machines.

=== Links ===
* AptGetHowto
* <nowiki>[[http://apt-proxy.sourceforge.net|apt-proxy webpage]]</nowiki>

----
CategoryInternet
