{|
| '''Warning'''
* This is a '''readonly''' and '''text-based''' archive of a deprecated wiki.
* '''Images''' and '''attachments''' have been removed to conserve space.
* '''Links''' may not work.
* A '''full compressed version''' of the wiki is available on archive.org
|}

__TOC__


== Scope ==
 
The following sections will describe how to use aufs on a / (root file system).  Aufs allows the creation of a root file system on a read-only flash device that feel just like a hard disk.  This is an alternative to the LiveCd image based USB flash systems.

Note: Aufs has many other uses.  This is not a how to on aufs.

This adventure was inspired by the Voyage Linux Distribution.

== AUFS support in main line kernel ==

Various unsuccessful attempts have been made to include aufs in the mainline kernel. The Ubuntu kernel has been supporting it, but there is 
a strong movement to drop support and use overlayfs instead. The upcomming Ubuntu 12.04 release will still contain aufs, but only because of certain problems with overlayfs (https://lists.ubuntu.com/archives/ubuntu-devel/2012-March/034869.html)

At the end of this Article, a script using overlayfs is given to help with the migration. 

== Introduction ==

Flash has a limited number of write operations, 10,000 to 1,000,000. It would  be nice if we could boot a system from a read-only file system to protect the flash.  LiveCd have done this for years, though a LiveCd just does not feel like a real system.

Goals: <<BR>>
1.The system must protect the flash.<<BR>> 
2.The system must be easy to update and upgrade. <<BR>>
3.The system must feel like The Real Thing. <<BR>>
4.Keep It Simple and Small, KISS. <<BR>>

== Requirements ==

Install Ubuntu 8.04, 4+ GB Flash device (USB or SDHC Class 4/6). 

== Install Ubuntu ==

Use the LiveCd to install to flash device.

== Before rootaufs script ==

This is from the EeePC test.  Ubuntu 8.04 was installed on a SDHC Class 4 flash device.    <<BR>>

The system is booted off of /dev/sdb.  The systems main hard disk, /dev/sda1, is not mounted.

<pre>
rootaufs:~$ df
Filesystem           1K-blocks      Used Available Use% Mounted on
/dev/sdb1              3916992   2044272   1673744  55% /
varrun                 1033584       100   1033484   1% /var/run
varlock                1033584         0   1033584   0% /var/lock
udev                   1033584        40   1033544   1% /dev
devshm                 1033584        12   1033572   1% /dev/shm
lrm                    1033584     38176    995408   4% /lib/modules/2.6.24-12-generic/volatile
/dev/sda1              3842376   3238736    408452  89% /media/sda1

</pre>

== After rootaufs script ==

After the rootaufs script is installed, the system is rebooted. <<BR>>

/dev/sdb1 is now mounted on /ro in a read-only state.  The system cannot write to /ro.  Aufs-tmpfs is a RAM disk mounted on /rw in a read-write state.  The aufs is using both /ro and /rw to mount / and run the system.  Everything works just the way you would expect.  <<BR>>

Because changes are stored in RAM, nothing is saved between reboots. See remountro and remountrw for more information on making changes without rebooting. Note:  the system is running from a ram disk. Do not fill the ram disk with your log files.  <<BR>>

Updates to the system are simple.  Remove aufs=tmpfs from the end of the command line in GRUB before the system boots and the system will boot in the “Before” state.  <<BR>>

<pre>
rootaufs:~$ df
Filesystem           1K-blocks      Used Available Use% Mounted on
varrun                 1033584       104   1033480   1% /var/run
varlock                1033584         0   1033584   0% /var/lock
udev                   1033584        40   1033544   1% /dev
devshm                 1033584        12   1033572   1% /dev/shm
lrm                    1033584     38176    995408   4% /lib/modules/2.6.24-12-generic/volatile
/dev/sdb1              3913620   2130640   1584180  58% /ro
aufs                   1033584      3668   1029916   1% /
aufs-tmpfs             1033584      3668   1029916   1% /rw

</pre>

=== Tested XEN domU ===

Scope:   Sandbox<<BR>>
System:  x86_64<<BR>>
Storage: iSCSI<<BR>>

NOTE: In order to fully protect the backend storage from any unauthorized changes, the disk from xen.cfg must be marked as read-only. In addition minor changes have to be made to init scripts that run fsck.

=== Tested Laptop ===

System: Toshiba<<BR>> 
RAM:    2GB<<BR>>
Flash:  USB Flash 4GB <<BR>>

System:  TOSHIBA Satellite A305 <<BR>>
Version: PSAG0U-02D00M <<BR>>
RAM:     4 GB<<BR>>
Flash:   8 GB SDHC <<BR>>
(Good Linux Laptop, boots SDHC card, Thank you best buy for helping test ubuntu 8.04.1 on each of your 27 demo laptops)<<BR>>
 

System HP tx1000<<BR>>
RAM:   2GB <<BR>>
Flash: SDHC 8GB<<BR>>
(This is not the best laptop for newbee's) <<BR>>

=== Tested eeepc ===
 
Note: Tested with Alpha 4 and apt-get dist-upgrade to Alpha 6.  Tested with 8.04 beta 1.<<BR>>

System: eeepc<<BR>>
RAM:    2GB<<BR>>
Flash:  SDHC 8GB || 4GB Class 4<<BR>>
 

Note: When installing on flash, use advanced option to put the boot loader on the flash drive, /dev/sdb . <<BR>> 

==== Step by Step eeepc ====
Note: Backup your data. If you make a mistake, you can over write /dev/sda on the EeePC with the Ubuntu installer.<<BR>>
 
This will not change the data on /dev/sda ( internal Flash )<<BR>>

Plug the SDHC card on the side of the EeePC.  Boot Ubuntu 8.04 – beta from an external USB CD-Rom. <<BR>>

===== Open Applications->Accessories->Terminal =====

If mounted, umount all disks.

{{{ 
 sudo umount /dev/sda1
 sudo umount /dev/sdb1

}}}

===== Click Install icon on desktop =====

===== Step 1 → Step 3 =====

Forward

===== Step 4 =====

Pick Manual<<BR>>
Remove all partitions from device /dev/sdb<<BR>>
Select /dev/sdb → free space<<BR>>
Click New<<BR>>
Select Prmary,Max size, Beginning, Ext2, / <<BR>>

Note: When you exit the partition editor, you will be asked to enable swap; just continue.<<BR>>

Or  <<BR>>
 
Pick “Guided – use entire Disk”<<BR>>
Pick “SCSI4 (0,0,0) (sdb) – 4.1 GB USB2.0 !CardReader SD0<<BR>>
Forward<<BR>>

Note: If you use "Guided", turn off swap in /etc/fstab after install. 

===== Step 5 =====
Name : <your name here><<BR>>
Password: <passwd><<BR>>
Name of this computer: rootaufs <<BR>>

===== Step 6 =====

Forward 

===== Step 7 =====

Click on Advanced<<BR>>

Install boot loader is checked.<<BR>>
Device for boot loader installation: <<BR>>
/dev/sdb <<BR>>
OK <<BR>>

Note: Please read and understand the information in the scroll box before you click Install.<<BR>>

===== Install =====

Click Install.

===== Restart =====

Note: Hit ESC and boot off of the !CardReader

==== First Boot ====

==== Update the System ==== 

<pre>

 apt-get update
 apt-get dist-upgrade
 apt-get install aufs-tools
 
</pre>

===== Install the rootaufs Script =====

<pre>

echo aufs >> /etc/initramfs-tools/modules
vi /etc/initramfs-tools/scripts/init-bottom/rootaufs
chmod 0755 /etc/initramfs-tools/scripts/init-bottom/rootaufs
mv /etc/initramfs-tools/scripts/init-bottom/rootaufs /etc/initramfs-tools/scripts/init-bottom/__rootaufs

</pre>

===== Remake the initramfs =====

<pre>

update-grub
update-initramfs -u

</pre>

===== Edit Grub Menu =====

This is how rootaufs is used. <<BR>>

Add aufs=tmpfs to the end of the menu.lst entry you wish to use read only. Do not add aufs=tmpfs after entries with "single".<<BR>>

{{{ 

## sed edit /boot/grub/menu.lst
  cp /boot/grub/menu.lst /boot/grub/menu.lst.aufs
  cat /boot/grub/menu.lst.aufs|sed  s/'ro quiet splash'/'ro quiet splash aufs=tmpfs'/ >/boot/grub/menu.lst

## or vi edit 

  vi /boot/grub/menu.lst

}}}

<pre>

title           Ubuntu hardy (development branch), kernel 2.6.24-12-generic
root            (hd1,0)
kernel          /boot/vmlinuz-2.6.24-12-generic root=UUID=77a02dc5-aab7-41d5-a743-4659f2a16131 ro quiet splash aufs=tmpfs
initrd          /boot/initrd.img-2.6.24-12-generic
quiet

</pre>

===== Adding software to the system is easy =====

When the grub loader appears, hit e to edit. Remove aufs=tmpfs and hit b, to boot. <<BR>>
Make the needed changes and reboot.<<BR>>

===== Make Grub Menu changes persistent =====

The above method undoes your changes every time you run update-grub,
this shouldn't be to big of a problem, since the root filesystem is going to be ro. But if you install a updated kernel in rw mode you would have to edit /boot/grub/menu.lst again.

This method doesn't have that problem and also enables you to make a nice bootmenu entry for the rw mode

find this part in /boot/grub/menu.lst
<pre>

</pre>

and add "aufs=tmpfs" to the last rule, so it looks like this now

<pre>

</pre>

now find this part, it's a bit further down the file
<pre>

</pre>

and add this line

<pre>

</pre>

and now that's part is looking like this

<pre>

</pre>

after editing the file execute this command in the command line

<pre>

sudo update-grub

</pre>

Now when booting and you want to boot to the writable mode press 'esc' to enter the boot menu en select the 'writable mode' boot entry from your preferred kernel

===== Remountrw and Remountro =====

remountrw remounts /ro in a read / write mode. Files can now be copied from / to /ro. 

<pre>
sudo remountrw
</pre>

remountro remounts /ro in a read only mode

<pre>
sudo remountrw
</pre>

===== /Ro =====
/ro is the real root file system. /ro is mounted ro by default and is not harmed by power cycling the system.<<BR>>

Use remountrw and remountro to make changes to the system without rebooting into single user mode.<<BR>>

===== /RW =====

/rw is a file system in RAM. As the system runs files are updated on / . /rw is the real location of the files that are changed. <<BR>>

/rw is mounted to allow df to show the real space used by the read / write part of the file system. <<BR>>

Note: Removing a file from /rw restores the file found in /ro. Removing the file from / hides the file found in /ro  <<BR>>
 
===== Home Accounts on / =====

Note: if your home account is on the root file system, your files are in ram and not saved.

== rootaufs Script ==

This was sent as an email to Voyage Linux mailing list. 

Copy the following code to /etc/initramfs-tools/scripts/init-bottom/rootaufs
<pre>

case $1 in
prereqs)
    exit 0
    ;;
esac

export aufs

for x in $(cat /proc/cmdline); do 
    case $x in 
    root=*)
        ROOTNAME=${x#root=}
        ;;
    aufs=*)
        aufs=${x#aufs=}
        case $aufs in
        tmpfs-debug)
            aufs=tmpfs
            aufsdebug=1
            ;;
        esac    
        ;;
    esac
done

if [ "$aufs" != "tmpfs" ]; then
### not set in boot loader 
### I'm not loved. good bye
    exit 0
fi

echo 
echo "       root-aufs:  Setting up aufs on ${rootmnt} as root file system "
echo 

modprobe -q --use-blacklist aufs
if [ $? -ne 0 ]; then
    echo    root-aufs error:      Failed to load aufs.ko
    exit 0
fi

mkdir /aufs
mkdir /rw
mkdir /ro

mount -t tmpfs aufs-tmpfs /rw
mount --move ${rootmnt} /ro 
if [ $? -ne 0 ]; then
    echo    root-aufs error:    ${rootmnt}  failed to move to /ro
    exit 0
fi

mount -t aufs -o dirs=/rw:/ro=ro aufs /aufs
if [ $? -ne 0 ]; then
    echo    root-aufs error:      Failed to mount /aufs files system
    exit 0
fi

[  -d /aufs/ro ] || mkdir /aufs/ro
[  -d /aufs/rw ] || mkdir /aufs/rw

mount --move /ro /aufs/ro
if [ $? -ne 0 ]; then
    echo    root-aufs error:      Failed to move /ro /aufs/ro 
    exit 0
fi

mount --move /rw /aufs/rw
if [ $? -ne 0 ]; then
    echo    root-aufs error:      Failed to move /rw /aufs/rw 
    exit 0
fi

if [ "0$aufsdebug" -eq 1 ]; then
    echo  "   root-aufs debug:    Remove the root file system and swap from fstab "
    echo 
    echo 
    echo  "         ROOTNAME $ROOTNAME "
    echo  "         resume   $resume   "
    echo 
    echo  '     BlaYO pointed out that grep can be used to quickly remove '
    echo  '      the root file system from fstab. '
    echo 
    echo  '	Thank you BlaYO for the debug info.'
    echo

fi

cat <<EOF >/aufs/etc/fstab

EOF

cat /aufs/ro/etc/fstab|grep -v ' / ' | grep -v swap >>/aufs/etc/fstab  
if [ $? -ne 0 ]; then
    echo    root-aufs error:      Failed to create /aufs/etc/fstab 
### exit 0
fi

ROOTTYPE=$(cat /proc/mounts|grep ${ROOT}|cut -d' ' -f3)
ROOTOPTIONS=$(cat /proc/mounts|grep ${ROOT}|cut -d' ' -f4)
echo ${ROOT} /ro $ROOTTYPE $ROOTOPTIONS 0 0 >>/aufs/etc/fstab

cat /aufs/ro/etc/rc.local|sed 's/\(.*\)exit/\1\#exit/' >/aufs/etc/rc.local  
echo mount -f  /ro >>/aufs/etc/rc.local 

echo "echo aufs / aufs rw,xino=/rw/.aufs.xino,br:/rw=rw:/ro=ro 0 0 >>/etc/mtab" >>/aufs/etc/rc.local
echo "echo aufs-tmpfs /rw tmpfs rw 0 0 >>/etc/mtab" >>/aufs/etc/rc.local 
echo exit 0 >>/aufs/etc/rc.local 

[ -e /scripts/init-bottom/_apparmor ] && rm /scripts/init-bottom/_apparmor
[ -e /aufs/etc/init.d/apparmor ] && rm /aufs/etc/init.d/apparmor

echo \#!/bin/sh >/aufs/bin/remountrw
echo mount -o remount,rw ${ROOT} >>/aufs/bin/remountrw
chmod 0700 /aufs/bin/remountrw

echo \#!/bin/sh >/aufs/bin/remountro
echo mount -o remount,ro ${ROOT} >>/aufs/bin/remountro
chmod 0700 /aufs/bin/remountro

if [ "0$aufsdebug" -eq 1 ]; then
    echo
    echo "   root-aufs debug:    mount --move /aufs ${rootmnt} "
    echo 
    echo '   root-aufs debug: 	init will stop here.   '
    echo  
    exit 0
fi

mount --move /aufs ${rootmnt}

exit 0 

</pre>

== Known issues ==

=== Apparmor ===

Note: an issues has been posted to the forum, "AUFS root partition breaks networking" ,http://ubuntuforums.org/showthread.php?t=1220145

updated rootaufs works with 9.10 as of 2009.12.7 
status: apparmor is now part of initramfs. Apparmor is starting at the before rootaufs can pivot the root file system into place. 

Apparmor is updating it's access control lists on a read only drive.  This issue was not corrected in the live cd. When apparmor works on the live cd it should work with rootaufs.

To correct problems with network you can disable apparmor or execute next commands:
<pre>
apt-get install apparmor-utils
aa-complain dhclient3
</pre>

Alternative, as far as you do not require apparmor at all, you can uninstall it by:
<pre>
sudo apt-get remove --purge apparmor
</pre>

== Overlayfs ==
This is a script that uses overlayfs instead of aufs. 

Copy the following code to /etc/initramfs-tools/scripts/init-bottom/root-ro. Add overlayfs to /etc/initramfs-tools/modules. 
<pre>

PREREQ=""

prereqs()
{
    echo "${PREREQ}"
}

case "$1" in
    prereqs)
    prereqs
    exit 0
    ;;
esac

. /scripts/functions

MYTAG="root-ro"
DISABLE_MAGIC_FILE="/disable-root-ro"

ROOT_RO_DRIVER=
DISABLE_ROOT_RO=
for CMD_PARAM in $(cat /proc/cmdline); do 
    case ${CMD_PARAM} in 
        disable-root-ro=*)
            DISABLE_ROOT_RO=${CMD_PARAM#disable-root-ro=}
            ;;
        root-ro-driver=*)
            ROOT_RO_DRIVER=${CMD_PARAM#root-ro-driver=}
            ;;
    esac
done

if [ ! -z "${DISABLE_ROOT_RO}" ]; then
    log_warning_msg "${MYTAG}: disabled, found boot parameter disable-root-ro=${DISABLE_ROOT_RO}"
    exit 0
fi
if [ -e "${rootmnt}${DISABLE_MAGIC_FILE}" ]; then
    log_warning_msg "${MYTAG}: disabled, found file ${rootmnt}${DISABLE_MAGIC_FILE}"
    exit 0
fi

ROOT_RW=/mnt/root-rw
ROOT_RO=/mnt/root-ro

if [ -z "${ROOT_RO_DRIVER}" ]; then
    ROOT_RO_DRIVER=overlayfs
fi
case ${ROOT_RO_DRIVER} in
    overlayfs)
        MOUNT_PARMS="-t overlayfs -o lowerdir=${ROOT_RO},upperdir=${ROOT_RW} overlayfs-root ${rootmnt}"
        ;;
    aufs)
        MOUNT_PARMS="-t aufs -o dirs=${ROOT_RW}:${ROOT_RO}=ro aufs-root ${rootmnt}"
        ;;
*** )
        panic "${MYTAG} ERROR: invalide ROOT_RO_DRIVER ${ROOT_RO_DRIVER}"
        ;;
esac

modprobe -qb ${ROOT_RO_DRIVER}
if [ $? -ne 0 ]; then
    log_failure_msg "${MYTAG} ERROR: missing kernel module ${ROOT_RO_DRIVER}"
    exit 0
fi

[ -d ${ROOT_RW} ] || mkdir -p ${ROOT_RW}
if [ $? -ne 0 ]; then
    log_failure_msg "${MYTAG} ERROR: failed to create ${ROOT_RW}"
    exit 0
fi

[ -d ${ROOT_RO} ] || mkdir -p ${ROOT_RO}
if [ $? -ne 0 ]; then
    log_failure_msg "${MYTAG} ERROR: failed to create ${ROOT_RO}"
    exit 0
fi

mount -t tmpfs tmpfs-root ${ROOT_RW}
if [ $? -ne 0 ]; then
    log_failure_msg "${MYTAG} ERROR: failed to create tmpfs"
    exit 0
fi

mount --move ${rootmnt} ${ROOT_RO}
if [ $? -ne 0 ]; then
    log_failure_msg "${MYTAG} ERROR: failed to move root away from ${rootmnt} to ${ROOT_RO}"
    exit 0
fi

mount ${MOUNT_PARMS}
if [ $? -ne 0 ]; then
    log_failure_msg "${MYTAG} ERROR: failed to create new ro/rw layerd ${rootmnt}"
### do recovery and try resoring the mount for ${rootmnt}
    mount --move ${ROOT_RO} ${rootmnt}
    if [ $? -ne 0 ]; then
#### thats badm, drpo to s shell to let the user try fixing this
       panic "${MYTAG} RECOVERY ERROR: failed to move ${ROOT_RO} back to ${rootmnt}"
    fi
    exit 0
fi

[ -d ${rootmnt}${ROOT_RO} ] || mkdir -p ${rootmnt}${ROOT_RO}
mount --move ${ROOT_RO} ${rootmnt}${ROOT_RO}
if [ $? -ne 0 ]; then
    log_failure_msg "${MYTAG} ERROR: failed to move ${ROOT_RO} to ${rootmnt}${ROOT_RO}"
    exit 0
fi

[ -d ${rootmnt}${ROOT_RW} ] || mkdir -p ${rootmnt}${ROOT_RW}
mount --move ${ROOT_RW} ${rootmnt}${ROOT_RW}
if [ $? -ne 0 ]; then
    s "${MYTAG}: ERROR: failed to move ${ROOT_RW} to ${rootmnt}${ROOT_RW}"
    exit 0
fi

ROOT_TYPE=$(cat /proc/mounts | grep ${ROOT} | cut -d' ' -f3)
ROOT_OPTIONS=$(cat /proc/mounts | grep ${ROOT} | cut -d' ' -f4)
cat <<EOF >${rootmnt}/etc/fstab

${ROOT} ${ROOT_RO} ${ROOT_TYPE} ${ROOT_OPTIONS} 0 0

EOF
if [ $? -ne 0 ]; then
    log_failure_msg "${MYTAG} ERROR: failed to modify /etc/fstab (step 1)"
### exit 0
fi

cat ${rootmnt}${ROOT_RO}/etc/fstab | grep -v ' / ' | grep -v swap >>${rootmnt}/etc/fstab
if [ $? -ne 0 ]; then
    log_failure_msg "${MYTAG} ERROR: failed to modify etc/fstab (step 2)"
### exit 0
fi

log_success_msg "${MYTAG} sucessfully set up ro/tmpfs-rw layered root fs using ${ROOT_RO_DRIVER}"

exit 0 
</pre>

== Credits ==
nschembr - the entire turorial, and the rootaufs script<<BR>>
mannes - added <nowiki>[[#Make Grub Menu changes persistent|Make Grub Menu changes persistent]]</nowiki> section<<BR>>
Joaquín I. Bogado García - Lethe project and Apparmor error <<BR>>
Victor Arribas - Scripts changes August 2011, and debian live review (coming soon)
== Links ==
* <nowiki>[[http://ubuntuforums.org/showthread.php?p=5362116|Topic on this tutorial on the Ubuntu forums]]</nowiki>

----
